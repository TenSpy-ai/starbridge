<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Starbridge Intel Brief Pipeline — Explorer</title>
<style>
  :root {
    --bg: #0d1117; --surface: #161b22; --surface2: #21262d; --border: #30363d;
    --text: #e6edf3; --text-dim: #8b949e; --text-bright: #f0f6fc;
    --blue: #58a6ff; --green: #3fb950; --orange: #d29922; --purple: #bc8cff;
    --red: #f85149; --cyan: #39d2c0; --yellow: #e3b341; --pink: #f778ba;
    --llm: #2a1a3a; --llm-border: #8b5cf6;
    --template: #1a2a1e; --template-border: #4a9a5b;
    --logic: #2a1f1a; --logic-border: #f0883e;
    --validate: #2a1a1a; --validate-border: #f85149;
    --sqlite: #2a2a0a; --sqlite-border: #f5e14e;
    --api: #0d2a3a; --api-border: #39d2c0;
    --tool: #1a3a2a; --tool-border: #238636;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }

  /* ── App grid ─────────────────────────────────────── */
  .app { display: grid; grid-template-columns: 340px 1fr; grid-template-rows: auto 1fr auto auto; height: 100vh; }
  .app.diagram-mode { grid-template-columns: 1fr; }
  .app.diagram-mode .pipeline { display: none; }
  .app.diagram-mode .detail { display: none; }
  .app.diagram-mode .diagram-wrap { display: block; }

  /* ── View toggle ──────────────────────────────────── */

  /* ── Diagram wrap ─────────────────────────────────── */
  .diagram-wrap { display: none; position: relative; overflow: auto; background: var(--bg); grid-column: 1/-1; grid-row: 2; }


  /* ── Header ───────────────────────────────────────── */
  .header { grid-column: 1/-1; padding: 12px 20px; background: var(--surface); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; gap: 16px; }
  .header h1 { font-size: 15px; font-weight: 600; color: var(--text-bright); white-space: nowrap; }
  .controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
  .highlight-select { background: var(--surface2); border: 1px solid var(--border); color: var(--text-dim); padding: 4px 10px; border-radius: 6px; font-size: 11px; cursor: pointer; transition: all 0.15s; appearance: none; -webkit-appearance: none; padding-right: 20px; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%23768390'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 6px center; }
  .highlight-select:hover { border-color: var(--blue); color: var(--text); }
  .utility-btn { background: none; border: 1px solid var(--border); color: var(--text-dim); padding: 4px 10px; border-radius: 6px; font-size: 11px; cursor: pointer; transition: all 0.15s; }
  .utility-btn:hover { border-color: var(--text-dim); color: var(--text); background: var(--surface2); }

  /* ── Pipeline left panel ──────────────────────────── */
  .pipeline { overflow-y: auto; padding: 16px; border-right: 1px solid var(--border); background: var(--bg); }
  .phase-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.2px; color: var(--text-dim); margin: 16px 0 8px 0; text-align: center; border-bottom: 1px solid var(--border); padding-bottom: 6px; }
  .phase-label:first-child { margin-top: 0; }
  .step { padding: 10px 12px; border-radius: 8px; margin-bottom: 4px; cursor: pointer; border: 1px solid transparent; transition: all 0.15s; }
  .step:hover { background: var(--surface); }
  .step.selected { border-color: var(--blue); background: var(--surface); }
  .step.dimmed { opacity: 0.3; pointer-events: none; }
  .step-num { font-size: 10px; font-weight: 700; color: var(--text-dim); margin-bottom: 2px; display: flex; align-items: center; gap: 6px; }
  .step-name { font-size: 13px; font-weight: 500; }
  .step-meta { font-size: 11px; color: var(--text-dim); margin-top: 2px; }
  .step-badge { display: inline-block; padding: 1px 6px; border-radius: 4px; font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
  .badge-api { background: var(--api); color: var(--cyan); border: 1px solid var(--api-border); }
  .badge-template { background: var(--template); color: var(--template-border); border: 1px solid var(--template-border); }
  .badge-python, .badge-logic { background: var(--logic); color: var(--logic-border); border: 1px solid var(--logic-border); }
  .badge-sqlite { background: var(--sqlite); color: var(--sqlite-border); border: 1px solid var(--sqlite-border); }
  .badge-tool { background: rgba(57,210,192,0.1); color: var(--cyan); border: 1px solid var(--cyan); }
  .badge-validate { background: var(--validate); color: var(--red); border: 1px solid var(--validate-border); }
  .badge-notion { background: rgba(140,140,140,0.1); color: var(--text-dim); border: 1px solid rgba(140,140,140,0.3); }
  .badge-source { background: rgba(240,246,252,0.08); color: var(--text-bright); border: 1px solid var(--text-dim); }

  /* ── Step card enrichment indicators ────────────────── */
  .step-indicators { display:flex; gap:4px; align-items:center; flex-wrap:wrap; margin-top:3px; }
  .ind { display:inline-flex; align-items:center; gap:2px; padding:1px 5px; border-radius:3px; font-size:9px; font-family:'SF Mono','Fira Code',monospace; }
  .ind-svc { background:var(--bg-raised, var(--surface2)); border:1px solid var(--border); color:var(--text-dim); }
  .ind-timeout { color:var(--yellow); opacity:0.7; font-size:9px; }
  .ind-tools { color:var(--cyan); opacity:0.7; font-size:9px; }

  /* ── Sub-agent badge ──────────────────────────────────── */
  .subagent-badge { display:inline-flex; align-items:center; gap:2px; padding:1px 5px; border-radius:3px; font-size:8px; font-weight:600; text-transform:uppercase; background:var(--llm); color:var(--purple); border:1px solid var(--llm-border); }

  /* Compact sizing inside diagram nodes */
  .dnode .step-indicators { margin-top:2px; margin-bottom:1px; }
  .dnode .ind { font-size:8px; padding:0 3px; }

  .connector { display: none; }
  .parallel-group { border-left: 2px solid var(--text-dim); margin: 8px 0 8px 20px; padding: 14px 0 6px 12px; position: relative; margin-top: 20px; }
  .parallel-group::before { content: 'PARALLEL'; position: absolute; top: -8px; left: 8px; font-size: 9px; color: var(--text-dim); font-weight: 700; letter-spacing: 1px; background: var(--bg); padding: 0 4px; }

  /* ── Detail right panel ───────────────────────────── */
  .detail { overflow-y: auto; padding: 24px 28px; background: var(--surface); }
  .detail-empty { display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-dim); font-size: 14px; }
  .detail h2 { font-size: 18px; font-weight: 600; color: var(--text-bright); margin-bottom: 4px; }
  .detail .subtitle { font-size: 13px; color: var(--text-dim); margin-bottom: 20px; }
  .detail-section { margin-bottom: 24px; }
  .detail-section h3 { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
  .detail-section h3 .dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

  /* ── Data chips ───────────────────────────────────── */
  .data-flow { display: flex; flex-wrap: wrap; gap: 6px; }
  .data-chip { padding: 3px 10px; border-radius: 12px; font-size: 11px; font-family: 'SF Mono', 'Fira Code', monospace; }
  .chip-in { background: rgba(88,166,255,0.1); color: var(--blue); border: 1px solid rgba(88,166,255,0.3); }
  .chip-out { background: rgba(63,185,80,0.1); color: var(--green); border: 1px solid rgba(63,185,80,0.3); }
  .chip-feeds { background: rgba(210,153,34,0.1); color: var(--orange); border: 1px solid rgba(210,153,34,0.3); }
  .chip-tool { background: rgba(57,210,192,0.1); color: var(--cyan); border: 1px solid rgba(57,210,192,0.3); }

  /* ── Output schema ────────────────────────────────── */
  .output-schema { margin-top: 0; }
  .schema-row { margin-bottom: 8px; }
  .schema-row:last-child { margin-bottom: 0; }
  .schema-name { font-size: 11px; font-family: 'SF Mono', 'Fira Code', monospace; color: var(--green); background: rgba(63,185,80,0.1); border: 1px solid rgba(63,185,80,0.3); border-radius: 12px; padding: 3px 10px; display: inline-block; margin-bottom: 2px; }
  .schema-type { font-size: 10px; font-family: 'SF Mono', 'Fira Code', monospace; color: var(--text-dim); background: rgba(63,185,80,0.05); border: 1px solid rgba(63,185,60,0.1); border-radius: 4px; padding: 4px 8px; margin: 2px 0 0 0; white-space: pre-wrap; overflow-wrap: break-word; line-height: 1.5; }
  .schema-type-inline { font-size: 10px; font-family: 'SF Mono', 'Fira Code', monospace; color: var(--text-dim); display: block; padding-left: 2px; opacity: 0.8; }

  /* ── Input source groups ──────────────────────────── */
  .input-group { margin-bottom: 10px; }
  .input-group:last-child { margin-bottom: 0; }
  .input-group-label { font-size: 10px; color: var(--text-dim); margin-bottom: 4px; padding-left: 2px; }
  .src-link { color: var(--cyan); cursor: pointer; }
  .src-link:hover { text-decoration: underline; }

  /* ── Prompt / detail block ────────────────────────── */
  .prompt-block { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 16px; font-family: 'SF Mono', 'Fira Code', monospace; font-size: 12px; line-height: 1.6; white-space: pre-wrap; word-break: break-word; max-height: 400px; overflow-y: auto; color: var(--text); }

  /* ── Callout ──────────────────────────────────────── */
  .callout { display: flex; align-items: flex-start; gap: 8px; padding: 10px 14px; border-radius: 8px; font-size: 11px; line-height: 1.5; margin: 0 0 18px 0; border: 1px solid; }
  .callout-info { background: rgba(88,166,255,0.06); border-color: rgba(88,166,255,0.15); color: var(--blue); }
  .callout-icon { font-size: 14px; flex-shrink: 0; }

  /* ── Scoring bars ─────────────────────────────────── */
  .scoring-bar { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; }
  .scoring-bar-label { font-size: 11px; width: 90px; color: var(--text-dim); text-transform: capitalize; }
  .scoring-bar-track { flex: 1; height: 6px; background: var(--bg); border-radius: 3px; overflow: hidden; }
  .scoring-bar-fill { height: 100%; border-radius: 3px; background: var(--orange); }
  .scoring-bar-val { font-size: 10px; font-family: 'SF Mono', 'Fira Code', monospace; color: var(--text-dim); width: 32px; text-align: right; }

  /* ── Conditional run badge ────────────────────────── */
  .conditional-run { display: inline-block; font-size: 11px; font-weight: 600; padding: 3px 10px; border-radius: 12px; margin: 6px 0 2px 0; }
  .conditional-run-always { color: var(--green); background: rgba(63,185,80,0.1); border: 1px solid rgba(63,185,80,0.2); }
  .conditional-run-stop { color: var(--red); background: rgba(248,81,73,0.1); border: 1px solid rgba(248,81,73,0.2); }
  .conditional-run-skip { color: var(--orange); background: rgba(210,153,34,0.1); border: 1px solid rgba(210,153,34,0.2); }
  .conditional-run-branch { color: var(--purple); background: rgba(130,80,223,0.1); border: 1px solid rgba(130,80,223,0.2); }

  /* ── Quality rules ────────────────────────────────── */
  .quality-rule { padding: 6px 10px; background: rgba(248,81,73,0.08); border-left: 3px solid var(--red); border-radius: 0 6px 6px 0; margin-bottom: 6px; font-size: 12px; line-height: 1.5; color: var(--text-dim); }

  /* ── Edge cases ───────────────────────────────────── */
  .edge-case { padding: 8px 12px; background: var(--bg); border-radius: 6px; margin-bottom: 4px; font-size: 12px; border-left: 3px solid var(--orange); }
  .edge-case.ec-stop { border-left-color: var(--red); background: rgba(248,81,73,0.06); }
  .edge-case.ec-fail { border-left-color: var(--red); background: rgba(248,81,73,0.06); }
  .edge-case.ec-degrade { border-left-color: var(--orange); }
  .edge-case.ec-skip { border-left-color: var(--text-dim); }
  .edge-case .ec-severity { display: inline-block; font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; padding: 1px 5px; border-radius: 3px; white-space: nowrap; margin-right: 8px; vertical-align: middle; }
  .ec-stop .ec-severity { color: var(--red); background: rgba(248,81,73,0.15); }
  .ec-fail .ec-severity { color: var(--red); background: rgba(248,81,73,0.15); }
  .ec-degrade .ec-severity { color: var(--orange); background: rgba(210,153,34,0.15); }
  .ec-skip .ec-severity { color: var(--text-dim); background: rgba(139,148,158,0.15); }
  .edge-case .ec-label { color: var(--text); font-weight: 600; }
  .edge-case .ec-action { color: var(--text-dim); display: block; margin-top: 3px; margin-left: 2px; }

  /* ── Impl tags ────────────────────────────────────── */
  .impl-row { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 4px; }
  .impl-tag { font-size: 10px; font-family: 'SF Mono', 'Fira Code', monospace; background: var(--surface2); border: 1px solid var(--border); color: var(--text-dim); padding: 2px 8px; border-radius: 4px; }
  .impl-tag span { color: var(--blue); }

  /* ── Check list ───────────────────────────────────── */
  .check-item { font-size: 12px; color: var(--text-dim); padding: 4px 0; line-height: 1.5; display: flex; gap: 6px; }
  .check-advisory { color: var(--yellow); }

  /* ── Prompt output bar ────────────────────────────── */
  .prompt-output { grid-column: 1/-1; border-top: 1px solid var(--border); background: var(--surface); padding: 12px 20px; display: flex; align-items: flex-start; gap: 12px; position: relative; }
  .prompt-output.minimized { padding: 10px 20px; }
  .prompt-output.minimized .prompt-output-text { display: none; }
  .prompt-output.minimized .prompt-output-actions { display: none; }
  .prompt-output.minimized .resize-handle { display: none; }
  .resize-handle { position: absolute; top: 0; left: 0; right: 0; height: 12px; cursor: ns-resize; z-index: 10; display: flex; align-items: center; justify-content: center; }
  .resize-handle::after { content: ''; display: block; width: 36px; height: 3px; border-radius: 2px; background: var(--border); transition: background 0.15s; }
  .resize-handle:hover::after { background: var(--accent); }
  .prompt-output-text { flex: 1; font-family: 'SF Mono', 'Fira Code', monospace; font-size: 12px; color: var(--text); line-height: 1.5; overflow-y: auto; max-height: 150px; white-space: pre-wrap; }
  .prompt-output-actions { position: absolute; bottom: 10px; right: 16px; display: flex; gap: 6px; z-index: 5; }
  .key-toggle-btn { background: var(--surface2); border: 1px solid var(--border); color: var(--text-dim); padding: 4px 8px; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.15s; white-space: nowrap; }
  .key-toggle-btn:hover { border-color: var(--blue); color: var(--text); }
  .key-toggle-btn.active { border-color: var(--blue); color: var(--blue); background: rgba(88,166,255,0.1); }
  .copy-btn { background: var(--blue); color: #fff; border: none; padding: 6px 16px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.15s; }
  .copy-btn:hover { opacity: 0.85; }
  .copy-btn.copied { background: var(--green); }
  .minimize-btn { background: none; border: none; color: var(--text-dim); font-size: 16px; cursor: pointer; padding: 0 4px; line-height: 1; flex-shrink: 0; border-radius: 3px; }
  .minimize-btn:hover { color: var(--text); background: var(--surface2); }
  .view-all-btn { background: var(--surface2); color: var(--text); border: 1px solid var(--border); padding: 6px 16px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; white-space: nowrap; }
  .view-all-btn:hover { background: var(--border); border-color: var(--blue); }

  /* ── Modal ────────────────────────────────────────── */
  .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
  .modal-overlay.visible { display: flex; }
  .modal { background: var(--bg); border: 1px solid var(--border); border-radius: 12px; width: 90vw; max-width: 900px; height: 85vh; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
  .modal-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
  .modal-header h3 { font-size: 15px; color: var(--text-bright); }
  .modal-close { background: none; border: none; color: var(--text-dim); font-size: 14px; cursor: pointer; padding: 2px 6px; border-radius: 4px; line-height: 1; }
  .modal-close:hover { color: var(--text); background: var(--surface2); }
  .modal-body { flex: 1; overflow-y: auto; padding: 20px; }
  .modal-body pre { font-family: 'SF Mono', 'Fira Code', monospace; font-size: 12px; color: var(--text); line-height: 1.5; white-space: pre-wrap; }

  /* ── Legend ───────────────────────────────────────── */
  .legend { grid-column: 1/-1; display: flex; align-items: center; gap: 16px; padding: 9px 20px; border-top: 1px solid var(--border); background: var(--surface); flex-wrap: wrap; }
  .legend-item { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text-dim); }
  .legend-dot { width: 10px; height: 10px; border-radius: 3px; }
  .legend-sep { width: 1px; height: 16px; background: var(--border); }
  .legend-stat { font-family: 'SF Mono', 'Fira Code', monospace; font-size: 11px; color: var(--text-dim); }
  .legend-stat strong { color: var(--text); font-weight: 600; }

  /* ── Monitor mode ─────────────────────────────────── */
  .monitor-wrap { padding: 24px 32px; overflow-y: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 24px; align-content: start; min-height: 100%; }
  .monitor-left { display: flex; flex-direction: column; gap: 20px; }
  .monitor-right { display: flex; flex-direction: column; gap: 20px; }

  /* Form */
  .webhook-form { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 20px; }
  .webhook-form h3 { font-size: 13px; font-weight: 700; color: var(--text-bright); margin: -20px -20px 14px -20px; padding: 20px 20px 12px 20px; border-bottom: 1px solid var(--border); text-transform: uppercase; letter-spacing: 0.8px; }
  .form-row { margin-bottom: 12px; }
  .form-label { display: block; font-size: 11px; font-weight: 600; color: var(--text-dim); margin-bottom: 4px; }
  .form-required::after { content: ' *'; color: var(--red); }
  .form-input, .form-textarea { width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 8px 10px; font-size: 12px; color: var(--text); font-family: inherit; }
  .form-input:focus, .form-textarea:focus { outline: none; border-color: var(--blue); }
  .form-textarea { min-height: 50px; resize: vertical; }
  .form-hint { font-size: 10px; color: var(--text-dim); margin-top: 2px; font-style: italic; }
  .form-row-checkbox { flex-direction: row; align-items: flex-start; }
  .form-checkbox-label { font-size: 11px; color: var(--text); display: flex; align-items: center; gap: 6px; cursor: pointer; }
  .form-checkbox-label input[type="checkbox"] { accent-color: var(--blue); cursor: pointer; }
  .form-actions { display: flex; gap: 8px; align-items: center; margin-top: 16px; flex-wrap: wrap; }
  .btn-run { background: var(--green); color: #fff; border: none; padding: 8px 20px; border-radius: 6px; font-size: 12px; font-weight: 700; cursor: pointer; transition: all 0.15s; }
  .btn-run:hover { opacity: 0.85; }
  .btn-run:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn-preset, .btn-more { background: var(--surface2); border: 1px solid var(--border); color: var(--text-dim); padding: 6px 12px; border-radius: 6px; font-size: 11px; cursor: pointer; transition: all 0.15s; }
  .btn-preset:hover, .btn-more:hover { border-color: var(--blue); color: var(--text); }
  .sample-tag { display:none; font-size:9px; padding:2px 6px; border-radius:3px; background:rgba(210,153,34,0.15); color:var(--yellow); border:1px solid rgba(210,153,34,0.3); text-transform:uppercase; letter-spacing:0.5px; font-weight:700; margin-left:8px; vertical-align:middle; }
  .btn-preset.sample-active { border-color: #e74c3c; color: #e74c3c; }
  .btn-preset.sample-active:hover { border-color: #e74c3c; color: #e74c3c; opacity: 0.85; }
  .more-fields { display: none; }
  .more-fields.visible { display: block; }
  .batch-concurrency { display: flex; align-items: center; gap: 8px; margin-top: 10px; font-size: 11px; color: var(--text-dim); }
  .batch-concurrency select { background: var(--bg); border: 1px solid var(--border); border-radius: 4px; padding: 3px 6px; font-size: 11px; color: var(--text); font-family: inherit; }
  .batch-concurrency select:focus { outline: none; border-color: var(--blue); }
  .run-selector-row { display: flex; align-items: center; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); }
  .run-selector-row label { font-size: 11px; color: var(--text-dim); white-space: nowrap; }
  .run-selector { flex: 1; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 6px 8px; font-size: 11px; color: var(--text); font-family: inherit; }
  .run-selector:focus { outline: none; border-color: var(--blue); }

  /* Step tracker */
  .monitor-tracker { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 16px 20px; }
  .monitor-tracker.running { border-color: var(--blue); transition: border-color 0.6s ease-in-out; }
  .monitor-tracker.running.pulse-dim { border-color: var(--border); }
  .monitor-tracker h3 { font-size: 13px; font-weight: 700; color: var(--text-bright); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.8px; }
  .tracker-phase { margin-bottom: 10px; margin-top: 18px; }
  .tracker-phase:first-child { margin-top: 0; }
  .tracker-phase-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); margin-bottom: 6px; padding-bottom: 4px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
  .tracker-phase-dur { font-size: 9px; font-family: 'SF Mono', 'Fira Code', monospace; color: var(--text-dim); opacity: 0.7; font-weight: 400; }
  .tracker-total { display: flex; justify-content: space-between; align-items: center; padding: 8px 8px 4px; margin-top: 8px; border-top: 2px solid var(--border); font-size: 12px; font-weight: 700; color: var(--text-bright); }
  .tracker-step { display: flex; align-items: center; gap: 8px; padding: 5px 8px; border-radius: 6px; cursor: default; transition: background 0.1s; }
  .tracker-step:hover { background: rgba(255,255,255,0.02); }
  .tracker-step-id { font-size: 10px; font-family: 'SF Mono', 'Fira Code', monospace; font-weight: 700; color: var(--text-dim); min-width: 28px; }
  .tracker-step-name { font-size: 12px; color: var(--text); flex: 1; }
  .tracker-step-status { font-size: 12px; min-width: 20px; text-align: center; }
  .tracker-step-dur { font-size: 10px; font-family: 'SF Mono', 'Fira Code', monospace; color: var(--text-dim); min-width: 50px; text-align: right; }
  .tracker-header { display: flex; justify-content: space-between; align-items: center; margin: -16px -20px 8px -20px; padding: 16px 20px 10px 20px; border-bottom: 1px solid var(--border); }
  .tracker-header h3 { margin: 0; font-size: 13px; font-weight: 700; color: var(--text-bright); text-transform: uppercase; letter-spacing: 0.8px; }
  .tracker-controls { display: flex; gap: 4px; }
  .tracker-toggle { background: var(--surface2); border: 1px solid var(--border); color: var(--text-dim); padding: 3px 8px; border-radius: 4px; font-size: 10px; cursor: pointer; transition: all 0.15s; }
  .tracker-toggle:hover { border-color: var(--blue); color: var(--text); }
  .tracker-toggle.active { background: var(--blue); color: #fff; border-color: var(--blue); }
  .tracker-reset:hover { border-color: #e74c3c; color: #e74c3c; }
  .tracker-kill { color: var(--text-dim); }
  .tracker-kill:hover { background: #e74c3c; border-color: #e74c3c; color: #fff; }
  .tracker-kill.disabled { opacity: 0.3; pointer-events: none; }
  .tracker-output-wrap { position: relative; margin: 4px 0 8px 36px; }
  .tracker-output { background: var(--surface2); border: 1px solid var(--border); border-radius: 4px; padding: 8px 10px; font-size: 10px; font-family: 'SF Mono', 'Fira Code', monospace; color: var(--text-dim); max-height: 200px; overflow-y: auto; white-space: pre-wrap; word-break: break-word; }
  .tracker-output-copy { position: absolute; top: 4px; right: 4px; background: var(--surface); border: 1px solid var(--border); border-radius: 3px; padding: 2px 5px; font-size: 10px; color: var(--text-dim); cursor: pointer; opacity: 0; transition: opacity 0.15s; line-height: 1; }
  .tracker-output-wrap:hover .tracker-output-copy { opacity: 1; }
  .tracker-output-copy:hover { color: var(--text); border-color: var(--text-dim); }
  .tracker-substeps { padding-left: 36px; margin-top: 2px; }
  .tracker-substep { font-size: 10px; color: var(--text-dim); padding: 2px 0; display: flex; gap: 6px; }

  .st-pending { color: var(--text-dim); }
  .st-running { color: var(--blue); }
  .st-completed { color: var(--green); }
  .st-failed { color: var(--red); }
  .st-warning { color: var(--orange); }
  .st-running .tracker-step-status { opacity: 1; transition: opacity 0.6s ease-in-out; }
  .pulse-dim .st-running .tracker-step-status { opacity: 0.3; }

  /* Data viewer */
  .data-viewer { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; flex: 1; display: flex; flex-direction: column; min-height: 300px; margin-top: 20px; }
  .data-viewer-header { padding: 16px 20px 12px; margin: 0; border-bottom: 1px solid var(--border); }
  .data-export { margin-left: auto; }
  .data-export:hover { border-color: var(--green); color: var(--green); }
  .data-tab.active { background: var(--blue); color: #fff; border-color: var(--blue); }
  .data-panel { padding: 16px; overflow-y: auto; flex: 1; }
  .data-table { width: 100%; border-collapse: collapse; font-size: 11px; }
  .data-table th { text-align: left; font-weight: 700; color: var(--text-dim); padding: 6px 8px; border-bottom: 1px solid var(--border); text-transform: uppercase; font-size: 10px; letter-spacing: 0.5px; }
  .data-table td { padding: 6px 8px; border-bottom: 1px solid rgba(48,54,61,0.3); color: var(--text); }
  .data-table tr:hover td { background: rgba(255,255,255,0.02); }
  .data-kv { display: grid; grid-template-columns: 140px 1fr; gap: 6px 12px; font-size: 12px; }
  .data-kv dt { color: var(--text-dim); font-weight: 600; }
  .data-kv dd { color: var(--text); word-break: break-all; }
  .data-kv dd a { color: var(--blue); }
  .data-empty { color: var(--text-dim); font-size: 12px; font-style: italic; padding: 20px; text-align: center; }
  .report-preview { padding: 16px 20px; font-size: 13px; line-height: 1.7; color: var(--text); }
  .report-preview h1,.report-preview h2,.report-preview h3 { color: var(--text-bright); margin: 16px 0 8px; }
  .report-preview h1 { font-size: 18px; } .report-preview h2 { font-size: 15px; } .report-preview h3 { font-size: 13px; }
  .report-preview blockquote { border-left: 3px solid var(--blue); padding: 8px 12px; margin: 8px 0; background: rgba(88,166,255,0.05); border-radius: 0 4px 4px 0; }
  .report-preview ul { padding-left: 20px; margin: 8px 0; }
  .report-preview li { margin: 4px 0; }
  .report-preview hr { border: none; border-top: 1px solid var(--border); margin: 16px 0; }
  .report-preview strong { color: var(--text-bright); }
  .score-bars { margin: 8px 0 4px; }
  .score-bar-row { display: flex; align-items: center; gap: 8px; margin: 3px 0; font-size: 11px; }
  .score-bar-name { width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--text-dim); }
  .score-bar-track { flex: 1; height: 6px; background: var(--surface2); border-radius: 3px; overflow: hidden; }
  .score-bar-fill { height: 100%; border-radius: 3px; }
  .score-bar-val { width: 40px; text-align: right; font-family: 'SF Mono', monospace; color: var(--text-dim); font-size: 10px; }
  .monitor-msg { padding: 12px 16px; border-radius: 8px; font-size: 12px; margin-bottom: 12px; }
  .monitor-msg-error { background: rgba(248,81,73,0.1); border: 1px solid rgba(248,81,73,0.3); color: var(--red); }
  .monitor-msg-info { background: rgba(88,166,255,0.06); border: 1px solid rgba(88,166,255,0.15); color: var(--blue); }

  /* Batch panel */
  .batch-panel { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 16px 20px; display: none; }
  .batch-panel.visible { display: block; }
  .batch-header { display: flex; justify-content: space-between; align-items: center; margin: -16px -20px 12px -20px; padding: 16px 20px 10px 20px; border-bottom: 1px solid var(--border); }
  .batch-header h3 { font-size: 13px; font-weight: 700; color: var(--text-bright); text-transform: uppercase; letter-spacing: 0.8px; margin: 0; }
  .batch-summary { font-size: 11px; color: var(--text-dim); display: flex; gap: 10px; align-items: center; }
  .batch-summary .bs-count { font-family: 'SF Mono', 'Fira Code', monospace; }
  .batch-kill-all { background: transparent; border: 1px solid var(--red); color: var(--red); padding: 3px 10px; border-radius: 4px; font-size: 10px; font-weight: 600; cursor: pointer; transition: all 0.15s; }
  .batch-kill-all:hover { background: var(--red); color: #fff; }
  .batch-kill-all.disabled { opacity: 0.3; pointer-events: none; }
  .batch-table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 4px; }
  .batch-table th { text-align: left; font-weight: 700; color: var(--text-dim); padding: 5px 8px; border-bottom: 1px solid var(--border); text-transform: uppercase; font-size: 10px; letter-spacing: 0.5px; }
  .batch-table td { padding: 5px 8px; border-bottom: 1px solid rgba(48,54,61,0.3); color: var(--text); cursor: pointer; }
  .batch-table tr.batch-row:hover td { background: rgba(255,255,255,0.03); }
  .batch-table tr.batch-row.selected td { background: rgba(88,166,255,0.08); border-color: rgba(88,166,255,0.2); }
  .batch-status { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 9px; font-weight: 600; text-transform: uppercase; }
  .batch-status-completed { background: rgba(63,185,80,0.15); color: var(--green); }
  .batch-status-processing { background: rgba(88,166,255,0.15); color: var(--blue); }
  .batch-status-failed { background: rgba(248,81,73,0.15); color: var(--red); }
  .batch-status-queued { background: rgba(139,148,158,0.15); color: var(--text-dim); }
  .batch-status-pending { background: rgba(139,148,158,0.15); color: var(--text-dim); }
  .batch-status-cancelled { background: rgba(210,153,34,0.15); color: var(--orange); }
  .btn-csv { background: var(--surface2); border: 1px solid var(--border); color: var(--text-dim); padding: 6px 12px; border-radius: 6px; font-size: 11px; cursor: pointer; transition: all 0.15s; }
  .btn-csv:hover { border-color: var(--cyan); color: var(--cyan); }
  .btn-csv:disabled { opacity: 0.4; cursor: not-allowed; }

  /* ── "How It Runs" modal ──────────────────────────────── */
  .orch-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; display: flex; align-items: center; justify-content: center; }
  .orch-modal { background: var(--bg); border: 1px solid var(--border); border-radius: 12px; width: 640px; max-height: 80vh; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0,0,0,0.5); }
  .orch-modal-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid var(--border); }
  .orch-modal-title { font-size: 14px; font-weight: 700; color: var(--text-bright); }
  .orch-modal-close { background: none; border: none; color: var(--text-dim); font-size: 14px; cursor: pointer; padding: 2px 6px; border-radius: 4px; line-height: 1; }
  .orch-modal-close:hover { color: var(--text); background: var(--surface2); }
  .orch-modal-body { padding: 20px; overflow-y: auto; flex: 1; }
  .orch-section { margin-bottom: 20px; }
  .orch-section:last-child { margin-bottom: 0; }
  .orch-section-heading { font-size: 11px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
  .orch-rule { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 14px 16px; margin-bottom: 8px; }
  .orch-rule:last-child { margin-bottom: 0; }
  .orch-rule-label { font-size: 12px; font-weight: 700; color: var(--text-bright); margin-bottom: 4px; }
  .orch-rule-pattern { font-size: 11px; font-weight: 600; color: var(--blue); font-family: 'SF Mono', monospace; margin-bottom: 6px; }
  .orch-rule-detail { font-size: 11px; color: var(--text-dim); line-height: 1.5; }
  .orch-pool-table { width: 100%; font-size: 11px; border-collapse: collapse; }
  .orch-pool-table th { text-align: left; padding: 6px 10px; border-bottom: 1px solid var(--border); color: var(--text-dim); font-weight: 600; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
  .orch-pool-table td { padding: 6px 10px; border-bottom: 1px solid var(--border); color: var(--text); }
  .orch-pool-table td:first-child { font-weight: 600; color: var(--text-bright); }
  .orch-pool-table code { font-family: 'SF Mono', monospace; font-size: 11px; color: var(--blue); }


  /* ── Diagram canvas (SVG layer) ────────────────────── */
  .diagram-canvas { transform-origin: 0 0; transition: transform 0.15s ease; }
  .diagram-svg { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 1; }
  .diagram-nodes { position: absolute; top: 0; left: 0; z-index: 2; }

  /* ── Diagram nodes ─────────────────────────────────── */
  .dnode { position: absolute; width: 160px; padding: 10px 12px; border-radius: 10px; border: 2px solid var(--border); background: var(--surface); cursor: pointer; transition: border-color 0.2s, box-shadow 0.2s; user-select: none; }
  .dnode:hover { border-color: var(--blue); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
  .dnode.dnode-selected { border-color: var(--blue); box-shadow: 0 0 0 3px rgba(88,166,255,0.25), 0 0 20px rgba(88,166,255,0.3), 0 0 40px rgba(88,166,255,0.1); }
  .dnode.dnode-dimmed { opacity: 0.15; pointer-events: none; }
  .dnode-num { font-size: 9px; font-weight: 700; color: var(--text-dim); margin-bottom: 3px; display: flex; align-items: center; gap: 5px; }
  .dnode-name { font-size: 11px; font-weight: 600; color: var(--text-bright); line-height: 1.3; }
  .dnode-meta { font-size: 10px; color: var(--text-dim); margin-top: 3px; line-height: 1.3; }
  .dnode .step-badge { font-size: 8px; padding: 0px 5px; }

  /* Per-type diagram node borders */
  .dnode-llm { border-color: var(--llm-border); }
  .dnode-llm:hover { border-color: var(--purple); }
  .dnode-template { border-color: var(--template-border); }
  .dnode-template:hover { border-color: var(--template-border); }
  .dnode-sqlite { border-color: var(--sqlite-border); }
  .dnode-sqlite:hover { border-color: var(--yellow); }
  .dnode-api { border-color: var(--cyan); }
  .dnode-api:hover { border-color: var(--cyan); }
  .dnode-python { border-color: var(--logic-border); }
  .dnode-python:hover { border-color: var(--orange); }
  .dnode-tool { border-color: var(--cyan); }
  .dnode-tool:hover { border-color: var(--cyan); }
  .dnode-logic { border-color: var(--logic-border); }
  .dnode-logic:hover { border-color: var(--orange); }
  .dnode-validate { border-color: var(--validate-border); }
  .dnode-validate:hover { border-color: var(--red); }
  .dnode-source { border-color: var(--text-dim); }
  .dnode-source:hover { border-color: var(--text-bright); }

  /* ── Parallel/sequential group indicators ──────────── */
  .dgroup-parallel { position: absolute; border: 2px dashed var(--text-dim); border-radius: 14px; pointer-events: none; z-index: 0; }
  .dgroup-parallel-label { position: absolute; top: -10px; left: 20px; font-size: 9px; font-weight: 700; letter-spacing: 1px; color: var(--text-dim); background: var(--bg); padding: 0 8px; }
  .dgroup-sequential { position: absolute; border: 2px dotted var(--pink); border-radius: 10px; pointer-events: none; z-index: 0; }
  .dgroup-sequential-label { position: absolute; top: -10px; right: 20px; font-size: 9px; font-weight: 700; letter-spacing: 1px; color: var(--pink); background: var(--bg); padding: 0 8px; }

  /* ── Phase section backgrounds in diagram ──────────── */
  .dphase-section { position: absolute; border: 1px solid rgba(48,54,61,0.5); border-radius: 14px; background: rgba(22,27,34,0.3); pointer-events: none; }
  .dphase-section-label { position: absolute; top: -8px; left: 50%; transform: translateX(-50%); font-size: 9px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; color: var(--text-dim); background: var(--bg); padding: 0 10px; white-space: nowrap; border-bottom: 1px solid var(--border); padding-bottom: 2px; }
  .dphase-section.dphase-dimmed { opacity: 0.15; }

  /* ── Zoom controls ─────────────────────────────────── */
  .zoom-controls { display: none; position: fixed; top: 70px; left: 20px; z-index: 150; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 4px; gap: 2px; align-items: center; box-shadow: 0 4px 16px rgba(0,0,0,0.4); }
  .zoom-btn { background: var(--surface2); border: 1px solid var(--border); color: var(--text); width: 30px; height: 28px; border-radius: 4px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; transition: all 0.1s; }
  .zoom-btn:hover { border-color: var(--blue); color: var(--blue); }
  .zoom-level { font-size: 11px; color: var(--text-dim); padding: 0 8px; min-width: 44px; text-align: center; }

  /* ── Floating detail panel ─────────────────────────── */
  .diagram-detail-float { display: none; position: fixed; top: 80px; right: 24px; width: 440px; max-height: calc(100vh - 200px); overflow-y: auto; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 20px 24px; z-index: 100; box-shadow: 0 8px 32px rgba(0,0,0,0.5); }
  .diagram-detail-float.visible { display: block; }
  .diagram-detail-float .detail-close { position: absolute; top: 10px; right: 14px; background: none; border: none; color: var(--text-dim); font-size: 18px; cursor: pointer; padding: 4px 8px; border-radius: 4px; }
  .diagram-detail-float .detail-close:hover { background: var(--surface2); color: var(--text); }

  /* ── Edge tooltip ──────────────────────────────────── */
  .edge-tooltip { display: none; position: fixed; z-index: 200; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 10px 14px; font-size: 11px; pointer-events: none; max-width: 280px; box-shadow: 0 4px 16px rgba(0,0,0,0.4); }

  /* ── Edge highlight on hover ───────────────────────── */
  .edge-highlighted { background: rgba(88,166,255,0.08); border-radius: 6px; }

  /* ── Validation loop indicators ────────────────────── */
  .validation-loop-badge { font-size: 9px; font-weight: 700; color: #ff69b4; background: rgba(255,105,180,0.12); padding: 1px 6px; border-radius: 4px; letter-spacing: 0.3px; }
  .validation-loop-row { border-left: 2px dotted rgba(255,105,180,0.4); padding-left: 10px; }

  /* ── Editable prompt ───────────────────────────────── */
  .prompt-block .editable { outline: none; min-height: 100px; }
  .prompt-block .editable:focus { border-color: var(--blue); }
  .edit-hint { font-size: 11px; color: var(--text-dim); font-style: italic; margin-bottom: 8px; }

  /* ── Scrollbar ─────────────────────────────────────── */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* ── Config modal ────────────────────────────────── */
  .config-overlay { display:flex; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:1000; justify-content:center; align-items:center; }
  .config-panel { background:var(--bg); border:1px solid var(--border); border-radius:12px; width:560px; max-height:85vh; display:flex; flex-direction:column; box-shadow:0 20px 60px rgba(0,0,0,0.5); }
  .config-panel-header { display:flex; align-items:center; justify-content:space-between; padding:16px 20px; border-bottom:1px solid var(--border); flex-shrink:0; }
  .config-panel-header h3 { font-size:15px; color:var(--text-bright); margin:0; display:flex; align-items:center; gap:8px; }
  .config-panel-close { background:none; border:none; color:var(--text-dim); font-size:14px; cursor:pointer; padding:2px 6px; border-radius:4px; line-height:1; }
  .config-panel-close:hover { color:var(--text); background:var(--surface2); }
  .config-filter { margin:10px 20px; padding:6px 10px; background:var(--surface); border:1px solid var(--border); border-radius:6px; color:var(--text); font-size:12px; font-family:inherit; outline:none; width:calc(100% - 40px); }
  .config-filter::placeholder { color:var(--text-dim); }
  .config-filter:focus { border-color:var(--blue); }
  .config-panel-body { flex:1; overflow-y:auto; padding:0 20px 20px; }
  .config-cat { margin-bottom:12px; }
  .config-cat-header { display:flex; align-items:center; gap:6px; padding:6px 0; cursor:pointer; font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:0.8px; color:var(--text-dim); user-select:none; }
  .config-cat-header:hover { color:var(--text); }
  .config-cat-arrow { font-size:9px; transition:transform 0.15s; display:inline-block; }
  .config-cat.collapsed .config-cat-arrow { transform:rotate(-90deg); }
  .config-cat.collapsed .config-cat-items { display:none; }
  .config-cat-items { padding-left:2px; }
  .config-row { display:flex; justify-content:space-between; align-items:baseline; padding:3px 6px; border-radius:4px; gap:8px; }
  .config-row:hover { background:var(--surface2); }
  .config-row-key { font-size:11px; font-family:'SF Mono','Fira Code',monospace; color:var(--text-dim); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex-shrink:1; min-width:0; }
  .config-row-val { font-size:11px; font-family:'SF Mono','Fira Code',monospace; color:var(--text-bright); white-space:nowrap; text-align:right; flex-shrink:0; max-width:160px; overflow:hidden; text-overflow:ellipsis; cursor:pointer; border-radius:3px; padding:1px 4px; }
  .config-row-val:hover { background:var(--bg); }
  .config-row-val.editing { background:var(--bg); border:1px solid var(--blue); outline:none; cursor:text; overflow:visible; color:var(--text-bright); }
  .config-timeout-grid { display:grid; grid-template-columns:1fr 1fr; gap:2px 12px; padding-left:6px; }
  .config-timeout-item { display:flex; justify-content:space-between; gap:6px; padding:2px 0; }
  .config-timeout-key { font-size:11px; font-family:'SF Mono','Fira Code',monospace; color:var(--text-dim); }
  .config-timeout-val { font-size:11px; font-family:'SF Mono','Fira Code',monospace; color:var(--text-bright); cursor:pointer; border-radius:3px; padding:1px 4px; }
  .config-timeout-val:hover { background:var(--bg); }
  .config-timeout-val.editing { background:var(--bg); border:1px solid var(--blue); outline:none; cursor:text; overflow:visible; }
  .config-offline { padding:24px; text-align:center; color:var(--text-dim); font-size:12px; line-height:1.6; }
  .config-offline code { background:var(--bg); padding:2px 6px; border-radius:4px; font-size:11px; }
  .config-save-status { font-size:10px; padding:2px 8px; border-radius:4px; margin-left:8px; transition:opacity 0.3s; }
  .config-save-ok { color:var(--green); background:rgba(63,185,80,0.1); }
  .config-save-err { color:var(--red); background:rgba(248,81,73,0.1); }
  .config-ephemeral-note { font-size:10px; color:var(--text-dim); padding:4px 20px 8px; border-bottom:1px solid var(--border); opacity:0.7; }
  .config-reset-btn { background:none; border:1px solid var(--border); color:var(--text-dim); padding:3px 10px; border-radius:5px; font-size:10px; cursor:pointer; white-space:nowrap; }
  .config-reset-btn:hover { border-color:var(--red); color:var(--red); }

  /* ── Config chips in detail panel ──────────────────── */
  .config-chips { display:flex; flex-wrap:wrap; gap:4px; }
  .config-chip { display:inline-flex; align-items:center; gap:3px; padding:2px 7px; border-radius:4px; font-size:10px; font-family:'SF Mono','Fira Code',monospace; background:rgba(139,92,246,0.08); color:var(--purple); border:1px solid rgba(139,92,246,0.2); }
  .config-chip-icon { font-size:9px; opacity:0.7; }
</style>
</head>
<body>

<div class="app" id="app">

  <div class="header">
    <div style="display:flex;align-items:center;gap:12px">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 2086 292" fill="none" style="height:22px;flex-shrink:0"><g clip-path="url(#sbclip)"><path fill-rule="evenodd" clip-rule="evenodd" d="M362.341 21.9632L351.84 68.0405C351.234 70.6959 349.94 73.0675 348.158 74.9683C313.776 54.7186 273.733 43.0949 231.033 43.0949C103.435 43.0949 0 146.89 0 274.488H10.4287C10.4287 189.293 80.1861 119.699 165.252 119.699C250.317 119.699 319.839 189.422 319.839 274.488H462.501C462.501 225.862 447.416 180.693 421.682 143.408C423.606 142.031 425.866 141.1 428.312 140.754L480.307 133.398C507.141 129.601 507.174 90.8592 480.346 87.018L428.285 79.5638C422.133 78.6829 417.16 74.1017 415.778 68.0422L405.268 21.9599C400.061 -0.867586 367.543 -0.864591 362.341 21.9632ZM408.045 127.995C412.757 124.178 418.461 121.551 424.699 120.535C424.944 120.496 425.189 120.458 425.436 120.423L477.431 113.067C480.742 112.599 480.746 107.818 477.436 107.344L425.375 99.8897C425.153 99.8579 424.932 99.8241 424.711 99.7883C410.45 97.4725 398.981 86.7375 395.758 72.6079L385.249 26.5256C384.898 24.9899 382.711 24.9901 382.361 26.5258L371.859 72.6031C370.707 77.6601 368.498 82.2825 365.483 86.2399C360.073 93.3405 352.067 98.3002 342.909 99.7882C342.688 99.8243 342.465 99.8583 342.242 99.8902L290.185 107.344C286.874 107.818 286.878 112.599 290.19 113.067L342.181 120.423C342.429 120.458 342.675 120.495 342.921 120.535C357.18 122.858 368.646 133.599 371.861 147.734L382.36 193.904C382.71 195.441 384.899 195.441 385.249 193.904L385.406 193.212L395.757 147.73C397.566 139.779 401.986 132.903 408.045 127.995Z" fill="white"/></g><path fill-rule="evenodd" clip-rule="evenodd" d="M1515.95 13.4082C1502.4 13.4082 1492.44 23.3643 1492.44 35.8094C1492.44 48.8076 1502.4 58.2106 1515.95 58.2106C1529.5 58.2106 1539.46 48.8076 1539.46 35.8094C1539.46 23.3643 1529.22 13.4082 1515.95 13.4082ZM1497.14 226.911H1534.76V78.1228H1497.14V226.911ZM1681.74 19.2159H1719.62V226.911H1681.74V205.893C1671.78 222.209 1654.08 230.783 1633.34 230.783C1591.85 230.783 1560.88 196.49 1560.88 152.517C1560.33 109.097 1592.13 73.4213 1633.34 74.251C1654.08 74.251 1671.78 82.5477 1681.74 98.8646V19.2159ZM1681.74 152.517C1681.74 125.138 1664.04 107.161 1639.42 107.161C1626.98 107.161 1616.74 111.586 1608.72 120.16C1600.98 128.733 1597.11 139.519 1597.11 152.517C1597.11 178.237 1614.25 197.872 1639.42 197.872C1664.04 197.872 1681.74 179.896 1681.74 152.517ZM1903.99 78.1228H1866.1V96.9287C1856.14 82.2711 1838.72 74.251 1817.7 74.251C1776.22 74.251 1745.24 106.055 1745.24 148.369C1744.69 189.576 1776.5 223.316 1817.7 222.486C1838.44 222.486 1856.14 214.466 1866.1 199.808V212.807C1866.1 241.845 1850.06 257.332 1821.57 257.332C1803.6 257.332 1788.94 249.589 1780.92 237.42L1751.6 255.673C1765.16 275.585 1790.6 289.413 1821.57 289.413C1868.31 289.413 1903.99 261.757 1903.99 212.807V78.1228ZM1823.79 106.885C1848.95 106.885 1866.1 123.202 1866.1 148.369C1866.1 173.535 1848.95 189.576 1823.79 189.576C1798.62 189.576 1781.47 172.429 1781.47 148.369C1781.47 124.308 1798.62 106.885 1823.79 106.885ZM1966.39 165.515H2082.82C2082.86 164.671 2082.9 163.841 2082.93 163.026C2083.17 157.701 2083.38 152.999 2083.38 148.922C2083.38 104.949 2050.74 74.251 2006.49 74.251C1962.52 74.251 1929.61 107.991 1929.61 152.517C1929.61 197.043 1963.35 230.783 2011.19 230.783C2039.96 230.783 2065.95 217.785 2078.95 198.149L2049.91 179.896C2042.44 191.235 2027.51 198.425 2011.19 198.425C1988.24 198.425 1971.09 186.81 1966.39 165.515ZM2047.15 138.966H1966.39C1970.82 117.947 1986.86 105.779 2006.77 105.779C2029.72 105.779 2045.21 119.053 2047.15 138.966ZM1475.47 77.8462V112.416C1470.21 111.033 1464.13 110.204 1457.77 110.204C1433.43 110.204 1416.56 127.627 1416.56 151.964V226.911H1378.95V78.1228H1416.56V103.013C1424.03 86.4195 1439.79 75.3572 1458.6 75.3572C1465.51 75.3572 1471.04 76.1869 1475.47 77.8462ZM1280.59 230.783C1322.08 231.336 1353.88 195.936 1353.05 152.517C1353.88 109.097 1322.08 73.4213 1280.59 74.251C1259.85 74.251 1242.15 82.8243 1232.19 99.1412V19.2159H1194.58V226.911H1232.19V205.616C1242.15 221.933 1259.57 230.783 1280.59 230.783ZM1305.21 120.16C1313.23 128.733 1317.1 139.519 1317.1 152.517C1317.1 178.237 1299.67 197.872 1274.51 197.872C1249.89 197.872 1232.47 179.896 1232.47 152.517C1232.47 125.138 1249.89 107.161 1274.51 107.161C1286.95 107.161 1297.19 111.586 1305.21 120.16ZM1172.91 77.8462V112.416C1167.65 111.033 1161.57 110.204 1155.21 110.204C1130.87 110.204 1114 127.627 1114 151.964V226.911H1076.39V78.1228H1114V103.013C1121.47 86.4195 1137.23 75.3572 1156.04 75.3572C1162.95 75.3572 1168.48 76.1869 1172.91 77.8462ZM1043.3 78.1228H1005.41V98.8646C995.454 82.5477 977.755 74.251 957.013 74.251C915.806 73.4213 884.001 109.097 884.555 152.517C884.555 196.49 915.529 230.783 957.013 230.783C977.755 230.783 995.454 222.209 1005.41 205.893V226.911H1043.3V78.1228ZM963.097 107.161C987.711 107.161 1005.41 125.138 1005.41 152.517C1005.41 179.896 987.711 197.872 963.097 197.872C937.93 197.872 920.784 178.237 920.784 152.517C920.784 139.519 924.655 128.733 932.399 120.16C940.419 111.586 950.652 107.161 963.097 107.161ZM863.465 191.512L871.762 221.656C863.188 227.188 848.807 230.783 835.256 230.783C798.474 230.783 779.115 209.764 779.115 168.834V111.033H747.31V78.1227H779.115V38.5749H816.726V78.1227H866.23V111.033H816.726V168.557C816.726 187.363 824.747 197.319 840.234 197.319C848.531 197.319 856.274 195.383 863.465 191.512ZM624.689 179.343L596.204 195.66C602.012 205.339 611.138 213.36 623.86 220.274C636.581 227.188 650.962 230.783 667.279 230.783C707.104 230.783 736.695 212.253 736.695 184.044C736.695 161.643 721.485 148.092 690.234 141.178L668.386 136.2C645.431 130.945 639.347 127.35 639.347 118.777C639.347 109.927 651.239 104.119 667.832 104.119C684.149 104.119 699.913 111.863 706.827 122.649L735.036 106.608C729.505 97.4818 720.655 90.0148 708.763 83.6539C696.871 77.2931 683.32 74.251 668.662 74.251C630.774 74.251 603.671 92.7804 603.671 120.989C603.671 143.114 618.882 156.389 650.133 163.303L671.981 168.281C694.935 173.535 701.019 177.131 701.019 185.98C701.019 194.83 686.915 200.638 668.109 200.638C648.473 200.638 632.433 191.512 624.689 179.343Z" fill="white"/><defs><clipPath id="sbclip"><rect width="504" height="274.615" fill="white"/></clipPath></defs></svg>
      <h1>Intel Brief<span style="font-size:10px;font-weight:700;letter-spacing:1px;background:var(--purple);color:var(--bg);padding:2px 8px;border-radius:4px;margin-left:10px">V2</span></h1>
    </div>
    <div class="controls">
      <span style="font-size:12px;color:var(--text-dim)">18 Steps &middot; 7 Phases</span>
      <select class="highlight-select" id="highlightSelect" onchange="focusPhase(this.value)">
        <option value="all" selected>Highlight: All</option>
        <option value="discover">Highlight: Discovery</option>
        <option value="generate">Highlight: Generation</option>
      </select>
      <select class="highlight-select" id="viewSelect" onchange="setView(this.value)">
        <option value="list" selected>View: List</option>
        <option value="diagram">View: Diagram</option>
        <option value="monitor">View: Monitor</option>
      </select>
      <button class="utility-btn" onclick="toggleOrchModal()">Details</button>
      <button class="utility-btn" onclick="toggleConfigPanel()" id="btnConfig" title="Pipeline Config">&#9881;</button>
    </div>
  </div>

  <div class="pipeline" id="pipeline"></div>
  <div class="detail" id="detail"><div class="detail-empty">Click a step to see details</div></div>

  <div class="diagram-wrap" id="diagramWrap">
    <div class="monitor-wrap" id="monitorWrap" style="display:none"></div>
    <div class="diagram-canvas" id="diagramCanvas" style="display:none">
      <svg class="diagram-svg" id="diagramSvg"></svg>
      <div class="diagram-nodes" id="diagramNodes"></div>
    </div>
    <div class="diagram-detail-float" id="diagramDetail"></div>
  </div>

  <div class="legend">
    <div class="legend-item"><div class="legend-dot" style="background:var(--purple)"></div>LLM (Claude CLI)</div>
    <div class="legend-item"><div class="legend-dot" style="background:var(--cyan)"></div>API (Starbridge/Notion)</div>
    <div class="legend-item"><div class="legend-dot" style="background:var(--template-border)"></div>Template</div>
    <div class="legend-item"><div class="legend-dot" style="background:var(--orange)"></div>Python Logic</div>
    <div class="legend-item"><div class="legend-dot" style="background:var(--sqlite-border)"></div>SQLite</div>
    <div class="legend-sep"></div>
    <div class="legend-stat"><strong>5</strong> LLM calls</div>
    <div class="legend-stat"><strong>~13</strong> API calls</div>
    <div class="legend-stat"><strong>3</strong> SQLite ops</div>
    <div class="legend-sep"></div>
    <div class="legend-stat">Target runtime: <strong>30-60s</strong></div>
    <div class="legend-stat" style="color:var(--red)">Strict mode: <strong>no fallbacks</strong></div>
  </div>

  <div class="prompt-output" id="promptOutputBar">
    <div class="resize-handle" id="promptResizeHandle"></div>
    <button class="minimize-btn" id="minimizeBtn" onclick="togglePromptBar()" title="Minimize">&#9662;</button>
    <div class="prompt-output-text" id="promptOutput">Select a step to see its full markdown spec.</div>
    <div class="prompt-output-actions">
      <button class="view-all-btn" onclick="showAllMarkdown()">View All Steps</button>
      <button class="copy-btn" id="copyBtn" onclick="copyPrompt()">Copy Step</button>
      <button class="key-toggle-btn active" id="keyToggleBtn" onclick="toggleLegend()" title="Toggle key">&#128273;</button>
    </div>
  </div>

  <div class="modal-overlay" id="mdModalOverlay" onclick="if(event.target===this)hideAllMarkdown()">
    <div class="modal">
      <div class="modal-header">
        <h3>Full Pipeline Markdown</h3>
        <div style="display:flex;gap:8px">
          <button class="copy-btn" id="copyAllBtn" onclick="copyAllMarkdown()">Copy All Steps</button>
          <button class="modal-close" onclick="hideAllMarkdown()">&times;</button>
        </div>
      </div>
      <div class="modal-body"><pre id="mdModalContent"></pre></div>
    </div>
  </div>

  <div class="zoom-controls" id="zoomControls">
    <button class="zoom-btn" onclick="zoomDiagram(-0.1)" title="Zoom out">&#8722;</button>
    <span class="zoom-level" id="zoomLevel">100%</span>
    <button class="zoom-btn" onclick="zoomDiagram(0.1)" title="Zoom in">+</button>
    <button class="zoom-btn" onclick="zoomDiagram(0)" title="Fit to view" style="font-size:12px">Fit</button>
  </div>

  <div id="edgeTooltip" class="edge-tooltip"></div>

</div>

<script>
// =======================================================
// STATE
// =======================================================

var state = {
  selectedStep: null,
  focusPhase: 'all',
  editedPrompts: {},
  view: 'list',
  zoom: 1,
  promptMinimized: false,
  highlightedEdge: null,
  config: null
};

// =======================================================
// STEPS — Production pipeline (18 steps, 7 phases)
// =======================================================

var STEPS = [

  // --- Phase I: SOURCE ---
  { id:'s0', num:'0', phase:'source', name:'Parse Webhook', type:'python',
    meta:'Extract + validate 7 webhook fields — pure Python, no external calls',
    conditionalRun:{ type:'stop', rule:'STOPS if no target_domain AND no target_company' },
    inputs:[], outputs:['target_company','target_domain','product_description','campaign_id','prospect_name','prospect_email','tier'],
    tools:[], module:'pipeline.py', fn:'s0_parse_webhook', timeout:null, service:null,
    prompt:null,
    detail:'Extracts the 7 webhook fields from the incoming Clay webhook payload. First step — no external calls, pure Python. At least one of target_company or target_domain must be non-empty. No format validation — domain format is checked in s1 (warning only).',
    qualityRules:[
      'At least one of target_company or target_domain must be non-empty'
    ],
    edgeCases:[
      { label:'target_domain looks like email or invalid format', action:'s0 passes through as-is with no validation. s1 logs a warning if format is suspect but does not modify the value.', severity:'degrade' },
      { label:'Both target_company and target_domain missing', action:'Raise ValueError — pipeline stops immediately.', severity:'stop' }
    ],
    outputSchema:{
      'target_company':'string','target_domain':'string (validated)','product_description':'string',
      'campaign_id':'string','prospect_name':'string','prospect_email':'string',
      'tier':'string (optional)'
    }
  },

  // --- Phase II: INPUT ---
  { id:'s1', num:'1', phase:'input', name:'Validate + Load + DB Stub', type:'sqlite',
    meta:'Validate domain, init SQLite, create run stub, load prior runs for same domain',
    conditionalRun:{ type:'stop', rule:'STOPS if SQLite init fails — no state preservation possible' },
    inputs:['target_company','target_domain','product_description','campaign_id','prospect_name','prospect_email','tier'],
    outputs:['DB_RUN_ID','PRIOR_RUNS'],
    tools:['sqlite_init','sqlite_insert','sqlite_select'], module:'pipeline.py + db.py', fn:'s1_validate_and_load', timeout:null, service:'SQLite',
    configKeys:['ENABLE_PRIOR_RUN_DEDUP'],
    prompt:null,
    detail:'Validates domain format, initializes SQLite DB (creates tables if they don\'t exist), and creates a run stub at status=\'processing\'. Run stub exists from this point forward — all subsequent steps have a run_id so partial state can be recovered even if a later step crashes.\n\nLoads prior runs (LIMIT 5, most recent first) for the same target_domain. Prior run data (search_strategy, featured_buyer_name, secondary_buyers) flows to s2 so the LLM can diversify its strategy on repeat runs.\n\nEvery step uses a StepTimer context manager that logs timing + status to the audit_log table.',
    qualityRules:[
      'Run stub must be created before any API or LLM call — enables partial state recovery from s1 onward',
      'PRIOR_RUNS must include search_strategy, featured_buyer_name, and secondary_buyers so s2 can diversify'
    ],
    edgeCases:[
      { label:'SQLite init fails', action:'Hard fail — pipeline cannot preserve state. Operator must check DB path and permissions.', severity:'stop' },
      { label:'Prior runs exist for same target_domain', action:'Loaded in PRIOR_RUNS. Full run data (strategy, buyers) passed to s2, which diversifies keywords and buyer selections.', severity:'skip' }
    ],
    outputSchema:{
      'DB_RUN_ID':'integer — auto-increment ID from INSERT INTO runs (status=\'processing\')',
      'PRIOR_RUNS':'[{ id, target_domain, target_company, search_strategy, featured_buyer_name, secondary_buyers, status, created_at, ... }] — SELECT * returns all run columns (snake_case). s2 extracts strategy + buyer names from completed runs to diversify.'
    }
  },

  // --- Phase III: ANALYZE ---
  { id:'s2', num:'2', phase:'analyze', name:'LLM: Search Strategy', type:'llm',
    meta:'SLED procurement analyst sub-agent — buyer segments, keywords, opportunity types',
    conditionalRun:{ type:'always' },
    inputs:['target_company','target_domain','product_description','PRIOR_RUNS'],
    outputs:['SEARCH_STRATEGY'],
    tools:['claude_cli'], module:'pipeline.py → llm.py', fn:'s2_search_strategy() → llm.search_strategy()', timeout:'300s (CLI subprocess)', service:'Claude CLI (configurable via LLM_MODEL)',
    configKeys:['LLM_MODEL','LLM_MAX_OUTPUT_TOKENS'],
    prompt:'You are a SLED (State, Local, Education, District) procurement intelligence analyst.\n\nAnalyze this vendor/product and determine which SLED buyer segments and search keywords would surface relevant procurement signals — active contracts, RFPs, board discussions, budget allocations — where this product could be a fit.\n\nReturn ONLY a JSON object with these exact keys:\n{\n  "sled_segments": ["HigherEducation", ...],\n  "primary_keywords": ["keyword1", "keyword2", "keyword3"],\n  "alternate_keywords": ["keyword4", "keyword5"],\n  "meeting_keywords": ["phrase1", "phrase2", ...],\n  "rfp_keywords": ["term1", "term2", ...],\n  "buyer_types": ["HigherEducation", "SchoolDistrict"],\n  "opportunity_types": ["Meeting", "Purchase", "RFP", "Contract"],\n  "geographic_hints": ["California", ...] or [],\n  "ideal_buyer_profile": "1-sentence description"\n}\n\nValid buyer_types: HigherEducation, SchoolDistrict, School, City, County, StateAgency, PoliceDepartment, FireDepartment, Library, SpecialDistrict\n\nValid opportunity_types: Meeting, Purchase, RFP, Contract\nYou MUST return opportunity_types — this controls which procurement signals are searched.\nSelect the types most relevant to this product — include all 4 if broadly applicable, or narrow to 2-3 if the product targets specific procurement channels.\n\nKEYWORD GUIDELINES:\n\nprimary_keywords (3-5): Most likely to match procurement signals overall. Should be procurement-relevant: \'career services technology\' not just \'career\'.\n\nalternate_keywords (2-3): Broader terms for fallback searches.\n\nmeeting_keywords (up to 8): Action-oriented phrases matching board meeting agenda language — focus on PRE-procurement signals: problem identification, solution exploration, and planning activities. Use language like \'discussed challenges in [X]\', \'explored options for [Y]\', \'requested analysis of [Z]\'. Include specific service areas in the phrases. AVOID late-stage procurement language (approved contract, awarded vendor). These surface early buying intent before an RFP is issued.\n\nrfp_keywords (up to 8): Terms that appear in RFP/procurement documents — both specific product categories and general service descriptions. Include both specific and general variations. Focus on terms a procurement officer would use, not marketing language.\n\nIf PRIOR RUNS are provided, you MUST diversify — use different keyword angles, target different buyer segments, or shift geographic focus. Do NOT repeat the same primary_keywords or buyer_types from prior runs unless no alternatives exist.',
    contentTemplate:'Company: {target_company}\nDomain: {target_domain}\nProduct Description: {product_description}\n\n[if prior_runs contains any with status == "completed":]\n--- PRIOR RUNS FOR THIS DOMAIN ---\nDiversify your strategy — avoid repeating the same keywords and buyer selections.\n\nRun {i+1} ({created_at or "?"}):\n  Strategy: {search_strategy[:500]}       ← only if search_strategy is non-empty\n  Featured: {featured_buyer_name}          ← only if featured_buyer_name is non-empty\n  Secondary: {secondary_buyers[:300]}      ← only if secondary_buyers is non-empty\n\n[repeats for each completed run — runs with status != "completed" are skipped entirely]',
    detail:'Calls _call_llm(system_prompt, content) → subprocess `claude -p` with 300s timeout.\n\nContent template is built from target_company, target_domain, product_description. If PRIOR_RUNS contains completed runs, each run\\\'s search_strategy (JSON, truncated to 500 chars), featured_buyer_name, and secondary_buyers (truncated to 300 chars) are appended. Failed/processing runs are filtered out.\n\nLLM response is parsed via _extract_json() (extracts first JSON object from raw text). Missing keys are backfilled with defaults:\n- primary_keywords → [target_company]\n- sled_segments → buyer_types (copied)\n- ideal_buyer_profile → product_description[:200]\n- All other list keys → []\n\nNo retry on parse failure — if _extract_json finds no JSON, the step fails.',
    qualityRules:[
      'Keywords must use SLED procurement language, not vendor marketing speak',
      'At least 1 SLED buyer_type must be identified',
      'Primary and alternate keywords must not significantly overlap',
      'If prior completed runs exist, strategy MUST diversify — different keywords, buyer types, or geographic focus vs. prior runs'
    ],
    edgeCases:[
      { label:'Product description too vague', action:'LLM infers from target_company + domain. No explicit confidence flag — quality depends on LLM judgment.', severity:'degrade' },
      { label:'LLM times out (>300s)', action:'Step fails. Pipeline crash handler saves partial state and marks run as failed.', severity:'fail' },
      { label:'Prior runs exist for same domain', action:'DIVERGE strategy — use different keyword angles, segments, or geographic focus.', severity:'skip' }
    ],
    outputSchema:{
      'SEARCH_STRATEGY':'{ primary_keywords: string[], alternate_keywords: string[], meeting_keywords: string[], rfp_keywords: string[], buyer_types: string[], opportunity_types: string[], geographic_hints: string[], ideal_buyer_profile: string, sled_segments: string[] (defaults to buyer_types) }'
    }
  },

  // --- Phase IV: DISCOVER (4 parallel) ---
  { id:'s3a', num:'3a', phase:'discover', name:'Primary Opp Search', type:'api', parallel:true,
    meta:'opportunity_search() — primary + meeting keywords + LLM-chosen opportunity types, pageSize=40',
    conditionalRun:{ type:'always' },
    inputs:['SEARCH_STRATEGY.primary_keywords','SEARCH_STRATEGY.meeting_keywords','SEARCH_STRATEGY.opportunity_types'],
    outputs:['DISCOVERY_SIGNALS_A'],
    tools:['opportunity_search'], module:'tools.py', fn:'opportunity_search()', timeout:'300s (Phase IV pool — shared by s3a/s3b/s3c/s3d via TIMEOUTS["s3a"])', service:'Starbridge API',
    configKeys:['TIMEOUTS.s3a','OPPORTUNITY_PAGE_SIZE','OPPORTUNITY_SORT_FIELD','MAX_WORKERS_DISCOVERY'],
    prompt:null,
    detail:'Searches Starbridge\'s 107M+ procurement records using primary keywords + meeting keywords (early buying intent phrases) and opportunity types. Results sorted by SearchRelevancy. Runs in parallel with s3b, s3c, and s3d via ThreadPoolExecutor.\n\nCall: opportunity_search(search_query=joined(primary_keywords + meeting_keywords), types=opportunity_types, page_size=40). sort_field defaults to \'SearchRelevancy\' in tools.py.\n\nTimeout: All 4 Phase IV futures share a single as_completed(timeout=TIMEOUTS["s3a"]=300s). There are no per-step timeouts — if any future exceeds 300s, the pool raises TimeoutError.',
    qualityRules:[],
    edgeCases:[
      { label:'0 results', action:'Returns empty list (valid response). s4 scoring proceeds with fewer signals. If all 3 searches return 0, s4 finds no buyers and pipeline errors.', severity:'degrade' },
      { label:'API timeout (>300s)', action:'Pipeline hard-fails. Crash handler persists partial state.', severity:'fail' }
    ],
    outputSchema:{ 'DISCOVERY_SIGNALS_A':'[{ buyerId, buyerName, title, summary, type, postedDate, dueDate, purchaseAmount }]' }
  },

  { id:'s3b', num:'3b', phase:'discover', name:'Alternate Opp Search', type:'api', parallel:true,
    meta:'opportunity_search() — alternate + RFP keywords for discovery breadth',
    conditionalRun:{ type:'skip', rule:'Skipped entirely if no alternate_keywords AND no rfp_keywords in SEARCH_STRATEGY' },
    inputs:['SEARCH_STRATEGY.alternate_keywords','SEARCH_STRATEGY.rfp_keywords','SEARCH_STRATEGY.opportunity_types'],
    outputs:['DISCOVERY_SIGNALS_B'],
    tools:['opportunity_search'], module:'tools.py', fn:'opportunity_search()', timeout:'300s (Phase IV pool — shared)', service:'Starbridge API',
    configKeys:['TIMEOUTS.s3b','OPPORTUNITY_PAGE_SIZE','OPPORTUNITY_SORT_FIELD'],
    prompt:null,
    detail:'Broader secondary search using alternate keywords + RFP/procurement terms to catch signals the primary search might miss. Same tool call structure as s3a but with alternate_keywords + rfp_keywords. Runs in parallel with s3a, s3c, and s3d.',
    qualityRules:[],
    edgeCases:[
      { label:'0 results', action:'Returns empty list (valid response). s4 scoring proceeds with s3a/s3c signals.', severity:'skip' },
      { label:'High overlap with s3a', action:'Expected if keywords are close. Deduplication in s4 handles this.', severity:'skip' }
    ],
    outputSchema:{ 'DISCOVERY_SIGNALS_B':'[{ buyerId, buyerName, title, summary, type, postedDate, dueDate, purchaseAmount }]' }
  },

  { id:'s3c', num:'3c', phase:'discover', name:'Buyer Type Search', type:'api', parallel:true,
    meta:'buyer_search() — buyer_types filter + ideal_buyer_profile keyword as name-contains query',
    conditionalRun:{ type:'skip', rule:'Skipped if no buyer_types in SEARCH_STRATEGY' },
    inputs:['SEARCH_STRATEGY.buyer_types','SEARCH_STRATEGY.ideal_buyer_profile'],
    outputs:['DISCOVERY_BUYERS_C'],
    tools:['buyer_search'], module:'tools.py', fn:'buyer_search()', timeout:'300s (Phase IV pool — shared)', service:'Starbridge API',
    configKeys:['TIMEOUTS.s3c','BUYER_SEARCH_PAGE_SIZE'],
    prompt:null,
    detail:'Buyer search filtered by buyer_types (e.g. SchoolDistrict, City) + a name-contains keyword extracted from ideal_buyer_profile. The first significant word (>3 chars, not a stop word) from the profile is passed as the query param. Long queries return 0 results (known API quirk), so only one word is used.\n\nSurfaces buyers by type that may not appear in opportunity results. Runs in parallel with s3a, s3b, and s3d. Results merged and deduplicated in s4.',
    qualityRules:[],
    edgeCases:[
      { label:'0 results', action:'Returns empty list (valid response). s4 scoring proceeds with buyers from s3a/s3b/s3d.', severity:'skip' },
      { label:'Long query string returns 0 results', action:'Truncate to first word of buyer_type. Known API quirk (documented in MEMORY.md).', severity:'degrade' }
    ],
    outputSchema:{ 'DISCOVERY_BUYERS_C':'[{ buyerId, name, stateCode, tags: string[], url }]' }
  },

  { id:'s3d', num:'3d', phase:'discover', name:'Buyer Geo Search', type:'api', parallel:true,
    meta:'buyer_search() — geographic_hints \u2192 state_codes filter only',
    conditionalRun:{ type:'skip', rule:'Skipped if no valid US state codes can be extracted from geographic_hints (empty list or all hints fail state-code lookup)' },
    inputs:['SEARCH_STRATEGY.geographic_hints'],
    outputs:['DISCOVERY_BUYERS_D'],
    tools:['buyer_search'], module:'tools.py', fn:'buyer_search()', timeout:'300s (Phase IV pool — shared)', service:'Starbridge API',
    configKeys:['TIMEOUTS.s3d','BUYER_SEARCH_PAGE_SIZE'],
    prompt:null,
    detail:'Buyer search filtered by geographic state codes only. Converts geographic_hints (full names like "California" or abbreviations like "CA") to two-letter state codes via STATE_CODES map. Processes up to 3 geographic hints (geo[:3]).\n\nSurfaces buyers in target regions that may not appear in opportunity results. Runs in parallel with s3a, s3b, and s3c. Results merged and deduplicated in s4.',
    qualityRules:[],
    edgeCases:[
      { label:'0 results', action:'Returns empty list (valid response). s4 scoring proceeds with buyers from s3a/s3b/s3c.', severity:'skip' },
      { label:'Invalid state name', action:'Unrecognized geographic hints are silently skipped. Only US states + DC supported.', severity:'skip' }
    ],
    outputSchema:{ 'DISCOVERY_BUYERS_D':'[{ buyerId, name, stateCode, tags: string[], url }]' }
  },

  // --- Phase V: SELECT ---
  { id:'s4', num:'4', phase:'select', name:'Rank + Score Buyers', type:'python',
    meta:'Deterministic scoring: merge signals \u2192 buyer map \u2192 6-factor score \u2192 select featured + secondary',
    conditionalRun:{ type:'stop', rule:'STOPS if 0 buyers found across all 4 discovery searches' },
    inputs:['DISCOVERY_SIGNALS_A','DISCOVERY_SIGNALS_B','DISCOVERY_BUYERS_C','DISCOVERY_BUYERS_D','SEARCH_STRATEGY.primary_keywords','SEARCH_STRATEGY.buyer_types','SEARCH_STRATEGY.ideal_buyer_profile'],
    outputs:['FEATURED_BUYER_ID','FEATURED_BUYER_NAME','FEATURED_BUYER_TYPE','SECONDARY_BUYERS','ALL_SCORED_BUYERS','SELECTION_RATIONALE','DISCOVERY_BUYERS'],
    tools:[], module:'pipeline.py', fn:'s4_rank_and_select', timeout:null, service:null,
    configKeys:['MAX_SECONDARY_BUYERS'],
    prompt:null,
    detail:'Deterministic scoring — no LLM call. Merges signals from s3a/s3b and buyers from s3c + s3d into a buyer map, deduplicating by buyerId. Scores each buyer on 6 weighted factors, sorts descending. Top scorer = featured, next 4 = secondary. Outputs combined DISCOVERY_BUYERS for DB persistence.\n\nKeyword scoring (10% weight) uses tokens from primary_keywords + ideal_buyer_profile (stop words filtered). This gives buyers a boost when their signals mention terms from the ideal profile description.',
    scoring:{ type_match:25, signal_count:20, recency:20, urgency:15, dollar:10, keyword:10 },
    qualityRules:[
      'Scoring is purely deterministic — 6 weighted factors, no LLM',
      'Secondary buyers are the next 4 highest-scoring — no diversity logic applied'
    ],
    edgeCases:[
      { label:'0 buyers across all searches', action:'Raise ValueError — pipeline stops. BDR must trigger manually.', severity:'stop' },
      { label:'Only 1 unique buyer found', action:'That buyer is featured. No secondary cards generated (empty SECONDARY_BUYERS list).', severity:'degrade' },
      { label:'Opportunity types don\'t match SEARCH_STRATEGY', action:'Type-match scoring (25% weight) penalizes mismatches but doesn\'t exclude them.', severity:'skip' }
    ],
    outputSchema:{
      'FEATURED_BUYER_ID':'string',
      'FEATURED_BUYER_NAME':'string',
      'FEATURED_BUYER_TYPE':'string — buyer type of the featured buyer (e.g. SchoolDistrict, City)',
      'SECONDARY_BUYERS':'[{ buyerId, buyerName, buyerType, score, signalCount, topSignalType, topSignalSummary }]',
      'ALL_SCORED_BUYERS':'[{ buyerId, buyerName, score, signalCount, stateCode }]',
      'SELECTION_RATIONALE':'string — why featured buyer was selected',
      'DISCOVERY_BUYERS':'[raw buyer dicts from s3c + s3d combined] — passed to s5 for DB persistence via update_run_discovery()'
    }
  },

  { id:'s5', num:'5', phase:'select', name:'Persist Discovery', type:'sqlite',
    meta:'Backfill run stub with discovery columns, insert scored buyers into discoveries table',
    conditionalRun:{ type:'always' },
    inputs:['DISCOVERY_SIGNALS_A','DISCOVERY_SIGNALS_B','DISCOVERY_BUYERS','FEATURED_BUYER_ID','FEATURED_BUYER_NAME','FEATURED_BUYER_TYPE','SELECTION_RATIONALE','SECONDARY_BUYERS','DB_RUN_ID','SEARCH_STRATEGY','ALL_SCORED_BUYERS','target_domain'],
    outputs:['DB_RUN_ID (backfilled)'],
    tools:['sqlite_update'], module:'pipeline.py → db.py', fn:'s5_persist_discovery() → db.update_run_discovery() + db.insert_discoveries()', timeout:null, service:'SQLite',
    prompt:null,
    detail:'Backfills the run stub (created in s1) with discovery-phase columns: search_strategy, discovery_signals_a/b, discovery_buyers, featured_buyer_id/name/type, selection_rationale, secondary_buyers. Inserts all scored buyers into the discoveries table.\n\nEnables: future runs load cached raw discovery data, re-ranking without re-calling APIs, analytics on search strategy performance, debugging raw vs ranked selections.',
    qualityRules:[
      'DB_RUN_ID should already exist (created in s1). If missing, falls back to insert_run() as safety net — should never fire in normal flow.',
      'All scored buyers must have a corresponding row in the discoveries table'
    ],
    edgeCases:[
      { label:'SQLite write fails', action:'Pipeline hard-fails. Crash handler logs the error.', severity:'fail' }
    ],
    outputSchema:{ 'DB_RUN_ID':'integer — same run_id (backfilled), now with discovery columns populated' }
  },

  // --- Phase VI: ENRICH & GENERATE (5 parallel branches) ---
  { id:'s8', num:'8', phase:'generate', name:'Exec Summary', type:'template', parallel:true,
    meta:'Python template — signal/buyer counts \u2192 single-sentence summary paragraph (no header)',
    conditionalRun:{ type:'always' },
    inputs:['target_company','SEARCH_STRATEGY.sled_segments','FEATURED_BUYER_NAME','FEATURED_BUYER_TYPE','ALL_SCORED_BUYERS','DISCOVERY_SIGNALS_A','DISCOVERY_SIGNALS_B'],
    outputs:['SECTION_EXEC_SUMMARY'],
    tools:[], module:'pipeline.py', fn:'s8_exec_summary', timeout:'330s (Phase VI pool — shared by all branches via TIMEOUTS["s6"])', service:null,
    configKeys:['TIMEOUTS.s6','MAX_WORKERS_ENRICHMENT'],
    prompt:null,
    template:'We scanned **{signal_count} procurement signals** across **{buyer_count} SLED buyers** in the {seg_str} space for **{product}**. Leading match: **{featured}**[ ({type_label})]*, with the strongest combination of signal recency, urgency, and relevance.\n\nVariables:\n  signal_count  = len(DISCOVERY_SIGNALS_A) + len(DISCOVERY_SIGNALS_B)\n  buyer_count   = len(ALL_SCORED_BUYERS)\n  seg_str       = " and ".join(BUYER_TYPE_LABEL[s] for s in sled_segments[:3])  — fallback "SLED"\n  product       = target_company\n  featured      = FEATURED_BUYER_NAME  — fallback "Unknown"\n  type_label    = BUYER_TYPE_LABEL[FEATURED_BUYER_TYPE]  — appended in parens only if non-empty\n\n* [ ] = conditional segment',
    detail:'Python template, no LLM. Runs in parallel branch A of Phase VI. Pure string formatting — no markdown header, produces a bare paragraph. BUYER_TYPE_LABEL maps API buyer type strings (e.g. "SchoolDistrict") to display labels ("School District").',
    qualityRules:[],
    edgeCases:[
      { label:'Template rendering fails', action:'Template-based — almost no failure modes. Catch-all returns empty string.', severity:'skip' }
    ],
    outputSchema:{ 'SECTION_EXEC_SUMMARY':'string — bare paragraph (no header): single sentence with signal count, buyer count, featured buyer name, and buyer type' }
  },

  { id:'s6', num:'6', phase:'generate', name:'Featured Intel Fetch', type:'api', parallel:true,
    meta:'buyer_profile + buyer_contacts + buyer_chat (async) — 3 sub-calls on featured buyer',
    conditionalRun:{ type:'always' },
    inputs:['FEATURED_BUYER_ID','FEATURED_BUYER_NAME','DISCOVERY_SIGNALS_A','DISCOVERY_SIGNALS_B'],
    outputs:['FEAT_PROFILE','FEAT_CONTACTS','FEAT_OPPORTUNITIES','FEAT_AI_CONTEXT'],
    tools:['buyer_profile','buyer_contacts','buyer_chat (async)'], module:'tools.py', fn:'buyer_profile() || buyer_contacts() || buyer_chat()', timeout:'330s (Phase VI pool via TIMEOUTS["s6"]) / 300s (BUYER_CHAT_MAX_WAIT)', service:'Starbridge API',
    configKeys:['TIMEOUTS.s6','BUYER_CHAT_MAX_WAIT','FEATURED_CONTACT_PAGE_SIZE','MAX_WORKERS_FEATURED','ASYNC_POLL_INTERVAL'],
    prompt:null,
    detail:'3 parallel API sub-calls (buyer_profile, buyer_contacts, buyer_chat) + post-processing step that filters discovery signals to the featured buyer.\n\nbuyer_chat uses async polling (POST \u2192 poll GET every 3s) to avoid SSE streaming timeouts — it\'s an AI analysis endpoint that can take 10-90s.\n\nSub-call timeouts: buyer_profile and buyer_contacts use TIMEOUTS["s7"] (300s each — note: uses s7 key, not s6). buyer_chat uses TIMEOUTS["s6"] (330s pool) with BUYER_CHAT_MAX_WAIT (300s) for async polling. Each sub-call duration is tracked and logged to audit_log.\n\nAfter API calls complete, filters DISCOVERY_SIGNALS_A + B to opportunities matching the featured buyerId \u2192 FEAT_OPPORTUNITIES.\n\nAll 3 sub-calls must succeed — any failure hard-fails the pipeline. Pool uses manual pool.shutdown(wait=False, cancel_futures=True) to clean up after completion.',
    qualityRules:[
      'All 3 sub-calls (profile, contacts, chat) must succeed — no partial results',
      'buyer_chat MUST use async endpoint to avoid SSE timeout (documented in MEMORY.md)'
    ],
    edgeCases:[
      { label:'buyer_chat times out (>300s)', action:'Pipeline hard-fails. Crash handler persists partial state.', severity:'fail' },
      { label:'buyer_profile fails', action:'Pipeline hard-fails. Crash handler persists partial state.', severity:'fail' },
      { label:'buyer_contacts fails', action:'Pipeline hard-fails. Crash handler persists partial state.', severity:'fail' }
    ],
    outputSchema:{
      'FEAT_PROFILE':'{ name, tags: string[], stateCode, url, address, budget, procurementScore, enrollment, population }',
      'FEAT_CONTACTS':'[{ name, title, normalizedTitles: string[], email, phone, emailVerified, worksAtBuyer }]',
      'FEAT_OPPORTUNITIES':'[opportunity] — filtered from DISCOVERY_SIGNALS_A + B where buyerId matches featured buyer',
      'FEAT_AI_CONTEXT':'string — narrative strategic context from buyer_chat (required)'
    }
  },

  { id:'s9', num:'9', phase:'generate', name:'LLM: Featured Section', type:'llm', parallel:true,
    meta:'Featured buyer writer — snapshot card + why it matters (3 bullets) + key contact + recent strategic signals',
    conditionalRun:{ type:'always' },
    inputs:['FEAT_PROFILE','FEAT_CONTACTS','FEAT_AI_CONTEXT','FEATURED_BUYER_NAME','FEATURED_BUYER_TYPE','FEAT_OPPORTUNITIES','target_company','product_description'],
    outputs:['SECTION_FEATURED'],
    tools:['claude_cli'], module:'pipeline.py → llm.py', fn:'s9_featured_section() → llm.featured_section()', timeout:'300s (_call_llm subprocess timeout) within 330s Phase VI pool (runs inside s6→s9 branch)', service:'Claude CLI (configurable via LLM_MODEL)',
    configKeys:['LLM_MODEL','AI_PROFILE_CHAR_LIMIT','AI_CONTACTS_CHAR_LIMIT','AI_OPPS_CHAR_LIMIT','AI_CONTEXT_CHAR_LIMIT','AI_CONTACTS_MAX','AI_OPPS_MAX'],
    prompt:'You are generating the Featured Buyer section for a Starbridge SLED intelligence report.\n\nCRITICAL: You MUST use ONLY the data provided below. Do NOT use any outside knowledge.\nThe buyer name, profile data, contacts, and opportunities below are the ONLY source of truth.\nIf a field is missing from the data, OMIT that line — do NOT guess or fill in from memory.\n\nGenerate these sub-sections in order:\n\n1. **BUYER SNAPSHOT CARD** — A blockquote card with:\n   - Emoji for buyer type (🏛️=HigherEducation/StateAgency, 🏫=SchoolDistrict/School, 🏙️=City, 🏢=County)\n   - Buyer name (MUST match the BUYER field below) and type label on the first line\n   - State, City, size metric (Enrollment for education, Population for government)\n   - Procurement Score (procurementHellScore, 0-100), Fiscal Year Start, Website, Phone\n   - Omit any line where data is unavailable — do NOT invent values\n\n2. **WHY THIS BUYER MATTERS** — Exactly 3 bullets. Each MUST:\n   - Reference a SPECIFIC signal from the OPPORTUNITIES data below by name/title\n   - Explain why it creates an opening for the prospect\'s product\n   - Be concrete enough for a BDR to reference on a phone call\n   BAD: "They invest in technology."\n   GOOD: "Board approved $2.3M demonstration project for shared data infrastructure."\n\n3. **KEY CONTACT** — Pick the single best contact from CONTACTS data below:\n   - Prefer emailVerified=true, Director+ seniority, role overlap with product\n   - Format: Name — Title — Email\n   - MUST be a contact from the provided data, not invented\n\n4. **RECENT STRATEGIC SIGNALS** — Top 3-5 signals from OPPORTUNITIES below:\n   - Each: titled paragraph (2-4 sentences)\n   - Include dates, dollar amounts, initiative names — ONLY from provided data\n   - End each with parenthetical source: *(Board meeting, Nov 2025)*\n\nOutput as clean markdown. No meta-commentary. ZERO outside knowledge — data below only.',
    contentTemplate:'PROSPECT PRODUCT: {target_company}\nPRODUCT DESCRIPTION: {product_description}\n\nBUYER: {FEATURED_BUYER_NAME}\nBUYER TYPE: {FEATURED_BUYER_TYPE}\n\nBUYER PROFILE:\n{json.dumps(FEAT_PROFILE, indent=2)[:3000]}          ← AI_PROFILE_CHAR_LIMIT=3000\n\nCONTACTS:\n{json.dumps(FEAT_CONTACTS[:20], indent=2)[:3000]}    ← first AI_CONTACTS_MAX=20 contacts, then AI_CONTACTS_CHAR_LIMIT=3000\n\nOPPORTUNITIES:\n{json.dumps(FEAT_OPPORTUNITIES[:15], indent=2)[:4000]} ← first AI_OPPS_MAX=15 opps, then AI_OPPS_CHAR_LIMIT=4000\n\n[if FEAT_AI_CONTEXT is non-empty:]\nAI STRATEGIC CONTEXT:\n{str(FEAT_AI_CONTEXT)[:3000]}                          ← AI_CONTEXT_CHAR_LIMIT=3000; omitted entirely if empty/None',
    detail:'Calls _call_llm(system_prompt, content) → subprocess `claude -p` with 300s timeout. Runs sequentially after s6 within the s6→s9 branch of Phase VI.\n\nContent is built from 8 params: buyer_name, buyer_type, product (target_company), product_desc, profile_json (FEAT_PROFILE → JSON → [:3000]), contacts_json (FEAT_CONTACTS[:20] → JSON → [:3000]), opps_json (FEAT_OPPORTUNITIES[:15] → JSON → [:4000]), ai_context (str(FEAT_AI_CONTEXT)[:3000], omitted entirely if empty/None).\n\nOutput: raw markdown string returned directly from _call_llm(). No JSON parsing, no fallbacks. Stored as SECTION_FEATURED, passed to s12.',
    qualityRules:[
      'Every bullet must reference a specific initiative, date, or dollar amount — no generic claims',
      'Key contact should have emailVerified == true (preferred). If none verified, LLM picks best available and notes it.',
      'No hallucinated data — every fact must come from FEAT_PROFILE, FEAT_CONTACTS, or FEAT_AI_CONTEXT'
    ],
    edgeCases:[
      { label:'No contacts with verified email', action:'LLM picks best available contact and adds unverified note.', severity:'degrade' },
      { label:'Few opportunities for buyer', action:'LLM reduces Strategic Signals section to match available data.', severity:'degrade' },
      { label:'LLM times out (>300s)', action:'Pipeline hard-fails. Crash handler persists partial state.', severity:'fail' }
    ],
    outputSchema:{ 'SECTION_FEATURED':'string — markdown: ## Featured: {buyer} + snapshot card + why it matters (3 bullets) + key contact + recent strategic signals (3-5)' }
  },

  { id:'s7', num:'7', phase:'generate', name:'Secondary Intel Fetch', type:'api', parallel:true,
    meta:'buyer_profile + buyer_contacts per secondary buyer — up to 4 buyers, ThreadPool(max_workers=4)',
    conditionalRun:{ type:'skip', rule:'Skipped if SECONDARY_BUYERS is empty (0 selected in s4)' },
    inputs:['SECONDARY_BUYERS'],
    outputs:['SEC_PROFILES','SEC_CONTACTS'],
    tools:['buyer_profile','buyer_contacts'], module:'tools.py', fn:'buyer_profile() + buyer_contacts() per buyer', timeout:'330s (Phase VI pool — shared; s7 also has internal as_completed(timeout=TIMEOUTS["s7"]=300s))', service:'Starbridge API',
    configKeys:['TIMEOUTS.s7','SECONDARY_CONTACT_PAGE_SIZE','MAX_WORKERS_SECONDARY','MAX_SECONDARY_BUYERS'],
    prompt:null,
    detail:'Fetches profile + contacts for each secondary buyer in parallel. Uses ThreadPoolExecutor(max_workers=4). Lower contact page_size (20 vs 50 for featured) since we only need one contact per card. No buyer_chat for secondaries — discovery signals are sufficient.\n\nRuns in parallel branch C of Phase VI. With 4 secondaries, that\'s up to 8 API calls total.',
    qualityRules:[],
    edgeCases:[
      { label:'Any profile/contacts call fails', action:'Pipeline hard-fails. Crash handler persists partial state.', severity:'fail' },
      { label:'Secondary fetch times out', action:'Pipeline hard-fails. Crash handler persists partial state.', severity:'fail' }
    ],
    outputSchema:{
      'SEC_PROFILES':'[{ buyerId, name, tags: string[], stateCode, url, address, budget, procurementScore }]',
      'SEC_CONTACTS':'[{ buyerId, contacts: [{ name, title, email, phone, emailVerified, worksAtBuyer }] }]'
    }
  },

  { id:'s10', num:'10', phase:'generate', name:'LLM: Secondary Cards', type:'llm', parallel:true,
    meta:'Compact 3-4 line cards per secondary buyer — Top Signal + Key Contact + Relevance',
    conditionalRun:{ type:'skip', rule:'Outputs empty string if SECONDARY_BUYERS is empty' },
    inputs:['target_company','product_description','SEC_PROFILES','SEC_CONTACTS','SECONDARY_BUYERS'],
    outputs:['SECTION_SECONDARY'],
    tools:['claude_cli'], module:'pipeline.py → llm.py', fn:'s10_secondary_cards() → llm.secondary_cards()', timeout:'300s (_call_llm subprocess timeout) within 330s Phase VI pool (runs inside s7→s10 branch)', service:'Claude CLI (configurable via LLM_MODEL)',
    configKeys:['LLM_MODEL','MAX_SECONDARY_BUYERS'],
    prompt:'Generate compact buyer cards for secondary SLED buyers.\n\nFor each buyer, output exactly:\n\n**[Buyer Name]** | [Type Label]\n- **Top Signal:** [Most relevant initiative, RFP, or procurement activity]\n- **Key Contact:** [Name — Title — Email] (or \'No contacts available\')\n- **Relevance:** [1 sentence on why this buyer matters for the product]\n\nKeep each card to 3-4 lines. Be specific — name initiatives, not generic claims.\nOutput as clean markdown. No meta-commentary.',
    contentTemplate:'PROSPECT PRODUCT: {target_company}\nPRODUCT DESCRIPTION: {product_description}\n\n--- BUYER 1 ---\nName: {buyerName} | Type: {buyerType or "Unknown"}\nScore: {score:.3f} | Signals: {signalCount}\nTop Signal: {topSignalType} — {topSignalSummary}\nProfile: {json.dumps(SEC_PROFILES[0])[:800]}             ← only if SEC_PROFILES[i] exists and is truthy\nContacts: {json.dumps(matching_contacts[:5])[:800]}       ← matched by buyerId from SEC_CONTACTS; only if .contacts exists; first 5 contacts\n\n--- BUYER 2 ---\n...\n\n[repeats for each buyer in SECONDARY_BUYERS[:4] — MAX_SECONDARY_BUYERS=4]\n[pipeline.py pre-concatenates all buyer data into one flat string (buyers_content) before passing to llm.secondary_cards()]',
    detail:'Calls _call_llm(system_prompt, content) → subprocess `claude -p` with 300s timeout. Runs sequentially after s7 within the s7→s10 branch of Phase VI.\n\npipeline.py pre-concatenates all buyer data into a single flat string (buyers_content): for each buyer in SECONDARY_BUYERS[:4] (MAX_SECONDARY_BUYERS=4), appends name, type (or "Unknown"), score (3 decimal places), signal count, top signal type + summary. Then conditionally appends: profile JSON[:800] (only if SEC_PROFILES[i] exists), contacts JSON[:800] (matched by buyerId from SEC_CONTACTS, first 5 contacts only, only if .contacts exists). LLM receives one flat content block, not structured inputs.\n\nOutput: raw markdown string returned directly from _call_llm(). No JSON parsing, no fallbacks. Stored as SECTION_SECONDARY, passed to s12.',
    qualityRules:[
      'Each card must include at least 1 specific signal fact (date, dollar amount, or initiative name)',
      'Cards should be concise — 3-4 lines max per buyer'
    ],
    edgeCases:[
      { label:'No contacts for a buyer', action:'LLM omits Key Contact line for that card.', severity:'skip' },
      { label:'LLM times out (>300s)', action:'Step fails. Pipeline crash handler saves partial state and marks run as failed.', severity:'fail' }
    ],
    outputSchema:{ 'SECTION_SECONDARY':'string — markdown: ## More Buyers + one compact card per secondary buyer' }
  },

  { id:'s11', num:'11', phase:'generate', name:'CTA Section', type:'template', parallel:true,
    meta:'Python template — Starbridge capabilities + discovery stats \u2192 marketing CTA block',
    conditionalRun:{ type:'always' },
    inputs:['target_company','SEARCH_STRATEGY.sled_segments','ALL_SCORED_BUYERS','DISCOVERY_SIGNALS_A','DISCOVERY_SIGNALS_B'],
    outputs:['SECTION_CTA'],
    tools:[], module:'pipeline.py', fn:'s11_cta', timeout:'330s (Phase VI pool — shared)', service:null,
    configKeys:['CTA_BUYERS_COUNT','CTA_RECORDS_COUNT'],
    prompt:null,
    template:'## What Starbridge Can Do\n\nStarbridge monitors **{CTA_BUYERS_COUNT} government and education buyers** across all 50 states, with **{CTA_RECORDS_COUNT} indexed board meetings and procurement records**. For {product} targeting {seg_str} buyers, we surface:\n\n- **Active procurement signals** — RFPs, contract expirations, board discussions, and budget allocations\n- **Verified decision-maker contacts** — directors, VPs, superintendents, and budget authorities\n- **AI-powered buyer analysis** — strategic context synthesized from public records and FOIA data\n\nThis scan surfaced **{total_signals} signals** across **{buyer_count} buyers** in the {seg_str} space.\n\nVariables:\n  CTA_BUYERS_COUNT  = config string  — default "296,000+"\n  CTA_RECORDS_COUNT = config string  — default "107M+"\n  product           = target_company\n  seg_str           = ", ".join(BUYER_TYPE_LABEL[s] for s in sled_segments[:3])  — fallback "SLED"\n  total_signals     = len(DISCOVERY_SIGNALS_A) + len(DISCOVERY_SIGNALS_B)\n  buyer_count       = len(ALL_SCORED_BUYERS)',
    detail:'Python template, no LLM. Runs in parallel branch D of Phase VI. Produces markdown with header. CTA_BUYERS_COUNT and CTA_RECORDS_COUNT are editable config strings — update via config panel to change marketing numbers.',
    qualityRules:[],
    edgeCases:[
      { label:'Template rendering fails', action:'Template-based — almost no failure modes. Catch-all returns empty string.', severity:'skip' }
    ],
    outputSchema:{ 'SECTION_CTA':'string — markdown: ## What Starbridge Can Do + discovery stats + Starbridge capabilities' }
  },

  // --- Phase VII: ASSEMBLE & VALIDATE ---
  { id:'s12', num:'12', phase:'assemble', name:'Assemble + Publish (LLM → Notion)', type:['llm','api'],
    meta:'LLM assembles report from pre-generated sections (s8, s9, s10, s11) AND publishes to Notion via MCP tools in one CLI session. Footer generated inline by LLM.',
    conditionalRun:{ type:'stop', rule:'STOPS if NOTION_PARENT_PAGE_ID is not set (raises RuntimeError)' },
    inputs:['SECTION_FEATURED','SECTION_SECONDARY','SECTION_EXEC_SUMMARY','SECTION_CTA','target_company','product_description','FEATURED_BUYER_NAME','FEATURED_BUYER_TYPE','NOTION_PARENT_PAGE_ID'],
    outputs:['REPORT_MARKDOWN','NOTION_PAGE_URL'],
    tools:['claude_cli','mcp_Notion_notion_create_pages'], module:'pipeline.py + llm.py', fn:'s12_assemble() + llm.shape_and_publish_report()', timeout:'300s (LLM_TOOL_TIMEOUT — MCP connection + report assembly + Notion publish)', service:'Claude CLI + Notion MCP (via Datagen)',
    configKeys:['LLM_MODEL','LLM_TOOL_TIMEOUT','NOTION_PARENT_PAGE_ID','AI_REPORT_OPPS_MAX','AI_REPORT_OPPS_CHAR_LIMIT','AI_REPORT_SECTION_CHAR_LIMIT'],
    prompt:'You are assembling a final SLED intelligence report from pre-generated sections and publishing it to Notion.\n\n═══ YOUR ROLE ═══\n\nYou are an ASSEMBLER. Specialized sub-agents have already generated each section from raw source data. Your job is to combine them into a single, cohesive report and publish it.\n\nYOU MUST:\n1. Add the report title header: # 📊 [Buyer Name] — Intelligence Report for [Product]\n2. Include the FEATURED BUYER SECTION as-is\n3. Include the ADDITIONAL BUYERS SECTION as-is (OMIT if empty or \'No secondary buyers\')\n4. Include the EXEC SUMMARY SECTION as-is\n5. Include the CTA SECTION as-is\n6. Add horizontal rules (---) between major sections\n7. Add the footer: *Generated Starbridge Intelligence [Current Month Year]*\n   followed by: *Data source: Starbridge buyer profile, contacts, and opportunity database*\n8. Publish the assembled report to Notion\n\nYOU MUST NOT:\n- Add facts, names, numbers, dates, or analysis not already in the sections\n- Remove or significantly alter content from the provided sections\n- Re-generate sections from scratch — use them as provided\n\n═══ SECTION ORDER ═══\n\n1. Title header\n2. Featured Buyer Section (buyer snapshot, signals, contacts, analysis)\n3. Additional Buyers Section (secondary buyer cards) — omit if none\n4. Exec Summary Section\n5. CTA Section\n6. Footer\n\n═══ NOTION PUBLISHING ═══\n\nAfter assembling the report markdown above, you MUST publish it to Notion.\n\nUse the `executeTool` MCP tool with these parameters:\n  tool_alias_name: "mcp_Notion_notion_create_pages"\n  parameters: {\n    "parent": {"page_id": "{{VAR}}"},\n    "pages": [{\n      "properties": {"title": "[Buyer Name] — Intelligence Report for [Product]"},\n      "content": "[THE FULL ASSEMBLED REPORT MARKDOWN]"\n    }]\n  }\n\n═══ FINAL OUTPUT FORMAT ═══\n\nAfter publishing to Notion, output your response in EXACTLY this format:\n1. The complete report markdown (same content you published)\n2. A delimiter line: ---NOTION_URL---\n3. The Notion page URL from the tool result on its own line\n\nIf the Notion tool fails, still output the report markdown but put PUBLISH_FAILED after the delimiter.\n\nOUTPUT: The report markdown + delimiter + URL. No meta-commentary.',
    contentTemplate:'TARGET COMPANY: {target_company}\nPRODUCT DESCRIPTION: {product_description}\n\nFEATURED BUYER: {FEATURED_BUYER_NAME}\nBUYER TYPE: {FEATURED_BUYER_TYPE}\n\n--- FEATURED BUYER SECTION (generated by specialized sub-agent) ---\n{SECTION_FEATURED}\n\n--- ADDITIONAL BUYERS SECTION (generated by specialized sub-agent) ---\n{SECTION_SECONDARY or "No secondary buyers."}\n\n--- EXEC SUMMARY SECTION (generated by specialized sub-agent) ---\n{SECTION_EXEC_SUMMARY}\n\n--- CTA SECTION (generated by template) ---\n{SECTION_CTA}',
    detail:'Spawns Claude CLI with MCP tool access: `claude -p --model {LLM_MODEL} --mcp-config {temp_config} --allowedTools mcp__datagen__executeTool`. 300s subprocess timeout (LLM_TOOL_TIMEOUT).\n\nMCP config: temp JSON file built at runtime with Datagen server URL (https://mcp.datagen.dev/mcp) + DATAGEN_API_KEY. Must include "type": "http" — without it the CLI hangs on transport auto-detection.\n\nContent: 4 pre-generated section strings + metadata. s12 does NOT receive raw data — it works only with pre-generated section markdown from s8 (exec summary), s9 (featured), s10 (secondary), s11 (CTA).\n\nExecution:\n1. pipeline.py s12_assemble() builds data_kwargs from state\n2. llm.shape_and_publish_report() builds MCP config temp file\n3. _call_llm_with_tools() spawns `claude -p` with --mcp-config and --allowedTools\n4. LLM assembles report (sections + title header + horizontal rules + footer)\n5. LLM calls executeTool MCP tool to create Notion page\n6. LLM outputs: [full markdown] ---NOTION_URL--- [notion page url]\n7. Python splits stdout on ---NOTION_URL--- delimiter to extract REPORT_MARKDOWN + NOTION_PAGE_URL\n\nRetry: 2 attempts max. If the first LLM+MCP session fails (Notion 500, MCP param error, timeout), s12 retries with a fresh LLM call. A fresh call can format MCP params differently. Logged as s12_assemble_retry (warning) on first failure. Hard-fails after 2nd attempt.',
    qualityRules:[
      'Assembler must not add, remove, or alter facts from pre-generated sections',
      'All 4 sections (featured, secondary, exec summary, CTA) must appear in final report',
      'Notion page URL must be successfully extracted from LLM output'
    ],
    edgeCases:[
      { label:'LLM-with-tools fails (MCP error, timeout)', action:'Retries once with fresh LLM call (logged as s12_assemble_retry). Hard-fails after 2nd attempt.', severity:'fail' },
      { label:'Notion URL not in LLM output', action:'Step fails. Pipeline crash handler saves partial state and marks run as failed.', severity:'fail' },
      { label:'Empty section provided', action:'LLM assembles report without that section. Missing featured section would produce a minimal report.', severity:'skip' }
    ],
    outputSchema:{ 'REPORT_MARKDOWN':'string — full CEO-format markdown', 'NOTION_PAGE_URL':'string — Notion page URL from LLM tool call' }
  },

  { id:'s13', num:'13', phase:'assemble', name:'Validate + Fix + Update Notion', type:['validate','llm','api'],
    meta:'6 deterministic issue checks + 2 warning checks (1 deterministic, 1 LLM). If any findings, LLM fixes the report and updates the Notion page.',
    conditionalRun:{ type:'always' },
    inputs:['REPORT_MARKDOWN','FEATURED_BUYER_NAME','SECONDARY_BUYERS','target_company','NOTION_PAGE_URL'],
    outputs:['VALIDATION_RESULT','VALIDATED_REPORT_MARKDOWN'],
    tools:['claude_cli','notion_update_page (SDK)'], module:'pipeline.py + llm.py', fn:'s13_validate() + llm.fact_check() + llm.fix_report()', timeout:'300s (no pool — sequential Phase VII; bounded by CLI subprocess timeout)', service:'Claude CLI + Datagen SDK (tools.notion_update_page)',
    configKeys:['TIMEOUTS.s13','LLM_MODEL','AI_VALIDATION_SOURCE_LIMIT'],
    prompt:'You are a fact-checker reviewing a SLED intelligence report for internal consistency.\n\nCHECK FOR:\n- Contradictions within the report (e.g. buyer name differs between sections)\n- Claims that appear fabricated (generic statements with no specifics)\n- Contact information that looks malformed or placeholder-like\n- Sections that reference data not present elsewhere in the report\n\nIGNORE these (they are correct):\n- ALL dates including the generation date and opportunity dates\n- Aggregate counts (total signals, total buyers)\n- Formatting, style, section structure\n\nRespond with ONLY: PASS or FAIL followed by a numbered list of issues found.',
    contentTemplate:'BUYER: {FEATURED_BUYER_NAME}\n\nREPORT TO CHECK:\n{REPORT_MARKDOWN[:4000]}\n\n(Only used for check 8 — the LLM fact-check. Checks 1-7 are deterministic Python, no LLM call.)',
    detail:'**Execution order:**\n1. Run 6 deterministic checks against REPORT_MARKDOWN → append failures to issues[]\n2. Run 1 deterministic check for secondary buyer names in report → append failures to warnings[]\n3. Call llm.fact_check(buyer_name, report) → _call_llm() with max_tokens=1024 → append failures to warnings[]\n4. Evaluate: passed = len(issues) == 0\n5. If any issues OR warnings exist:\n   a. Call llm.fix_report(buyer_name, report, issues, warnings) → returns corrected markdown\n   b. Update Notion page with corrected report via tools.notion_update_page() (non-blocking)\n   c. Store corrected report as VALIDATED_REPORT_MARKDOWN\n6. Log result\n\n**Validation checks (8):**\n\n*Issues (block validation — passed = false):*\n1. [issue] Buyer name present in report header (first 500 chars)\n2. [issue] Product name (target_company) mentioned in report (case-insensitive)\n3. [issue] Current month/year stamp in report (e.g. \"February 2026\")\n4. [issue] Every contact row has at least one of email or phone\n5. [issue] Report length exceeds 500 characters\n6. [issue] All emails in report have valid format\n\n*Warnings (logged but don\'t block — passed unaffected):*\n7. [warning] Each secondary buyer name appears in report\n8. [warning] LLM fact_check() — returns (bool, detail_str). If \"FAIL\" in result → (False, result[:500]). Else → (True, result[:200]).\n\n**Report fixing:** When any findings exist (issues OR warnings), llm.fix_report() generates a corrected report. The fix LLM receives the original report + all findings and returns corrected markdown. The corrected report replaces the Notion page content via tools.notion_update_page(). Both fix and Notion update are non-blocking (try/except).\n\n**DB persistence:** s14 saves VALIDATED_REPORT_MARKDOWN (if available) instead of REPORT_MARKDOWN via: data.get(\"VALIDATED_REPORT_MARKDOWN\") or data.get(\"REPORT_MARKDOWN\").',
    qualityRules:[
      'passed = len(issues) == 0 — only checks 1-6 can block the pipeline',
      'Checks 7-8 add to warnings[] only — logged but do not block',
      'llm.fact_check() returns (bool, str) tuple; pipeline builds {passed, issues[], warnings[], fixed, checked_at} dict',
      'llm.fix_report() is called when ANY findings exist (issues OR warnings) — not just blocking issues',
      'Notion page is updated with corrected content, not a warning banner'
    ],
    edgeCases:[
      { label:'LLM fact-check times out', action:'Pipeline hard-fails (exception from _call_llm). Crash handler persists partial state.', severity:'fail' },
      { label:'Deterministic check fails', action:'Added to issues[]. passed=false. Report fixed via LLM + Notion updated. Pipeline continues to s14.', severity:'degrade' },
      { label:'LLM fact-check returns FAIL', action:'Added to warnings[]. Report fixed via LLM + Notion updated. passed still depends only on issues[].', severity:'degrade' },
      { label:'LLM fix_report fails', action:'Logged as warning (non-blocking). Original report stays on Notion. Pipeline continues.', severity:'degrade' },
      { label:'Notion page update fails', action:'Logged as warning (non-blocking). Corrected report still saved to DB as VALIDATED_REPORT_MARKDOWN. Pipeline continues.', severity:'degrade' }
    ],
    outputSchema:{
      'VALIDATION_RESULT':'{ passed: boolean, issues: string[], warnings: string[], fixed: boolean, checked_at: ISO timestamp } — passed = len(issues) == 0',
      'VALIDATED_REPORT_MARKDOWN':'string — corrected report markdown (only present if findings were found and fix succeeded)'
    }
  },

  { id:'s14', num:'14', phase:'assemble', name:'Save + Respond', type:'sqlite',
    meta:'Update run to \'completed\', persist all intel + sections to DB, build final response JSON',
    conditionalRun:{ type:'always' },
    inputs:['REPORT_MARKDOWN','NOTION_PAGE_URL','DB_RUN_ID','FEATURED_BUYER_ID','FEATURED_BUYER_NAME','FEAT_CONTACTS','FEAT_PROFILE','FEAT_OPPORTUNITIES','FEAT_AI_CONTEXT','SECONDARY_BUYERS','SEC_PROFILES','SEC_CONTACTS','SECTION_EXEC_SUMMARY','SECTION_FEATURED','SECTION_SECONDARY','SECTION_CTA','DISCOVERY_SIGNALS_A','DISCOVERY_SIGNALS_B','VALIDATION_RESULT'],
    outputs:['final_response'],
    tools:['sqlite_update'], module:'pipeline.py + db.py', fn:'s14_save_and_respond() + update_run_completed()', timeout:null, service:'SQLite',
    prompt:null,
    detail:'Final step. Receives REPORT_MARKDOWN and NOTION_PAGE_URL from s12 (LLM-driven assembly + publish) and includes them in the response JSON.\n\nUpdates run to \'completed\' status. Saves all section content, raw intel data (FEAT_PROFILE, FEAT_CONTACTS, FEAT_OPPORTUNITIES, FEAT_AI_CONTEXT, SEC_PROFILES, SEC_CONTACTS), report markdown, and contacts to SQLite. Builds the final response JSON containing:\n- report_url — the published Notion page URL from s12. This is what Clay posts to Slack #intent-reports as the "intel is ready" link for BDRs\n- report_markdown — the full LLM-assembled report from s12\n- metadata — validation results, timing, signal/buyer counts\n\nMust succeed — SQLite write failure hard-fails the pipeline.\n\nPersisting raw intel + individual sections enables: section-level regeneration without re-calling Starbridge APIs, A/B testing different prompts on same intel, analytics on section quality.',
    qualityRules:[
      'Run status must transition from \'processing\' to \'completed\' — no other final states',
      'Response JSON must include all required fields: status, buyer_id, buyer_name, report_url, report_markdown, metadata'
    ],
    edgeCases:[
      { label:'SQLite update fails', action:'Pipeline hard-fails. Crash handler persists partial state.', severity:'fail' }
    ],
    outputSchema:{
      'final_response':'{ status, buyer_id, buyer_name, report_url, report_markdown, metadata: { profile_available, contacts_count, opportunities_count, ai_chat_available, secondary_buyers, total_signals_scanned, validation, generation_timestamp, total_duration_seconds } }'
    }
  }
];

// =======================================================
// ORCHESTRATION DATA (rendered in "How It Runs" modal)
// =======================================================

var ORCHESTRATION = {
  stateMerge: {
    label: 'State Merging',
    pattern: 'state |= step_result()',
    detail: 'Each step returns a dict of new keys. Merged forward-only \u2014 no removal. All downstream steps see accumulated state from every prior step.'
  },
  errorHandling: {
    label: 'Error Handling',
    pattern: 'Hard-fail with targeted retries',
    detail: 'Most steps hard-fail on exception \u2014 crash handler calls update_run_failed() and preserves partial state in SQLite. Exceptions: s12 retries once (fresh LLM call), Notion MCP calls auto-retry 3x on transient 500s, s13 fix+update is non-blocking (try/except, pipeline continues on failure).'
  },
  cancellation: {
    label: 'Cancellation',
    pattern: 'threading.Event + subprocess kill',
    detail: 'stop_event checked via _check_cancelled() at start of phases III, IV, V, VII. If set, raises PipelineCancelled. LLM subprocesses polled every 0.5s \u2014 killed if event is set. Run marked as cancelled in SQLite.'
  },
  poolShutdown: {
    label: 'Pool Shutdown',
    pattern: 'Manual shutdown for error cleanup',
    detail: 'Phase VI and s6 internal pools use pool.shutdown(wait=False, cancel_futures=True) instead of context manager. Prevents ThreadPoolExecutor from blocking on remaining futures after a timeout or error.'
  },
  dbLifecycle: {
    label: 'DB Lifecycle',
    pattern: 'Stub \u2192 backfill \u2192 backfill \u2192 final',
    detail: 's1: insert_run_stub (minimal row, status=processing). s5: update_run_discovery (backfill search_strategy, signals, buyers). s14: update_run_completed (backfill enrichment, report, notion_url, status=completed). On crash: update_run_failed (partial_state JSON, status=failed).'
  },
  retryResilience: {
    label: 'Retry & Resilience',
    pattern: '3 retry layers',
    detail: 'Notion MCP (tools.py): 3 attempts, backoff 2s/5s/10s, transient 500/502/503 only \u2014 4xx schema errors fail immediately. s12 LLM+MCP publish: 2 attempts, immediate \u2014 fresh LLM call may format MCP params differently. s13 fix+update: non-blocking try/except \u2014 LLM fix generates corrected report, Notion update pushes it, either can fail without blocking pipeline. Starbridge REST: no retries (deterministic responses).'
  },
  batchExecution: {
    label: 'Batch Execution',
    pattern: 'Semaphore-gated concurrency',
    detail: 'MAX_CONCURRENT_RUNS (default 3) controls parallel pipelines via threading.Semaphore. Batch endpoint pre-creates all run stubs, returns run_ids immediately. Each run gets a config snapshot frozen at submission time. Excess runs queue on semaphore.acquire() until a slot opens.'
  },
  priorRunDedup: {
    label: 'Prior Run Deduplication',
    pattern: 's1 loads \u2192 s2 diversifies',
    detail: 's1 queries completed runs for same domain (load_prior_runs). s2 passes them to the LLM with "PRIOR RUNS" context \u2014 keywords, featured buyer, secondary buyers. LLM instructed to diversify: different keyword angles, buyer segments, geographic focus. s4 scoring is purely deterministic (no prior-run awareness).'
  },
  configIsolation: {
    label: 'Config Isolation',
    pattern: 'snapshot \u2192 apply \u2192 run',
    detail: 'Config deep-copied at run submission. apply_config_to_modules() pushes snapshot into pipeline/tools/llm cached module bindings via setattr(). Mid-run UI config changes only affect the next run. Batch runs share one snapshot.'
  },
  conditionalSkipping: {
    label: 'Conditional Skipping',
    pattern: 'if not data: log "skipped", return {}',
    detail: 's3b skips if no alternate/rfp keywords. s3c skips if no buyer_types. s3d skips if no valid state codes (geographic_hints empty or all fail US-state lookup). s7 skips if no secondary buyers. s10 skips if no secondary buyers. s3b/s3c/s3d call log_step(status="skipped", duration=0) to audit_log; s7/s10 only log to stderr. Downstream steps handle empty results gracefully.'
  },
  asyncPolling: {
    label: 'Async Polling',
    pattern: 'POST /async \u2192 run_uuid \u2192 poll GET /output',
    detail: 'buyer_chat uses Datagen async endpoint to avoid HTTP timeout on 10-90s SSE streaming. Poll loop checks every ASYNC_POLL_INTERVAL seconds. HTTP 202 = still pending. Raises TimeoutError if BUYER_CHAT_MAX_WAIT exceeded. Elapsed time logged on completion.'
  },
  llmSubprocess: {
    label: 'LLM Subprocess',
    pattern: 'Popen + poll(0.5s) + cancel/timeout kill',
    detail: 'Claude CLI spawned via subprocess.Popen. Prompt written to stdin, then closed. Process polled every 0.5s \u2014 checked for cancel event or timeout. On cancel: proc.kill() + PipelineCancelled. On timeout: proc.kill() + RuntimeError. MCP tool sessions use temp config file cleaned up in finally block.'
  }
};

// =======================================================
// CONSTANTS & DERIVED DATA
// =======================================================

var PHASE_LABELS = {
  source:   'I \u2014 Source',
  input:    'II \u2014 Input Validation',
  analyze:  'III \u2014 Target Analysis',
  discover: 'IV \u2014 Signal Discovery',
  select:   'V \u2014 Buyer Selection',
  generate: 'VI \u2014 Enrich & Generate',
  assemble: 'VII \u2014 Assemble & Validate'
};

var NODE_POSITIONS = {
  s0:  { x: 490, y: 60 },
  s1:  { x: 490, y: 320 },
  s2:  { x: 490, y: 580 },
  s3a: { x: 190, y: 850 },
  s3b: { x: 390, y: 850 },
  s3c: { x: 590, y: 850 },
  s3d: { x: 790, y: 850 },
  s4:  { x: 350, y: 1100 },
  s5:  { x: 630, y: 1220 },
  s6:  { x: 80, y: 1540 },
  s7:  { x: 280, y: 1540 },
  s8:  { x: 480, y: 1540 },
  s11: { x: 680, y: 1540 },
  s9:  { x: 80, y: 1690 },
  s10: { x: 280, y: 1690 },
  s12: { x: 490, y: 1960 },
  s13: { x: 490, y: 2120 },
  s14: { x: 490, y: 2280 }
};
var NODE_W = 160;

var SYSTEM_INPUTS = { 'CURRENT_DATE': null };

var STEPS_MAP = {};
STEPS.forEach(function(s) { STEPS_MAP[s.id] = s; });

var INPUT_SOURCES = (function() {
  var map = {};
  STEPS.forEach(function(s) {
    s.outputs.forEach(function(v) { map[v] = s.id; });
  });
  STEPS.forEach(function(s) {
    s.inputs.forEach(function(v) {
      if (v.indexOf('.') !== -1 && !map[v]) {
        var base = v.split('.')[0];
        if (map[base]) map[v] = map[base];
      }
    });
  });
  Object.keys(SYSTEM_INPUTS).forEach(function(k) { map[k] = SYSTEM_INPUTS[k]; });
  return map;
})();

var COMPUTED_EDGES = (function() {
  var edges = {};
  STEPS.forEach(function(targetStep) {
    targetStep.inputs.forEach(function(varName) {
      var base = varName.split('.')[0];
      var sourceId = INPUT_SOURCES[varName] || INPUT_SOURCES[base];
      if (!sourceId) return;
      var key = sourceId + '->' + targetStep.id;
      if (!edges[key]) edges[key] = { source: sourceId, target: targetStep.id, variables: [] };
      edges[key].variables.push(varName);
    });
  });
  return edges;
})();

var VALIDATION_LOOPS = [
  // Note: s14→s11 retry loop was planned but is not implemented in the current codebase.
  // Keeping array empty until the retry mechanism is built.
];

var PHASE_ROMAN = (function() {
  var romans = ['I', 'II', 'III', 'IV', 'V', 'VI', 'VII', 'VIII', 'IX', 'X'];
  var map = {}, count = 0;
  STEPS.forEach(function(s) {
    if (!map[s.phase]) map[s.phase] = romans[count++];
  });
  return map;
})();

var PARALLEL_GROUPS = (function() {
  var map = {}, code = 64, inGroup = false;
  STEPS.forEach(function(s) {
    if (s.parallel) {
      if (!inGroup) { code++; inGroup = true; }
      map[s.id] = String.fromCharCode(code);
    } else {
      inGroup = false;
    }
  });
  return map;
})();

// =======================================================
// HELPERS
// =======================================================

function escHtml(s) {
  return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function getTypes(s) { return Array.isArray(s.type) ? s.type : [s.type]; }
function primaryType(s) { return getTypes(s)[0]; }
function hasType(s, t) { return getTypes(s).includes(t); }
function typeBadges(s) {
  return getTypes(s).map(function(t) {
    if (t === 'llm') return '<span class="subagent-badge">ai</span>';
    return '<span class="step-badge badge-' + t + '">' + t + '</span>';
  }).join(' ');
}

function renderSubAgentBadge(s) {
  return '';
}

function renderIndicators(s) {
  var html = '<div class="step-indicators">';
  var svcMap = {'Claude CLI':'LLM','Starbridge API':'STARBRIDGE','Notion MCP':'Notion','SQLite':'DB'};
  if (s.service) {
    var svcShort = s.service;
    Object.keys(svcMap).forEach(function(k) { if (s.service.indexOf(k) !== -1) svcShort = svcMap[k]; });
    html += '<span class="ind ind-svc">' + svcShort + '</span>';
  }
  if (s.timeout) {
    var t = s.timeout.replace(/ \(.*\)/, '');
    html += '<span class="ind ind-timeout">' + t + '</span>';
  }
  if (s.tools && s.tools.length) html += '<span class="ind ind-tools">' + s.tools.length + (s.tools.length === 1 ? ' tool' : ' tools') + '</span>';
  html += '</div>';
  return html;
}

function phaseMatch(phase, focus) {
  if (focus === 'discover') return ['source','input','analyze','discover','select'].indexOf(phase) !== -1;
  if (focus === 'generate') return ['generate','assemble'].indexOf(phase) !== -1;
  return true;
}

function getOutboundEdges(stepId) {
  return Object.values(COMPUTED_EDGES).filter(function(e) { return e.source === stepId; })
    .sort(function(a,b) { return STEPS.findIndex(function(s){return s.id===a.target;}) - STEPS.findIndex(function(s){return s.id===b.target;}); });
}

function getSourceLabel(src) {
  if (!src) return 'Webhook (entry point)';
  var s = STEPS.find(function(x) { return x.id === src; });
  return s ? 'Step ' + s.num + ': ' + s.name : src;
}

// =======================================================
// INPUT CHIPS (with edge hover + highlight)
// =======================================================

function renderInputChips(inputs, targetStepId) {
  if (!inputs.length) return '<span style="color:var(--text-dim);font-size:11px">None (entry point)</span>';
  var groups = {};
  inputs.forEach(function(name) {
    var base = name.split('.')[0];
    var src = INPUT_SOURCES[name] || INPUT_SOURCES[base] || null;
    if (!groups[src]) groups[src] = [];
    groups[src].push(name);
  });

  var html = '';
  var order = [null].concat(STEPS.map(function(s) { return s.id; }));
  var sortedKeys = Object.keys(groups).sort(function(a, b) {
    return order.indexOf(a === 'null' ? null : a) - order.indexOf(b === 'null' ? null : b);
  });

  sortedKeys.forEach(function(src) {
    var label = getSourceLabel(src === 'null' ? null : src);
    var stepId = (src && src !== 'null') ? src : null;
    var clickAttr = stepId ? ' onclick="navToStep(\'' + stepId + '\')"' : '';
    var linkClass = stepId ? ' src-link' : '';
    var edgeKey = stepId && targetStepId ? stepId + '->' + targetStepId : '';
    var hoverAttr = edgeKey ? ' onmouseenter="highlightEdge(\'' + edgeKey + '\')" onmouseleave="unhighlightEdge()"' : '';

    html += '<div class="input-group" data-edge="' + edgeKey + '"' + hoverAttr + '>';
    html += '<div class="input-group-label">from <span class="' + linkClass + '"' + clickAttr + '>' + label + '</span></div>';
    html += '<div class="data-flow">';
    groups[src].forEach(function(n) { html += '<span class="data-chip chip-in">' + n + '</span>'; });
    html += '</div></div>';
  });
  return html;
}

// =======================================================
// FEEDS INTO (with validation loops + edge hover)
// =======================================================

function renderFeedsInto(stepId) {
  var outbound = getOutboundEdges(stepId);
  var loops = VALIDATION_LOOPS.filter(function(l) { return l.from === stepId || l.to === stepId; });
  if (!outbound.length && !loops.length) return '';
  var html = '<div class="detail-section"><h3><span class="dot" style="background:var(--orange)"></span>Feeds Into</h3>';
  // Validation loops first
  loops.forEach(function(loop) {
    var otherId = loop.from === stepId ? loop.to : loop.from;
    var other = STEPS.find(function(x) { return x.id === otherId; });
    if (!other) return;
    var loopKey = loop.from + '<->' + loop.to;
    var clickAttr = ' onclick="navToStep(\'' + otherId + '\')"';
    html += '<div class="input-group validation-loop-row" data-edge="' + loopKey + '" onmouseenter="highlightEdge(\'' + loopKey + '\')" onmouseleave="unhighlightEdge()">';
    html += '<div class="input-group-label"><span class="validation-loop-badge">\u21c4 validation loop</span> with <span class="src-link"' + clickAttr + '>Step ' + other.num + ': ' + other.name + '</span></div>';
    html += '<div style="color:var(--text-dim);font-size:11px;margin-top:2px">' + loop.label + '</div>';
    html += '</div>';
  });
  // Normal outbound edges
  outbound.forEach(function(edge) {
    var target = STEPS.find(function(x) { return x.id === edge.target; });
    if (!target) return;
    var clickAttr = ' onclick="navToStep(\'' + edge.target + '\')"';
    html += '<div class="input-group" data-edge="' + edge.source + '->' + edge.target + '" onmouseenter="highlightEdge(\'' + edge.source + '->' + edge.target + '\')" onmouseleave="unhighlightEdge()">';
    html += '<div class="input-group-label">to <span class="src-link"' + clickAttr + '>Step ' + target.num + ': ' + target.name + '</span></div>';
    if (edge.variables.length) {
      html += '<div class="data-flow">';
      edge.variables.forEach(function(v) { html += '<span class="data-chip chip-feeds">' + v + '</span>'; });
      html += '</div>';
    }
    html += '</div>';
  });
  html += '</div>';
  return html;
}

// =======================================================
// EDGE TOOLTIPS & HIGHLIGHTING
// =======================================================

function showEdgeTooltip(event, edgeKey) {
  var tooltip = document.getElementById('edgeTooltip');
  var html = '';

  var loop = VALIDATION_LOOPS.find(function(l) { return l.from + '<->' + l.to === edgeKey; });
  if (loop) {
    var fromStep = STEPS.find(function(s) { return s.id === loop.from; });
    var toStep = STEPS.find(function(s) { return s.id === loop.to; });
    if (!fromStep || !toStep) return;
    html += '<div style="color:#ff69b4;font-weight:600;font-size:11px;margin-bottom:6px">\u21c4 Validation Loop</div>';
    html += '<div style="color:var(--text-bright);font-size:10px;margin-bottom:6px">Step ' + fromStep.num + ' \u21c4 Step ' + toStep.num + '</div>';
    html += '<div style="color:var(--text-dim);font-size:10px">' + loop.label + '</div>';
  } else {
    var edge = COMPUTED_EDGES[edgeKey];
    if (!edge) return;
    var sourceStep = STEPS.find(function(s) { return s.id === edge.source; });
    var targetStep = STEPS.find(function(s) { return s.id === edge.target; });
    if (!sourceStep || !targetStep) return;

    html += '<div style="color:var(--text-bright);font-weight:600;font-size:11px;margin-bottom:6px">';
    html += 'Step ' + sourceStep.num + ' \u2192 Step ' + targetStep.num;
    html += '</div>';
    html += '<div style="color:var(--text-dim);font-size:10px;margin-bottom:6px">';
    html += sourceStep.name + ' \u2192 ' + targetStep.name;
    html += '</div>';

    if (edge.variables.length) {
      html += '<div class="data-flow" style="gap:3px">';
      edge.variables.forEach(function(v) {
        html += '<span class="data-chip chip-in" style="font-size:9px;padding:2px 6px">' + v + '</span>';
      });
      html += '</div>';
    }
  }

  tooltip.innerHTML = html;
  tooltip.style.display = 'block';
  tooltip.style.left = Math.min(event.clientX + 12, window.innerWidth - 300) + 'px';
  tooltip.style.top = (event.clientY - 10) + 'px';
}

function hideEdgeTooltip() {
  document.getElementById('edgeTooltip').style.display = 'none';
}

function highlightEdge(edgeKey) {
  state.highlightedEdge = edgeKey;
  var isLoop = edgeKey.indexOf('<->') !== -1;
  if (isLoop) {
    var parts = edgeKey.split('<->');
    var visPath = document.getElementById('epath-vloop-' + parts[0] + '-' + parts[1]);
    if (visPath) { visPath.setAttribute('stroke', '#ff69b4'); visPath.setAttribute('stroke-width', '3'); }
  } else {
    var visPath = document.getElementById('epath-' + edgeKey.replace('->','-'));
    if (visPath) { visPath.setAttribute('stroke', '#58a6ff'); visPath.setAttribute('stroke-width', '3'); }
    var visArrow = document.getElementById('earrow-' + edgeKey.replace('->','-'));
    if (visArrow) visArrow.setAttribute('fill', '#58a6ff');
  }
  document.querySelectorAll('[data-edge]').forEach(function(el) {
    el.classList.toggle('edge-highlighted', el.getAttribute('data-edge') === edgeKey);
  });
}

function unhighlightEdge() {
  if (state.highlightedEdge) {
    var isLoop = state.highlightedEdge.indexOf('<->') !== -1;
    if (isLoop) {
      var parts = state.highlightedEdge.split('<->');
      var loop = VALIDATION_LOOPS.find(function(l) { return l.from === parts[0] && l.to === parts[1]; });
      if (loop) {
        var isActive = state.selectedStep === loop.from || state.selectedStep === loop.to;
        var color = isActive ? 'rgba(255,105,180,0.8)' : 'rgba(255,105,180,0.35)';
        var width = isActive ? 2.5 : 1.5;
        var visPath = document.getElementById('epath-vloop-' + loop.from + '-' + loop.to);
        if (visPath) { visPath.setAttribute('stroke', color); visPath.setAttribute('stroke-width', String(width)); }
      }
    } else {
      var edge = COMPUTED_EDGES[state.highlightedEdge];
      if (edge) {
        var isActive = state.selectedStep === edge.source || state.selectedStep === edge.target;
        var color = isActive ? '#58a6ff' : 'rgba(48,54,61,0.45)';
        var width = isActive ? 2.5 : 1.5;
        var visPath = document.getElementById('epath-' + state.highlightedEdge.replace('->','-'));
        if (visPath) { visPath.setAttribute('stroke', color); visPath.setAttribute('stroke-width', String(width)); }
        var visArrow = document.getElementById('earrow-' + state.highlightedEdge.replace('->','-'));
        if (visArrow) visArrow.setAttribute('fill', color);
      }
    }
  }
  state.highlightedEdge = null;
  document.querySelectorAll('.edge-highlighted').forEach(function(el) {
    el.classList.remove('edge-highlighted');
  });
}

function selectEdgeNode(edgeKey) {
  var edge = COMPUTED_EDGES[edgeKey];
  if (!edge) return;
  if (state.view === 'diagram') selectDiagramNode(edge.target);
}

// =======================================================
// LIST VIEW
// =======================================================

function renderPipeline() {
  var el = document.getElementById('pipeline');
  var html = '';
  var lastPhase = '';
  var inParallel = false;

  STEPS.forEach(function(s) {
    if (s.phase !== lastPhase) {
      if (inParallel) { html += '</div>'; inParallel = false; }
      if (lastPhase) html += '<div class="connector"></div>';
      html += '<div class="phase-label">' + PHASE_LABELS[s.phase] + '</div>';
      lastPhase = s.phase;
    }
    if (s.parallel && !inParallel) { html += '<div class="parallel-group">'; inParallel = true; }
    if (!s.parallel && inParallel) { html += '</div>'; inParallel = false; }

    var dimmed = state.focusPhase !== 'all' && !phaseMatch(s.phase, state.focusPhase);
    var selected = state.selectedStep === s.id;
    html += '<div class="step' + (selected?' selected':'') + (dimmed?' dimmed':'') + '" onclick="selectStep(\'' + s.id + '\')" id="lstep-' + s.id + '">';
    html += '<div class="step-num">' + renderSubAgentBadge(s) + typeBadges(s) + ' Step ' + s.num + '</div>';
    html += '<div class="step-name">' + s.name + '</div>';
    html += renderIndicators(s);
    html += '<div class="step-meta">' + s.meta + '</div>';
    html += '</div>';
  });

  if (inParallel) html += '</div>';
  el.innerHTML = html;
  if (state.selectedStep) {
    var el2 = document.getElementById('lstep-' + state.selectedStep);
    if (el2) el2.scrollIntoView({ block:'nearest' });
  }
}

// =======================================================
// DETAIL PANEL (shared rendering for list + floating)
// =======================================================

function buildDetailHtml(id, isFloating) {
  var s = STEPS.find(function(x) { return x.id === id; });
  if (!s) return '';

  var html = '';
  if (isFloating) {
    html += '<button class="detail-close" onclick="closeDiagramDetail()">&times;</button>';
  }
  html += '<h2 style="font-size:' + (isFloating?'16':'18') + 'px;font-weight:600;color:var(--text-bright);margin-bottom:4px;' + (isFloating?'padding-right:30px':'') + '">Step ' + s.num + ': ' + s.name + '</h2>';
  html += '<div style="font-size:' + (isFloating?'12':'13') + 'px;color:var(--text-dim);margin-bottom:' + (isFloating?'16':'20') + 'px">' + s.meta + '</div>';

  // Conditional run
  if (s.conditionalRun) {
    var cr = s.conditionalRun;
    var crLabel = cr.type === 'always' ? 'Always runs' : cr.type === 'stop' ? 'Hard stop' : cr.type === 'skip' ? 'Conditional skip' : 'Branches';
    var crText = cr.rule ? crLabel + ' \u2014 ' + cr.rule : crLabel;
    html += '<div class="detail-section"><h3><span class="dot" style="background:var(--text-bright)"></span>Conditional Run</h3>';
    html += '<div class="conditional-run conditional-run-' + cr.type + '">' + crText + '</div>';
    html += '</div>';
  }

  // Implementation
  html += '<div class="detail-section"><h3><span class="dot" style="background:var(--text-dim)"></span>Implementation</h3>';
  html += '<div class="impl-row">';
  html += '<span class="impl-tag">' + s.module + '</span>';
  html += '<span class="impl-tag"><span>' + s.fn + '</span></span>';
  if (s.timeout) html += '<span class="impl-tag">timeout: ' + s.timeout + '</span>';
  if (s.service) html += '<span class="impl-tag">service: ' + s.service + '</span>';
  html += '</div></div>';

  // Config chips
  if (s.configKeys && s.configKeys.length) {
    html += renderConfigChips(s);
  }

  // Tools
  if (s.tools && s.tools.length) {
    html += '<div class="detail-section"><h3><span class="dot" style="background:var(--cyan)"></span>Tool Calls</h3><div class="data-flow">';
    s.tools.forEach(function(t) { html += '<span class="data-chip chip-tool">' + t + '</span>'; });
    html += '</div></div>';
  }

  // Data In
  html += '<div class="detail-section"><h3><span class="dot" style="background:var(--blue)"></span>Data In</h3>';
  html += renderInputChips(s.inputs, s.id);
  html += '</div>';

  // Data Out
  html += '<div class="detail-section"><h3><span class="dot" style="background:var(--green)"></span>Data Out</h3>';
  if (s.outputSchema) {
    html += '<div class="output-schema">';
    s.outputs.forEach(function(d) {
      var schema = s.outputSchema[d];
      if (!schema) return;
      var isComplex = schema.indexOf('{') !== -1 || schema.indexOf('[') !== -1;
      html += '<div class="schema-row">';
      html += '<span class="schema-name">' + d + '</span>';
      if (isComplex) {
        html += '<pre class="schema-type">' + escHtml(schema) + '</pre>';
      } else {
        html += '<span class="schema-type-inline">' + escHtml(schema) + '</span>';
      }
      html += '</div>';
    });
    html += '</div>';
  } else {
    html += '<div class="data-flow">';
    s.outputs.forEach(function(d) { html += '<span class="data-chip chip-out">' + d + '</span>'; });
    html += '</div>';
  }
  html += '</div>';

  // Feeds Into
  html += renderFeedsInto(s.id);

  // Prompt / Detail blocks (v2 hybrid-aware logic)
  var pt = primaryType(s);
  var isHybrid = getTypes(s).length > 1;

  if (isHybrid && s.detail) {
    var detailLabel = pt === 'tool' ? 'Tool Logic' : pt === 'validate' ? 'Validation Logic' : pt === 'logic' ? 'Logic' : pt === 'sqlite' ? 'DB Operations' : 'Detail';
    var detailColor = pt === 'validate' ? 'var(--red)' : pt === 'sqlite' ? 'var(--sqlite-border)' : 'var(--orange)';
    html += '<div class="detail-section"><h3><span class="dot" style="background:' + detailColor + '"></span>' + detailLabel + '</h3>';
    html += '<div class="prompt-block">' + escHtml(s.detail) + '</div></div>';
  }
  if (hasType(s, 'llm') && s.prompt) {
    var prompt = state.editedPrompts[s.id] || s.prompt;
    html += '<div class="detail-section"><h3><span class="dot" style="background:var(--purple)"></span>LLM System Prompt</h3>';
    html += '<div class="edit-hint">Click to edit this prompt. Changes update the copy output below.</div>';
    html += '<div class="prompt-block"><div class="editable" contenteditable="true" id="promptEdit-' + s.id + '" oninput="onPromptEdit(\'' + s.id + '\')">' + escHtml(prompt) + '</div></div></div>';
  }
  if (hasType(s, 'llm') && s.contentTemplate) {
    html += '<div class="detail-section"><h3><span class="dot" style="background:var(--purple)"></span>LLM Content (User Message)</h3>';
    html += '<div class="prompt-block">' + escHtml(s.contentTemplate) + '</div></div>';
  }
  if (!hasType(s, 'llm') && s.prompt) {
    html += '<div class="detail-section"><h3><span class="dot" style="background:var(--purple)"></span>Prompt</h3>';
    html += '<div class="prompt-block">' + escHtml(s.prompt) + '</div></div>';
  }
  if (!isHybrid && s.detail) {
    var dLabel = pt === 'template' ? 'Template Logic' : pt === 'llm' ? 'LLM Sub-Agent Logic' : pt === 'api' ? 'API Call Detail' : pt === 'sqlite' ? 'DB Operations' : pt === 'python' ? 'Step Detail' : 'Logic';
    var dColor = pt === 'llm' ? 'var(--purple)' : pt === 'api' ? 'var(--cyan)' : pt === 'sqlite' ? 'var(--sqlite-border)' : pt === 'template' ? 'var(--template-border)' : 'var(--orange)';
    html += '<div class="detail-section"><h3><span class="dot" style="background:' + dColor + '"></span>' + dLabel + '</h3>';
    html += '<div class="prompt-block">' + escHtml(s.detail) + '</div></div>';
  }

  // Output Template (template steps: s8, s11)
  if (s.template) {
    html += '<div class="detail-section"><h3><span class="dot" style="background:var(--template-border)"></span>Output Template</h3>';
    html += '<div class="prompt-block">' + escHtml(s.template) + '</div></div>';
  }

  // Scoring weights (s4 only)
  if (s.scoring) {
    html += '<div class="detail-section"><h3><span class="dot" style="background:var(--orange)"></span>Scoring Weights</h3>';
    Object.entries(s.scoring).forEach(function(entry) {
      var k = entry[0], v = entry[1];
      html += '<div class="scoring-bar"><span class="scoring-bar-label">' + k.replace(/_/g,' ') + '</span>';
      html += '<div class="scoring-bar-track"><div class="scoring-bar-fill" style="width:' + (v*4) + '%"></div></div>';
      html += '<span class="scoring-bar-val">' + v + '%</span></div>';
    });
    html += '</div>';
  }

  // Validation checks (s14)
  if (s.checks) {
    html += '<div class="detail-section"><h3><span class="dot" style="background:var(--red)"></span>Validation Checks (' + s.checks.length + ')</h3>';
    s.checks.forEach(function(c, i) {
      var isAdvisory = c.indexOf('advisory') !== -1;
      html += '<div class="check-item' + (isAdvisory?' check-advisory':'') + '">';
      html += '<span>' + (i+1) + '.</span><span>' + c + '</span></div>';
    });
    html += '</div>';
  }

  // Quality rules
  if (s.qualityRules && s.qualityRules.length) {
    html += '<div class="detail-section"><h3><span class="dot" style="background:var(--red)"></span>Quality Rules</h3>';
    s.qualityRules.forEach(function(r) { html += '<div class="quality-rule">' + r + '</div>'; });
    html += '</div>';
  }

  // Edge cases
  if (s.edgeCases && s.edgeCases.length) {
    html += '<div class="detail-section"><h3><span class="dot" style="background:var(--orange)"></span>Edge Cases</h3>';
    s.edgeCases.forEach(function(ec) {
      var sev = ec.severity || 'degrade';
      var sevLabel = sev==='stop'?'STOP':sev==='fail'?'FAIL':sev==='skip'?'SKIP':'DEGRADE';
      html += '<div class="edge-case ec-' + sev + '"><span class="ec-severity">' + sevLabel + '</span>';
      html += '<span class="ec-label">' + ec.label + '</span>';
      html += '<span class="ec-action">' + ec.action + '</span></div>';
    });
    html += '</div>';
  }

  return html;
}

function renderDetail(id) {
  var el = document.getElementById('detail');
  if (!id) { el.innerHTML = '<div class="detail-empty">Click a step to see details</div>'; return; }
  el.innerHTML = buildDetailHtml(id, false);
}

function selectStep(id) {
  state.selectedStep = id;
  if (state.view === 'list') { renderPipeline(); renderDetail(id); }
  updatePrompt();
}

function navToStep(id) {
  if (state.view === 'diagram') { selectDiagramNode(id); }
  else { selectStep(id); }
}

// =======================================================
// MONITOR VIEW (live pipeline execution)
// =======================================================

var MONITOR_PRESETS = {
  vmock: {
    target_company: 'VMock',
    target_domain: 'vmock.com',
    product_description: 'AI-powered career services platform for universities \u2014 resume reviews, interview prep, career readiness assessments, and employer matching',
    campaign_id: 'test_vmock_001',
    prospect_name: 'Test Prospect',
    prospect_email: 'test@vmock.com'
  }
};

var SAMPLE_RUN_55 = {
  input: {
    target_company: 'VMock',
    target_domain: 'vmock.com',
    product_description: 'AI-powered career services platform for universities \u2014 resume reviews, interview prep, career readiness assessments, and employer matching',
    campaign_id: 'test_vmock_001',
    prospect_name: 'Test Prospect',
    prospect_email: 'test@vmock.com'
  },
  run: {
    id: 55, status: 'completed', target_company: 'VMock', target_domain: 'vmock.com',
    product_description: 'AI-powered career services platform for universities \u2014 resume reviews, interview prep, career readiness assessments, and employer matching',
    featured_buyer_name: 'Allentown School District', featured_buyer_type: 'SchoolDistrict',
    featured_score: 0.8435,
    selection_rationale: 'Selected Allentown School District (score: 0.844) with 4 signals. Top signal: Selling \u2014 College and Career Readiness Platform (RFP)',
    search_strategy: JSON.stringify({"sled_segments":["HigherEducation","SchoolDistrict","StateAgency"],"primary_keywords":["career services platform","resume review software","career readiness technology","student employment outcomes","AI career coaching"],"alternate_keywords":["workforce readiness software","student career development","career counseling technology"],"meeting_keywords":["discussed challenges in career services staffing","explored options for student career readiness assessment","requested analysis of graduate employment outcomes","reviewed student career services utilization rates","discussed strategies for improving post-graduation employment","explored AI tools for career counseling support","requested proposals for career development technology","discussed gaps in resume and interview preparation resources"],"rfp_keywords":["career services software","resume review platform","career readiness assessment tool","student employment services","interview preparation software","career coaching platform","workforce development technology","career outcomes tracking system"],"buyer_types":["HigherEducation","SchoolDistrict","StateAgency"],"opportunity_types":["Meeting","Purchase","RFP","Contract"],"geographic_hints":[],"ideal_buyer_profile":"Universities and colleges with 5,000+ students seeking to scale career services delivery, improve graduate employment rates, and modernize resume review and interview preparation through AI-powered tools."}),
    secondary_buyers: JSON.stringify([
      {buyerName:'Savannah-Chatham County School District',buyerType:'SchoolDistrict',signalCount:2,score:0.7168},
      {buyerName:'Texas Workforce Commission',buyerType:'StateAgency',signalCount:2,score:0.7037},
      {buyerName:'Options For Youth San Gabriel District',buyerType:'SchoolDistrict',signalCount:2,score:0.6941},
      {buyerName:'University Of South Carolina Columbia',buyerType:'HigherEducation',signalCount:2,score:0.6925}
    ]),
    notion_url: 'https://www.notion.so/30c845c16a8381ceb8bff452a148a15e',
    validation_result: JSON.stringify({passed:true,issues:[],warnings:[],fixed:false}),
    created_at: '2026-02-19 12:36:13', completed_at: '2026-02-19 12:42:44',
    prior_run_count: 0, dedup_enabled: 0
  },
  audit: [
  {
    "step": "s0_parse_webhook",
    "status": "success",
    "duration_seconds": 0.0,
    "message": "target=VMock (vmock.com)",
    "created_at": "2026-02-19 12:36:13",
    "metadata": {
      "target_company": "VMock",
      "target_domain": "vmock.com",
      "product_description": "AI-powered career services platform for universities — resume reviews, interview prep, career readiness assessments, and employer matching"
    }
  },
  {
    "step": "s1_validate_and_load",
    "status": "success",
    "duration_seconds": 0.003,
    "message": "run_id=55, prior=0, dedup=off",
    "created_at": "2026-02-19 12:36:13",
    "metadata": {
      "run_id": 55,
      "prior_runs": 0,
      "dedup_enabled": false
    }
  },
  {
    "step": "s2_search_strategy",
    "status": "success",
    "duration_seconds": 22.683,
    "message": "kw=['career services platform', 'resume review software', 'career readiness technology', 'student employment outcomes', 'AI career coaching'], types=['Meeting', 'Purchase', 'RFP', 'Contract']",
    "created_at": "2026-02-19 12:36:36",
    "metadata": {
      "SEARCH_STRATEGY": {
        "sled_segments": [
          "HigherEducation",
          "SchoolDistrict",
          "StateAgency"
        ],
        "primary_keywords": [
          "career services platform",
          "resume review software",
          "career readiness technology",
          "student employment outcomes",
          "AI career coaching"
        ],
        "alternate_keywords": [
          "workforce readiness software",
          "student career development",
          "career counseling technology"
        ],
        "meeting_keywords": [
          "discussed challenges in career services staffing",
          "explored options for student career readiness assessment",
          "requested analysis of graduate employment outcomes",
          "reviewed student career services utilization rates",
          "discussed strategies for improving post-graduation employment",
          "explored AI tools for career counseling support",
          "requested proposals for career development technology",
          "discussed gaps in resume and interview preparation resources"
        ],
        "rfp_keywords": [
          "career services software",
          "resume review platform",
          "career readiness assessment tool",
          "student employment services",
          "interview preparation software",
          "career coaching platform",
          "workforce development technology",
          "career outcomes tracking system"
        ],
        "buyer_types": [
          "HigherEducation",
          "SchoolDistrict",
          "StateAgency"
        ],
        "opportunity_types": [
          "Meeting",
          "Purchase",
          "RFP",
          "Contract"
        ],
        "geographic_hints": [],
        "ideal_buyer_profile": "Universities and colleges with 5,000+ students seeking to scale career services delivery, improve graduate employment rates, and modernize resume review and interview preparation through AI-powered tools."
      }
    }
  },
  {
    "step": "s3d_buyer_geo_search",
    "status": "skipped",
    "duration_seconds": 0.0,
    "message": "No geographic hints in strategy",
    "created_at": "2026-02-19 12:36:36"
  },
  {
    "step": "s3c_buyer_type_search",
    "status": "success",
    "duration_seconds": 4.89,
    "message": "9 buyers",
    "created_at": "2026-02-19 12:36:41",
    "metadata": {
      "DISCOVERY_BUYERS_C": {
        "_count": 9,
        "_sample": [
          {
            "buyerId": "dff77151-915e-4cb6-bb20-f7eb6bbcf8de",
            "name": "Michigan Association Of State Universities",
            "type": "System, NonProfitOrganization",
            "stateCode": "MI",
            "countryCode": "US",
            "website": "https://www.masu.org",
            "foiaRequestMethod": "Email",
            "city": null,
            "zip": null,
            "street": null,
            "county": "Ingham",
            "population": null,
            "parentName": "State of Michigan"
          },
          {
            "buyerId": "3e423d2d-016a-4b51-9048-5ea109c2ce9f",
            "name": "Independent Colleges And Universities Of Florida",
            "type": "System, HigherEducation",
            "stateCode": "FL",
            "countryCode": "US",
            "website": "https://icuf.org",
            "foiaRequestMethod": "Email",
            "city": null,
            "zip": null,
            "street": null,
            "county": "Leon",
            "population": null,
            "parentName": "State of Florida"
          },
          {
            "buyerId": "3edb3d0c-877a-49c5-8cb6-828cc7a22051",
            "name": "The Universities At Shady Grove",
            "type": "UndergraduateInstitution",
            "stateCode": "MD",
            "countryCode": "US",
            "website": "https://shadygrove.umd.edu",
            "foiaRequestMethod": "Email",
            "city": null,
            "zip": null,
            "street": null,
            "county": "Montgomery",
            "population": null,
            "parentName": null
          },
          {
            "buyerId": "01fbeb39-ec07-4227-8280-59f96c960bde",
            "name": "New Jersey Association Of State Colleges And Universities",
            "type": "System, HigherEducation",
            "stateCode": "NJ",
            "countryCode": "US",
            "website": "https://njascu.org",
            "foiaRequestMethod": "Email",
            "city": null,
            "zip": null,
            "street": null,
            "county": "Mercer",
            "population": null,
            "parentName": "State of New Jersey"
          },
          {
            "buyerId": "56a6702f-a265-434f-b139-1c95c37390d0",
            "name": "The Connecticut State Colleges And Universities System (CSCU)",
            "type": "System, AdministrativeAgency",
            "stateCode": "CT",
            "countryCode": "US",
            "website": "https://www.ct.edu",
            "foiaRequestMethod": null,
            "city": null,
            "zip": null,
            "street": null,
            "county": "Capitol",
            "population": null,
            "parentName": "State of Connecticut"
          },
          {
            "buyerId": "dafcd1ca-53e7-43be-856d-1caa9f2fab2f",
            "name": "Minnesota State Colleges and Universities System Office",
            "type": "HigherEducation",
            "stateCode": "MN",
            "countryCode": "US",
            "website": "http://minnstate.edu",
            "foiaRequestMethod": "Email",
            "city": "ST PAUL",
            "zip": "55101",
            "street": null,
            "county": "Ramsey",
            "population": null,
            "parentName": "State of Minnesota"
          },
          {
            "buyerId": "2ad22cb5-f57a-4d20-b44e-448141b68b1e",
            "name": "Tennessee Independent Colleges And Universities Association",
            "type": "System, HigherEducation",
            "stateCode": "TN",
            "countryCode": "US",
            "website": "https://ticua.org",
            "foiaRequestMethod": "Email",
            "city": null,
            "zip": null,
            "street": null,
            "county": "Davidson",
            "population": null,
            "parentName": "State of Tennessee"
          },
          {
            "buyerId": "d081ac2b-98a0-469f-a3b6-87c518f88c04",
            "name": "Illinois State Universities Retirement System",
            "type": "",
            "stateCode": "IL",
            "countryCode": "US",
            "website": "https://surs.org/",
            "foiaRequestMethod": null,
            "county": null,
            "population": null,
            "parentName": null
          },
          {
            "buyerId": "49106274-aa92-4f22-ac50-436a1f112ef1",
            "name": "Illinois State Universities Civil Service System",
            "type": "",
            "stateCode": "IL",
            "countryCode": "US",
            "website": "https://www.sucss.illinois.gov/",
            "foiaRequestMethod": null,
            "county": "Champaign",
            "population": null,
            "parentName": null
          }
        ]
      }
    }
  },
  {
    "step": "s3b_alternate_search",
    "status": "success",
    "duration_seconds": 17.176,
    "message": "40 results",
    "created_at": "2026-02-19 12:36:53",
    "metadata": {
      "DISCOVERY_SIGNALS_B": {
        "_count": 40,
        "_sample": [
          {
            "id": "4d262b04-f40d-4ed5-8527-63b7865b5c17",
            "title": "College and Career Success Readiness Platform (RFP)",
            "summary": "Provide comprehensive college and career readiness software platform. ",
            "type": "Selling",
            "status": "Past",
            "postedDate": "2024-12-26",
            "dueDate": null,
            "untilDate": "2025-01-20",
            "createdAt": "2025-01-16T20:46:55.337348Z",
            "purchaseAmount": null,
            "buyerId": "adbe201b-eec7-4828-86ad-7f50747f40fd",
            "buyerName": "Aurora Public Schools",
            "buyerType": "SchoolDistrict",
            "buyerState": "CO",
            "documentType": null
          },
          {
            "id": "5e406bc5-899a-412c-9739-cfe2b0de6dc8",
            "title": "College and Career Readiness Software (RFP)",
            "summary": "Provide college and career readiness software. ",
            "type": "Selling",
            "status": "Past",
            "postedDate": "2025-04-26",
            "dueDate": null,
            "untilDate": "2025-05-12",
            "createdAt": "2025-04-29T16:03:55.406037Z",
            "purchaseAmount": null,
            "buyerId": "a8a4ec24-0d19-4682-9857-49d16ce780ff",
            "buyerName": "Harlingen Consolidated Independent School District",
            "buyerType": "SchoolDistrict",
            "buyerState": "TX",
            "documentType": null
          },
          {
            "id": "512b9af2-a599-494b-85f3-a209512fee12",
            "title": "USBE First Credential Career Mapping Tool Software Platform (RFP)",
            "summary": "Provide career mapping software platform, an online system that offers a statewide education and career mapping software platform that is linked to state career opportunities and offers a career interest aptitude assessment.",
            "type": "Selling",
            "status": "Past",
            "postedDate": "2025-09-26",
            "dueDate": null,
            "untilDate": "2025-11-06",
            "createdAt": "2025-10-06T10:02:37.913148Z",
            "purchaseAmount": null,
            "buyerId": "158243fa-931b-40f3-a2c2-172d152bdb3a",
            "buyerName": "Utah State Board of Education",
            "buyerType": "StateAgency",
            "buyerState": "UT",
            "documentType": null
          },
          {
            "id": "56ffc0cc-1ce4-4a31-a79a-1ab10c308fa8",
            "title": "Districtwide College & Career Readiness Platform (RFP)",
            "summary": "Development, implementation, and management of a districtwide college & career readiness platform. ",
            "type": "Selling",
            "status": "Past",
            "postedDate": "2025-01-27",
            "dueDate": null,
            "untilDate": "2025-02-25",
            "createdAt": "2025-01-28T11:02:40.873863Z",
            "purchaseAmount": null,
            "buyerId": "1a2977a7-8c77-4309-ba1b-aec8b95db04e",
            "buyerName": "Richland School District Two",
            "buyerType": "SchoolDistrict",
            "buyerState": "SC",
            "documentType": null
          },
          {
            "id": "608e4824-67df-4ec6-bd16-d90f0af88865",
            "title": "Mycareercloset.org Turnkey Career Readiness Platform *SOLE SOURCE*",
            "summary": "Provide turnkey career readiness platform including digital career closet management system, curated professional clothing kits, virtual styling and coaching services.",
            "type": "Selling",
            "status": "Past",
            "postedDate": "2025-12-11",
            "dueDate": null,
            "untilDate": "2026-01-05",
            "createdAt": "2025-12-12T06:58:33.106781Z",
            "purchaseAmount": null,
            "buyerId": "0a0a7a25-e22c-4a95-9a2f-0d3ad37df0c1",
            "buyerName": "Alcorn State University",
            "buyerType": "HigherEducation",
            "buyerState": "MS",
            "documentType": null
          },
          {
            "id": "0ff1dcdf-03e3-468c-9cff-3ff0de8e9116",
            "title": "College and Career Readiness Platform (RFP)",
            "summary": "Provide a comprehensive, user-friendly, and fully integrated College and Career Readiness Platform designed to support students in grades K-12 by seamlessly integrating with district systems, facilitating individualized academic and career planning, and offering robust tools for college, trade school, and workforce exploration. In addition to the platform, the vendor must deliver professional development services to ensure effective implementation, sustained usage, and maximized engagement. ",
            "type": "Selling",
            "status": "Past",
            "postedDate": "2025-05-30",
            "dueDate": null,
            "untilDate": "2025-06-16",
            "createdAt": "2025-06-02T04:00:12.985735Z",
            "purchaseAmount": null,
            "buyerId": "1ddbb5ef-b1a6-40ff-8f55-ede3c1ad77ef",
            "buyerName": "City of Waterbury",
            "buyerType": "City",
            "buyerState": "CT",
            "documentType": null
          },
          {
            "id": "c5ad268e-f940-495e-a76a-648a4a21dc44",
            "title": "College and Career Readiness Platform (RFP)",
            "summary": "Provide a web-based, k-12 comprehensive college and career readiness platform.",
            "type": "Selling",
            "status": "Past",
            "postedDate": "2025-01-24",
            "dueDate": null,
            "untilDate": "2025-02-25",
            "createdAt": "2025-01-25T08:23:14.112064Z",
            "purchaseAmount": null,
            "buyerId": "1cd0fbd7-0cf9-4648-b9c3-a825a539ee16",
            "buyerName": "Fulton County School District",
            "buyerType": "SchoolDistrict",
            "buyerState": "GA",
            "documentType": null
          },
          {
            "id": "87fd06c7-9cac-4526-a607-2e62c5d7966b",
            "title": "College and Career Readiness Platform (RFP)",
            "summary": "Seeking qualified firms to establish a contract for a college and career readiness platform with comprehensive student services. The selected platform must provide: career exploration tools based on interests and aptitudes; college search and comparison features; college application system integration and document submission capabilities that align with third-party systems such as the common application; academic planning (including pathway/course alignment); individual graduation plan or indivi",
            "type": "Selling",
            "status": "Future",
            "postedDate": "2026-01-22",
            "dueDate": null,
            "untilDate": "2026-02-24",
            "createdAt": "2026-01-27T11:06:31.877560Z",
            "purchaseAmount": null,
            "buyerId": "980fbc2c-6d06-4fbe-a1bf-60b11efae14b",
            "buyerName": "Savannah-Chatham County School District",
            "buyerType": "SchoolDistrict",
            "buyerState": "GA",
            "documentType": null
          },
          {
            "id": "08580f59-36e5-49a4-ae19-1d6d4a9a30fe",
            "title": "College and Career Readiness (CCR) Software Solution (RFI)",
            "summary": "Comprehensive, integrated college and career readiness (CCR) software solution.",
            "type": "Selling",
            "status": "Past",
            "postedDate": "2025-01-29",
            "dueDate": null,
            "untilDate": "2025-03-21",
            "createdAt": "2025-02-06T05:05:50.602790Z",
            "purchaseAmount": null,
            "buyerId": "179cf4f5-43ac-42af-85c5-3f1113a18061",
            "buyerName": "Peyton School District 49",
            "buyerType": "SchoolDistrict",
            "buyerState": "CO",
            "documentType": null
          },
          {
            "id": "f397cdbd-84ec-494b-be15-c28ef29c671b",
            "title": "Software - Career & College Readiness Program / WPS 8633-W6",
            "summary": "Software - Career & College Readiness Program.",
            "type": "Selling",
            "status": "Past",
            "postedDate": "2025-01-16",
            "dueDate": null,
            "untilDate": "2026-02-11",
            "createdAt": "2026-01-17T13:41:28.313410Z",
            "purchaseAmount": null,
            "buyerId": "162521c2-f32c-4b86-8745-86aea23010c1",
            "buyerName": "City of Worcester",
            "buyerType": "City",
            "buyerState": "MA",
            "documentType": null
          }
        ]
      }
    }
  },
  {
    "step": "s3a_primary_search",
    "status": "success",
    "duration_seconds": 19.396,
    "message": "40 results",
    "created_at": "2026-02-19 12:36:56",
    "metadata": {
      "DISCOVERY_SIGNALS_A": {
        "_count": 40,
        "_sample": [
          {
            "id": "cc93e6e3-ae7c-422a-8659-d6fdf47eff4a",
            "title": "Youth Career and Employment Readiness Services",
            "summary": "Provide youth career and employment readiness services for county residents ages 14 through 24 4 include but are not limited to exposure to careers, paid internships, apprenticeships, mentorships, educational support, academic advising, technical and soft skills building, job search, job placement, job retention services, financial wellness/literacy, youth entrepreneurship, and wraparound services. Services must use a strengths-based, youth-led and trauma-informed approach to service delivery.",
            "type": "Selling",
            "status": "Past",
            "postedDate": "2025-01-16",
            "dueDate": null,
            "untilDate": "2025-02-20",
            "createdAt": "2025-01-21T17:13:00.500666Z",
            "purchaseAmount": null,
            "buyerId": "8f0e65ce-8b7a-4dfc-8e32-d39af94c48d4",
            "buyerName": "Hennepin County",
            "buyerType": "County",
            "buyerState": "MN",
            "documentType": null
          },
          {
            "id": "1aea0bf0-6cb9-4814-b84f-087e8a0ea069",
            "title": "Career Acceleration Platform Solution - AI- Powered",
            "summary": "seeks to procure a comprehensive, scalable, and inclusive AI-powered Career Acceleration Platform to enhance student and alumni career readiness, streamline access to high-quality feedback, and provide actionable data to improve institutional career outcomes. The solution must integrate advanced technology with user-centered design to empower students, strengthen cross-campus collaboration, and expand the University’s capacity to deliver career development support at scale.",
            "type": "Selling",
            "status": "Past",
            "postedDate": "2025-11-05",
            "dueDate": null,
            "untilDate": "2025-12-04",
            "createdAt": "2025-11-06T05:00:40.083386Z",
            "purchaseAmount": null,
            "buyerId": "65413dde-08e8-4227-803f-c704eff5e941",
            "buyerName": "University Of South Carolina Columbia",
            "buyerType": "HigherEducation",
            "buyerState": "SC",
            "documentType": null
          },
          {
            "id": "87fd06c7-9cac-4526-a607-2e62c5d7966b",
            "title": "College and Career Readiness Platform (RFP)",
            "summary": "Seeking qualified firms to establish a contract for a college and career readiness platform with comprehensive student services. The selected platform must provide: career exploration tools based on interests and aptitudes; college search and comparison features; college application system integration and document submission capabilities that align with third-party systems such as the common application; academic planning (including pathway/course alignment); individual graduation plan or indivi",
            "type": "Selling",
            "status": "Future",
            "postedDate": "2026-01-22",
            "dueDate": null,
            "untilDate": "2026-02-24",
            "createdAt": "2026-01-27T11:06:31.877560Z",
            "purchaseAmount": null,
            "buyerId": "980fbc2c-6d06-4fbe-a1bf-60b11efae14b",
            "buyerName": "Savannah-Chatham County School District",
            "buyerType": "SchoolDistrict",
            "buyerState": "GA",
            "documentType": null
          },
          {
            "id": "4d262b04-f40d-4ed5-8527-63b7865b5c17",
            "title": "College and Career Success Readiness Platform (RFP)",
            "summary": "Provide comprehensive college and career readiness software platform. ",
            "type": "Selling",
            "status": "Past",
            "postedDate": "2024-12-26",
            "dueDate": null,
            "untilDate": "2025-01-20",
            "createdAt": "2025-01-16T20:46:55.337348Z",
            "purchaseAmount": null,
            "buyerId": "adbe201b-eec7-4828-86ad-7f50747f40fd",
            "buyerName": "Aurora Public Schools",
            "buyerType": "SchoolDistrict",
            "buyerState": "CO",
            "documentType": null
          },
          {
            "id": "608e4824-67df-4ec6-bd16-d90f0af88865",
            "title": "Mycareercloset.org Turnkey Career Readiness Platform *SOLE SOURCE*",
            "summary": "Provide turnkey career readiness platform including digital career closet management system, curated professional clothing kits, virtual styling and coaching services.",
            "type": "Selling",
            "status": "Past",
            "postedDate": "2025-12-11",
            "dueDate": null,
            "untilDate": "2026-01-05",
            "createdAt": "2025-12-12T06:58:33.106781Z",
            "purchaseAmount": null,
            "buyerId": "0a0a7a25-e22c-4a95-9a2f-0d3ad37df0c1",
            "buyerName": "Alcorn State University",
            "buyerType": "HigherEducation",
            "buyerState": "MS",
            "documentType": null
          },
          {
            "id": "0005fe3c-683c-44f9-8283-8949cf12d6aa",
            "title": "AI-Powered Virtual Resume Review Software for Career Center Integration (RFP)",
            "summary": "Provide AI-powered virtual resume review software services. ",
            "type": "Selling",
            "status": "Past",
            "postedDate": "2025-01-09",
            "dueDate": null,
            "untilDate": "2025-01-24",
            "createdAt": "2025-01-16T19:31:03.087358Z",
            "purchaseAmount": null,
            "buyerId": "c80f270e-7acc-48e1-be99-fae4770bcc0a",
            "buyerName": "University Of Houston Downtown",
            "buyerType": "HigherEducation",
            "buyerState": "TX",
            "documentType": null
          },
          {
            "id": "52ada4bf-2505-4ef2-808b-1874ecb39ac6",
            "title": "College and Career Readiness Services (RFP No. 211)",
            "summary": "Procurement of a provider for College and Career Readiness Services, including Career and Technical Education, Dual Enrollment, and Grant Writing Services.",
            "type": "Selling",
            "status": "Past",
            "postedDate": "2020-04-06",
            "dueDate": null,
            "untilDate": "2020-05-15",
            "createdAt": "2026-01-06T23:48:49.113115Z",
            "purchaseAmount": null,
            "buyerId": "b7883e15-cce8-40fe-9f36-3bdef21beb0a",
            "buyerName": "Options For Youth San Gabriel District",
            "buyerType": "SchoolDistrict",
            "buyerState": "CA",
            "documentType": null
          },
          {
            "id": "dbd0d355-6ae6-4bb1-9a3e-305334283d72",
            "title": "Career Readiness and Exploration Services 2025 (RFP)",
            "summary": "Career readiness and exploration services 2025. ",
            "type": "Selling",
            "status": "Past",
            "postedDate": "2025-10-08",
            "dueDate": null,
            "untilDate": "2025-11-07",
            "createdAt": "2025-10-17T13:00:31.557105Z",
            "purchaseAmount": null,
            "buyerId": "889d5a0c-b22e-4112-8292-1ae729c926ba",
            "buyerName": "Detroit Employment Solutions Corporation (DESC)",
            "buyerType": "SpecialDistrict",
            "buyerState": "MI",
            "documentType": null
          },
          {
            "id": "c5ad268e-f940-495e-a76a-648a4a21dc44",
            "title": "College and Career Readiness Platform (RFP)",
            "summary": "Provide a web-based, k-12 comprehensive college and career readiness platform.",
            "type": "Selling",
            "status": "Past",
            "postedDate": "2025-01-24",
            "dueDate": null,
            "untilDate": "2025-02-25",
            "createdAt": "2025-01-25T08:23:14.112064Z",
            "purchaseAmount": null,
            "buyerId": "1cd0fbd7-0cf9-4648-b9c3-a825a539ee16",
            "buyerName": "Fulton County School District",
            "buyerType": "SchoolDistrict",
            "buyerState": "GA",
            "documentType": null
          },
          {
            "id": "5e406bc5-899a-412c-9739-cfe2b0de6dc8",
            "title": "College and Career Readiness Software (RFP)",
            "summary": "Provide college and career readiness software. ",
            "type": "Selling",
            "status": "Past",
            "postedDate": "2025-04-26",
            "dueDate": null,
            "untilDate": "2025-05-12",
            "createdAt": "2025-04-29T16:03:55.406037Z",
            "purchaseAmount": null,
            "buyerId": "a8a4ec24-0d19-4682-9857-49d16ce780ff",
            "buyerName": "Harlingen Consolidated Independent School District",
            "buyerType": "SchoolDistrict",
            "buyerState": "TX",
            "documentType": null
          }
        ]
      }
    }
  },
  {
    "step": "s4_rank_and_select",
    "status": "success",
    "duration_seconds": 0.001,
    "message": "Featured=Allentown School District, 52 total buyers",
    "created_at": "2026-02-19 12:36:56",
    "metadata": {
      "FEATURED": {
        "name": "Allentown School District",
        "id": "5c9566d3-9a6c-4db0-93ab-c0dda6cd2e6b",
        "score": 0.8435,
        "signals": 4
      },
      "SECONDARY_BUYERS": {
        "_count": 4,
        "_sample": [
          {
            "name": "Savannah-Chatham County School District",
            "score": 0.7168
          },
          {
            "name": "Texas Workforce Commission",
            "score": 0.7037
          },
          {
            "name": "Options For Youth San Gabriel District",
            "score": 0.6941
          },
          {
            "name": "University Of South Carolina Columbia",
            "score": 0.6925
          }
        ]
      },
      "TOTAL_SCORED": 52
    }
  },
  {
    "step": "s5_persist_discovery",
    "status": "success",
    "duration_seconds": 0.008,
    "message": "run_id=55, 52 discoveries",
    "created_at": "2026-02-19 12:36:56",
    "metadata": {
      "discoveries": 52,
      "run_id": 55
    }
  },
  {
    "step": "s8_exec_summary",
    "status": "success",
    "duration_seconds": 0.0,
    "message": "80 signals, 52 buyers, featured=Allentown School District",
    "created_at": "2026-02-19 12:36:56",
    "metadata": {
      "SECTION_EXEC_SUMMARY": "We scanned **80 procurement signals** across **52 SLED buyers** in the Higher Education and School District and State Agency space for **VMock**. Leading match: **Allentown School District** (School District), with the strongest combination of signal recency, urgency, and relevance."
    }
  },
  {
    "step": "s11_cta",
    "status": "success",
    "duration_seconds": 0.0,
    "message": "80 signals, 52 buyers",
    "created_at": "2026-02-19 12:36:56",
    "metadata": {
      "SECTION_CTA": "## What Starbridge Can Do\n\nStarbridge monitors **296,000+ government and education buyers** across all 50 states, with **107M+ indexed board meetings and procurement records**. For VMock targeting Higher Education, School District, State Agency buyers, we surface:\n\n- **Active procurement signals** — RFPs, contract expirations, board discussions, and budget allocations\n- **Verified decision-maker contacts** — directors, VPs, superintendents, and budget authorities\n- **AI-powered buyer analysis** — strategic context synthesized from public records and FOIA data\n\nThis scan surfaced **80 signals** across **52 buyers** in the Higher Education, School District, State Agency space."
    }
  },
  {
    "step": "s6_buyer_profile",
    "status": "success",
    "duration_seconds": 3.169,
    "message": "",
    "created_at": "2026-02-19 12:36:59",
    "metadata": {
      "FEAT_PROFILE": {
        "id": "5c9566d3-9a6c-4db0-93ab-c0dda6cd2e6b",
        "name": "Allentown School District",
        "countryCode": "US",
        "stateCode": "PA",
        "url": "http://www.allentownsd.org",
        "foiaRequestContactId": "c9d86807-f908-4c71-a0dd-949d16e60fa7",
        "foiaRequestFormUrl": "https://resources.finalsite.net/images/v1708021984/allentownsdorg/fqrj7bz0lhkr7zi5umgc/UpdatedRighttoKnowForm_2.pdf",
        "tags": [
          "SchoolDistrict"
        ],
        "metadata": {
          "agency": {
            "category": "School District"
          },
          "source": {
            "id": "105378",
            "file": "https://storage.cloud.google.com/starbridge-imported-files/buyer-import/01/10/2024/output_v5.csv",
            "name": "csv_NCES"
          },
          "address": {
            "zip": "18105",
            "city": "Allentown",
            "phone": "(484)765-4000",
            "state": "PA",
            "country": "US",
            "street1": "31 S Penn Street",
            "website": "http://www.allentownsd.org/"
          },
          "contact": {
            "phone": "(484)765-4000"
          },
          "originalName": "Allentown City School District"
        },
        "zip": "18105",
        "source": "csv_NCES",
        "mainId": "5c9566d3-9a6c-4db0-93ab-c0dda6cd2e6b",
        "main": true,
        "nameNormalized": "allentown school district",
        "city": "Allentown",
        "type": "SchoolDistrict",
        "prime": true,
        "extraData": {
          "commonName": "Allentown SD",
          "procurementHellScore": 62,
          "angelProcurementSummary": "## **QUICK DECISION FLOW**\n\n\n   1. Sole Source: If sale is less than $21,000, use sole source.\n   2. Coops: Lead with Sourcewell; for IT, route via CDW-G on a cooperative contract.\n   3. Resellers: If IT-focused, engage CDW-G and keep the purchase on a co-op.\n\n\n\n---\n\n## **SOLE SOURCE**\n\n\n   Allentown School District, PA: Given the district's rare or non-existent use of sole source contracts above the $21,000 competitive bidding threshold, redirect this effort to cooperative purchasing channels. This approach offers a pre-competed, faster path to approval and avoids the high risk and procedural hurdles of pursuing a sole source justification with the district.\n\n\n\n---\n\n## **COOPERATIVES**\n\n\n   Allentown School District has used cooperative purchasing before (confirmed Sourcewell participant).\n   - COSTARS: Pennsylvania’s statewide cooperative program for local public procurement units; Allentown School District can register and buy directly from awarded suppliers without rebidding.\n   - PEPPM National Cooperative Purchasing Program: Technology-focused cooperative administered by a Pennsylvania IU with K-12 eligibility; ideal for IT, devices, peripherals, and edtech purchases.\n   - Keystone Purchasing Network (KPN): Pennsylvania IU-administered national cooperative with a broad K-12-friendly portfolio; useful for facilities, furniture, services, and instructional needs.\n   - Lancaster-Lebanon IU13 – Collaborative Purchasing Solutions (CPS): Statewide IU-run cooperative-style solicitations available to all Pennsylvania public procurement units; helpful for turnkey bids and vendor awards beyond just technology.\n\n\n\n---\n\n## **RESELLERS**\n\n\n   The district has purchased using resellers before (confirmed history with CDW-G for IT infrastructure).\n   - CDW Government (CDW-G)\n   - CDW Government LLC\n   - SHI International Corp.\n   - Connection Public Sector (GovConnection)",
          "totalEnrollment": 16769,
          "ncesId": 4202280,
          "ncesIdString": "4202280",
          "ncesStateDistrictId": "PA-121390302",
          "county": "Lehigh",
          "street1": "31 S Penn Street",
          "mainPhoneNumber": "(484) 765-4000",
          "sis": "Sapphire",
          "lms": "Google Classroom",
          "lmsArray": [
            "GoogleClassroom"
          ],
          "schoolDistrictLocale": "City",
          "schoolDistrictFteEquivalentTeachers": 1050,
          "schoolDistrictLowestGradeOffered": -1,
          "schoolDistrictHighestGradeOffered": 12,
          "schoolDistrictType": "RegularLocalDistrict",
          "schoolDistrictNumberOfSchools": 21,
          "schoolDistrictElementarySchools": 14,
          "schoolDistrictMiddleSchools": 4,
          "schoolDistrictHighSchools": 3,
          "schoolDistrictTotalStaff": 2535.7,
          "schoolDistrictMedianHouseholdIncome": 51704,
          "englishLearners": 15.8,
          "fiscalYearStartDate": "07/01",
          "employeeFte": 2535.7,
          "location": {
            "lat": 40.60296,
            "lon": -75.46632
          },
          "logoPath": "https://storage.googleapis.com/starbridge-fe-static/logo/61429df5-066c-426f-9b58-2513da6b822b.png",
          "freeOrReducedLunchEligiblePercentage": 99,
          "propensityToSpendScore": 78,
          "propensityToSpendSummary": "The district's adopted General Fund rose about 10.66% to $483.4M driven largely by substantial state funding increases (including a large Ready to Learn boost) while the local millage remained unchanged. Significant capital projects are active in planning (Dieruff practice field upgrades and a new K–8 East Side campus), indicating willingness to fund capital investments. However, an October state budget impasse that delayed payments prompted temporary spending controls and the district has new multi‑year labor contracts that increase recurring personnel costs, creating near‑term cash‑flow caution and ongoing cost pressure. Net effect: strengthened near‑term purchasing capacity and openness to opportunistic investments with prudent selectivity around discretionary spending until cash‑flow normalizes and recurring cost impacts are absorbed.",
          "budgetChangeAnalysisSourceUrls": [
            "https://www.pa.gov/content/dam/copapwp-pagov/en/education/documents/schools/grants-and-funding/school-finances/finances/gfbdata/2025-26/2025-26%20gfb%20allentown%20city%20sd.pdf",
            "https://resources.finalsite.net/images/v1717173351/allentownsdorg/q1hyewwcfuhlacdf709z/2024-2025ProposedBudget.pdf",
            "https://www.facebook.com/groups/ASDID/posts/24021364847529121/",
            "https://citizenportal.ai/articles/6183540/Pennsylvania/Finance-committee-advances-Allentown-School-Districts-202526-budget-to-full-board",
            "https://www.facebook.com/groups/ASDID/posts/any-updates-on-the-mandatory-superintendent-review-or-is-she-just-keeping-this-8/24681495318182734/",
            "https://www.lehighvalleynews.com/school-news/allentown-school-district-plans-to-hold-the-line-on-taxes-for-3rd-consecutive-year",
            "http://www.allentownsd.org/schoolboard",
            "https://citizenportal.ai/articles/6236606/Pennsylvania/Allentown-School-District-leaders-present-balanced-4815-million-202526-budget-pledge-no-local-tax-increase",
            "https://www.wfmz.com/news/area/lehighvalley/interim-cfo-presents-districts-proposed-436-million-2024-25-budget/article_ded6bc0c-f884-11ee-86b8-f3212697215c.html",
            "https://www.lehighvalleynews.com/school-news/allentown-school-board-approves-483-4-million-budget-holds-line-on-taxes-for-3rd-year-straight"
          ],
          "propensityToSpend": "OpenToSpend",
          "yoyChangeInEnrollment": 1.58,
          "enrollmentTrend": "ModeratelyIncreasing",
          "enrollmentTrendBasedOnFte": false,
          "schoolDistrictTotalStudents": 16510,
          "procurementHellSummary": "SCORE: 62 / 100\n\nREASONING:\n\nSole Source (20%): Scored 10, reflecting the rare or non-existent use of sole source contracts above the competitive bidding threshold, indicating a competitive procurement environment. The environment is very restrictive regarding sole-sourcing.\n\nCo-op Participation (40%): Scored 60, reflecting occasional cooperative purchasing participation, with confirmed membership in Sourcewell and PEPPM. However, public records lack explicit details regarding contracts awarded through this mechanism.\n\nReseller Engagement (10%): Scored 65, reflecting occasional reseller engagements, primarily for IT infrastructure, with a confirmed instance of using CDW-G. Visibility into other reseller contracts is limited by the district's procurement portal.\n\nVendor Barriers (15%): Scored 75, reflecting significant vendor barriers, including extensive insurance and bonding requirements, and substantial local preference policies, despite a simple vendor registration process.\n\nProcurement Thresholds (15%): Scored 68, reflecting a relatively low competitive bidding threshold of $21,000, which necessitates frequent formal procurement processes for moderately sized purchases. Pennsylvania's procurement regulations, including the Public School Code and annually adjusted bidding thresholds (>$23,800 for 2025), impose a moderate level of complexity.\n\nOverall synthesis: The Allentown School District's procurement process is characterized as moderately difficult, with a score of 62. The primary drivers of this friction are significant vendor barriers (extensive insurance/bonding, local preference) and a low competitive bidding threshold that triggers frequent formal solicitations. While the district's minimal reliance on sole-source contracts is a positive aspect, its impact is somewhat offset by only occasional use of cooperative purchasing and reseller channels. The district's confirmed use of multiple cooperative purchasing agreements, including PEPPM and Sourcewell, provides significant alternative pathways for vendors, mitigating some of the friction. Vendors should anticipate a structured and demanding procurement process, with some potential for streamlined engagement through established IT resellers and cooperative contracts.\n\nSOURCE URLs:\n\nhttp://www.allentownsd.org"
        },
        "createdAt": "2024-10-01T18:08:45.095656Z",
        "updatedAt": "2025-10-31T00:00:42.148943Z"
      }
    }
  },
  {
    "step": "s6_buyer_contacts",
    "status": "success",
    "duration_seconds": 0.419,
    "message": "47 contacts",
    "created_at": "2026-02-19 12:36:59",
    "metadata": {
      "FEAT_CONTACTS": {
        "_count": 47,
        "_sample": [
          {
            "contactId": "05af1a74-ee92-44a5-a84f-62feb9e6717a",
            "name": "Jennifer Aponte",
            "firstName": "Jennifer",
            "lastName": "Aponte",
            "middleName": null,
            "salutation": "Mrs.",
            "title": "Principal",
            "normalizedTitles": [
              "Principal"
            ],
            "email": "apontej@allentownsd.org",
            "phone": "+1-484-765-5681",
            "linkedInUrl": null,
            "worksAtBuyer": true,
            "source": "WebAgent",
            "foiaRequestContact": false,
            "metadataV2": {
              "worksAtBuyerRunId": "trun_8f84ca30d6fb47778529e5c329a37e35",
              "findContactRunId": "trun_047c230ba85e4164990cd501281bda18",
              "foundByWebAgentModel": "Pro"
            }
          },
          {
            "contactId": "e4b1826c-bc98-4931-b29b-fcf2c103e087",
            "name": "Carol D. Birks",
            "firstName": "Carol",
            "lastName": "Birks",
            "middleName": "D.",
            "salutation": "Dr.",
            "title": "Superintendent / Chief Executive Officer",
            "normalizedTitles": [
              "Chief Executive Officer",
              "Superintendent",
              "Chief",
              "Executive Officer"
            ],
            "email": "birksc@allentownsd.org",
            "phone": "+1-484-765-4235",
            "linkedInUrl": null,
            "worksAtBuyer": true,
            "source": "WebAgent",
            "foiaRequestContact": false,
            "metadataV2": {
              "worksAtBuyerRunId": "trun_12d19ab17dfc4f26b286ca78609e2970",
              "findContactRunId": "trun_047c230ba85e4164a51a3e43fe1eec85",
              "foundByWebAgentModel": "Pro"
            }
          },
          {
            "contactId": "5ea23ea5-24e6-4023-9dd6-412d0cf7b12a",
            "name": "Andrene Brown-Nowell",
            "firstName": "Andrene",
            "lastName": "Brown-Nowell",
            "middleName": null,
            "salutation": "Ms.",
            "title": "President",
            "normalizedTitles": [
              "President"
            ],
            "email": "nowella@allentownsd.org",
            "phone": "+1-484-765-4000",
            "linkedInUrl": null,
            "worksAtBuyer": true,
            "source": "WebAgent",
            "foiaRequestContact": false,
            "metadataV2": {
              "worksAtBuyerRunId": "trun_bc61097a6828477487a1210bd7e667ca",
              "findContactRunId": "trun_047c230ba85e416492feb890213cbd7f",
              "foundByWebAgentModel": "Pro"
            }
          },
          {
            "contactId": "5f7061b9-37db-4c4e-aaf2-f66652071b1a",
            "name": "Josephine Cacace",
            "firstName": "Josephine",
            "lastName": "Cacace",
            "middleName": null,
            "salutation": "Ms.",
            "title": "Director of Finance",
            "normalizedTitles": [
              "Director of Finance",
              "Director"
            ],
            "email": "cacacej@allentownsd.org",
            "phone": "+1-484-765-4000",
            "linkedInUrl": null,
            "worksAtBuyer": true,
            "source": "WebAgent",
            "foiaRequestContact": false,
            "metadataV2": {
              "worksAtBuyerRunId": "trun_a70b06f124904526a5657a68d37daab7",
              "findContactRunId": "trun_047c230ba85e4164b98b19b9d5b7350e",
              "foundByWebAgentModel": "Pro"
            }
          },
          {
            "contactId": "ccda4f5a-dfe7-4fb8-8767-b0359029d2d1",
            "name": "Cari Cantor",
            "firstName": "Cari",
            "lastName": "Cantor",
            "middleName": null,
            "salutation": "Ms.",
            "title": "Director of Federal Programs",
            "normalizedTitles": [
              "Director of Federal Programs"
            ],
            "email": "cantorc@allentownsd.org",
            "phone": null,
            "linkedInUrl": null,
            "worksAtBuyer": true,
            "source": "WebAgent",
            "foiaRequestContact": false,
            "metadataV2": {
              "worksAtBuyerRunId": "trun_51df0254ab264a44bfdf728c532ad049",
              "findContactRunId": "trun_3940873bcb284a4e96696d35acb461ed",
              "foundByWebAgentModel": "Pro"
            }
          },
          {
            "contactId": "ccf29e0e-4f77-4f68-825b-047b5a58c7ad",
            "name": "Cattima Cirksey",
            "firstName": "Cattima",
            "lastName": "Cirksey",
            "middleName": null,
            "salutation": "Dr.",
            "title": "Director of Family and Community Engagement",
            "normalizedTitles": [
              "Director of Community Engagement",
              "Director of Family Engagement"
            ],
            "email": "cirkseyc@allentownsd.org",
            "phone": "+1-484-765-4000",
            "linkedInUrl": null,
            "worksAtBuyer": true,
            "source": "WebAgent",
            "foiaRequestContact": false,
            "metadataV2": {
              "worksAtBuyerRunId": "trun_51df0254ab264a44b8600ba815592b00",
              "findContactRunId": "trun_3940873bcb284a4eb61ce7cb8f865422",
              "foundByWebAgentModel": "Pro"
            }
          },
          {
            "contactId": "006fa133-a220-4efd-8773-1982a55b9827",
            "name": "George Clay",
            "firstName": "George",
            "lastName": "Clay",
            "middleName": null,
            "salutation": null,
            "title": "Assistant Director of Safety and Security",
            "normalizedTitles": [
              "Assistant Director of Safety",
              "Assistant Director of Security"
            ],
            "email": "claygf@allentownsd.org",
            "phone": "+1-484-765-4130",
            "linkedInUrl": null,
            "worksAtBuyer": true,
            "source": "WebAgent",
            "foiaRequestContact": false,
            "metadataV2": {
              "worksAtBuyerRunId": "trun_b8617b9561414b0aaf5e35ea3818aada",
              "findContactRunId": "trun_67cddcfe8ce64732b72dc31a2bbb53c5",
              "foundByWebAgentModel": "Pro"
            }
          },
          {
            "contactId": "f0b81eb5-4cff-4393-a93f-2ee6c4c22166",
            "name": "Amelia Coleman",
            "firstName": "Amelia",
            "lastName": "Coleman",
            "middleName": null,
            "salutation": "Dr.",
            "title": "Deputy Superintendent, Chief Academic Officer",
            "normalizedTitles": [
              "Chief Academic Officer",
              "Deputy Superintendent",
              "Academic Officer",
              "Chief",
              "Deputy",
              "Superintendent"
            ],
            "email": "colemana@allentownsd.org",
            "phone": "+1-484-765-4277",
            "linkedInUrl": null,
            "worksAtBuyer": true,
            "source": "WebAgent",
            "foiaRequestContact": false,
            "metadataV2": {
              "worksAtBuyerRunId": "trun_219b05ab9e214f2cab90a4c5a7050e9a",
              "findContactRunId": "trun_047c230ba85e4164ba14bcd96cdd041c",
              "foundByWebAgentModel": "Pro"
            }
          },
          {
            "contactId": "2449d129-90f1-441f-9509-43b4f6f0b2a0",
            "name": "Sarah Cummings",
            "firstName": "Sarah",
            "lastName": "Cummings",
            "middleName": null,
            "salutation": "Dr.",
            "title": "Intervention Specialist",
            "normalizedTitles": [
              "Specialist of Intervention"
            ],
            "email": "cummingss@allentownsd.org",
            "phone": "+1-484-765-5661",
            "linkedInUrl": null,
            "worksAtBuyer": true,
            "source": "WebAgent",
            "foiaRequestContact": false,
            "metadataV2": {
              "worksAtBuyerRunId": "trun_bc61097a68284774a9c959c8fa168774",
              "findContactRunId": "trun_047c230ba85e4164909009f9594ed269",
              "foundByWebAgentModel": "Pro"
            }
          },
          {
            "contactId": "f609f8ad-6eea-4709-9380-f5a1d7d91a12",
            "name": "Jorge J. Delfin",
            "firstName": "Jorge",
            "lastName": "Delfin",
            "middleName": "J.",
            "salutation": "Mr.",
            "title": "Executive Director of Technology",
            "normalizedTitles": [
              "Executive Director of Technology"
            ],
            "email": "delfinj@allentownsd.org",
            "phone": "+1-484-765-4212",
            "linkedInUrl": null,
            "worksAtBuyer": true,
            "source": "WebAgent",
            "foiaRequestContact": false,
            "metadataV2": {
              "findContactRunId": "trun_047c230ba85e4164a3f1e258036dda0d",
              "foundByWebAgentModel": "Core"
            }
          }
        ]
      }
    }
  },
  {
    "step": "s7_secondary_intel",
    "status": "success",
    "duration_seconds": 7.293,
    "message": "4 profiles, 4 contact sets",
    "created_at": "2026-02-19 12:37:03",
    "metadata": {
      "SEC_PROFILES": {
        "_count": 4,
        "_sample": [
          {
            "resolved_buyer_id": "b7883e15-cce8-40fe-9f36-3bdef21beb0a",
            "search_query_used": null,
            "profile": {
              "id": "b7883e15-cce8-40fe-9f36-3bdef21beb0a",
              "name": "Options For Youth San Gabriel District",
              "parentId": "1086cba2-1029-45d1-825f-ad432ab2d42d",
              "countryCode": "US",
              "stateCode": "CA",
              "url": "https://ofy-sg.org/",
              "foiaRequestContactId": "b4800fb3-1bac-4af8-b918-08e7f8da4aa7",
              "foiaRequestFormUrl": "https://alltechsi.formstack.com/forms/transcript",
              "foiaRequestMethod": "Email",
              "tags": [
                "SchoolDistrict"
              ],
              "metadata": {
                "agency": {
                  "category": "School District"
                },
                "source": {
                  "id": "92897",
                  "file": "https://storage.cloud.google.com/starbridge-imported-files/buyer-import/01/10/2024/output_v5.csv",
                  "name": "csv_NCES"
                },
                "address": {
                  "zip": "91776",
                  "city": "San Gabriel",
                  "phone": "(626)282-0390",
                  "state": "CA",
                  "country": "US",
                  "street1": "215 S. Mission Dr.",
                  "website": "http://www.ofy.org"
                },
                "contact": {
                  "phone": "(626)282-0390"
                },
                "cleanedName": "Options For Youth San Gabriel School District",
                "originalName": "Options For Youth San Gabriel District"
              },
              "zip": "91776",
              "source": "csv_NCES",
              "mainId": "b7883e15-cce8-40fe-9f36-3bdef21beb0a",
              "main": true,
              "nameNormalized": "options for youth san gabriel school district",
              "linkedOn": "2024-11-01T20:26:59.039368Z",
              "linkedBy": "merge_rollback_for_csv_file",
              "parentLinkedOn": "2024-11-01T17:34:24.724958Z",
              "parentLinkedBy": "csv",
              "city": "San Gabriel",
              "type": "SchoolDistrict",
              "prime": true,
              "extraData": {
                "commonName": "Options For Youth San Gabriel",
                "totalEnrollment": 244,
                "ncesId": 602398,
                "ncesIdString": "0602398",
                "ncesStateDistrictId": "CA-1996016",
                "county": "Los Angeles",
                "street1": "215 S. Mission Dr.",
                "mainPhoneNumber": "(626) 962-3311",
                "parentName": "Options For Youth Charter Schools",
                "higherEdMascot": "Lions",
                "lms": "Google Classroom",
                "lmsArray": [
                  "GoogleClassroom"
                ],
                "schoolDistrictLocale": "Suburb",
                "schoolDistrictFteEquivalentTeachers": 9.77,
                "schoolDistrictLowestGradeOffered": 7,
                "schoolDistrictHighestGradeOffered": 12,
                "schoolDistrictType": "CharterDistrict",
                "schoolDistrictNumberOfSchools": 1,
                "schoolDistrictElementarySchools": 0,
                "schoolDistrictMiddleSchools": 0,
                "schoolDistrictHighSchools": 1,
                "schoolDistrictTotalStaff": 18.43,
                "englishLearners": 4.1,
                "employeeFte": 18.4,
                "location": {
                  "lat": 34.10024,
                  "lon": -118.1105
                },
                "freeOrReducedLunchEligiblePercentage": 77,
                "schoolDistrictTotalStudents": 226
              },
              "createdAt": "2024-10-01T17:40:11.647820Z",
              "updatedAt": "2025-12-09T19:04:11.890002Z"
            }
          },
          {
            "resolved_buyer_id": "65413dde-08e8-4227-803f-c704eff5e941",
            "search_query_used": null,
            "profile": {
              "id": "65413dde-08e8-4227-803f-c704eff5e941",
              "name": "University Of South Carolina Columbia",
              "parentId": "6e63d4a4-1324-4e37-9df0-f22bd5a8a03c",
              "countryCode": "US",
              "stateCode": "SC",
              "url": "http://sc.edu",
              "foiaRequestContactId": "dc8f5ad7-7086-476d-b18d-0b22038ce856",
              "foiaRequestFormUrl": "https://universityofsouthcarolina.justfoia.com/Forms/Launch/d705cbd6-1396-49b7-939e-8d86c5a87deb",
              "foiaRequestMethod": "OnlineForm",
              "tags": [
                "ResearchInstitution",
                "HigherEducation"
              ],
              "metadata": {
                "agency": {
                  "category": "Research Institution"
                },
                "source": {
                  "id": "81235",
                  "file": "https://storage.cloud.google.com/starbridge-imported-files/buyer-import/01/10/2024/output_v5.csv",
                  "name": "csv_MUCKROCK"
                },
                "address": {
                  "state": "SC",
                  "country": "US",
                  "website": "http://www.sc.edu/"
                },
                "contact": {},
                "originalName": "University Of South Carolina Columbia"
              },
              "zip": "29208",
              "source": "csv_COURSEDOG",
              "mainId": "65413dde-08e8-4227-803f-c704eff5e941",
              "main": true,
              "nameNormalized": "university of south carolina columbia",
              "parentLinkedOn": "2024-11-01T17:34:24.724958Z",
              "parentLinkedBy": "csv",
              "city": "Columbia",
              "type": "HigherEducation",
              "prime": true,
              "extraData": {
                "commonName": "UofSC Columbia",
                "aiAdoptionScore": 73,
                "aiAdoptionSummary": "**Sentiment**: Enthusiastic\n\n\n \n**Reasoning**:\n\nThe University of South Carolina demonstrates clear, institution-level commitment to AI through a published AI roadmap, an active Artificial Intelligence Institute, and tangible deployments and pilots (e.g., Microsoft 365 Copilot) across faculty, staff, and students. Procurement and experimentation with vendor tools (Element451, OpenAI, Google Gemini) plus a strong startup/incubator ecosystem and technology commercialization support indicate the university is moving beyond curiosity into operational adoption and innovation enablement. Although board-level oversight appears limited, the overall evidence shows coordinated strategy, investment, and integration across research, education, and administrative functions consistent with an enthusiastic adoption posture.\n\n\n \n**Evidence**:\n* The university published a \"Roadmap for Artificial Intelligence Application in Research,\" outlining initiatives like the Carolina Grants and Innovation Hub and centralized research databases.\n* The Division of IT officially launched Microsoft 365 Copilot (user group of 50+ faculty, staff, and students) to pilot administrative, educational, and research uses, and is actively exploring tools such as Element451, OpenAI, and Google Gemini.\n* The Artificial Intelligence Institute of South Carolina (AIISC) serves as an institution-wide task force fostering interdisciplinary collaboration for research, education, workforce, and economic development—demonstrating organizational governance for AI activities.\n* USC is executing a hybrid-cloud strategy (custom SDDC with DartPoints, Cloud Transformation Program) while maintaining compliance-conscious on-prem systems, showing infrastructure investment to support scalable AI workloads.",
                "startupFriendlinessScore": 72,
                "startupFriendlinessSummary": "The USC/Columbia Technology Incubator serves as a regional hub housing over 40 early-stage technology and innovation-based startups, offering free counseling, mentoring, shared resources and support programs. The Technology Commercialization Office provides entrepreneurs with IP protection services, SBIR/STTR resources, connections to incubator and accelerator resources, and support for turning USC inventions into sustainable spinout companies. Additional innovation facilities include the Center for Applied Innovation and Advanced Analytics and the Digital Transformation Lab.",
                "procurementHellScore": 68,
                "angelProcurementSummary": "## **QUICK DECISION FLOW**\n\n\n   1. Sole Source: If the need is proprietary or requires exact compatibility/continuity of research, pursue a sole source with Purchasing and the department.\n   2. Coops: If a state-approved cooperative (e.g., Sourcewell) or a statewide term contract applies, ask Purchasing to validate and proceed.\n   3. Resellers: Route through a reseller on South Carolina statewide contracts for the fastest path.\n\n\n\n---\n\n## **SOLE SOURCE**\n\n\n   - Entity: University of South Carolina (Columbia, SC)\n   - When to use: Product is proprietary or uniquely essential for specialized research/grant projects, or required for compatibility with existing critical systems/continuity of research.\n   - Documentation: Work with the end-user to draft a detailed sole source justification addressing vendor exclusivity, equipment/system compatibility, and continuity of research.\n   - Public notice: Intent to sole source must be publicly advertised for contracts over $50,000.\n   - Approvals: Board of Trustees approval is required for any contract exceeding $650,000.\n\n\n\n---\n\n## **COOPERATIVES**\n\n\n   USC uses cooperative purchasing selectively, with emphasis on state-approved options due to South Carolina’s anti-piggybacking rules. Always have Purchasing validate eligibility and use.\n   - Statewide Term Contracts (Goods & Services & IT): Mandatory and convenient; USC can buy directly from awarded vendors during the contract term.\n   - NASPO ValuePoint: Broad, lead-state cooperative widely used in SC; aligns with USC eligibility and offers many statewide solutions.\n   - E&I Cooperative Services: Higher-education–focused; competitively sourced contracts tailored to universities.\n   - OMNIA Partners (Public Sector): Large national cooperative open to higher education with extensive contracts.\n\n\n\n---\n\n## **RESELLERS**\n\n\n   USC has purchased through resellers using South Carolina statewide contracts.\n   - CDW Government (CDW-G)\n   - SHI International Corp\n   - Carahsoft Technology Corp.\n   - Ingram Micro Public Sector LLC.",
                "ipedsId": 218663,
                "ipedsIdString": "218663",
                "totalEnrollment": 36579,
                "county": "Richland",
                "street1": "1501 Pendleton St",
                "mainPhoneNumber": "(803) 777-0169",
                "parentName": "University Of South Carolina System",
                "higherEdGraduationRate": 78,
                "higherEdFullTimeEnrollment": 36731,
                "higherEdRetentionRate": 91,
                "higherEdGraduationEnrollment": 8109,
                "higherEdUndergradEnrollment": 28470,
                "higherEdControlOfInstitution": "Public",
                "higherEdLevelOfInstitution": "FourYears",
                "higherEdInstitutionType": "LargeResearchUniversity",
                "higherEdRecruitmentAdmissionsCrm": "Slate, Salesforce",
                "higherEdAdvisingStudentSuccessCrm": "EAB Navigate",
                "higherEdRecruitmentAdmissionsCrmArray": [
                  "Salesforce",
                  "TechnolutionsSlate"
                ],
                "higherEdAdvisingStudentSuccessCrmArray": [
                  "EABNavigate"
                ],
                "higherEdEndowment": 141354947,
                "higherEdCommonNameOfInstitution": "USC",
                "higherEdMascot": "Gamecocks",
                "higherEdNumberOfOnCampusResidents": 9340,
                "higherEdNumberOfFullTimeEmployees": 5209,
                "higherEdDegreeAuditVendor": "EllucianDegreeWorks",
                "higherEdCurriculumManagementVendor": "Leepfrog",
                "higherEdEventSchedulingVendor": "CollegeNet25Live",
                "higherEdProcurementThresholds": "Summary: Formal Bid Threshold: $100,000 | Sole Source Limit: $50,000\nDetails: Purchases up to $4,999.99: Use Purchasing Card if allowable, no quote required. Purchases $5,000-$10,000: Purchase Order required, one written quote demonstrating a fair and reasonable price. Purchases $10,000.01-$25,000: Written request and three bona fide responsive quotes required. If three quotes cannot be obtained, advertisement in South Carolina Business Opportunities publication required. Purchases $25,000.01-$100,000: Written request, advertisement, sealed bids or proposals required. Purchases above $100,000: Formal sealed solicitation process, advertisement required. Sole source procurements permitted up to $50,000 without additional advertisement. Additional advertisement is mandated for higher sole source amounts.",
                "sis": "EllucianBanner",
                "lms": "Blackboard",
                "lmsArray": [
                  "Blackboard"
                ],
                "fiscalYearStartDate": "07/01",
                "employeeFte": 5209,
                "location": {
                  "lat": 33.99488,
                  "lon": -81.0285
                },
                "logoPath": "https://storage.googleapis.com/starbridge-fe-static/logo/9e960026-e6d3-4f68-beed-445fa29486be.png",
                "propensityToSpendScore": 88,
                "propensityToSpendSummary": "Mary Anne Fitzpatrick, appointed Executive Vice President for Academic Affairs and Provost, signals continuity and an administrative posture supportive of strategic investments and likely smoother approvals for mission‑aligned procurements. FY2026 operating resources increased 10.6% to $1.806 billion, recurring state appropriations rose about $35.3M, enrollment and tuition gains add roughly $21.8M, and the campus holds approximately $701M in unrestricted balances (including ~$160M for one‑time commitments), creating strong near‑term purchasing capacity. Significant capital plans—including a $100M STEM building, $195M campus residential development, and multiple infrastructure and renovation projects—indicate active investment priorities across facilities and research support. A modest $1.7M audit finding and some one‑time commitments temper but do not materially constrain spending; overall posture is expansion‑oriented and ready to fund prioritized initiatives.",
                "budgetChangeAnalysisSourceUrls": [
                  "https://sc.edu/about/offices_and_divisions/board_of_trustees/news_and_updates/",
                  "https://www.columbiabusinessmonthly.com/2025/06/23/536346/usc-trustees-approve-2026-budget-no-tuition-increase-for-sc-residents",
                  "https://osa.sc.gov/wp-content/uploads/2025/10/USC-Annual-Comprehensive-Financial-Report-FY25-electronic-copy.pdf",
                  "https://sc.edu/about/offices_and_divisions/board_of_trustees/annual_board_report/2023_board_report_v2.pdf",
                  "https://sc.edu/about/offices_and_divisions/budget/documents/fy26_bot_budget_document_final.pdf",
                  "https://cms.sc.edu/about/offices_and_divisions/budget/documents/fy25_budgetdoc.pdf",
                  "https://www.dailygamecock.com/article/2024/07/usc-board-of-trustees-approves-budget-for-2025-fiscal-year-news-bassett",
                  "https://sc.edu/uofsc/posts/2025/06/board-of-trustees-approves-2026-budget.php"
                ],
                "propensityToSpend": "AggressiveSpender",
                "yoyChangeInEnrollment": 5.4,
                "enrollmentTrend": "StronglyIncreasing",
                "enrollmentTrendBasedOnFte": true,
                "procurementHellSummary": "SCORE: 68 / 100\n\n\n\nREASONING:\n\nSole Source (20%): Scored 60, reflecting a structured and regularly used, but highly controlled, sole-source process for specialized IT, research, and proprietary needs. Public notice via the South Carolina Business Opportunities (SCBO) portal for contracts over $50,000 and Board of Trustees approval for contracts over $650,000 indicate a formal, yet viable, path for non-competitive procurement.\n\nCo-op Participation (40%): Scored 60, reflecting moderate friction due to restrictive state policies. While the university is a participating agency in Sourcewell (Acct #8595) and can use state-adopted cooperative contracts, South Carolina law generally prohibits \"piggybacking,\" requiring upfront participation in solicitations. This severely limits the flexibility and efficiency typically offered by national cooperatives. The state's explicit prohibition on post-award \"piggybacking\" on cooperative contracts (per SC Code §11-35-4810) severely limits the use of national purchasing cooperatives, a primary channel for streamlined sales for many vendors.\n\nReseller Engagement (10%): Scored 40, reflecting evidence of established reseller channels. The availability of a statewide contract with a major IT reseller (CDW-G, #4400035249) and Board approval for large SaaS contracts (e.g., OpenAI) confirms that resellers are a viable procurement path, mitigating some friction from direct purchasing rules.\n\nVendor Barriers (15%): Scored 60, reflecting moderate vendor barriers typical of a state institution, including a multi-step supplier portal registration process and significant preference policies for in-state vendors that can disadvantage out-of-state suppliers. This includes an invitation-only registration process and significant insurance requirements.\n\nProcurement Thresholds (15%): Scored 70, reflecting high friction due to a low competitive bidding threshold of $10,000, which triggers formal procurement processes for many routine purchases. The requirement for Board of Trustees approval for sole source contracts over $650,000 adds a significant procedural layer for large-scale projects. This low $10,000 competitive bidding threshold triggers formal procurement processes for many routine purchases.\n\nOverall synthesis: The University of South Carolina presents a high-friction procurement environment, primarily driven by restrictive state laws that forbid piggybacking on cooperative contracts and a low $10,000 competitive bidding threshold that triggers formal processes for many purchases. As a large flagship university with an enrollment exceeding 38,000 students, its inherent bureaucracy and multi-layered approval structure, including the Board of Trustees and State Fiscal Authority, add to the complexity. While good digital transparency with its public-facing Supplier Portal for solicitations and awards, and established channels for sole-source and reseller contracts provide some clarity and alternative paths, they do not fully offset the significant procedural hurdles. The most influential factors driving the score are the restrictive state cooperative purchasing laws and the low $10,000 competitive bidding threshold. These are compounded by moderate vendor barriers, including an invitation-only registration process and significant insurance requirements. The final score reflects a challenging but navigable landscape where vendors must carefully follow state and institutional rules, with Board of Trustees oversight on all major contracts.\n\n\n\nSOURCE URLs:\n\nhttps://sc.edu/about/offices_and_divisions/purchasing/documents/purchasing_matrix.pdf\n\nhttps://supplier.ps.sc.edu/s/sourcing/sourcingGuest\n\nhttps://sc.edu/about/offices_and_divisions/controller/forms_and_policies/supplier_onboarding.php",
                "higherEdFiscalYearStart": "July01"
              },
              "createdAt": "2024-10-02T11:37:39.163282Z",
              "updatedAt": "2025-12-09T11:00:32.254406Z"
            }
          },
          {
            "resolved_buyer_id": "980fbc2c-6d06-4fbe-a1bf-60b11efae14b",
            "search_query_used": null,
            "profile": {
              "id": "980fbc2c-6d06-4fbe-a1bf-60b11efae14b",
              "name": "Savannah-Chatham County School District",
              "parentId": "ba6db9cc-12a1-401e-a91a-0606f759272f",
              "countryCode": "US",
              "stateCode": "GA",
              "url": "https://www.sccpss.com",
              "foiaRequestContactId": "dff54dc2-68f8-407c-92d1-5f3d01dd4fa3",
              "foiaRequestMethod": "Email",
              "tags": [
                "SchoolDistrict"
              ],
              "metadata": {
                "agency": {
                  "category": "School District"
                },
                "source": {
                  "id": "94611",
                  "file": "https://storage.cloud.google.com/starbridge-imported-files/buyer-import/01/10/2024/output_v5.csv",
                  "name": "csv_NCES"
                },
                "address": {
                  "zip": "31401",
                  "city": "Savannah",
                  "phone": "(912)201-5585",
                  "state": "GA",
                  "country": "US",
                  "street1": "208 Bull St"
                },
                "contact": {
                  "phone": "(912)201-5585"
                },
                "originalName": "Savannah-Chatham Co Sch Dist",
                "data-migrations": {
                  "url-import": "clay"
                }
              },
              "zip": "31401",
              "source": "csv_NCES",
              "mainId": "980fbc2c-6d06-4fbe-a1bf-60b11efae14b",
              "main": true,
              "nameNormalized": "savannahchatham county school district",
              "parentLinkedOn": "2024-11-01T19:02:25.373137Z",
              "parentLinkedBy": "sql_script_county_parent_update",
              "city": "Savannah",
              "type": "SchoolDistrict",
              "prime": true,
              "extraData": {
                "commonName": "Savannah-Chatham County SD",
                "procurementHellScore": 52,
                "angelProcurementSummary": "## **QUICK DECISION FLOW**\n\n\n   1. Sole Source: If uniquely proprietary and essential, pursue a direct sole-source under Policy DJE.\n   2. Coops: If your offering is on a cooperative (e.g., Sourcewell or GA statewide), route the purchase through the coop to bypass formal bidding.\n   3. Resellers: There is no evidence SCCPSS purchases through major resellers; they rely on direct procurement.\n\n\n\n---\n\n## **SOLE SOURCE**\n\n\n   Savannah-Chatham County School District, GA allows direct sole-source procurement when the product is proprietary and essential, per Policy DJE. Build internal support with the owning department (e.g., IT, Curriculum), then work with the Purchasing Department to draft a formal sole-source justification that meets Policy DJE exception criteria. Be prepared for Chief Financial Officer review for any contract exceeding $25,000. Past approvals used as precedent include iReady and Blue Line Solutions.\n\n\n\n---\n\n## **COOPERATIVES**\n\n\n   SCCPSS has used cooperative purchasing (confirmed use of Sourcewell) and allows it under Policy DJE to efficiently bypass formal bidding. Recommended programs to leverage:\n   - Georgia DOAS Statewide Contracts: Fastest, most compliant route for common goods/services for GA K-12.\n   - OMNIA Partners (Public Sector): Broad national portfolio to fill gaps when local/state options don’t fit.\n   - TIPS (The Interlocal Purchasing System): K-12 focused with strong compliance support.\n   - PEPPM National Cooperative: Technology-focused with extensive K-12 IT and classroom tech coverage.\n\n\n\n---\n\n## **RESELLERS**\n\n\n   There is no evidence SCCPSS purchases through major resellers; they rely on direct procurement. While this entity does not appear to use resellers today, the following may be worth suggesting they explore:\n   - Carahsoft Technology Corp.\n   - CDW Government (CDW-G)\n   - Insight Public Sector (Insight Enterprises)\n   - Connection Public Sector (Connection)",
                "totalEnrollment": 35744,
                "ncesId": 1301020,
                "ncesIdString": "1301020",
                "ncesStateDistrictId": "GA-625",
                "county": "Chatham",
                "street1": "208 Bull St",
                "mainPhoneNumber": "(912) 395-5600",
                "parentName": "Chatham County",
                "sis": "Powerschool",
                "lms": "Brightspace | Google Classroom | Microsoft Teams for Education",
                "lmsArray": [
                  "Brightspace",
                  "GoogleClassroom",
                  "MicrosoftTeamsForEducation"
                ],
                "schoolDistrictLocale": "City",
                "schoolDistrictFteEquivalentTeachers": 2710,
                "schoolDistrictLowestGradeOffered": -1,
                "schoolDistrictHighestGradeOffered": 12,
                "schoolDistrictType": "RegularLocalDistrict",
                "schoolDistrictNumberOfSchools": 58,
                "schoolDistrictElementarySchools": 33,
                "schoolDistrictMiddleSchools": 9,
                "schoolDistrictHighSchools": 12,
                "schoolDistrictTotalStaff": 5571.5,
                "schoolDistrictMedianHouseholdIncome": 66171,
                "englishLearners": 5.6,
                "fiscalYearStartDate": "07/01",
                "employeeFte": 5571.5,
                "location": {
                  "lat": 32.07634,
                  "lon": -81.09259
                },
                "logoPath": "https://storage.googleapis.com/starbridge-fe-static/logo/bcc075f3-2679-4ab3-a442-07def8c34ffa.png",
                "freeOrReducedLunchEligiblePercentage": 74,
                "propensityToSpendScore": 35,
                "propensityToSpendSummary": "Julian Robinson was named Chief Technology Officer; his appointment is a modest positive directional signal but no specific purchasing priorities were identified, so near‑term procurement posture is unchanged. The adopted FY26 General Fund increased 5.24% to $654.7M, but a 0.15‑mill rollback reducing local revenue by about $2.8M and targeted vacancy and central office cuts of roughly $25.6M materially tighten operating/discretionary capacity. Ongoing pressures from rising personnel costs (TRS and SHBP) and a newly approved homestead exemption that caps future tax growth further constrain flexibility. Significant capital projects are funded and prioritized, but operating purchases should be limited to mission‑critical items with clear, immediate ROI, so procurement will be selective and tactical.",
                "budgetChangeAnalysisSourceUrls": [
                  "https://resources.finalsite.net/images/v1746635228/spsccpsscom/azjudtwlj8cyeiqcqium/FY26PreliminaryBudgetBook.pdf",
                  "https://www.sccpss.com/departments/finance/budget",
                  "https://www.sccpss.com/departments/public-affairs/board-briefs",
                  "https://www.sccpss.com/news/news-landing-page/~board/district-news/post/highlights-from-the-june-4-2025-board-meeting",
                  "https://www.savannahnow.com/story/news/education/2025/06/26/savannah-chatham-school-board-approves-fy2026-millage-rate-and-budget-despite-debate/84350550007/",
                  "https://www.facebook.com/wtoc11/posts/the-savannah-chatham-county-public-school-system-has-tentatively-adopted-a-more-/1162124735954892/",
                  "https://www.wtoc.com/2025/06/04/sccpss-passes-tentative-more-than-940-million-budget-also-passes-tentative-millage-rate/",
                  "https://www.legis.ga.gov/api/document/docs/default-source/house-budget-and-research-office-document-library/2026-fiscal-year/fy_2026_bill_gov_rec_(hb_68).pdf?sfvrsn=cf4a86db_2",
                  "https://citizenportal.ai/articles/6229375/Georgia/Savannah-Chatham-County-schools-preview-FY2026-budget-emphasize-staffing-and-literacy?ss=&af=-15361&source=ballotpedia",
                  "https://governor.sc.gov/sites/governor/files/Documents/Executive-Budget/FY26%20Executive%20Budget%20Book%20-%20FINAL%20WEB%20VERSION.pdf"
                ],
                "propensityToSpend": "Selective",
                "yoyChangeInEnrollment": -0.18,
                "enrollmentTrend": "StableFlat",
                "enrollmentTrendBasedOnFte": false,
                "schoolDistrictTotalStudents": 35781,
                "procurementHellSummary": "SCORE: 52 / 100\n\nREASONING:\n\nSole Source (20%): Scored 60, reflecting occasional but high-value sole source usage for proprietary curriculum and IT software renewals, such as the $612,909 iReady contract, which limits competition for established platforms.\n\nCo-op Participation (40%): Scored 25, reflecting regular and authorized use of cooperative contracts, particularly Sourcewell for fleet management, which provides a streamlined procurement path for vendors on those agreements.\n\nReseller Engagement (10%): Scored 100, reflecting no evidence of engagement with major IT or general resellers like CDW-G, SHI, or Carahsoft, indicating vendors must engage with the district directly through formal competitive procurement channels.\n\nVendor Barriers (15%): Scored 60, reflecting moderate overall barriers driven by extensive insurance requirements, including $1M/$2M commercial general liability and $1M umbrella policies, which can be challenging for smaller vendors to meet. The district's large size introduces significant procedural bureaucracy and stricter compliance demands typical of large public entities.\n\nProcurement Thresholds (15%): Scored 25, reflecting a vendor-friendly formal competitive bidding threshold of $75,000 (per Policy DJE), which allows for more flexible procurement on a significant volume of smaller purchases.\n\nOverall synthesis: The district presents a moderately difficult procurement environment. While a high competitive bid threshold and active co-op program provide clear, navigable paths to entry, the complete lack of a reseller channel and extensive insurance requirements are significant barriers for vendors. The district's large size further contributes to procedural bureaucracy and stricter compliance demands. The final score reflects a district that is challenging but navigable, with clear, albeit rigid, paths to winning contracts for vendors who can meet the demanding insurance requirements or participate in cooperative agreements.\n\nSOURCE URLs:\n\nhttps://www.sccpss.com/divisions/procurement/Pages/default.aspx\n\nhttps://go.boarddocs.com/ga/sccpss/Board.nsf/Public\n\nhttps://nces.ed.gov/ccd/districtsearch/district_detail.asp?ID2=1301020"
              },
              "createdAt": "2024-10-01T17:44:00.357573Z",
              "updatedAt": "2025-10-14T15:41:02.095289Z"
            }
          },
          {
            "resolved_buyer_id": "3cf65af1-76c9-4c5d-997e-1ac7b83cfbd6",
            "search_query_used": null,
            "profile": {
              "id": "3cf65af1-76c9-4c5d-997e-1ac7b83cfbd6",
              "name": "Texas Workforce Commission",
              "parentId": "3f2504e0-4f89-11d3-9a0c-0305e82c3343",
              "countryCode": "US",
              "stateCode": "TX",
              "url": "https://www.twc.texas.gov",
              "foiaRequestContactId": "bfdc7b90-9e06-43b9-870a-e9f0d0f75f5e",
              "foiaRequestFormUrl": "https://twc.govqa.us/WEBAPP/_rs/(S(2g0dlqrg2cmspao30wps1gs0))/supporthome.aspx",
              "tags": [],
              "metadata": {
                "address": {
                  "zip": "78778",
                  "city": "Austin",
                  "street": "101 E 15th Street",
                  "stateCode": "TX",
                  "rawAddress": "101 E 15th Street Austin, TX 78778"
                },
                "originalName": "Texas Workforce Commission",
                "defaultCommonName": true
              },
              "zip": "78778",
              "source": "csv_state_agencies",
              "mainId": "3cf65af1-76c9-4c5d-997e-1ac7b83cfbd6",
              "main": true,
              "nameNormalized": "texas workforce commission",
              "parentLinkedOn": "2024-12-03T21:29:27.548697Z",
              "parentLinkedBy": "state_agency_import",
              "city": "Austin",
              "type": "StateAgency",
              "prime": true,
              "extraData": {
                "commonName": "Texas Workforce Commission",
                "county": "Travis",
                "street1": "101 E 15th St",
                "mainPhoneNumber": "(800) 628-5115",
                "parentName": "State of Texas",
                "budgetAmount": 5159755593,
                "budgetSbita": 470542310,
                "budgetLatestYear": 2025,
                "budgetConfidence": "Verified",
                "fiscalYearStartDate": "09/01",
                "employeeFte": 4723.6,
                "location": {
                  "lat": 30.27649,
                  "lon": -97.739
                },
                "logoPath": "https://storage.googleapis.com/starbridge-fe-static/logo/f5d426fe-c8c2-4953-b18c-94e62a856215.png"
              },
              "createdAt": "2024-12-03T15:23:53.868Z",
              "updatedAt": "2025-11-21T01:00:13.049845Z"
            }
          }
        ]
      },
      "SEC_CONTACTS": {
        "_count": 4,
        "_sample": [
          {
            "buyerId": "b7883e15-cce8-40fe-9f36-3bdef21beb0a",
            "buyerName": "Options For Youth San Gabriel District",
            "contacts": [
              {
                "contactId": "30f2b7f3-183c-44a5-bf82-f6272e7a988d",
                "name": "Megan Betry",
                "firstName": "Megan",
                "lastName": "Betry",
                "middleName": null,
                "salutation": null,
                "title": "Principal",
                "normalizedTitles": [
                  "Principal"
                ],
                "email": "mbetry@ofy.org",
                "phone": "+1-626-622-0640",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_51df0254ab264a4482ed844e87d58d4a",
                  "findContactRunId": "trun_3940873bcb284a4e865e271509fbd585",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-11-12T15:34:26.605770Z",
                "updatedAt": "2025-11-12T15:34:26.605770Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-11T05:00:20.111775Z"
              },
              {
                "contactId": "502c8dfe-9f1a-4827-ad84-a035973de63b",
                "name": "Jessica Cordova",
                "firstName": "Jessica",
                "lastName": "Cordova",
                "middleName": null,
                "salutation": null,
                "title": "Assistant Principal of Instructional Operations",
                "normalizedTitles": [
                  "Assistant Principal of Instructional Operations",
                  "Assistant Principal",
                  "Principal",
                  "Principal of Instructional Operations"
                ],
                "email": "jcordova@ofy.org",
                "phone": "+1-626-720-7165",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_3df7eb182f9c41cfa04e099cef85c22e",
                  "findContactRunId": "trun_047c230ba85e4164a262481b50be73f9",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-11-12T15:59:07.872615Z",
                "updatedAt": "2026-02-16T20:55:09.739547Z",
                "emailVerified": true,
                "emailLastChecked": "2026-01-12T05:00:26.616543Z"
              },
              {
                "contactId": "423678ba-1c51-4666-81a9-dd2856ee5da9",
                "name": "Jose Gonzalez",
                "firstName": "Jose",
                "lastName": "Gonzalez",
                "middleName": null,
                "salutation": null,
                "title": "Career Pathways Coordinator",
                "normalizedTitles": [
                  "Career Pathways Coordinator",
                  "Coordinator"
                ],
                "email": "josegonzalez@ofy.org",
                "phone": "+1-626-961-3044",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_3df7eb182f9c41cfb45341b13b2f28b3",
                  "findContactRunId": "trun_047c230ba85e4164ad03310a36c9d240",
                  "foundByWebAgentModel": "Pro",
                  "emailEnrichmentId": "58dce0c2-a3c8-4ab4-8452-2539a561a1ad"
                },
                "createdAt": "2026-02-13T13:36:35.854566Z",
                "updatedAt": "2026-02-13T13:36:35.854567Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-13T13:32:39.214445Z"
              },
              {
                "contactId": "51ed2d12-df9a-4823-8c7f-7054a576f1c8",
                "name": "Jane Gothold",
                "firstName": "Jane",
                "lastName": "Gothold",
                "middleName": null,
                "salutation": "Ms.",
                "title": "Chairperson and Board Member",
                "normalizedTitles": [
                  "Chairperson",
                  "Member of the Board"
                ],
                "email": "jgothold@ofy.org",
                "phone": null,
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_5c024a8efab14036ada4f6e6f4deebcd",
                  "findContactRunId": "trun_047c230ba85e4164b45fae60b3665252",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-12-26T05:03:52.293595Z",
                "updatedAt": "2025-12-27T06:46:48.751150Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-16T05:02:23.203616Z"
              },
              {
                "contactId": "099c85d2-874d-490c-b75b-bbad6dc0a37c",
                "name": "Susana Guardado",
                "firstName": "Susana",
                "lastName": "Guardado",
                "middleName": null,
                "salutation": null,
                "title": "APIP",
                "normalizedTitles": [
                  "APIP"
                ],
                "email": "susanaguardado@oflschools.org",
                "phone": "+1-626-282-0390",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_12d19ab17dfc4f26a039e8300d88bd6e",
                  "findContactRunId": "trun_047c230ba85e4164831bdd199486738c",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2026-02-08T13:37:50.045451Z",
                "updatedAt": "2026-02-08T13:37:50.045451Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-08T13:37:37.435928Z"
              },
              {
                "contactId": "0da78042-82a5-44d8-887a-2dd3aa6ecf66",
                "name": "Ileana Kiriakos",
                "firstName": "Ileana",
                "lastName": "Kiriakos",
                "middleName": null,
                "salutation": "Ms.",
                "title": "Superintendent",
                "normalizedTitles": [
                  "Superintendent"
                ],
                "email": "ileana@ofy.org",
                "phone": "+1-909-531-3015",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_3df7eb182f9c41cfae28e71b4b693fb5",
                  "findContactRunId": "trun_047c230ba85e416483367b6c672ea26a",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-12-05T19:30:35.977365Z",
                "updatedAt": "2026-02-15T07:50:20.063452Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-11T05:00:37.620234Z"
              },
              {
                "contactId": "720e3c3c-ba4b-41b1-a58d-c2a72f43f19c",
                "name": "Jodi Moreno",
                "firstName": "Jodi",
                "lastName": "Moreno",
                "middleName": null,
                "salutation": null,
                "title": "Assistant Director of Leadership & Learning",
                "normalizedTitles": [
                  "Assistant Director of Leadership",
                  "Assistant Director of Learning"
                ],
                "email": null,
                "phone": "+1-626-282-0390",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_70563438605b469cbecf03e0a1970bf7",
                  "findContactRunId": "trun_047c230ba85e4164a13f27612bd1bb2b",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2026-01-23T09:25:37.585007Z",
                "updatedAt": "2026-01-23T09:25:37.585007Z"
              },
              {
                "contactId": "dca352da-b6de-4966-a2a1-164d7c68a399",
                "name": "Jodi Moreno",
                "firstName": "Jodi",
                "lastName": "Moreno",
                "middleName": null,
                "salutation": null,
                "title": "Principal",
                "normalizedTitles": [
                  "Principal"
                ],
                "email": "jmoreno@ofy.org",
                "phone": "+1-626-282-0390",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_3df7eb182f9c41cf941d42bbe34be4cb",
                  "findContactRunId": "trun_047c230ba85e4164a8cb888a07fdacc1",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-12-25T06:13:50.223940Z",
                "updatedAt": "2026-02-13T13:03:55.814029Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-11T05:00:15.751516Z"
              },
              {
                "contactId": "8a4bdf56-0df1-4ac8-bc9e-4638de3b4c23",
                "name": "Charles Pak",
                "firstName": "Charles",
                "lastName": "Pak",
                "middleName": null,
                "salutation": null,
                "title": "Assistant Superintendent of Instruction",
                "normalizedTitles": [
                  "Assistant Superintendent of Instruction",
                  "Assistant Superintendent",
                  "Superintendent",
                  "Superintendent of Instruction"
                ],
                "email": "cpak@ofy.org",
                "phone": "+1-626-221-4207",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_12d19ab17dfc4f26bc024d279500d278",
                  "findContactRunId": "trun_047c230ba85e4164b8c5edb76c048b17",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-12-05T20:05:29.882016Z",
                "updatedAt": "2026-02-09T17:56:43.363153Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-17T05:01:03.881242Z"
              },
              {
                "contactId": "a328440a-0cd6-43ec-9c5f-c8bfee9f8831",
                "name": "Alisa Pineda",
                "firstName": "Alisa",
                "lastName": "Pineda",
                "middleName": null,
                "salutation": null,
                "title": "Special Education Specialist",
                "normalizedTitles": [
                  "Specialist of Special Education",
                  "Specialist"
                ],
                "email": "alisapineda@ofy.org",
                "phone": "+1-626-282-0390",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_12d19ab17dfc4f26a90df1044e4ac3f0",
                  "findContactRunId": "trun_047c230ba85e4164a600ee629a8e5ebb",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2026-02-10T11:26:05.541043Z",
                "updatedAt": "2026-02-10T11:26:05.541044Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-10T11:26:05.512917Z"
              },
              {
                "contactId": "c6f2f57c-d12d-4241-9ef3-19a8d1af9de8",
                "name": "Kelly Tello",
                "firstName": "Kelly",
                "lastName": "Tello",
                "middleName": null,
                "salutation": null,
                "title": "Special Education Specialist",
                "normalizedTitles": [
                  "Specialist of Special Education"
                ],
                "email": "kellytello@ofy.org",
                "phone": "+1-626-282-0390",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_5c024a8efab1403684bafdc0e0f79e68",
                  "findContactRunId": "trun_047c230ba85e41648b9eadc079d01fe3",
                  "foundByWebAgentModel": "Pro",
                  "emailEnrichmentId": "ffc1736a-116a-4926-bd2d-1e315af595b2"
                },
                "createdAt": "2025-12-25T06:58:58.858050Z",
                "updatedAt": "2025-12-25T06:58:58.858050Z",
                "emailVerified": true,
                "emailLastChecked": "2025-12-25T06:58:02.440844Z"
              },
              {
                "contactId": "9cab75b6-e5b4-4c74-aedd-7f6cf374de56",
                "name": "Andy Tsai",
                "firstName": "Andy",
                "lastName": "Tsai",
                "middleName": null,
                "salutation": "Mr.",
                "title": "Assistant Superintendent of Business Operations (Chief Business Official)",
                "normalizedTitles": [
                  "Assistant Superintendent of Business Operations",
                  "Chief Business Official",
                  "Assistant Superintendent",
                  "Business Official",
                  "Chief Official",
                  "Superintendent",
                  "Superintendent of Business Operations"
                ],
                "email": "andy@ofy.org",
                "phone": "+1-626-590-8573",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_3df7eb182f9c41cfb456b90d390ea622",
                  "findContactRunId": "trun_047c230ba85e4164979acec1fd66d545",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-12-05T19:47:23.427416Z",
                "updatedAt": "2026-02-16T19:16:53.236877Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-10T08:46:35.087135Z"
              }
            ]
          },
          {
            "buyerId": "65413dde-08e8-4227-803f-c704eff5e941",
            "buyerName": "University Of South Carolina Columbia",
            "contacts": [
              {
                "contactId": "92b8522e-c267-46f5-a8f1-7ff479b923c5",
                "name": "Brian Alden",
                "firstName": "Brian",
                "lastName": "Alden",
                "middleName": null,
                "salutation": null,
                "title": "Associate Director of Communications & Public Relations (M. Soccer, Softball)",
                "normalizedTitles": [
                  "Associate Director of Communications",
                  "Associate Director of Public Relations"
                ],
                "email": "aldenb@mailbox.sc.edu",
                "phone": null,
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_219b05ab9e214f2caf149080e8a3dfb7",
                  "enrichContactRunId": "trun_7bd5d8ef71fb41bc9347dd7af6c1f779",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2026-01-28T00:46:42.924810Z",
                "updatedAt": "2026-01-28T00:46:42.924810Z",
                "emailVerified": true,
                "emailLastChecked": "2026-01-28T00:46:22.900727Z"
              },
              {
                "contactId": "1bc1dbe8-0c74-4c73-833a-3b6280b37b71",
                "name": "Michael Amiridis",
                "firstName": "Michael",
                "lastName": "Amiridis",
                "middleName": null,
                "salutation": "Dr.",
                "title": "President",
                "normalizedTitles": [
                  "President"
                ],
                "email": "michael.amiridis@sc.edu",
                "phone": "+1-803-777-2001",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_51df0254ab264a4495625cb226f3418f",
                  "findContactRunId": "trun_3940873bcb284a4e81d070a49156bc9f",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-09-06T13:59:27.787656Z",
                "updatedAt": "2025-10-30T20:12:32.883984Z",
                "emailVerified": true,
                "emailLastChecked": "2026-01-06T05:01:17.734470Z"
              },
              {
                "contactId": "6f2bba1e-ea14-4bd7-9c2f-812665db4d28",
                "name": "Lara Lomicka Anderson",
                "firstName": "Lara",
                "lastName": "Anderson",
                "middleName": "Lomicka",
                "salutation": "Dr.",
                "title": "Vice Provost for Undergraduate Affairs and Dean of Undergraduate Studies; Dean of the Graduate School (interim)",
                "normalizedTitles": [
                  "Dean of Undergraduate Studies",
                  "Interim Dean of the Graduate School",
                  "Vice Provost of Undergraduate Affairs",
                  "Dean of the Graduate School"
                ],
                "email": "lomicka@mailbox.sc.edu",
                "phone": "+1-803-777-2808",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_164fae35bd014825b9731f40d04195c4",
                  "findContactRunId": "trun_047c230ba85e416491030404094f9597",
                  "enrichContactRunId": "trun_7bd5d8ef71fb41bca179dcac9a06b184",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-10-16T02:06:23.039644Z",
                "updatedAt": "2026-01-30T05:21:18.066809Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-15T05:02:06.445680Z"
              },
              {
                "contactId": "09593aa3-8636-4d5f-8126-ef790e1b6d4c",
                "name": "Jeannette O. Andrews",
                "firstName": "Jeannette",
                "lastName": "Andrews",
                "middleName": "O.",
                "salutation": "Dr.",
                "title": "Dean and Helen Gurley Wolford Professor of Nursing",
                "normalizedTitles": [
                  "Dean",
                  "Professor of Nursing"
                ],
                "email": "j.andrews@sc.edu",
                "phone": "+1-803-777-3862",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_e1377c6c328e4b95a0ab3080c90bd466",
                  "findContactRunId": "trun_67cddcfe8ce64732b2ec951d06c61389",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-12-10T14:41:02.417636Z",
                "updatedAt": "2025-12-10T14:41:02.417637Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-09T05:00:49.154119Z"
              },
              {
                "contactId": "a3cd1037-f27c-486b-ab3a-4add147510d6",
                "name": "Samuel Jonathan Andrews",
                "firstName": "Samuel",
                "lastName": "Andrews",
                "middleName": "Jonathan",
                "salutation": null,
                "title": "System Procurement Manager",
                "normalizedTitles": [
                  "Manager of System Procurement"
                ],
                "email": "sja1@mailbox.sc.edu",
                "phone": "+1-803-777-3489",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_bc61097a682847749fb5c26d7c10a85a",
                  "findContactRunId": "trun_047c230ba85e416482e1f3525621c67e",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-11-26T21:40:08.669250Z",
                "updatedAt": "2025-11-26T21:40:08.669250Z",
                "emailVerified": true,
                "emailLastChecked": "2026-01-26T05:02:50.973515Z"
              },
              {
                "contactId": "ff367157-ac2c-4acf-b307-d8a51d2f7d7e",
                "name": "Lauryn Antoine",
                "firstName": "Lauryn",
                "lastName": "Antoine",
                "middleName": null,
                "salutation": null,
                "title": "Talent Acquisition, Assistant",
                "normalizedTitles": [
                  "Assistant of Talent Acquisition"
                ],
                "email": "lantoine@mailbox.sc.edu",
                "phone": "+1-803-777-3872",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_51df0254ab264a449f6fa3c3dcc824c2"
                },
                "createdAt": "2025-08-16T05:30:47.578613Z",
                "updatedAt": "2025-11-23T09:37:13.122323Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-14T05:01:04.508550Z"
              },
              {
                "contactId": "95da4edb-d5f8-4f8d-ae56-65ed85a79d98",
                "name": "Sophia Arconti",
                "firstName": "Sophia",
                "lastName": "Arconti",
                "middleName": null,
                "salutation": null,
                "title": "Associate Vice President, Creative Services",
                "normalizedTitles": [
                  "Associate Vice President of Creative Services"
                ],
                "email": "sarconti@mailbox.sc.edu",
                "phone": "+1-803-777-3687",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_e1377c6c328e4b95a1423fdd364de80c"
                },
                "createdAt": "2025-08-23T03:29:47.205500Z",
                "updatedAt": "2025-12-13T10:13:00.413268Z",
                "emailVerified": true,
                "emailLastChecked": "2025-12-21T05:02:28.568131Z"
              },
              {
                "contactId": "8aa000be-48bb-4f53-b193-cca7dada0ba6",
                "name": "Donna K. Arnett",
                "firstName": "Donna",
                "lastName": "Arnett",
                "middleName": "K.",
                "salutation": null,
                "title": "Educational Foundation Distinguished Professor",
                "normalizedTitles": [
                  "Distinguished Professor of Educational Foundation",
                  "Distinguished Professor",
                  "Professor",
                  "Professor of Educational Foundation"
                ],
                "email": "donna.arnett@sc.edu",
                "phone": null,
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_219b05ab9e214f2c995938b0c6549315",
                  "enrichContactRunId": "trun_7bd5d8ef71fb41bcafb2008f2e367ca0",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-11-25T18:06:01.906717Z",
                "updatedAt": "2026-02-05T21:57:42.987501Z",
                "emailVerified": true,
                "emailLastChecked": "2026-01-25T05:00:53.552466Z"
              },
              {
                "contactId": "6e8f5bc9-34de-4f8b-9fff-f96fb2a1bde3",
                "name": "April Barnes",
                "firstName": "April",
                "lastName": "Barnes",
                "middleName": null,
                "salutation": "Dr.",
                "title": "Assistant Vice President, University Housing",
                "normalizedTitles": [
                  "Assistant Vice President of University Housing",
                  "Assistant Vice President",
                  "Vice President",
                  "Vice President of University Housing"
                ],
                "email": "barnesa1@mailbox.sc.edu",
                "phone": "+1-803-777-4283",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_12d19ab17dfc4f2685e442c4812196d1",
                  "findContactRunId": "trun_047c230ba85e41648efc0bac86131eb7",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-12-02T15:06:17.609960Z",
                "updatedAt": "2026-02-10T08:26:39.590861Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-01T05:00:48.294156Z"
              },
              {
                "contactId": "d7928516-1646-4abf-bdc9-b4496c375c76",
                "name": "Alicia Bervine",
                "firstName": "Alicia",
                "lastName": "Bervine",
                "middleName": null,
                "salutation": null,
                "title": "Executive Director of Human Resources",
                "normalizedTitles": [
                  "Executive Director of Human Resources",
                  "Director",
                  "Director of Human Resources",
                  "Executive Director"
                ],
                "email": "bervine@mailbox.sc.edu",
                "phone": "+1-803-777-4989",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_12d19ab17dfc4f269b1b72354d88742e",
                  "enrichContactRunId": "trun_1fbaa0b4561644689742ca17ac1006f3",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2026-02-04T15:07:39.069064Z",
                "updatedAt": "2026-02-04T15:07:39.069064Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-04T15:07:38.953933Z"
              },
              {
                "contactId": "65f6c531-a5d8-411d-a7e0-91aa70bd1e7d",
                "name": "John Brice Bible",
                "firstName": "John",
                "lastName": "Bible",
                "middleName": "Brice",
                "salutation": "Mr.",
                "title": "Vice President for Information Technology & Chief Information Officer",
                "normalizedTitles": [
                  "Chief Information Officer",
                  "Vice President of Information Technology",
                  "Chief Officer",
                  "Information Officer",
                  "President",
                  "President of Information Technology",
                  "Vice President"
                ],
                "email": "bricebible@sc.edu",
                "phone": "+1-803-777-1800",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_3df7eb182f9c41cf903405462ad6ec50",
                  "findContactRunId": "trun_047c230ba85e416484d2d92946544c16",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-09-23T21:39:34.469190Z",
                "updatedAt": "2026-02-16T20:03:06.625817Z",
                "emailVerified": true,
                "emailLastChecked": "2026-01-23T05:00:36.004210Z"
              },
              {
                "contactId": "d57096b0-21f8-44fa-a1af-c7a3824de358",
                "name": "Kathryn Bishop",
                "firstName": "Kathryn",
                "lastName": "Bishop",
                "middleName": null,
                "salutation": null,
                "title": "Graduate Assistant, Career Studio",
                "normalizedTitles": [
                  "Graduate Assistant of Career Studio",
                  "Graduate Assistant"
                ],
                "email": "kab28@email.sc.edu",
                "phone": "+1-803-576-8431",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_e1377c6c328e4b95bea20e158360851d",
                  "enrichContactRunId": "trun_7bd5d8ef71fb41bca119ffe01779aaa7",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-12-15T13:23:13.884882Z",
                "updatedAt": "2025-12-15T13:23:13.884882Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-19T05:02:03.209565Z"
              },
              {
                "contactId": "ff81d32d-c33c-4e29-8533-105b4d9c4684",
                "name": "Jennifer Renee Blevins",
                "firstName": "Jennifer",
                "lastName": "Blevins",
                "middleName": "Renee",
                "salutation": null,
                "title": "Instructor; Interim Director of the Writing Center",
                "normalizedTitles": [
                  "Instructor",
                  "Interim Director of the Writing Center",
                  "Director of the Writing Center"
                ],
                "email": "jblevins@email.sc.edu",
                "phone": "+1-803-777-2078",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_219b05ab9e214f2c800ad565f705dacb",
                  "enrichContactRunId": "trun_7bd5d8ef71fb41bca73c41f96639a073",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2026-01-28T00:44:33.070546Z",
                "updatedAt": "2026-01-28T00:44:33.070547Z",
                "emailVerified": true,
                "emailLastChecked": "2026-01-28T00:44:03.625470Z"
              },
              {
                "contactId": "b0328bc6-6fd8-4526-9003-f1e517ea2007",
                "name": "Melody Boland",
                "firstName": "Melody",
                "lastName": "Boland",
                "middleName": null,
                "salutation": null,
                "title": "Associate Director of Student Advocacy",
                "normalizedTitles": [
                  "Associate Director of Student Advocacy"
                ],
                "email": "mboland@mailbox.sc.edu",
                "phone": "+1-803-777-2535",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_a504d9f25672416f95b1d8555a076970"
                },
                "createdAt": "2025-08-23T05:16:12.838908Z",
                "updatedAt": "2025-12-22T06:40:07.859435Z",
                "emailVerified": true,
                "emailLastChecked": "2025-12-22T05:01:09.040337Z"
              },
              {
                "contactId": "42cadc75-4704-49cc-b2b1-8bae408cd1bb",
                "name": "Jessica Bowers",
                "firstName": "Jessica",
                "lastName": "Bowers",
                "middleName": null,
                "salutation": null,
                "title": "Leave & Workers Compensation Manager",
                "normalizedTitles": [
                  "Manager of Leave",
                  "Manager of Workers' Compensation"
                ],
                "email": "jb204@mailbox.sc.edu",
                "phone": "+1-803-777-3243",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_51df0254ab264a4492002a063d891769"
                },
                "createdAt": "2025-08-16T02:52:14.436152Z",
                "updatedAt": "2025-11-22T05:31:57.200189Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-14T05:01:01.155742Z"
              },
              {
                "contactId": "8ced8c8a-9b4a-4609-9912-418af0f7d8a4",
                "name": "Stacey Bradley",
                "firstName": "Stacey",
                "lastName": "Bradley",
                "middleName": null,
                "salutation": null,
                "title": "Interim Secretary of the University and Board of Trustees",
                "normalizedTitles": [
                  "Interim Secretary of the Board of Trustees",
                  "Interim Secretary of the University",
                  "Interim Secretary",
                  "Secretary"
                ],
                "email": "sbradley@sc.edu",
                "phone": "+1-803-777-3836",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_12d19ab17dfc4f26871e73401229056d",
                  "findContactRunId": "trun_047c230ba85e416488b5a42b9ca16810",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2026-02-04T00:53:24.997342Z",
                "updatedAt": "2026-02-04T00:53:24.997342Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-04T00:53:06.106375Z"
              },
              {
                "contactId": "702ef517-50b6-4f6d-97fe-023e9d5c9f12",
                "name": "Adam Brown",
                "firstName": "Adam",
                "lastName": "Brown",
                "middleName": null,
                "salutation": null,
                "title": "Senior Director, Marketing and Communications",
                "normalizedTitles": [
                  "Senior Director of Communication",
                  "Senior Director of Marketing"
                ],
                "email": "adam.brown@moore.sc.edu",
                "phone": "+1-803-777-4306",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_a504d9f25672416fb12835629d79706f"
                },
                "createdAt": "2025-08-23T05:39:50.024875Z",
                "updatedAt": "2025-12-17T05:16:49.611783Z",
                "emailVerified": true,
                "emailLastChecked": "2025-12-22T05:01:00.864861Z"
              },
              {
                "contactId": "b18f4909-5939-43e6-b7b0-d7a209152edf",
                "name": "Alan Buck",
                "firstName": "Alan",
                "lastName": "Buck",
                "middleName": null,
                "salutation": null,
                "title": "Manager of Employer Development and Experiential Education",
                "normalizedTitles": [
                  "Manager of Employer Development",
                  "Manager of Experiential Education"
                ],
                "email": "alan.buck@sc.edu",
                "phone": "+1-803-607-0974",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_e1377c6c328e4b95ba55a7fdfc9c32ea",
                  "enrichContactRunId": "trun_7bd5d8ef71fb41bc9015c6b87e2842c9",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-12-12T12:51:31.023104Z",
                "updatedAt": "2025-12-12T12:51:31.023104Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-11T05:00:49.856013Z"
              },
              {
                "contactId": "6ae41ce7-4d8f-46b6-9861-a0975697c5ec",
                "name": "LaNaé Budden",
                "firstName": "LaNaé",
                "lastName": "Budden",
                "middleName": null,
                "salutation": "Dr.",
                "title": "First-Generation Center Director",
                "normalizedTitles": [
                  "Director of First-Generation Center"
                ],
                "email": "briggsr@mailbox.sc.edu",
                "phone": "+1-803-544-1242",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_51df0254ab264a44a481b13a378e9677"
                },
                "createdAt": "2025-08-23T04:35:53.128643Z",
                "updatedAt": "2025-11-17T05:27:11.846087Z",
                "emailVerified": true,
                "emailLastChecked": "2025-12-22T05:00:49.756989Z"
              },
              {
                "contactId": "11c65a07-1010-4359-9ad2-346bff892c3e",
                "name": "P. Ann Byrd",
                "firstName": "P. Ann",
                "lastName": "Byrd",
                "middleName": null,
                "salutation": "Dr.",
                "title": "Executive Director and Lead Strategist, SC TEACHER (Housed in USC College of Education)",
                "normalizedTitles": [
                  "Executive Director",
                  "Lead Strategist",
                  "Teacher of SC",
                  "Director",
                  "Strategist",
                  "Teacher"
                ],
                "email": "panbyrd@mailbox.sc.edu",
                "phone": null,
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_12d19ab17dfc4f26b81468572660b34c",
                  "enrichContactRunId": "trun_1fbaa0b456164468ba9895f9c90a0900",
                  "foundByWebAgentModel": "Pro",
                  "emailEnrichmentId": "2a8a9776-3213-4bfd-a765-b660527a6f6e"
                },
                "createdAt": "2026-02-10T01:47:04.675396Z",
                "updatedAt": "2026-02-10T01:47:04.675397Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-10T01:24:06.167953Z"
              }
            ]
          },
          {
            "buyerId": "980fbc2c-6d06-4fbe-a1bf-60b11efae14b",
            "buyerName": "Savannah-Chatham County School District",
            "contacts": [
              {
                "contactId": "68db6fec-e997-48c9-851d-185e6d0d262f",
                "name": "Ronald Aikens",
                "firstName": "Ronald",
                "lastName": "Aikens",
                "middleName": null,
                "salutation": "Mr.",
                "title": "Work-Based Learning / Youth Apprenticeship Coordinator",
                "normalizedTitles": [
                  "Coordinator of Work-Based Learning",
                  "Coordinator of Youth Apprenticeship"
                ],
                "email": "ronald.aikens@sccpss.com",
                "phone": "+1-912-395-6765",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_b8617b9561414b0aa8475792e873b100"
                },
                "createdAt": "2025-09-15T04:13:45.054564Z",
                "updatedAt": "2026-01-04T05:11:45.087998Z",
                "emailVerified": true,
                "emailLastChecked": "2026-01-14T05:00:08.215965Z"
              },
              {
                "contactId": "7ce52161-89fc-47b3-b7d0-2239ee784196",
                "name": "Raymond Barnes",
                "firstName": "Raymond",
                "lastName": "Barnes",
                "middleName": null,
                "salutation": "Dr.",
                "title": "Chief of Schools",
                "normalizedTitles": [
                  "Chief of School"
                ],
                "email": "raymond.barnes@sccpss.com",
                "phone": "+1-912-395-5582",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_e1377c6c328e4b95b50f5beece9cfb07",
                  "enrichContactRunId": "trun_7bd5d8ef71fb41bcbd2a8212e58464af",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-12-11T20:12:40.419406Z",
                "updatedAt": "2025-12-11T20:12:40.419407Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-10T05:01:37.134063Z"
              },
              {
                "contactId": "cd8200d0-dd17-4440-b603-be975389e6a0",
                "name": "Ashok Sonny Batra",
                "firstName": "Ashok",
                "lastName": "Batra",
                "middleName": "Sonny",
                "salutation": null,
                "title": "Executive Director of Capital Projects",
                "normalizedTitles": [
                  "Executive Director of Capital Projects"
                ],
                "email": "ashok.batra@sccpss.com",
                "phone": "+1-912-346-2167",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_2f599300768441d08a571c466c938b5a",
                  "findContactRunId": "trun_047c230ba85e416495bde2020f555b3b",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-10-25T15:49:03.997764Z",
                "updatedAt": "2025-12-02T12:33:20.352844Z",
                "emailVerified": true,
                "emailLastChecked": "2025-12-25T05:01:38.879460Z"
              },
              {
                "contactId": "41c3c9b8-d3f3-4e37-9b60-281f33682b0b",
                "name": "Sheila Blanco",
                "firstName": "Sheila",
                "lastName": "Blanco",
                "middleName": null,
                "salutation": null,
                "title": "Public Information Manager",
                "normalizedTitles": [
                  "Manager of Public Information"
                ],
                "email": "sheila.blanco@sccpss.com",
                "phone": "+1-912-395-5538",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_bc61097a682847748469ae037d9e7570",
                  "findContactRunId": "trun_047c230ba85e41649584da776bf073b9",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-10-23T18:25:19.747102Z",
                "updatedAt": "2025-10-23T18:25:19.747102Z",
                "emailVerified": true,
                "emailLastChecked": "2025-12-23T05:00:56.099497Z"
              },
              {
                "contactId": "2ac2f03d-a0e9-450f-a7c1-6883f5261028",
                "name": "David A. Bringman",
                "firstName": "David",
                "lastName": "Bringman",
                "middleName": "A.",
                "salutation": "Dr.",
                "title": "Board Member, District 6",
                "normalizedTitles": [
                  "Board Member"
                ],
                "email": "david.bringman@sccpss.com",
                "phone": "+1-912-961-4032",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_b8617b9561414b0ab424dfeb50fcb80e",
                  "enrichContactRunId": "trun_7bd5d8ef71fb41bcb6401e3e5f265a59",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2026-01-05T21:03:30.359344Z",
                "updatedAt": "2026-01-05T21:03:30.359344Z",
                "emailVerified": true,
                "emailLastChecked": "2026-01-05T21:03:18.849306Z"
              },
              {
                "contactId": "b9e633ef-082a-440e-b73f-5df6c07bd0cd",
                "name": "Joanna Brooks",
                "firstName": "Joanna",
                "lastName": "Brooks",
                "middleName": null,
                "salutation": null,
                "title": "Principal",
                "normalizedTitles": [
                  "Principal"
                ],
                "email": "joanna.brooks@sccpss.com",
                "phone": "+1-912-395-3400",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_bc61097a68284774bd82b964d3284842"
                },
                "createdAt": "2025-07-25T19:13:59.849525Z",
                "updatedAt": "2025-10-22T07:30:42.953212Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-14T05:00:53.180856Z"
              },
              {
                "contactId": "54b0d9fa-2a0c-4227-a78a-1794a18b8c1c",
                "name": "Jennifer Brown",
                "firstName": "Jennifer",
                "lastName": "Brown",
                "middleName": null,
                "salutation": null,
                "title": "LMSS",
                "normalizedTitles": [
                  "LMSS"
                ],
                "email": "jennifer.brown@sccpss.com",
                "phone": null,
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_bc61097a6828477493f6ca20b179bb41"
                },
                "createdAt": "2025-07-04T13:29:09.437190Z",
                "updatedAt": "2025-10-22T09:50:02.222710Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-15T05:02:33.281319Z"
              },
              {
                "contactId": "f52a980d-2124-4bb9-8b2d-d6785e2c4cd4",
                "name": "Troy Brown",
                "firstName": "Troy",
                "lastName": "Brown",
                "middleName": null,
                "salutation": "Dr.",
                "title": "Network Superintendent Elementary/K-8 Schools",
                "normalizedTitles": [
                  "Superintendent of Network Elementary School",
                  "Superintendent of Network K-8 School",
                  "Superintendent of Network"
                ],
                "email": "troy.brown@sccpss.com",
                "phone": "+1-912-395-5582",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_bc61097a68284774ae16653392ab996c"
                },
                "createdAt": "2025-07-25T19:35:07.431704Z",
                "updatedAt": "2025-10-22T09:36:56.490385Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-15T05:00:20.837079Z"
              },
              {
                "contactId": "74bf30e9-936a-4fc0-a6dc-3dc99b9e71e9",
                "name": "Edra Buckles",
                "firstName": "Edra",
                "lastName": "Buckles",
                "middleName": null,
                "salutation": null,
                "title": "Senior Director of Networking & Engineering Services",
                "normalizedTitles": [
                  "Senior Director of Engineering Services",
                  "Senior Director of Networking",
                  "Director of Engineering Services",
                  "Director of Networking"
                ],
                "email": "edra.buckles@sccpss.com",
                "phone": "+1-912-395-1022",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_5c024a8efab14036a477ed970b421ac2",
                  "findContactRunId": "trun_047c230ba85e4164ae928a8794bb47ac",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-12-14T20:49:18.818082Z",
                "updatedAt": "2025-12-20T06:45:11.925213Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-14T05:01:05.414367Z"
              },
              {
                "contactId": "bcf0713d-57f7-4f9b-9bc3-3d845ddc1542",
                "name": "Andrea Danielle Burkiett",
                "firstName": "Andrea",
                "lastName": "Burkiett",
                "middleName": "Danielle",
                "salutation": "Mrs.",
                "title": "Director of Elementary Curriculum & Instruction",
                "normalizedTitles": [
                  "Director of Elementary Curriculum",
                  "Director of Elementary Instruction",
                  "Director of Curriculum",
                  "Director of Instruction"
                ],
                "email": "andrea.burkiett@sccpss.com",
                "phone": "+1-912-395-5584",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_8f84ca30d6fb4777be3b9e01392e61bf",
                  "findContactRunId": "trun_047c230ba85e41648bb97d4fe23f41b0",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-08-19T20:19:13.370372Z",
                "updatedAt": "2026-01-24T11:35:45.898629Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-17T05:00:20.179107Z"
              },
              {
                "contactId": "a15f6485-1927-47cb-98f3-92dbd7b8b2b4",
                "name": "Derrick Butler",
                "firstName": "Derrick",
                "lastName": "Butler",
                "middleName": null,
                "salutation": "Dr.",
                "title": "Chief Academic Officer",
                "normalizedTitles": [
                  "Chief Academic Officer",
                  "Academic Officer",
                  "Chief Officer"
                ],
                "email": "derrick.butler@sccpss.com",
                "phone": "+1-912-395-5582",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_12d19ab17dfc4f269b4b7e7f55b74cca",
                  "findContactRunId": "trun_047c230ba85e4164ba6718c242bac5d0",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-07-25T19:10:43.879225Z",
                "updatedAt": "2026-02-10T17:19:49.102046Z",
                "emailVerified": true,
                "emailLastChecked": "2025-12-27T05:00:28.430658Z"
              },
              {
                "contactId": "26db35e9-259e-4d6e-a448-e275a805145c",
                "name": "Ross Cairney",
                "firstName": "Ross",
                "lastName": "Cairney",
                "middleName": null,
                "salutation": null,
                "title": "Executive Director of Capital Projects & Maintenance",
                "normalizedTitles": [
                  "Executive Director of Capital Projects",
                  "Executive Director of Maintenance",
                  "Director",
                  "Director of Capital Projects",
                  "Director of Maintenance",
                  "Executive Director"
                ],
                "email": "ross.cairney@sccpss.com",
                "phone": "+1-912-513-0891",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_12d19ab17dfc4f268ff157b5dd062fc0",
                  "findContactRunId": "trun_047c230ba85e4164a8cecac456aa6d4e",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-12-02T14:59:43.433581Z",
                "updatedAt": "2026-02-12T03:52:40.383813Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-01T05:00:48.455028Z"
              },
              {
                "contactId": "68532a86-712e-440c-b4a8-928fc0c7d30f",
                "name": "Stephanie Campbell",
                "firstName": "Stephanie",
                "lastName": "Campbell",
                "middleName": null,
                "salutation": null,
                "title": "Board Member, District 7",
                "normalizedTitles": [
                  "Board Member of District 7",
                  "Board Member"
                ],
                "email": "stephanie.campbell@sccpss.com",
                "phone": "+1-912-429-2304",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_2f599300768441d08e30acb545d91d34",
                  "findContactRunId": "trun_047c230ba85e4164831ae6a179d53e65",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-12-14T09:03:35.167674Z",
                "updatedAt": "2025-12-14T09:03:35.167674Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-13T05:02:18.068141Z"
              },
              {
                "contactId": "156d6b7a-8a45-4b2e-8f29-77b035eb6bf6",
                "name": "Joan Carter",
                "firstName": "Joan",
                "lastName": "Carter",
                "middleName": null,
                "salutation": null,
                "title": "Purchasing Manager",
                "normalizedTitles": [
                  "Manager of Purchasing",
                  "Manager",
                  "Purchasing"
                ],
                "email": "joan.carter@sccpss.com",
                "phone": "+1-912-395-5572",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_3df7eb182f9c41cf8ec7480c404ce1a6",
                  "findContactRunId": "trun_047c230ba85e4164be77aab35cb31fa4",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2026-02-17T16:14:32.494513Z",
                "updatedAt": "2026-02-17T16:14:32.494513Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-17T16:14:32.456372Z"
              },
              {
                "contactId": "4fa148fe-82bc-4bd8-8f67-e39d089a4140",
                "name": "Julian Childers",
                "firstName": "Julian",
                "lastName": "Childers",
                "middleName": null,
                "salutation": null,
                "title": "Director of Secondary Curriculum & Instruction",
                "normalizedTitles": [
                  "Director of Instruction",
                  "Director of Secondary Curriculum",
                  "Director"
                ],
                "email": "julian.childers@sccpss.com",
                "phone": "+1-912-395-5584",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_12d19ab17dfc4f26904ecec182837c88",
                  "findContactRunId": "trun_047c230ba85e4164ab2e7851856f5ae1",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-09-15T04:43:15.401344Z",
                "updatedAt": "2026-02-11T19:22:07.458495Z",
                "emailVerified": true,
                "emailLastChecked": "2026-01-14T05:00:27.168103Z"
              },
              {
                "contactId": "3a7b026c-5212-40d2-a931-0a7d493ac974",
                "name": "Brittany Clark",
                "firstName": "Brittany",
                "lastName": "Clark",
                "middleName": null,
                "salutation": null,
                "title": "Teacher Specialist - Science",
                "normalizedTitles": [
                  "Teacher Specialist of Science",
                  "Teacher Specialist"
                ],
                "email": null,
                "phone": null,
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_2f599300768441d0b15bbeb4ebc3ee7c",
                  "findContactRunId": "trun_047c230ba85e4164b87cbfe8a0261b0c",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-12-13T06:38:02.266724Z",
                "updatedAt": "2025-12-13T06:38:02.266725Z"
              },
              {
                "contactId": "5408de67-39fd-4020-affd-302463902465",
                "name": "Tomika Courtney-McClinton",
                "firstName": "Tomika",
                "lastName": "Courtney-McClinton",
                "middleName": null,
                "salutation": null,
                "title": "SCCPSS Specialist for Elementary Social Studies",
                "normalizedTitles": [
                  "Specialist of Social Studies Elementary School",
                  "Specialist of Social Studies"
                ],
                "email": null,
                "phone": null,
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_dd8c309d1034414897cb12dd1e88286d"
                },
                "createdAt": "2025-07-25T18:16:41.650963Z",
                "updatedAt": "2025-11-26T09:11:33.794924Z"
              },
              {
                "contactId": "887b6ba5-82af-4bd2-aaa6-447a66b40815",
                "name": "Megan Davidson",
                "firstName": "Megan",
                "lastName": "Davidson",
                "middleName": null,
                "salutation": null,
                "title": "Chief Operating Officer",
                "normalizedTitles": [
                  "Chief Operating Officer",
                  "Chief Officer",
                  "Operating Officer"
                ],
                "email": "megan.davidson@sccpss.com",
                "phone": "+1-912-395-3000",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_12d19ab17dfc4f268bb76eece0446bfa",
                  "findContactRunId": "trun_047c230ba85e4164be031a7420d2b897",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-10-18T05:10:33.381331Z",
                "updatedAt": "2026-02-09T18:58:18.993346Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-16T20:54:12.649760Z"
              },
              {
                "contactId": "7039d0cb-39ed-4e05-821f-210eff7af30d",
                "name": "Jacqueline Dorsey",
                "firstName": "Jacqueline",
                "lastName": "Dorsey",
                "middleName": null,
                "salutation": null,
                "title": "Director of Compensatory Programs",
                "normalizedTitles": [
                  "Director of Compensatory Program"
                ],
                "email": "jacqueline.dorsey@sccpss.com",
                "phone": "+1-912-395-5635",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_e1377c6c328e4b958454d364f6625146",
                  "findContactRunId": "trun_67cddcfe8ce647328f8f4ee7bd61d08f",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-12-06T16:22:38.924896Z",
                "updatedAt": "2025-12-06T16:22:38.924897Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-05T05:06:19.358465Z"
              },
              {
                "contactId": "a1c01207-866c-417d-93b6-540fdff00940",
                "name": "Travis Easter",
                "firstName": "Travis",
                "lastName": "Easter",
                "middleName": null,
                "salutation": null,
                "title": "Social Studies Teacher",
                "normalizedTitles": [
                  "Teacher of Social Studies"
                ],
                "email": "travis.easter@sccpss.com",
                "phone": null,
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_bc61097a682847748f506f33f71c05e0"
                },
                "createdAt": "2025-07-02T01:11:37.776971Z",
                "updatedAt": "2025-10-22T09:00:25.817945Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-14T05:01:55.474632Z"
              }
            ]
          },
          {
            "buyerId": "3cf65af1-76c9-4c5d-997e-1ac7b83cfbd6",
            "buyerName": "Texas Workforce Commission",
            "contacts": [
              {
                "contactId": "da8e0655-4f16-47b8-b1b8-7926e68813ad",
                "name": "Elida Arriaga",
                "firstName": "Elida",
                "lastName": "Arriaga",
                "middleName": null,
                "salutation": null,
                "title": "Records Management Officer, Document Services",
                "normalizedTitles": [
                  "Document Services",
                  "Officer of Records Management"
                ],
                "email": "elida.arriaga@twc.texas.gov",
                "phone": "+1-512-952-1716",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_70563438605b469cbfe1c4cf6f5463c8",
                  "findContactRunId": "trun_047c230ba85e4164b96745bc7a8dcf72",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-08-18T16:59:50.145137Z",
                "updatedAt": "2026-01-15T03:29:37.106759Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-16T05:00:47.044881Z"
              },
              {
                "contactId": "30dcdd5f-8210-479a-9838-fb57e1a37789",
                "name": "Mahalia Cecilia Baldini",
                "firstName": "Mahalia",
                "lastName": "Baldini",
                "middleName": "Cecilia",
                "salutation": "Ms.",
                "title": "Director, Adult Education and Literacy (AEL); Chief Deputy Division Director, Workforce Development",
                "normalizedTitles": [
                  "Chief Deputy Division Director of Workforce Development",
                  "Director of Adult Education and Literacy",
                  "Chief Deputy Division Director",
                  "Director",
                  "Division Director",
                  "Division Director of Workforce Development"
                ],
                "email": "mahalia.baldini@twc.texas.gov",
                "phone": "+1-512-470-3300",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_12d19ab17dfc4f26953d8152507c7b5f",
                  "findContactRunId": "trun_047c230ba85e4164a44e2f936b6bcfd6",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-08-18T15:17:10.279075Z",
                "updatedAt": "2026-02-05T18:31:11.005953Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-16T05:00:50.757902Z"
              },
              {
                "contactId": "63a694c4-e2f9-4210-89cd-aee9491687f4",
                "name": "Elizabeth Noelle Bell",
                "firstName": "Elizabeth",
                "lastName": "Bell",
                "middleName": "Noelle",
                "salutation": null,
                "title": "Director of IT Applications Solutions, IT Acquisitions",
                "normalizedTitles": [
                  "Director of Information Technology Acquisitions",
                  "Director of Information Technology Applications"
                ],
                "email": "noelle.bell@twc.texas.gov",
                "phone": "+1-512-580-6570",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_70563438605b469c908b4257dcf91551",
                  "findContactRunId": "trun_047c230ba85e41649238f9519344bbb6",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-10-25T01:10:03.394260Z",
                "updatedAt": "2026-01-20T14:39:27.033815Z",
                "emailVerified": true,
                "emailLastChecked": "2025-12-24T05:02:02.778504Z"
              },
              {
                "contactId": "522b0666-3a9a-4e49-a8e0-829cab5cf14c",
                "name": "Daniel Castronovo",
                "firstName": "Daniel",
                "lastName": "Castronovo",
                "middleName": null,
                "salutation": null,
                "title": "Director, Training and Development",
                "normalizedTitles": [
                  "Director of Development",
                  "Director of Training",
                  "Director"
                ],
                "email": "daniel.castronovo@twc.texas.gov",
                "phone": "+1-737-667-5410",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_3df7eb182f9c41cfaf00d9ffb9df01aa",
                  "findContactRunId": "trun_047c230ba85e41648885ff213891b1d5",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-08-18T15:05:42.289529Z",
                "updatedAt": "2026-02-15T10:11:26.911340Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-11T05:00:23.000172Z"
              },
              {
                "contactId": "5edb7622-d44e-46eb-8083-a852b475ec55",
                "name": "Kristie Caviness",
                "firstName": "Kristie",
                "lastName": "Caviness",
                "middleName": null,
                "salutation": "Ms.",
                "title": "Employer Engagement and Community Outreach Manager",
                "normalizedTitles": [
                  "Manager of Community Outreach",
                  "Manager of Employer Engagement"
                ],
                "email": "kristie.caviness@twc.texas.gov",
                "phone": "+1-512-417-9272",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_51df0254ab264a44a374b8624e50a941"
                },
                "createdAt": "2025-08-18T17:09:06.750264Z",
                "updatedAt": "2025-11-24T07:27:36.670150Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-16T05:02:27.345016Z"
              },
              {
                "contactId": "e9cf2bc0-9418-4bd6-9e11-2090224022d2",
                "name": "Tara B Cole",
                "firstName": "Tara",
                "lastName": "Cole",
                "middleName": "B",
                "salutation": null,
                "title": "Evaluation Lead, Office of Apprenticeship",
                "normalizedTitles": [
                  "Lead of Evaluation"
                ],
                "email": "tara.cole@twc.texas.gov",
                "phone": null,
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_bc61097a6828477498e07fad342e4f5f",
                  "findContactRunId": "trun_047c230ba85e41648a2d56a16eef0d12",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-10-25T14:33:39.494863Z",
                "updatedAt": "2025-10-25T14:33:39.494863Z",
                "emailVerified": true,
                "emailLastChecked": "2025-12-25T05:01:16.328250Z"
              },
              {
                "contactId": "e0babef1-f435-4179-8cb3-f1cf6462a587",
                "name": "Jennifer K. Colehower",
                "firstName": "Jennifer",
                "lastName": "Colehower",
                "middleName": "K.",
                "salutation": null,
                "title": "Division Director, Information Innovation & Insight",
                "normalizedTitles": [
                  "Division Director of Information Innovation",
                  "Division Director of Insight",
                  "Director",
                  "Director of Information Innovation",
                  "Director of Insight",
                  "Division Director"
                ],
                "email": "jennifer.colehower@twc.texas.gov",
                "phone": "+1-512-463-7997",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_12d19ab17dfc4f26899f10d5293d4134",
                  "findContactRunId": "trun_047c230ba85e4164bce3ef047f079b49",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-08-18T16:57:36.391198Z",
                "updatedAt": "2026-02-11T09:41:08.461152Z",
                "emailVerified": true,
                "emailLastChecked": "2026-01-25T05:02:13.251359Z"
              },
              {
                "contactId": "69bbfb61-7e0b-45fe-970c-865950da92ad",
                "name": "Brent Connett",
                "firstName": "Brent",
                "lastName": "Connett",
                "middleName": null,
                "salutation": null,
                "title": "Commissioner Representing the Public",
                "normalizedTitles": [
                  "Commissioner of the Public",
                  "Commissioner"
                ],
                "email": "opc@twc.texas.gov",
                "phone": "+1-512-463-3030",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_2f599300768441d0936f8b74cf2db921",
                  "findContactRunId": "trun_047c230ba85e416497736068d39b6841",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-12-02T12:10:56.158242Z",
                "updatedAt": "2025-12-02T12:10:56.158243Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-01T05:01:15.314162Z"
              },
              {
                "contactId": "ed5fe5bd-2e84-459b-94a6-6dfc5636f4db",
                "name": "Dallas Curry-Ikner",
                "firstName": "Dallas",
                "lastName": "Curry-Ikner",
                "middleName": null,
                "salutation": null,
                "title": "Purchaser",
                "normalizedTitles": [
                  "Purchaser"
                ],
                "email": "dallas.curryikner@twc.texas.gov",
                "phone": "+1-737-400-5612",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_bc61097a682847749db3ce268e23b553",
                  "findContactRunId": "trun_047c230ba85e4164ba2f8230969c1e0f",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-10-25T02:26:40.074659Z",
                "updatedAt": "2025-10-25T02:26:40.074660Z",
                "emailVerified": true,
                "emailLastChecked": "2025-12-24T05:01:50.801404Z"
              },
              {
                "contactId": "baf4e407-ec01-4ecd-9640-f73a132a40b6",
                "name": "Heather Hall",
                "firstName": "Heather",
                "lastName": "Hall",
                "middleName": null,
                "salutation": null,
                "title": "Chief Information Officer",
                "normalizedTitles": [
                  "Chief Information Officer"
                ],
                "email": "heather.hall@twc.texas.gov",
                "phone": "+1-737-263-2005",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_164fae35bd014825a08ef05377ddc839",
                  "findContactRunId": "trun_65f61383e0c74e168c201c27f36a4e65",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-08-18T16:08:25.491987Z",
                "updatedAt": "2026-01-24T06:49:14.347210Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-16T05:02:10.535857Z"
              },
              {
                "contactId": "dd4a94cd-e076-4a1f-b164-50020804c3ea",
                "name": "Diana Harris",
                "firstName": "Diana",
                "lastName": "Harris",
                "middleName": null,
                "salutation": null,
                "title": "Director, UI Client Services",
                "normalizedTitles": [
                  "Director of User Interface Client Services",
                  "Director"
                ],
                "email": "diana.harris@twc.texas.gov",
                "phone": null,
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_12d19ab17dfc4f2681b80c50c5580ad0",
                  "findContactRunId": "trun_047c230ba85e4164bef47d9780115cad",
                  "foundByWebAgentModel": "Pro",
                  "emailEnrichmentId": "26425004-6f3c-4a69-8988-0e0873bc5b13"
                },
                "createdAt": "2026-02-10T20:07:58.514776Z",
                "updatedAt": "2026-02-10T20:07:58.514777Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-10T19:53:34.408909Z"
              },
              {
                "contactId": "8825c332-9925-4b34-a412-4e7383101d21",
                "name": "Elizabeth A Hernandez",
                "firstName": "Elizabeth",
                "lastName": "Hernandez",
                "middleName": "A",
                "salutation": null,
                "title": "Director, Infrastructure Services",
                "normalizedTitles": [
                  "Director of Infrastructure Services"
                ],
                "email": "elizabeth@texas.gov",
                "phone": null,
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_12d19ab17dfc4f268d1b2ba43742d8dc",
                  "findContactRunId": "trun_047c230ba85e4164b8b2c2d6ee0f0e18",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2026-01-15T03:34:10.017566Z",
                "updatedAt": "2026-02-03T17:09:39.156531Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-19T05:02:36.345267Z"
              },
              {
                "contactId": "7f38603e-1572-4cd4-bd5e-497363f2a6d7",
                "name": "Amy Landrum",
                "firstName": "Amy",
                "lastName": "Landrum",
                "middleName": null,
                "salutation": null,
                "title": "Director, Communications & Media",
                "normalizedTitles": [
                  "Director of Communications",
                  "Director of Media"
                ],
                "email": null,
                "phone": "+1-512-936-3352",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_70563438605b469c974b6dbeb62de598",
                  "findContactRunId": "trun_047c230ba85e4164b2f1b019170265db",
                  "foundByWebAgentModel": "Pro",
                  "emailEnrichmentId": "4b259fd9-d35e-40ff-ba2d-66c45bb9ec66"
                },
                "createdAt": "2026-01-23T11:47:36.785207Z",
                "updatedAt": "2026-01-23T11:47:36.785207Z"
              },
              {
                "contactId": "9fec8977-f155-4277-9ba7-687b9a079f6f",
                "name": "Amy S Landrum",
                "firstName": "Amy",
                "lastName": "Landrum",
                "middleName": "S",
                "salutation": null,
                "title": "Director, Communications & Media",
                "normalizedTitles": [
                  "Director of Communications",
                  "Director of Media"
                ],
                "email": "mason.campbell@adhe.edu",
                "phone": "+1-512-936-3352",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_2f599300768441d09a75b8314ce78d39",
                  "findContactRunId": "trun_047c230ba85e4164ac51e25395f3780f",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-09-25T02:43:40.206376Z",
                "updatedAt": "2025-12-15T12:17:52.708129Z",
                "emailVerified": true,
                "emailLastChecked": "2026-01-24T05:02:21.047459Z"
              },
              {
                "contactId": "11b0a098-e3c2-4eb4-8aa8-16fe6b84a966",
                "name": "Lance Leatherwood",
                "firstName": "Lance",
                "lastName": "Leatherwood",
                "middleName": null,
                "salutation": null,
                "title": "Chief Information Security Officer",
                "normalizedTitles": [
                  "Chief Information Security Officer",
                  "Chief Officer",
                  "Information Security Officer"
                ],
                "email": "lance.leatherwood@twc.texas.gov",
                "phone": "+1-512-962-2476",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_3df7eb182f9c41cfa2c20332e1ba0f80",
                  "findContactRunId": "trun_047c230ba85e4164853d5a51576e2755",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-09-06T10:00:10.496952Z",
                "updatedAt": "2026-02-16T13:54:22.788238Z",
                "emailVerified": true,
                "emailLastChecked": "2026-01-06T05:00:47.622701Z"
              },
              {
                "contactId": "9e5a6575-19d8-43a3-bfbc-f5ff895fc899",
                "name": "Reagan Miller",
                "firstName": "Reagan",
                "lastName": "Miller",
                "middleName": null,
                "salutation": null,
                "title": "Division Director, Child Care & Early Learning Division",
                "normalizedTitles": [
                  "Director of Child Care",
                  "Director of Division",
                  "Director of Early Learning",
                  "Director"
                ],
                "email": "reagan.miller2@twc.texas.gov",
                "phone": "+1-512-936-3563",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_12d19ab17dfc4f2696e22ea6c17b2231",
                  "findContactRunId": "trun_047c230ba85e416485c1748de443e4a4",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-09-25T02:28:13.137811Z",
                "updatedAt": "2026-02-12T13:55:41.449786Z",
                "emailVerified": true,
                "emailLastChecked": "2026-01-24T05:02:51.738559Z"
              },
              {
                "contactId": "864c99b6-6a79-4fc6-889b-17619c7b062f",
                "name": "Veronica Moore",
                "firstName": "Veronica",
                "lastName": "Moore",
                "middleName": null,
                "salutation": null,
                "title": "Program Support Specialist & Corrections, Adult Education & Literacy (TWC)",
                "normalizedTitles": [
                  "Program Support Specialist of Adult Education and Literacy",
                  "Program Support Specialist of Corrections",
                  "Program Support Specialist"
                ],
                "email": "veronica.moore@twc.texas.gov",
                "phone": "+1-512-463-0197",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_70563438605b469c98e3745fdd36c4ff",
                  "findContactRunId": "trun_047c230ba85e41649643b4d5f90378e0",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2026-01-23T10:27:05.490210Z",
                "updatedAt": "2026-01-23T10:27:05.490211Z",
                "emailVerified": true,
                "emailLastChecked": "2026-01-23T10:26:51.571353Z"
              },
              {
                "contactId": "1136bacc-5e48-4358-89f8-913832318658",
                "name": "Chris Nelson",
                "firstName": "Chris",
                "lastName": "Nelson",
                "middleName": null,
                "salutation": "Mr.",
                "title": "Chief Financial Officer",
                "normalizedTitles": [
                  "Chief Financial Officer"
                ],
                "email": "chris.nelson@twc.texas.gov",
                "phone": "+1-512-463-1829",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_70563438605b469cb41545c641db274b",
                  "findContactRunId": "trun_047c230ba85e4164b5f17d8c6e43e920",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-08-18T16:57:11.907907Z",
                "updatedAt": "2026-01-21T22:11:47.279741Z",
                "emailVerified": true,
                "emailLastChecked": "2026-02-05T05:02:33.391916Z"
              },
              {
                "contactId": "032c0568-0109-4c03-8878-fc3c7a364cc0",
                "name": "Sarah J Noel",
                "firstName": "Sarah",
                "lastName": "Noel",
                "middleName": "J",
                "salutation": null,
                "title": "Purchasing Agent (PHS Deputy Director)",
                "normalizedTitles": [
                  "Agent of Purchasing",
                  "Deputy Director",
                  "Agent",
                  "Director"
                ],
                "email": "sarah.noel@twc.texas.gov",
                "phone": "+1-737-400-5361",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_12d19ab17dfc4f26810db049d8d6d52e",
                  "findContactRunId": "trun_047c230ba85e41648bf3a34b82deeef1",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-10-25T01:18:22.664180Z",
                "updatedAt": "2026-02-01T22:49:12.691792Z",
                "emailVerified": true,
                "emailLastChecked": "2025-12-24T05:02:03.603503Z"
              },
              {
                "contactId": "11340fee-19a8-4889-9c1a-711d4ee40e63",
                "name": "Jeffery C Peden",
                "firstName": "Jeffery",
                "lastName": "Peden",
                "middleName": "C",
                "salutation": "Mr.",
                "title": "Deputy Chief Information Officer, IT Infrastructure Services",
                "normalizedTitles": [
                  "Deputy Chief Information Officer of Information Technology Infrastructure Services",
                  "Deputy Chief Information Officer"
                ],
                "email": "jeff.peden@twc.texas.gov",
                "phone": "+1-512-475-3691",
                "linkedInUrl": null,
                "worksAtBuyer": true,
                "source": "WebAgent",
                "foiaRequestContact": false,
                "metadataV2": {
                  "worksAtBuyerRunId": "trun_3df7eb182f9c41cfae59a6b502178e3a",
                  "findContactRunId": "trun_047c230ba85e41649314504f5251af8a",
                  "foundByWebAgentModel": "Pro"
                },
                "createdAt": "2025-10-25T01:34:41.210991Z",
                "updatedAt": "2026-02-18T14:29:33.071184Z",
                "emailVerified": true,
                "emailLastChecked": "2025-12-24T05:01:50.814229Z"
              }
            ]
          }
        ]
      }
    }
  },
  {
    "step": "s10_secondary_cards",
    "status": "success",
    "duration_seconds": 21.668,
    "message": "1683 chars, 4 buyers",
    "created_at": "2026-02-19 12:37:25",
    "metadata": {
      "SECTION_SECONDARY": "**Savannah-Chatham County School District** | School District\n- **Top Signal:** College and Career Readiness Platform (RFP) — active procurement\n- **Key Contact:** Ronald Aikens — Work-Based Learning / Youth Apprenticeship Coordinator — ronald.aikens@sccpss.com\n- **Relevance:** Active RFP for career readiness platform aligns directly with VMock's resume review and career assessment capabilities for student workforce prep.\n\n**Texas Workforce Commission** | State Agency\n- **Top Signal:** Career Exploration Assessment Services (RFP) — 3 signals tracked\n- **Key Contact:** Elida Arriaga — Records Management Officer, Document Services — elida.arriaga@twc.texas.gov\n- **Relevance:** State-level workforce agency procuring career exploration assessments — VMock's AI-powered career readiness tools fit the assessment services scope at scale.\n\n**Options For Youth San Gabriel District** | School District\n- **Top Signal:** College and Career Readiness Services (RFP No. 211) — active solicitation\n- **Key Contact:** Megan Betry — Principal — mbetry@ofy.org\n- **Relevance:** Alternative education district with explicit RFP for career readiness services; VMock's interview prep and employer matching supports their workforce-focused mission.\n\n**University Of South Carolina Columbia** | Higher Education\n- **Top Signal:** Career Acceleration Platform Solution — AI-Powered — 4 signals tracked (highest signal count)\n- **Key Contact:** Brian Alden — Associate Director of Communications & Public Relations — aldenb@mailbox.sc.edu\n- **Relevance:** Major research university actively seeking an AI-powered career acceleration platform — near-exact match for VMock's core product offering."
    }
  },
  {
    "step": "s6_buyer_chat",
    "status": "success",
    "duration_seconds": 238.909,
    "message": "4177 chars",
    "created_at": "2026-02-19 12:40:58",
    "metadata": {
      "FEAT_AI_CONTEXT": "The Allentown School District (ASD) is currently undergoing a significant transformation focused on modernizing its high school models and integrating advanced technology, particularly Artificial Intelligence (AI), into its instructional and operational frameworks.\n\n### Strategic Priorities\nThe district’s primary roadmap is the **\"Lighting the Way: A Blueprint for Innovation and Excellence 2030\"** strategic plan. Recent board discussions and 2025-2026 school plans highlight the following key priorities:\n*   **Competency-Based High School Models:** Transitioning traditional high schools into specialized academies. A flagship project is the redesign of **Bridgeview Academy of Health, Science, Innovation, and Technology**, which focuses on healthcare and AI-themed pathways.\n*   **Academic Excellence & Equity:** Specific measurable goals for the 2025-2026 cycle include increasing 3rd-grade literacy proficiency, improving Algebra 1 pass rates by 9th grade, and reducing chronic absenteeism through evidence-based Multi-Tiered Systems of Support (MTSS).\n*   **Organizational Efficiency:** A strategic goal to align fiscal and human capital to enhance state-of-the-art technology infrastructure and modern learning environments across all campuses.\n\n### Recent Technology Initiatives\nASD is aggressively pursuing \"Technology for Universal Learning\" with a strong focus on AI and data-driven decision-making:\n*   **AI-Powered Educator Platform (March 2025):** The district issued an RFP for an AI platform to support teachers with lesson planning, student assessments, data analysis, and personalized learning strategies.\n*   **Enterprise Data Warehouse (January 2026):** A new initiative to centralize instructional and operational data to support MTSS compliance and \"data-informed leadership.\"\n*   **Strategic Progress Monitoring:** In late 2024 and early 2025, the district launched a search for a robust **Strategic Plan Dashboard** to track KPIs and identify district improvement areas in real-time.\n*   **AI Policy Integration (July 2025):** The board revised its official AI policy to ensure compliance with federal regulations, specifically addressing the oversight of AI-generated content in education.\n\n### Major Procurement Activity\nRecent procurement reflects high-value investments in facilities, specialized planning, and infrastructure:\n*   **Bridgeview Academy Program Planning (January 2026):** ASD issued an RFP for a **School Program Planning Consultant** specifically to design the AI-themed healthcare and technology pathways for the newly renamed Bridgeview Academy.\n*   **Engineering and Energy Services (January 2026):** A procurement effort for engineering services that includes optional **AI-enabled facility management** and asset management programs.\n*   **Student Transportation (July 2024):** A major multi-year contract (effective through June 30, 2027) with **First Student, Inc.** for alternative student transportation services.\n*   **Infrastructure & HVAC:** In late 2024, the district signaled commitments for over **$100 million** in projects related to HVAC, ventilation upgrades, and new modular classroom installations.\n\n### Leadership Changes (Past 12 Months)\nThe district completed a significant governing board reorganization in late 2025 while maintaining executive leadership stability:\n*   **Board of Directors (December 2025):** Five new directors were sworn in: **Evette D’Amore, Cereta Johnson, Dianne Michels, Denzel Morris** (each for four-year terms), and **Robert Nicholoff** (two-year term).\n*   **Board Leadership:** In December 2025, the board elected **Andrene Brown-Nowell** as President and **Audrey Mathison** as Vice President for the 2026 term.\n*   **Superintendent:** **Dr. Carol D. Birks** remains at the helm as Superintendent and CEO, overseeing the implementation of the \"2030 Blueprint\" and quoted in all recent major leadership and strategic announcements.\n*   **Administrative Appointments:** For the 2025-2026 school year, the district announced several key leadership additions, including new directors for Virtual Education and Instructional Technology to support its specialized academy rollout."
    }
  },
  {
    "step": "s9_featured_section",
    "status": "success",
    "duration_seconds": 32.272,
    "message": "2972 chars",
    "created_at": "2026-02-19 12:41:30",
    "metadata": {
      "SECTION_FEATURED": "> 🏫 **Allentown School District** — School District\n> **State:** PA · **City:** Allentown\n> **Procurement Score:** 62/100 · **Website:** allentownsd.org · **Phone:** (484) 765-4000\n\n---\n\n### Why This Buyer Matters\n\n- **Active RFP for exactly what VMock does.** Allentown SD posted a \"College and Career Readiness Platform\" RFP (January 2026) seeking a unified CCR platform for grades K-12 that facilitates student self-discovery, career exploration, and academic planning — a near-perfect overlap with VMock's resume review, interview prep, and career readiness assessment capabilities.\n\n- **PA Act 158 compliance is driving urgency.** The same RFP explicitly requires tools to support all five Pennsylvania Act 158 graduation pathways, including Career and Technical Education (CTE) and evidence-based documentation. VMock's assessment and evidence-collection features map directly to this compliance mandate.\n\n- **District-wide AI adoption strategy creates executive buy-in.** ASD issued a separate RFP for an AI-Powered Educator Platform (March 2025) and revised its official AI policy in July 2025 — signaling that AI-powered tools already have institutional support and a streamlined approval path at the board level.\n\n---\n\n### Key Contact\n\n**Dr. Carol D. Birks** — Superintendent / Chief Executive Officer — birksc@allentownsd.org\n\n---\n\n### Recent Strategic Signals\n\n**College and Career Readiness Platform RFP**\nAllentown SD issued a formal RFP on January 20, 2026 for a \"single, unified CCR platform for all students in grades K-12.\" The solicitation calls for career exploration, academic planning, multilingual accessibility, educator progress monitoring, and compliance tooling for Pennsylvania's Act 158 graduation pathways. Proposals were due February 6, 2026. *(RFP, January 2026)*\n\n**AI-Powered Educator Platform**\nIn March 2025, the district issued an RFP for an AI platform to support teachers with lesson planning, student assessments, data analysis, and personalized learning strategies — demonstrating that AI-driven education technology has already passed the district's procurement and policy review process. *(RFP, March 2025)*\n\n**Bridgeview Academy Redesign with AI-Themed Pathways**\nIn January 2026, ASD issued an RFP for a School Program Planning Consultant to design AI-themed healthcare and technology pathways for the newly renamed Bridgeview Academy of Health, Science, Innovation, and Technology. This competency-based high school model is a flagship initiative under the district's \"Lighting the Way 2030\" strategic plan. *(RFP, January 2026)*\n\n**Enterprise Data Warehouse Initiative**\nIn January 2026, the district launched an initiative to centralize instructional and operational data into an enterprise data warehouse, supporting MTSS compliance and data-informed leadership. This infrastructure investment signals readiness for platforms that generate student-level analytics and outcome tracking. *(District initiative, January 2026)*"
    }
  },
  {
    "step": "s12_assemble",
    "status": "success",
    "duration_seconds": 40.817,
    "message": "5886 chars",
    "created_at": "2026-02-19 12:42:11",
    "metadata": {
      "REPORT_MARKDOWN": "# 📊 Allentown School District — Intelligence Report for VMock\n\n---\n\n> 🏫 **Allentown School District** — School District\n> **State:** PA · **City:** Allentown\n> **Procurement Score:** 62/100 · **Website:** allentownsd.org · **Phone:** (484) 765-4000\n\n---\n\n### Why This Buyer Matters\n\n- **Active RFP for exactly what VMock does.** Allentown SD posted a \"College and Career Readiness Platform\" RFP (January 2026) seeking a unified CCR platform for grades K-12 that facilitates student self-discovery, career exploration, and academic planning — a near-perfect overlap with VMock's resume review, interview prep, and career readiness assessment capabilities.\n\n- **PA Act 158 compliance is driving urgency.** The same RFP explicitly requires tools to support all five Pennsylvania Act 158 graduation pathways, including Career and Technical Education (CTE) and evidence-based documentation. VMock's assessment and evidence-collection features map directly to this compliance mandate.\n\n- **District-wide AI adoption strategy creates executive buy-in.** ASD issued a separate RFP for an AI-Powered Educator Platform (March 2025) and revised its official AI policy in July 2025 — signaling that AI-powered tools already have institutional support and a streamlined approval path at the board level.\n\n---\n\n### Key Contact\n\n**Dr. Carol D. Birks** — Superintendent / Chief Executive Officer — birksc@allentownsd.org\n\n---\n\n### Recent Strategic Signals\n\n**College and Career Readiness Platform RFP**\nAllentown SD issued a formal RFP on January 20, 2026 for a \"single, unified CCR platform for all students in grades K-12.\" The solicitation calls for career exploration, academic planning, multilingual accessibility, educator progress monitoring, and compliance tooling for Pennsylvania's Act 158 graduation pathways. Proposals were due February 6, 2026. *(RFP, January 2026)*\n\n**AI-Powered Educator Platform**\nIn March 2025, the district issued an RFP for an AI platform to support teachers with lesson planning, student assessments, data analysis, and personalized learning strategies — demonstrating that AI-driven education technology has already passed the district's procurement and policy review process. *(RFP, March 2025)*\n\n**Bridgeview Academy Redesign with AI-Themed Pathways**\nIn January 2026, ASD issued an RFP for a School Program Planning Consultant to design AI-themed healthcare and technology pathways for the newly renamed Bridgeview Academy of Health, Science, Innovation, and Technology. This competency-based high school model is a flagship initiative under the district's \"Lighting the Way 2030\" strategic plan. *(RFP, January 2026)*\n\n**Enterprise Data Warehouse Initiative**\nIn January 2026, the district launched an initiative to centralize instructional and operational data into an enterprise data warehouse, supporting MTSS compliance and data-informed leadership. This infrastructure investment signals readiness for platforms that generate student-level analytics and outcome tracking. *(District initiative, January 2026)*\n\n---\n\n## Additional Buyers\n\n**Savannah-Chatham County School District** | School District\n- **Top Signal:** College and Career Readiness Platform (RFP) — active procurement\n- **Key Contact:** Ronald Aikens — Work-Based Learning / Youth Apprenticeship Coordinator — ronald.aikens@sccpss.com\n- **Relevance:** Active RFP for career readiness platform aligns directly with VMock's resume review and career assessment capabilities for student workforce prep.\n\n**Texas Workforce Commission** | State Agency\n- **Top Signal:** Career Exploration Assessment Services (RFP) — 3 signals tracked\n- **Key Contact:** Elida Arriaga — Records Management Officer, Document Services — elida.arriaga@twc.texas.gov\n- **Relevance:** State-level workforce agency procuring career exploration assessments — VMock's AI-powered career readiness tools fit the assessment services scope at scale.\n\n**Options For Youth San Gabriel District** | School District\n- **Top Signal:** College and Career Readiness Services (RFP No. 211) — active solicitation\n- **Key Contact:** Megan Betry — Principal — mbetry@ofy.org\n- **Relevance:** Alternative education district with explicit RFP for career readiness services; VMock's interview prep and employer matching supports their workforce-focused mission.\n\n**University Of South Carolina Columbia** | Higher Education\n- **Top Signal:** Career Acceleration Platform Solution — AI-Powered — 4 signals tracked (highest signal count)\n- **Key Contact:** Brian Alden — Associate Director of Communications & Public Relations — aldenb@mailbox.sc.edu\n- **Relevance:** Major research university actively seeking an AI-powered career acceleration platform — near-exact match for VMock's core product offering.\n\n---\n\n## Executive Summary\n\nWe scanned **80 procurement signals** across **52 SLED buyers** in the Higher Education and School District and State Agency space for **VMock**. Leading match: **Allentown School District** (School District), with the strongest combination of signal recency, urgency, and relevance.\n\n---\n\n## What Starbridge Can Do\n\nStarbridge monitors **296,000+ government and education buyers** across all 50 states, with **107M+ indexed board meetings and procurement records**. For VMock targeting Higher Education, School District, State Agency buyers, we surface:\n\n- **Active procurement signals** — RFPs, contract expirations, board discussions, and budget allocations\n- **Verified decision-maker contacts** — directors, VPs, superintendents, and budget authorities\n- **AI-powered buyer analysis** — strategic context synthesized from public records and FOIA data\n\nThis scan surfaced **80 signals** across **52 buyers** in the Higher Education, School District, State Agency space.\n\n---\n\n*Generated Starbridge Intelligence February 2026*\n*Data source: Starbridge buyer profile, contacts, and opportunity database*",
      "NOTION_PAGE_URL": "https://www.notion.so/30c845c16a8381ceb8bff452a148a15e"
    }
  },
  {
    "step": "s13_llm_fact_check",
    "status": "success",
    "duration_seconds": 32.72,
    "message": "PASS: PASS\n\n1. The \"Why This Buyer Matters\" bullet 3 references an AI policy revision in July 2025, but no",
    "created_at": "2026-02-19 12:42:44"
  },
  {
    "step": "s13_validate",
    "status": "success",
    "duration_seconds": null,
    "message": "PASS: 0 issues, 0 warnings",
    "created_at": "2026-02-19 12:42:44",
    "metadata": {
      "issues": [],
      "warnings": [],
      "fixed": false
    }
  },
  {
    "step": "s14_pipeline_complete",
    "status": "success",
    "duration_seconds": 390.444,
    "message": "total=390.4s",
    "created_at": "2026-02-19 12:42:44",
    "metadata": {
      "total_duration_seconds": 390.4,
      "buyer_name": "Allentown School District",
      "notion_url": "https://www.notion.so/30c845c16a8381ceb8bff452a148a15e"
    }
  }
],
  discoveries: [
    {buyer_name:'Savannah-Chatham County School District',signal_type:'Selling',signal_score:0.7168,signal_summary:'College and Career Readiness Platform (RFP)'},
    {buyer_name:'Options For Youth San Gabriel District',signal_type:'Selling',signal_score:0.6941,signal_summary:'College and Career Readiness Services (RFP No. 211)'},
    {buyer_name:'University Of South Carolina Columbia',signal_type:'Selling',signal_score:0.6925,signal_summary:'Career Acceleration Platform Solution - AI- Powered'},
    {buyer_name:'Alcorn State University',signal_type:'Selling',signal_score:0,signal_summary:'Mycareercloset.org Turnkey Career Readiness Platform *SOLE SOURCE*'},
    {buyer_name:'Aurora Public Schools',signal_type:'Selling',signal_score:0,signal_summary:'College and Career Success Readiness Platform (RFP)'},
    {buyer_name:'City of Waterbury',signal_type:'Selling',signal_score:0,signal_summary:'College and Career Readiness Platform (RFP)'},
    {buyer_name:'City of Worcester',signal_type:'Selling',signal_score:0,signal_summary:'Software - Career & College Readiness Program / WPS 8633-W6'},
    {buyer_name:'Detroit Employment Solutions Corporation (DESC)',signal_type:'Selling',signal_score:0,signal_summary:'Career Readiness and Exploration Services 2025 (RFP)'},
    {buyer_name:'Fulton County School District',signal_type:'Selling',signal_score:0,signal_summary:'College and Career Readiness Platform (RFP)'},
    {buyer_name:'Harlingen Consolidated Independent School District',signal_type:'Selling',signal_score:0,signal_summary:'College and Career Readiness Software (RFP)'},
    {buyer_name:'Hennepin County',signal_type:'Selling',signal_score:0,signal_summary:'Youth Career and Employment Readiness Services'},
    {buyer_name:'Illinois State Universities Civil Service System',signal_type:'buyer_match',signal_score:0,signal_summary:'Buyer type match: N/A (IL)'},
    {buyer_name:'Illinois State Universities Retirement System',signal_type:'buyer_match',signal_score:0,signal_summary:'Buyer type match: N/A (IL)'},
    {buyer_name:'Independent Colleges And Universities Of Florida',signal_type:'buyer_match',signal_score:0,signal_summary:'Buyer type match: System, HigherEducation (FL)'},
    {buyer_name:'Michigan Association Of State Universities',signal_type:'buyer_match',signal_score:0,signal_summary:'Buyer type match: System, NonProfitOrganization (MI)'},
    {buyer_name:'Minnesota State Colleges and Universities System Office',signal_type:'buyer_match',signal_score:0,signal_summary:'Buyer type match: HigherEducation (MN)'},
    {buyer_name:'New Jersey Association Of State Colleges And Universities',signal_type:'buyer_match',signal_score:0,signal_summary:'Buyer type match: System, HigherEducation (NJ)'},
    {buyer_name:'Peyton School District 49',signal_type:'Selling',signal_score:0,signal_summary:'College and Career Readiness (CCR) Software Solution (RFI)'},
    {buyer_name:'Richland School District Two',signal_type:'Selling',signal_score:0,signal_summary:'Districtwide College & Career Readiness Platform (RFP)'},
    {buyer_name:'Tennessee Independent Colleges And Universities Association',signal_type:'buyer_match',signal_score:0,signal_summary:'Buyer type match: System, HigherEducation (TN)'},
    {buyer_name:'The Connecticut State Colleges And Universities System (CSCU)',signal_type:'buyer_match',signal_score:0,signal_summary:'Buyer type match: System, AdministrativeAgency (CT)'},
    {buyer_name:'The Universities At Shady Grove',signal_type:'buyer_match',signal_score:0,signal_summary:'Buyer type match: UndergraduateInstitution (MD)'},
    {buyer_name:'University Of Houston Downtown',signal_type:'Selling',signal_score:0,signal_summary:'AI-Powered Virtual Resume Review Software for Career Center Integration (RFP)'},
    {buyer_name:'Utah State Board of Education',signal_type:'Selling',signal_score:0,signal_summary:'USBE First Credential Career Mapping Tool Software Platform (RFP)'}
  ],
  contacts: [
    {contact_name:'Adam Brown',contact_title:'Senior Director, Marketing and Communications',contact_email:'adam.brown@moore.sc.edu',email_verified:true},
    {contact_name:'Alan Buck',contact_title:'Manager of Employer Development and Experiential Education',contact_email:'alan.buck@sc.edu',email_verified:true},
    {contact_name:'Alicia Bervine',contact_title:'Executive Director of Human Resources',contact_email:'bervine@mailbox.sc.edu',email_verified:true},
    {contact_name:'Alisa Pineda',contact_title:'Special Education Specialist',contact_email:'alisapineda@ofy.org',email_verified:true},
    {contact_name:'Amelia Coleman',contact_title:'Deputy Superintendent, Chief Academic Officer',contact_email:'colemana@allentownsd.org',email_verified:null},
    {contact_name:'Amy Landrum',contact_title:'Director, Communications & Media',contact_email:'',email_verified:null},
    {contact_name:'Amy S Landrum',contact_title:'Director, Communications & Media',contact_email:'mason.campbell@adhe.edu',email_verified:true},
    {contact_name:'Andrea Danielle Burkiett',contact_title:'Director of Elementary Curriculum & Instruction',contact_email:'andrea.burkiett@sccpss.com',email_verified:true},
    {contact_name:'Andrene Brown-Nowell',contact_title:'President',contact_email:'nowella@allentownsd.org',email_verified:null},
    {contact_name:'Andy Tsai',contact_title:'Assistant Superintendent of Business Operations (Chief Business Official)',contact_email:'andy@ofy.org',email_verified:true},
    {contact_name:'April Barnes',contact_title:'Assistant Vice President, University Housing',contact_email:'barnesa1@mailbox.sc.edu',email_verified:true},
    {contact_name:'Ashok Sonny Batra',contact_title:'Executive Director of Capital Projects',contact_email:'ashok.batra@sccpss.com',email_verified:true},
    {contact_name:'Brent Connett',contact_title:'Commissioner Representing the Public',contact_email:'opc@twc.texas.gov',email_verified:true},
    {contact_name:'Brian Alden',contact_title:'Associate Director of Communications & Public Relations (M. Soccer, Softball)',contact_email:'aldenb@mailbox.sc.edu',email_verified:true},
    {contact_name:'Brittany Clark',contact_title:'Teacher Specialist - Science',contact_email:'',email_verified:null},
    {contact_name:'Cari Cantor',contact_title:'Director of Federal Programs',contact_email:'cantorc@allentownsd.org',email_verified:null},
    {contact_name:'Carol D. Birks',contact_title:'Superintendent / Chief Executive Officer',contact_email:'birksc@allentownsd.org',email_verified:null},
    {contact_name:'Cattima Cirksey',contact_title:'Director of Family and Community Engagement',contact_email:'cirkseyc@allentownsd.org',email_verified:null},
    {contact_name:'Charles Pak',contact_title:'Assistant Superintendent of Instruction',contact_email:'cpak@ofy.org',email_verified:true},
    {contact_name:'Chris Nelson',contact_title:'Chief Financial Officer',contact_email:'chris.nelson@twc.texas.gov',email_verified:true},
    {contact_name:'Dallas Curry-Ikner',contact_title:'Purchaser',contact_email:'dallas.curryikner@twc.texas.gov',email_verified:true},
    {contact_name:'Daniel Castronovo',contact_title:'Director, Training and Development',contact_email:'daniel.castronovo@twc.texas.gov',email_verified:true},
    {contact_name:'David A. Bringman',contact_title:'Board Member, District 6',contact_email:'david.bringman@sccpss.com',email_verified:true},
    {contact_name:'Derrick Butler',contact_title:'Chief Academic Officer',contact_email:'derrick.butler@sccpss.com',email_verified:true},
    {contact_name:'Diana Harris',contact_title:'Director, UI Client Services',contact_email:'diana.harris@twc.texas.gov',email_verified:true},
    {contact_name:'Donna K. Arnett',contact_title:'Educational Foundation Distinguished Professor',contact_email:'donna.arnett@sc.edu',email_verified:true},
    {contact_name:'Edra Buckles',contact_title:'Senior Director of Networking & Engineering Services',contact_email:'edra.buckles@sccpss.com',email_verified:true},
    {contact_name:'Elida Arriaga',contact_title:'Records Management Officer, Document Services',contact_email:'elida.arriaga@twc.texas.gov',email_verified:true},
    {contact_name:'Elizabeth A Hernandez',contact_title:'Director, Infrastructure Services',contact_email:'elizabeth@texas.gov',email_verified:true},
    {contact_name:'Elizabeth Noelle Bell',contact_title:'Director of IT Applications Solutions, IT Acquisitions',contact_email:'noelle.bell@twc.texas.gov',email_verified:true},
    {contact_name:'George Clay',contact_title:'Assistant Director of Safety and Security',contact_email:'claygf@allentownsd.org',email_verified:null},
    {contact_name:'Heather Hall',contact_title:'Chief Information Officer',contact_email:'heather.hall@twc.texas.gov',email_verified:true},
    {contact_name:'Ileana Kiriakos',contact_title:'Superintendent',contact_email:'ileana@ofy.org',email_verified:true},
    {contact_name:'Jacqueline Dorsey',contact_title:'Director of Compensatory Programs',contact_email:'jacqueline.dorsey@sccpss.com',email_verified:true},
    {contact_name:'Jane Gothold',contact_title:'Chairperson and Board Member',contact_email:'jgothold@ofy.org',email_verified:true},
    {contact_name:'Jeannette O. Andrews',contact_title:'Dean and Helen Gurley Wolford Professor of Nursing',contact_email:'j.andrews@sc.edu',email_verified:true},
    {contact_name:'Jeffery C Peden',contact_title:'Deputy Chief Information Officer, IT Infrastructure Services',contact_email:'jeff.peden@twc.texas.gov',email_verified:true},
    {contact_name:'Jennifer Aponte',contact_title:'Principal',contact_email:'apontej@allentownsd.org',email_verified:null},
    {contact_name:'Jennifer Brown',contact_title:'LMSS',contact_email:'jennifer.brown@sccpss.com',email_verified:true},
    {contact_name:'Jennifer K. Colehower',contact_title:'Division Director, Information Innovation & Insight',contact_email:'jennifer.colehower@twc.texas.gov',email_verified:true},
    {contact_name:'Jennifer Renee Blevins',contact_title:'Instructor; Interim Director of the Writing Center',contact_email:'jblevins@email.sc.edu',email_verified:true},
    {contact_name:'Jessica Bowers',contact_title:'Leave & Workers Compensation Manager',contact_email:'jb204@mailbox.sc.edu',email_verified:true},
    {contact_name:'Jessica Cordova',contact_title:'Assistant Principal of Instructional Operations',contact_email:'jcordova@ofy.org',email_verified:true},
    {contact_name:'Joan Carter',contact_title:'Purchasing Manager',contact_email:'joan.carter@sccpss.com',email_verified:true},
    {contact_name:'Joanna Brooks',contact_title:'Principal',contact_email:'joanna.brooks@sccpss.com',email_verified:true},
    {contact_name:'Jodi Moreno',contact_title:'Assistant Director of Leadership & Learning',contact_email:'',email_verified:null},
    {contact_name:'Jodi Moreno',contact_title:'Principal',contact_email:'jmoreno@ofy.org',email_verified:true},
    {contact_name:'John Brice Bible',contact_title:'Vice President for Information Technology & Chief Information Officer',contact_email:'bricebible@sc.edu',email_verified:true},
    {contact_name:'Jorge J. Delfin',contact_title:'Executive Director of Technology',contact_email:'delfinj@allentownsd.org',email_verified:null},
    {contact_name:'Jose Gonzalez',contact_title:'Career Pathways Coordinator',contact_email:'josegonzalez@ofy.org',email_verified:true},
    {contact_name:'Josephine Cacace',contact_title:'Director of Finance',contact_email:'cacacej@allentownsd.org',email_verified:null},
    {contact_name:'Julian Childers',contact_title:'Director of Secondary Curriculum & Instruction',contact_email:'julian.childers@sccpss.com',email_verified:true},
    {contact_name:'Kathryn Bishop',contact_title:'Graduate Assistant, Career Studio',contact_email:'kab28@email.sc.edu',email_verified:true},
    {contact_name:'Kelly Tello',contact_title:'Special Education Specialist',contact_email:'kellytello@ofy.org',email_verified:true},
    {contact_name:'Kristie Caviness',contact_title:'Employer Engagement and Community Outreach Manager',contact_email:'kristie.caviness@twc.texas.gov',email_verified:true},
    {contact_name:'LaNa\u00e9 Budden',contact_title:'First-Generation Center Director',contact_email:'briggsr@mailbox.sc.edu',email_verified:true},
    {contact_name:'Lance Leatherwood',contact_title:'Chief Information Security Officer',contact_email:'lance.leatherwood@twc.texas.gov',email_verified:true},
    {contact_name:'Lara Lomicka Anderson',contact_title:'Vice Provost for Undergraduate Affairs and Dean of Undergraduate Studies; Dean of the Graduate School (interim)',contact_email:'lomicka@mailbox.sc.edu',email_verified:true},
    {contact_name:'Lauryn Antoine',contact_title:'Talent Acquisition, Assistant',contact_email:'lantoine@mailbox.sc.edu',email_verified:true},
    {contact_name:'Mahalia Cecilia Baldini',contact_title:'Director, Adult Education and Literacy (AEL); Chief Deputy Division Director, Workforce Development',contact_email:'mahalia.baldini@twc.texas.gov',email_verified:true},
    {contact_name:'Megan Betry',contact_title:'Principal',contact_email:'mbetry@ofy.org',email_verified:true},
    {contact_name:'Megan Davidson',contact_title:'Chief Operating Officer',contact_email:'megan.davidson@sccpss.com',email_verified:true},
    {contact_name:'Melody Boland',contact_title:'Associate Director of Student Advocacy',contact_email:'mboland@mailbox.sc.edu',email_verified:true},
    {contact_name:'Michael Amiridis',contact_title:'President',contact_email:'michael.amiridis@sc.edu',email_verified:true},
    {contact_name:'P. Ann Byrd',contact_title:'Executive Director and Lead Strategist, SC TEACHER (Housed in USC College of Education)',contact_email:'panbyrd@mailbox.sc.edu',email_verified:true},
    {contact_name:'Raymond Barnes',contact_title:'Chief of Schools',contact_email:'raymond.barnes@sccpss.com',email_verified:true},
    {contact_name:'Reagan Miller',contact_title:'Division Director, Child Care & Early Learning Division',contact_email:'reagan.miller2@twc.texas.gov',email_verified:true},
    {contact_name:'Ronald Aikens',contact_title:'Work-Based Learning / Youth Apprenticeship Coordinator',contact_email:'ronald.aikens@sccpss.com',email_verified:true},
    {contact_name:'Ross Cairney',contact_title:'Executive Director of Capital Projects & Maintenance',contact_email:'ross.cairney@sccpss.com',email_verified:true},
    {contact_name:'Samuel Jonathan Andrews',contact_title:'System Procurement Manager',contact_email:'sja1@mailbox.sc.edu',email_verified:true},
    {contact_name:'Sarah Cummings',contact_title:'Intervention Specialist',contact_email:'cummingss@allentownsd.org',email_verified:null},
    {contact_name:'Sarah J Noel',contact_title:'Purchasing Agent (PHS Deputy Director)',contact_email:'sarah.noel@twc.texas.gov',email_verified:true},
    {contact_name:'Sheila Blanco',contact_title:'Public Information Manager',contact_email:'sheila.blanco@sccpss.com',email_verified:true},
    {contact_name:'Sophia Arconti',contact_title:'Associate Vice President, Creative Services',contact_email:'sarconti@mailbox.sc.edu',email_verified:true},
    {contact_name:'Stacey Bradley',contact_title:'Interim Secretary of the University and Board of Trustees',contact_email:'sbradley@sc.edu',email_verified:true},
    {contact_name:'Stephanie Campbell',contact_title:'Board Member, District 7',contact_email:'stephanie.campbell@sccpss.com',email_verified:true},
    {contact_name:'Susana Guardado',contact_title:'APIP',contact_email:'susanaguardado@oflschools.org',email_verified:true},
    {contact_name:'Tara B Cole',contact_title:'Evaluation Lead, Office of Apprenticeship',contact_email:'tara.cole@twc.texas.gov',email_verified:true},
    {contact_name:'Tomika Courtney-McClinton',contact_title:'SCCPSS Specialist for Elementary Social Studies',contact_email:'',email_verified:null},
    {contact_name:'Travis Easter',contact_title:'Social Studies Teacher',contact_email:'travis.easter@sccpss.com',email_verified:true},
    {contact_name:'Troy Brown',contact_title:'Network Superintendent Elementary/K-8 Schools',contact_email:'troy.brown@sccpss.com',email_verified:true},
    {contact_name:'Veronica Moore',contact_title:'Program Support Specialist & Corrections, Adult Education & Literacy (TWC)',contact_email:'veronica.moore@twc.texas.gov',email_verified:true}
  ]
};

// Step execution order for "running" inference
var STEP_ORDER = ['s0','s1','s2','s3a','s3b','s3c','s3d','s4','s5','s8','s6','s9','s7','s10','s11','s12','s13','s14'];
var PARALLEL_PHASE_A = ['s3a','s3b','s3c','s3d'];
var PARALLEL_PHASE_B = ['s8','s6','s9','s7','s10','s11'];
var SEQ_BEFORE_A = 's2';
var SEQ_BEFORE_B = 's5';
var SEQ_AFTER_A = 's4';
var SEQ_AFTER_B = 's12';  // first step after Phase VI parallel pool

var monitorState = {
  runId: null,
  pollInterval: null,
  lastAudit: [],
  lastRun: null,
  activeTab: 'run',
  expandedSteps: {},
  moreFieldsVisible: false,
  showSubEntries: true,
  showOutputMsgs: false,
  sampleMode: false,
  // Batch state
  batchId: null,
  batchRunIds: [],
  batchPollInterval: null,
  batchRuns: [],
  selectedBatchRunId: null
};

function renderMonitor() {
  var wrap = document.getElementById('monitorWrap');
  var html = '<div class="monitor-left">';

  // ── Starting Point Form ──
  html += '<div class="webhook-form">';
  html += '<h3>Starting Point <span class="sample-tag" id="sampleTagForm">SAMPLE</span></h3>';
  html += '<div id="monitorMsg"></div>';

  html += '<div class="form-row"><label class="form-label form-required">Target Company</label>';
  html += '<input class="form-input" id="mf-target_company" placeholder="e.g. VMock"></div>';

  html += '<div class="form-row"><label class="form-label form-required">Target Domain</label>';
  html += '<input class="form-input" id="mf-target_domain" placeholder="e.g. vmock.com">';
  html += '<div class="form-hint">At least one of Company or Domain required</div></div>';

  html += '<div class="form-row"><label class="form-label">Product Description</label>';
  html += '<textarea class="form-textarea" id="mf-product_description" placeholder="What does this company sell?"></textarea>';
  html += '<div class="form-hint"><b>If provided</b>, used by s2 (search strategy), s9 (featured section), s10 (secondary cards), and s12 (report assembly) to tailor the intel report to this product.<br><b>If not provided</b>, s2 infers SLED relevance from company name and domain alone via AI search — keywords and buyer types will be less targeted.</div></div>';

  html += '<div class="form-row form-row-checkbox"><label class="form-checkbox-label"><input type="checkbox" id="mf-dedup" checked onchange="syncDedupToConfig(this.checked)"> Diversify keywords across prior runs for same domain</label>';
  html += '<div class="form-hint">When enabled, s2 analyzes prior run outcomes and generates different keywords/buyer types to avoid overlap</div></div>';

  html += '<div id="moreFields" class="more-fields">';
  html += '<div class="form-row"><label class="form-label">Campaign ID</label>';
  html += '<input class="form-input" id="mf-campaign_id"></div>';
  html += '<div class="form-row"><label class="form-label">Prospect Name</label>';
  html += '<input class="form-input" id="mf-prospect_name"></div>';
  html += '<div class="form-row"><label class="form-label">Prospect Email</label>';
  html += '<input class="form-input" id="mf-prospect_email" type="email"></div>';
  html += '<div class="form-row"><label class="form-label">Tier</label>';
  html += '<input class="form-input" id="mf-tier" placeholder="e.g. 1"></div>';
  html += '</div>';

  html += '<div class="form-actions">';
  html += '<button class="btn-run" id="btnRun" onclick="submitPipeline()">Run</button>';
  html += '<button class="btn-csv" id="btnCsv" onclick="triggerCsvUpload()">Upload CSV</button>';
  html += '<button class="btn-csv" onclick="downloadCsvTemplate()">CSV Template</button>';
  html += '<button class="btn-preset" onclick="loadPreset(\'vmock\')">Test Data</button>';
  html += '<button class="btn-preset" id="btnSample" onclick="toggleSampleRun()">Load Sample</button>';
  html += '<button class="btn-more" onclick="toggleMoreFields()">More Fields</button>';
  html += '</div>';
  html += '<input type="file" id="csvFileInput" accept=".csv" style="display:none" onchange="handleCsvUpload(event)">';

  // Concurrency selector — shown when CSV with 2+ targets is loaded
  html += '<div class="batch-concurrency" id="batchConcurrency" style="display:none">';
  html += '<label>Simultaneous runs:</label>';
  html += '<select id="batchConcurrencySelect" onchange="updateBatchConcurrency(this.value)" title="Each pipeline run uses 3\u20135 concurrent API threads. Above 3 simultaneous runs (~15 threads), you may hit Datagen rate limits.">';
  for (var ci = 1; ci <= 5; ci++) {
    html += '<option value="' + ci + '"' + (ci === 3 ? ' selected' : '') + '>' + ci + '</option>';
  }
  html += '</select>';
  html += '</div>';

  html += '<div class="run-selector-row">';
  html += '<label>Past Runs:</label>';
  html += '<select class="run-selector" id="runSelector" onchange="loadPastRun(this.value)"><option value="">Select a run...</option></select>';
  html += '</div>';

  html += '</div>';

  // ── Batch Progress Panel ──
  html += '<div class="batch-panel" id="batchPanel">';
  html += '<div class="batch-header">';
  html += '<h3>Batch Progress</h3>';
  html += '<div class="batch-summary" id="batchSummary"></div>';
  html += '<button class="batch-kill-all" id="btnBatchKill" onclick="killBatch()">Kill All</button>';
  html += '</div>';
  html += '<table class="batch-table"><thead><tr><th>#</th><th>Company</th><th>Domain</th><th>Status</th><th>Buyer</th><th>Report</th></tr></thead>';
  html += '<tbody id="batchTableBody"></tbody></table>';
  html += '</div>';

  // ── Step Tracker ──
  html += '<div class="monitor-tracker">';
  html += '<div class="tracker-header"><h3>Step Progress <span class="sample-tag" id="sampleTagTracker">SAMPLE</span></h3><div class="tracker-controls">';
  html += '<button class="tracker-toggle' + (monitorState.showSubEntries ? ' active' : '') + '" onclick="toggleAllSubEntries()" title="Toggle sub-entries">Status</button>';
  html += '<button class="tracker-toggle' + (monitorState.showOutputMsgs ? ' active' : '') + '" onclick="toggleOutputMsgs()" title="Toggle output messages">Outputs</button>';
  html += '<button class="tracker-toggle tracker-reset" onclick="resetMonitor()" title="Clear monitor">Reset</button>';
  html += '<button class="tracker-toggle tracker-kill' + (monitorState.lastRun && monitorState.lastRun.status === 'processing' && monitorState.pollInterval ? '' : ' disabled') + '" id="btnKill" onclick="killPipeline()" title="Kill running pipeline">Kill</button>';
  html += '</div></div>';
  html += '<div id="trackerSteps">';
  html += renderTrackerSteps([], null, null);
  html += '</div></div>';

  html += '</div>'; // end monitor-left

  // ── Data Viewer ──
  html += '<div class="monitor-right">';
  html += '<div class="data-viewer">';
  html += '<div class="tracker-header data-viewer-header"><h3>Data Explorer <span class="sample-tag" id="sampleTagData">SAMPLE</span></h3><div class="tracker-controls">';
  html += '<button class="tracker-toggle data-tab active" onclick="switchDataTab(\'run\')">Run</button>';
  html += '<button class="tracker-toggle data-tab" onclick="switchDataTab(\'discoveries\')">Discoveries</button>';
  html += '<button class="tracker-toggle data-tab" onclick="switchDataTab(\'contacts\')">Contacts</button>';
  html += '<button class="tracker-toggle data-tab" onclick="switchDataTab(\'audit_log\')">Audit Log</button>';
  html += '<button class="tracker-toggle data-tab" onclick="switchDataTab(\'report\')">Report</button>';
  html += '<button class="tracker-toggle data-export" id="btnExport" onclick="exportCurrentTab()">Export</button>';
  html += '</div></div>';
  html += '<div class="data-panel" id="dataPanel"><div class="data-empty">No run selected</div></div>';
  html += '</div>';
  html += '</div>'; // end monitor-right

  wrap.innerHTML = html;
  loadRunSelector();
  restoreMonitorState();
}

function restoreMonitorState() {
  // Re-apply persisted monitorState after renderMonitor rebuilds the DOM
  if (!monitorState.runId && !monitorState.lastAudit.length) return;
  // Restore form fields
  var run = monitorState.lastRun;
  if (run) {
    var mapping = { target_company: run.target_company, target_domain: run.target_domain, product_description: run.product_description };
    if (monitorState.sampleMode) {
      mapping.campaign_id = SAMPLE_RUN_55.input.campaign_id;
      mapping.prospect_name = SAMPLE_RUN_55.input.prospect_name;
      mapping.prospect_email = SAMPLE_RUN_55.input.prospect_email;
    }
    ['target_company','target_domain','product_description','campaign_id','prospect_name','prospect_email'].forEach(function(f) {
      var el = document.getElementById('mf-' + f);
      if (el && mapping[f]) el.value = mapping[f];
    });
  }
  // Restore more-fields visibility
  if (monitorState.moreFieldsVisible) {
    var mf = document.getElementById('moreFields');
    if (mf) mf.classList.add('visible');
  }
  // Restore tracker
  if (monitorState.lastAudit.length) {
    var el = document.getElementById('trackerSteps');
    var status = run ? run.status : null;
    if (el) el.innerHTML = renderTrackerSteps(monitorState.lastAudit, status, run);
  }
  // Restore data panel
  if (run && run.id) {
    switchDataTab(monitorState.activeTab);
  }
  // Restore run selector
  if (monitorState.runId) {
    var sel = document.getElementById('runSelector');
    if (sel) sel.value = monitorState.runId;
  }
  // Restore sample mode UI
  if (monitorState.sampleMode) {
    document.querySelectorAll('.sample-tag').forEach(function(t) { t.style.display = 'inline'; });
    var btn = document.getElementById('btnSample');
    if (btn) { btn.textContent = 'Remove Sample'; btn.classList.add('sample-active'); }
  }
  // Restore polling if run was in progress
  if (run && run.status === 'processing' && monitorState.runId && !monitorState.pollInterval) {
    startPolling(monitorState.runId);
  }
}

function stepIdFromAudit(auditStep) {
  // Map audit step names like "s3a_primary_search" → "s3a", "s13_validate" → "s13"
  for (var i = 0; i < STEP_ORDER.length; i++) {
    if (auditStep === STEP_ORDER[i] || auditStep.indexOf(STEP_ORDER[i] + '_') === 0) return STEP_ORDER[i];
  }
  return null;
}

function renderTrackerSteps(auditEntries, runStatus, runData) {
  // Group audit entries by step ID
  var stepEntries = {};
  (auditEntries || []).forEach(function(a) {
    var sid = stepIdFromAudit(a.step);
    if (!sid) return;
    if (!stepEntries[sid]) stepEntries[sid] = [];
    stepEntries[sid].push(a);
  });

  // Build set of completed steps (a step is "done" if it has any audit entries)
  var completedSteps = {};
  Object.keys(stepEntries).forEach(function(k) { completedSteps[k] = true; });

  var pipelineActive = runStatus === 'processing';

  // Pre-compute phase durations
  var phaseDurations = {};
  STEPS.forEach(function(s) {
    var ents = stepEntries[s.id] || [];
    var dur = 0;
    ents.forEach(function(a) { if (a.duration_seconds != null) dur += a.duration_seconds; });
    if (!phaseDurations[s.phase]) phaseDurations[s.phase] = 0;
    phaseDurations[s.phase] += dur;
  });

  var html = '';
  var lastPhase = '';

  STEPS.forEach(function(s) {
    if (s.phase !== lastPhase) {
      var pDur = phaseDurations[s.phase];
      var phaseHasEntries = STEPS.some(function(st) { return st.phase === s.phase && (stepEntries[st.id] || []).length > 0; });
      var pDurText = phaseHasEntries ? '<span class="tracker-phase-dur">' + pDur.toFixed(2) + 's</span>' : '';
      html += '<div class="tracker-phase"><div class="tracker-phase-label">' + PHASE_LABELS[s.phase] + pDurText + '</div></div>';
      lastPhase = s.phase;
    }

    var entries = stepEntries[s.id] || [];
    var statusClass = 'st-pending';
    var statusIcon = '\u25cb'; // ○
    var durText = '';

    if (entries.length) {
      // Aggregate: mixed (success+failure) → warning, all failure → failed, any warning/timeout/skipped → warning
      var hasFailure = entries.some(function(a) { return a.status === 'failure'; });
      var hasSuccess = entries.some(function(a) { return a.status === 'success'; });
      var hasWarning = entries.some(function(a) { return a.status === 'timeout' || a.status === 'warning' || a.status === 'skipped'; });
      if (hasFailure && hasSuccess) { statusClass = 'st-warning'; statusIcon = '\u26a0'; }
      else if (hasFailure) { statusClass = 'st-failed'; statusIcon = '\u2717'; }
      else if (hasWarning) { statusClass = 'st-warning'; statusIcon = '\u26a0'; }
      else { statusClass = 'st-completed'; statusIcon = '\u2713'; }
      // Total duration across all entries for this step
      var totalDur = 0; var hasDur = false;
      entries.forEach(function(a) { if (a.duration_seconds != null) { totalDur += a.duration_seconds; hasDur = true; } });
      if (hasDur) durText = totalDur.toFixed(2) + 's';
    } else if (pipelineActive) {
      // Infer running state
      var isRunning = false;
      if (PARALLEL_PHASE_A.indexOf(s.id) !== -1) {
        isRunning = !!completedSteps[SEQ_BEFORE_A];
      } else if (PARALLEL_PHASE_B.indexOf(s.id) !== -1) {
        isRunning = !!completedSteps[SEQ_BEFORE_B];
      } else if (s.id === SEQ_AFTER_A) {
        isRunning = PARALLEL_PHASE_A.every(function(id) { return !!completedSteps[id]; });
      } else if (s.id === SEQ_AFTER_B) {
        isRunning = PARALLEL_PHASE_B.every(function(id) { return !!completedSteps[id]; });
      } else {
        // Sequential: running if all prior sequential steps are done
        var idx = STEP_ORDER.indexOf(s.id);
        if (idx === 0) {
          isRunning = true;
        } else {
          var priorDone = true;
          for (var i = idx - 1; i >= 0; i--) {
            var priorId = STEP_ORDER[i];
            // Skip parallel siblings
            if (PARALLEL_PHASE_A.indexOf(priorId) !== -1 && PARALLEL_PHASE_A.indexOf(s.id) === -1) {
              if (!PARALLEL_PHASE_A.every(function(id) { return !!completedSteps[id]; })) { priorDone = false; break; }
              break;
            }
            if (PARALLEL_PHASE_B.indexOf(priorId) !== -1 && PARALLEL_PHASE_B.indexOf(s.id) === -1) {
              if (!PARALLEL_PHASE_B.every(function(id) { return !!completedSteps[id]; })) { priorDone = false; break; }
              break;
            }
            if (!completedSteps[priorId]) { priorDone = false; break; }
          }
          isRunning = priorDone;
        }
      }
      if (isRunning) { statusClass = 'st-running'; statusIcon = '\u25cf'; }
    }

    var expanded = monitorState.expandedSteps[s.id] !== undefined ? monitorState.expandedSteps[s.id] : (monitorState.showSubEntries && entries.length > 0);
    html += '<div class="tracker-step ' + statusClass + '" onclick="toggleTrackerExpand(\'' + s.id + '\')">';
    html += '<span class="tracker-step-id">' + s.id + '</span>';
    html += '<span class="tracker-step-name">' + s.name + '</span>';
    html += '<span class="tracker-step-status">' + statusIcon + '</span>';
    html += '<span class="tracker-step-dur">' + durText + '</span>';
    html += '</div>';

    // Substeps (expanded)
    if (expanded && entries.length) {
      html += '<div class="tracker-substeps">';
      entries.forEach(function(sub) {
        var subDur = sub.duration_seconds != null ? sub.duration_seconds.toFixed(2) + 's' : '';
        var subIcon = sub.status === 'success' ? '\u2713' : sub.status === 'failure' ? '\u2717' : '\u26a0';
        var subClass = sub.status === 'success' ? 'st-completed' : sub.status === 'failure' ? 'st-failed' : 'st-warning';
        var subName = sub.step.indexOf(s.id + '_') === 0 ? sub.step.replace(s.id + '_', '') : sub.step;
        html += '<div class="tracker-substep ' + subClass + '"><span>' + subIcon + '</span><span>' + subName + '</span><span>' + subDur + '</span>';
        if (sub.message) html += '<span style="opacity:0.6"> \u2014 ' + escHtml(sub.message) + '</span>';
        html += '</div>';
      });
      html += '</div>';
    }

    // Output data (when toggled on)
    if (monitorState.showOutputMsgs && entries.length) {
      var metaEntries = entries.filter(function(e) { return e.metadata; });
      if (metaEntries.length) {
        var outputId = 'output_' + s.id;
        html += '<div class="tracker-output-wrap">';
        html += '<button class="tracker-output-copy" onclick="copyOutput(\'' + outputId + '\')" title="Copy">&#x2398;</button>';
        html += '<div class="tracker-output" id="' + outputId + '">';
        metaEntries.forEach(function(sub) {
          var parsed = null;
          try { parsed = typeof sub.metadata === 'string' ? JSON.parse(sub.metadata) : sub.metadata; } catch(e) {}
          if (parsed) {
            var label = sub.step.indexOf(s.id + '_') === 0 ? sub.step.replace(s.id + '_', '') : sub.step;
            html += '<strong>' + escHtml(label) + ':</strong>\n' + escHtml(JSON.stringify(parsed, null, 2)) + '\n\n';
          }
        });
        html += '</div></div>';
      }
    }
  });

  // Total pipeline duration (wall-clock from run timestamps)
  var hasAnyEntries = Object.keys(stepEntries).length > 0;
  if (hasAnyEntries) {
    var statusText = runStatus === 'completed' ? 'completed' : runStatus === 'failed' ? 'failed' : 'in progress';
    var wallClock = null;
    if (runData && runData.created_at) {
      var end = runData.completed_at ? new Date(runData.completed_at + 'Z') : new Date();
      wallClock = (end - new Date(runData.created_at + 'Z')) / 1000;
    }
    var durStr = wallClock != null ? wallClock.toFixed(1) + 's' : '...';
    html += '<div class="tracker-total"><span>Total</span><span>' + durStr + ' (' + statusText + ')</span></div>';
  }

  return html;
}

function toggleTrackerExpand(stepId) {
  var current = monitorState.expandedSteps[stepId];
  if (current === undefined) current = monitorState.showSubEntries;
  monitorState.expandedSteps[stepId] = !current;
  reRenderTracker();
}

function toggleAllSubEntries() {
  monitorState.showSubEntries = !monitorState.showSubEntries;
  STEP_ORDER.forEach(function(sid) { monitorState.expandedSteps[sid] = monitorState.showSubEntries; });
  reRenderTracker();
}

function toggleOutputMsgs() {
  monitorState.showOutputMsgs = !monitorState.showOutputMsgs;
  reRenderTracker();
}

function copyOutput(id) {
  var el = document.getElementById(id);
  if (!el) return;
  navigator.clipboard.writeText(el.textContent.trim()).then(function() {
    var btn = el.parentElement.querySelector('.tracker-output-copy');
    if (btn) { btn.textContent = '\u2713'; setTimeout(function() { btn.innerHTML = '&#x2398;'; }, 1200); }
  });
}

function resetMonitor() {
  if (monitorState.pollInterval) { clearInterval(monitorState.pollInterval); monitorState.pollInterval = null; }
  stopBatchPolling();
  monitorState.runId = null;
  monitorState.lastAudit = [];
  monitorState.lastRun = null;
  monitorState.activeTab = 'run';
  monitorState.expandedSteps = {};
  monitorState.batchId = null;
  monitorState.batchRunIds = [];
  monitorState.batchRuns = [];
  monitorState.selectedBatchRunId = null;
  monitorState.pendingBatchWebhooks = null;
  monitorState.sampleMode = false;
  ['target_company','target_domain','product_description','campaign_id','prospect_name','prospect_email'].forEach(function(f) {
    var el = document.getElementById('mf-' + f);
    if (el) el.value = '';
  });
  var sel = document.getElementById('runSelector');
  if (sel) sel.value = '';
  var msg = document.getElementById('monitorMsg');
  if (msg) msg.innerHTML = '';
  var btn = document.getElementById('btnRun');
  if (btn) { btn.disabled = false; btn.textContent = 'Run'; }
  var csvBtn = document.getElementById('btnCsv');
  if (csvBtn) { csvBtn.disabled = false; }
  var bp = document.getElementById('batchPanel');
  if (bp) bp.classList.remove('visible');
  var concRow = document.getElementById('batchConcurrency');
  if (concRow) concRow.style.display = 'none';
  // Clear sample tags and reset sample button
  document.querySelectorAll('.sample-tag').forEach(function(t) { t.style.display = 'none'; });
  var sampleBtn = document.getElementById('btnSample');
  if (sampleBtn) { sampleBtn.textContent = 'Load Sample'; sampleBtn.classList.remove('sample-active'); }
  reRenderTracker();
  var dp = document.getElementById('dataPanel');
  if (dp) dp.innerHTML = '<div class="data-empty">No run selected</div>';
  document.querySelectorAll('.data-tab').forEach(function(t) { t.classList.remove('active'); });
  var runTab = document.querySelector('.data-tab');
  if (runTab) runTab.classList.add('active');
}

function killPipeline() {
  if (!monitorState.runId) return;
  var btn = document.getElementById('btnKill');
  if (btn) { btn.classList.add('disabled'); btn.textContent = 'Killing...'; }
  fetch('/api/kill/' + monitorState.runId, { method: 'POST' })
  .then(function(r) {
    if (!r.ok) return r.json().then(function(d) { throw new Error(d.detail || 'Kill failed'); });
    return r.json();
  })
  .then(function(data) {
    stopPolling();
    showMonitorMsg('Pipeline killed — Run #' + monitorState.runId, 'error');
    if (monitorState.lastRun) monitorState.lastRun.status = 'cancelled';
    var runBtn = document.getElementById('btnRun');
    if (runBtn) { runBtn.disabled = false; runBtn.textContent = 'Run'; }
    if (btn) btn.textContent = 'Kill';
    reRenderTracker();
    loadRunSelector();
    // Poll one last time to get final audit state
    fetch('/api/status/' + monitorState.runId)
    .then(function(r) { return r.json(); })
    .then(function(d) {
      monitorState.lastAudit = d.audit_log || [];
      monitorState.lastRun = d.run || {};
      reRenderTracker();
    });
  })
  .catch(function(err) {
    showMonitorMsg('Kill failed: ' + err.message, 'error');
    if (btn) { btn.classList.remove('disabled'); btn.textContent = 'Kill'; }
  });
}

function reRenderTracker() {
  var el = document.getElementById('trackerSteps');
  if (el) {
    // Preserve scroll positions of output panes before re-render
    var scrollState = {};
    el.querySelectorAll('.tracker-output').forEach(function(o) {
      if (o.id && o.scrollTop > 0) scrollState[o.id] = o.scrollTop;
    });
    // Also preserve the tracker container's own scroll position
    var containerScroll = el.scrollTop;

    el.innerHTML = renderTrackerSteps(monitorState.lastAudit, monitorState.lastRun ? monitorState.lastRun.status : null, monitorState.lastRun);

    // Restore scroll positions after re-render
    Object.keys(scrollState).forEach(function(id) {
      var restored = document.getElementById(id);
      if (restored) restored.scrollTop = scrollState[id];
    });
    el.scrollTop = containerScroll;
  }
  var btns = document.querySelectorAll('.tracker-toggle');
  btns.forEach(function(b) {
    if (b.textContent === 'Status') b.classList.toggle('active', monitorState.showSubEntries);
    if (b.textContent === 'Outputs') b.classList.toggle('active', monitorState.showOutputMsgs);
  });
  // Update Kill button + tracker border pulse
  var killBtn = document.getElementById('btnKill');
  var isRunning = monitorState.lastRun && monitorState.lastRun.status === 'processing' && monitorState.pollInterval;
  if (killBtn) killBtn.classList.toggle('disabled', !isRunning);
  var tracker = document.querySelector('.monitor-tracker');
  if (tracker) tracker.classList.toggle('running', !!isRunning);
}

// ── Form actions ──

function loadPreset(name) {
  var p = MONITOR_PRESETS[name];
  if (!p) return;
  var fields = ['target_company','target_domain','product_description','campaign_id','prospect_name','prospect_email'];
  fields.forEach(function(f) {
    var el = document.getElementById('mf-' + f);
    if (el) el.value = p[f] || '';
  });
  // Show more fields if preset has them
  if (p.campaign_id || p.prospect_name || p.prospect_email) {
    monitorState.moreFieldsVisible = true;
    var mf = document.getElementById('moreFields');
    if (mf) mf.classList.add('visible');
  }
}

function toggleSampleRun() {
  if (monitorState.sampleMode) {
    resetMonitor();
    return;
  }
  monitorState.sampleMode = true;
  // Populate form from sample input
  var fields = ['target_company','target_domain','product_description','campaign_id','prospect_name','prospect_email'];
  fields.forEach(function(f) {
    var el = document.getElementById('mf-' + f);
    if (el) el.value = SAMPLE_RUN_55.input[f] || '';
  });
  // Show more fields since sample has campaign_id/prospect_name/email
  monitorState.moreFieldsVisible = true;
  var mf = document.getElementById('moreFields');
  if (mf) mf.classList.add('visible');
  // Load audit + run into monitor state
  monitorState.lastAudit = SAMPLE_RUN_55.audit;
  monitorState.lastRun = SAMPLE_RUN_55.run;
  monitorState.runId = 55;
  // Render tracker and run tab
  var el = document.getElementById('trackerSteps');
  if (el) el.innerHTML = renderTrackerSteps(SAMPLE_RUN_55.audit, SAMPLE_RUN_55.run.status, SAMPLE_RUN_55.run);
  switchDataTab(monitorState.activeTab);
  // Show SAMPLE tags and update button
  document.querySelectorAll('.sample-tag').forEach(function(t) { t.style.display = 'inline'; });
  var btn = document.getElementById('btnSample');
  if (btn) { btn.textContent = 'Remove Sample'; btn.classList.add('sample-active'); }
}

function toggleMoreFields() {
  monitorState.moreFieldsVisible = !monitorState.moreFieldsVisible;
  var mf = document.getElementById('moreFields');
  if (mf) mf.classList.toggle('visible', monitorState.moreFieldsVisible);
}

// ── CSV batch ──

var CSV_HEADERS = ['target_company','target_domain','product_description','campaign_id','prospect_name','prospect_email','tier'];

function downloadCsvTemplate() {
  var rows = [CSV_HEADERS.join(',')];
  rows.push('VMock,vmock.com,"AI-powered career services platform",test_001,John Smith,john@vmock.com,1');
  var blob = new Blob([rows.join('\n')], { type: 'text/csv' });
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'pipeline-batch-template.csv';
  a.click();
  URL.revokeObjectURL(a.href);
}

function triggerCsvUpload() {
  var input = document.getElementById('csvFileInput');
  if (input) { input.value = ''; input.click(); }
}

function parseCsvLine(line) {
  var fields = [];
  var current = '';
  var inQuotes = false;
  for (var i = 0; i < line.length; i++) {
    var c = line[i];
    if (inQuotes) {
      if (c === '"') {
        if (i + 1 < line.length && line[i + 1] === '"') { current += '"'; i++; }
        else { inQuotes = false; }
      } else { current += c; }
    } else {
      if (c === '"') { inQuotes = true; }
      else if (c === ',') { fields.push(current.trim()); current = ''; }
      else { current += c; }
    }
  }
  fields.push(current.trim());
  return fields;
}

function parseCsv(text) {
  var lines = text.split(/\r?\n/).filter(function(l) { return l.trim().length > 0; });
  if (lines.length < 2) return { error: 'CSV must have a header row and at least one data row.' };

  var rawHeaders = parseCsvLine(lines[0]);
  // Normalize headers: lowercase, trim, replace spaces with underscores
  var headers = rawHeaders.map(function(h) { return h.toLowerCase().replace(/\s+/g, '_'); });

  // Validate headers — at least one recognized field
  var validCount = 0;
  headers.forEach(function(h) { if (CSV_HEADERS.indexOf(h) >= 0) validCount++; });
  if (validCount === 0) return { error: 'No recognized headers. Expected: ' + CSV_HEADERS.join(', ') };

  var webhooks = [];
  var errors = [];
  for (var i = 1; i < lines.length; i++) {
    var vals = parseCsvLine(lines[i]);
    var wh = {};
    for (var j = 0; j < headers.length; j++) {
      if (CSV_HEADERS.indexOf(headers[j]) >= 0 && vals[j]) wh[headers[j]] = vals[j];
    }
    if (!wh.target_company && !wh.target_domain) {
      errors.push('Row ' + i + ': missing target_company and target_domain');
    } else {
      webhooks.push(wh);
    }
  }
  if (errors.length) return { error: errors.join('\n') };
  return { webhooks: webhooks };
}

function handleCsvUpload(event) {
  var file = event.target.files[0];
  if (!file) return;
  var reader = new FileReader();
  reader.onload = function(e) {
    var result = parseCsv(e.target.result);
    if (result.error) {
      showMonitorMsg('CSV error: ' + result.error, 'error');
      return;
    }
    if (!result.webhooks.length) {
      showMonitorMsg('CSV has no valid rows.', 'error');
      return;
    }
    // Store webhooks — don't submit until user clicks Run / Run Batch
    monitorState.pendingBatchWebhooks = result.webhooks;
    var btn = document.getElementById('btnRun');
    if (btn) btn.textContent = result.webhooks.length >= 2 ? 'Run Batch' : 'Run';
    // Show concurrency selector for 2+ targets
    if (result.webhooks.length >= 2) {
      var concRow = document.getElementById('batchConcurrency');
      if (concRow) {
        concRow.style.display = 'flex';
        // Initialize from current config
        fetch('/api/config').then(function(r) { return r.json(); }).then(function(cfg) {
          var sel = document.getElementById('batchConcurrencySelect');
          if (sel && cfg.MAX_CONCURRENT_RUNS) sel.value = cfg.MAX_CONCURRENT_RUNS;
        }).catch(function() {});
      }
    }
    showMonitorMsg('CSV loaded — ' + result.webhooks.length + ' target' + (result.webhooks.length > 1 ? 's' : '') + ' ready', 'info');
  };
  reader.readAsText(file);
}

function updateBatchConcurrency(val) {
  var v = parseInt(val, 10);
  if (isNaN(v) || v < 1) v = 1;
  fetch('/api/config', {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ MAX_CONCURRENT_RUNS: v })
  }).catch(function() {});
}

function submitBatch(webhooks) {
  clearMonitorMsg();
  var btn = document.getElementById('btnRun');
  var csvBtn = document.getElementById('btnCsv');
  if (btn) { btn.disabled = true; }
  if (csvBtn) { csvBtn.disabled = true; }
  showMonitorMsg('Starting batch of ' + webhooks.length + ' runs...', 'info');

  fetch('/api/batch', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(webhooks)
  })
  .then(function(r) {
    if (!r.ok) return r.json().then(function(d) { throw new Error(d.detail || 'Server error'); });
    return r.json();
  })
  .then(function(data) {
    monitorState.batchId = data.batch_id;
    monitorState.batchRunIds = data.run_ids || [];
    monitorState.batchRuns = [];
    monitorState.selectedBatchRunId = null;
    showMonitorMsg('Batch #' + data.batch_id + ' started \u2014 ' + data.total + ' runs', 'info');
    var bp = document.getElementById('batchPanel');
    if (bp) bp.classList.add('visible');
    startBatchPolling(data.batch_id);
  })
  .catch(function(err) {
    showMonitorMsg('Batch failed: ' + err.message, 'error');
    if (btn) { btn.disabled = false; }
    if (csvBtn) { csvBtn.disabled = false; }
  });
}

function startBatchPolling(batchId) {
  stopBatchPolling();
  pollBatchStatus();
  monitorState.batchPollInterval = setInterval(pollBatchStatus, 2000);
}

function stopBatchPolling() {
  if (monitorState.batchPollInterval) {
    clearInterval(monitorState.batchPollInterval);
    monitorState.batchPollInterval = null;
  }
}

function pollBatchStatus() {
  if (!monitorState.batchId) return;
  fetch('/api/batch-status/' + monitorState.batchId)
  .then(function(r) { return r.json(); })
  .then(function(data) {
    monitorState.batchRuns = data.runs || [];
    renderBatchTable(data);

    // Check if all done
    var terminal = (data.completed || 0) + (data.failed || 0) + (data.cancelled || 0);
    if (terminal >= data.total) {
      stopBatchPolling();
      var btn = document.getElementById('btnRun');
      var csvBtn = document.getElementById('btnCsv');
      if (btn) { btn.disabled = false; btn.textContent = 'Run'; }
      if (csvBtn) { csvBtn.disabled = false; }
      var concRow = document.getElementById('batchConcurrency');
      if (concRow) concRow.style.display = 'none';
      var msgType = (data.failed || 0) > 0 ? 'error' : 'info';
      showMonitorMsg('Batch #' + data.batch_id + ' complete \u2014 ' + (data.completed || 0) + ' done, ' + (data.failed || 0) + ' failed', msgType);
      loadRunSelector();
    }
  })
  .catch(function() {});
}

function renderBatchTable(data) {
  var tbody = document.getElementById('batchTableBody');
  if (!tbody) return;

  var html = '';
  (data.runs || []).forEach(function(r, i) {
    var selected = monitorState.selectedBatchRunId === r.id ? ' selected' : '';
    var statusCls = 'batch-status-' + (r.status || 'queued');
    html += '<tr class="batch-row' + selected + '" onclick="selectBatchRun(' + r.id + ')">';
    html += '<td>' + (i + 1) + '</td>';
    html += '<td>' + escHtml(r.target_company || '') + '</td>';
    html += '<td>' + escHtml(r.target_domain || '') + '</td>';
    html += '<td><span class="batch-status ' + statusCls + '">' + (r.status || 'queued') + '</span></td>';
    html += '<td>' + escHtml(r.featured_buyer_name || '\u2014') + '</td>';
    html += '<td>';
    if (r.notion_url) html += '<a href="' + escHtml(r.notion_url) + '" target="_blank" style="color:var(--blue);font-size:10px">View</a>';
    html += '</td></tr>';
  });
  tbody.innerHTML = html;

  // Update summary
  var summary = document.getElementById('batchSummary');
  if (summary) {
    var parts = [];
    if (data.completed) parts.push('<span class="bs-count" style="color:var(--green)">' + data.completed + ' done</span>');
    if (data.processing) parts.push('<span class="bs-count" style="color:var(--blue)">' + data.processing + ' running</span>');
    if (data.pending) parts.push('<span class="bs-count" style="color:var(--text-dim)">' + data.pending + ' pending</span>');
    if (data.failed) parts.push('<span class="bs-count" style="color:var(--red)">' + data.failed + ' failed</span>');
    if (data.cancelled) parts.push('<span class="bs-count" style="color:var(--orange)">' + data.cancelled + ' cancelled</span>');
    summary.innerHTML = parts.join(' &middot; ');
  }

  // Update Kill All button
  var killBtn = document.getElementById('btnBatchKill');
  if (killBtn) {
    var hasActive = (data.processing || 0) + (data.pending || 0) > 0;
    killBtn.classList.toggle('disabled', !hasActive);
  }
}

function selectBatchRun(runId) {
  monitorState.selectedBatchRunId = runId;
  monitorState.runId = runId;

  // Re-highlight selected row
  document.querySelectorAll('.batch-row').forEach(function(row) {
    row.classList.toggle('selected', row.getAttribute('onclick').indexOf(runId) >= 0);
  });

  // Load this run's step tracker + data
  fetch('/api/status/' + runId)
  .then(function(r) { return r.json(); })
  .then(function(data) {
    monitorState.lastAudit = data.audit_log || [];
    monitorState.lastRun = data.run || {};
    reRenderTracker();
    if (monitorState.activeTab === 'run') renderRunTab(monitorState.lastRun);

    // Start single-run polling if still processing
    if (monitorState.lastRun.status === 'processing') {
      startPolling(runId);
    } else {
      stopPolling();
    }
  })
  .catch(function(err) { showMonitorMsg('Failed to load run: ' + err.message, 'error'); });
}

function killBatch() {
  if (!monitorState.batchId) return;
  var killBtn = document.getElementById('btnBatchKill');
  if (killBtn) { killBtn.classList.add('disabled'); killBtn.textContent = 'Killing...'; }

  fetch('/api/batch-kill/' + monitorState.batchId, { method: 'POST' })
  .then(function(r) {
    if (!r.ok) return r.json().then(function(d) { throw new Error(d.detail || 'Kill failed'); });
    return r.json();
  })
  .then(function(data) {
    showMonitorMsg('Batch killed \u2014 ' + data.killed + ' runs cancelled', 'error');
    if (killBtn) killBtn.textContent = 'Kill All';
    pollBatchStatus(); // one final poll
  })
  .catch(function(err) {
    showMonitorMsg('Batch kill failed: ' + err.message, 'error');
    if (killBtn) { killBtn.classList.remove('disabled'); killBtn.textContent = 'Kill All'; }
  });
}

function showMonitorMsg(text, type) {
  var el = document.getElementById('monitorMsg');
  if (el) el.innerHTML = '<div class="monitor-msg monitor-msg-' + (type || 'info') + '">' + escHtml(text) + '</div>';
}

function clearMonitorMsg() {
  var el = document.getElementById('monitorMsg');
  if (el) el.innerHTML = '';
}

function submitPipeline() {
  // If CSV was loaded, submit as batch instead
  if (monitorState.pendingBatchWebhooks && monitorState.pendingBatchWebhooks.length > 0) {
    var webhooks = monitorState.pendingBatchWebhooks;
    monitorState.pendingBatchWebhooks = null;
    submitBatch(webhooks);
    return;
  }

  var fields = ['target_company','target_domain','product_description','campaign_id','prospect_name','prospect_email'];
  var webhook = {};
  fields.forEach(function(f) {
    var el = document.getElementById('mf-' + f);
    if (el && el.value.trim()) webhook[f] = el.value.trim();
  });
  var tierEl = document.getElementById('mf-tier');
  if (tierEl && tierEl.value.trim()) webhook.tier = tierEl.value.trim();

  if (!webhook.target_company && !webhook.target_domain) {
    showMonitorMsg('At least one of Target Company or Target Domain is required.', 'error');
    return;
  }

  clearMonitorMsg();
  var btn = document.getElementById('btnRun');
  btn.disabled = true;
  btn.textContent = 'Starting...';

  fetch('/api/run', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(webhook)
  })
  .then(function(r) {
    if (r.status === 409) { showMonitorMsg('Pipeline already running. Wait for it to finish.', 'error'); btn.disabled = false; btn.textContent = 'Run'; return null; }
    if (!r.ok) return r.json().then(function(d) { throw new Error(d.detail || 'Server error'); });
    return r.json();
  })
  .then(function(data) {
    if (!data) return;
    btn.textContent = 'Running...';
    if (data.run_id) {
      monitorState.runId = data.run_id;
      startPolling(data.run_id);
      showMonitorMsg('Pipeline started \u2014 Run #' + data.run_id, 'info');
    } else {
      showMonitorMsg('Pipeline started but run_id not yet available. Refresh in a moment.', 'info');
      btn.disabled = false;
      btn.textContent = 'Run';
    }
  })
  .catch(function(err) {
    showMonitorMsg(err.message, 'error');
    btn.disabled = false;
    btn.textContent = 'Run';
  });
}

function syncDedupToConfig(checked) {
  // Push checkbox state to config API (same as editing in config panel)
  var body = { ENABLE_PRIOR_RUN_DEDUP: checked };
  fetch('/api/config', { method: 'PATCH', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) })
    .then(function(r) { return r.json(); })
    .then(function(res) {
      if (res.values) state.config.values = res.values;
    })
    .catch(function() {});
}

function syncDedupCheckbox() {
  // Sync checkbox from config state (called after config loads/resets)
  var cb = document.getElementById('mf-dedup');
  if (cb && state.config && state.config.values) {
    cb.checked = state.config.values.ENABLE_PRIOR_RUN_DEDUP !== false;
  }
}

// ── Polling ──

function startPulseClock() {
  if (monitorState.pulseInterval) return;
  monitorState.pulseInterval = setInterval(function() {
    var tracker = document.querySelector('.monitor-tracker');
    if (tracker) tracker.classList.toggle('pulse-dim');
  }, 600);
}

function stopPulseClock() {
  if (monitorState.pulseInterval) {
    clearInterval(monitorState.pulseInterval);
    monitorState.pulseInterval = null;
  }
  var tracker = document.querySelector('.monitor-tracker');
  if (tracker) tracker.classList.remove('pulse-dim');
}

function startPolling(runId) {
  stopPolling();
  monitorState.runId = runId;
  pollStatus();
  monitorState.pollInterval = setInterval(pollStatus, 1500);
  startPulseClock();
}

function stopPolling() {
  if (monitorState.pollInterval) {
    clearInterval(monitorState.pollInterval);
    monitorState.pollInterval = null;
  }
  stopPulseClock();
}

function pollStatus() {
  if (!monitorState.runId) return;
  fetch('/api/status/' + monitorState.runId)
  .then(function(r) { return r.json(); })
  .then(function(data) {
    monitorState.lastAudit = data.audit_log || [];
    monitorState.lastRun = data.run || {};

    // Update tracker (preserve scroll positions)
    var el = document.getElementById('trackerSteps');
    if (el) {
      var scrollState = {};
      el.querySelectorAll('.tracker-output').forEach(function(o) {
        if (o.id && o.scrollTop > 0) scrollState[o.id] = o.scrollTop;
      });
      var containerScroll = el.scrollTop;
      el.innerHTML = renderTrackerSteps(monitorState.lastAudit, monitorState.lastRun.status, monitorState.lastRun);
      Object.keys(scrollState).forEach(function(id) {
        var restored = document.getElementById(id);
        if (restored) restored.scrollTop = scrollState[id];
      });
      el.scrollTop = containerScroll;
    }

    // Update Kill button + tracker border pulse
    var killBtn = document.getElementById('btnKill');
    var isRunning = monitorState.lastRun.status === 'processing' && monitorState.pollInterval;
    if (killBtn) killBtn.classList.toggle('disabled', !isRunning);
    var tracker = document.querySelector('.monitor-tracker');
    if (tracker) tracker.classList.toggle('running', !!isRunning);

    // Update data panel if on Run tab
    if (monitorState.activeTab === 'run') renderRunTab(monitorState.lastRun);

    // Stop polling if done
    if (monitorState.lastRun.status === 'completed' || monitorState.lastRun.status === 'failed' || monitorState.lastRun.status === 'cancelled') {
      stopPolling();
      var btn = document.getElementById('btnRun');
      if (btn) { btn.disabled = false; btn.textContent = 'Run'; }
      var statusLabel = monitorState.lastRun.status;
      var msgType = monitorState.lastRun.status === 'completed' ? 'info' : 'error';
      showMonitorMsg('Pipeline ' + statusLabel + ' \u2014 Run #' + monitorState.runId, msgType);
      loadRunSelector(); // refresh run list
    }

    if (!data.pipeline_active && monitorState.lastRun.status === 'processing' && data.error) {
      stopPolling();
      var btn = document.getElementById('btnRun');
      if (btn) { btn.disabled = false; btn.textContent = 'Run'; }
      showMonitorMsg('Pipeline error: ' + data.error, 'error');
    }
  })
  .catch(function() {}); // silent polling errors
}

// ── Run selector ──

function loadRunSelector() {
  fetch('/api/runs')
  .then(function(r) { return r.json(); })
  .then(function(runs) {
    var sel = document.getElementById('runSelector');
    if (!sel) return;
    var html = '<option value="">Select a run...</option>';
    runs.forEach(function(r) {
      var label = '#' + r.id + ' ' + (r.target_company || r.target_domain || '?') + ' [' + r.status + '] ' + (r.created_at || '');
      html += '<option value="' + r.id + '">' + escHtml(label) + '</option>';
    });
    sel.innerHTML = html;
  })
  .catch(function() {});
}

function loadPastRun(runId) {
  if (!runId) return;
  stopPolling();
  // Clear sample mode if active
  monitorState.sampleMode = false;
  document.querySelectorAll('.sample-tag').forEach(function(t) { t.style.display = 'none'; });
  var sampleBtn = document.getElementById('btnSample');
  if (sampleBtn) { sampleBtn.textContent = 'Load Sample'; sampleBtn.classList.remove('sample-active'); }
  var tracker = document.querySelector('.monitor-tracker');
  if (tracker) tracker.classList.remove('running');
  monitorState.runId = parseInt(runId);
  // Load status once
  fetch('/api/status/' + runId)
  .then(function(r) { return r.json(); })
  .then(function(data) {
    monitorState.lastAudit = data.audit_log || [];
    monitorState.lastRun = data.run || {};
    var el = document.getElementById('trackerSteps');
    if (el) el.innerHTML = renderTrackerSteps(monitorState.lastAudit, monitorState.lastRun.status, monitorState.lastRun);
    if (monitorState.activeTab === 'run') renderRunTab(monitorState.lastRun);
    showMonitorMsg('Loaded Run #' + runId + ' [' + (monitorState.lastRun.status || '?') + ']', 'info');

    // If still processing, start polling
    if (monitorState.lastRun.status === 'processing' || monitorState.lastRun.status === 'pending') startPolling(parseInt(runId));
  })
  .catch(function(err) { showMonitorMsg('Failed to load run: ' + err.message, 'error'); });
}

// ── Data tabs ──

function switchDataTab(tab) {
  monitorState.activeTab = tab;
  var tabMap = { 'Run': 'run', 'Discoveries': 'discoveries', 'Contacts': 'contacts', 'Audit Log': 'audit_log', 'Report': 'report' };
  document.querySelectorAll('.data-tab').forEach(function(t) {
    t.classList.toggle('active', tabMap[t.textContent] === tab);
  });

  var panel = document.getElementById('dataPanel');
  if (!monitorState.runId) { panel.innerHTML = '<div class="data-empty">No run selected</div>'; return; }

  if (tab === 'run') {
    renderRunTab(monitorState.lastRun || {});
  } else if (tab === 'report') {
    renderReportTab();
  } else if (monitorState.sampleMode) {
    // Sample mode — use embedded data
    if (tab === 'audit_log') renderAuditLogTab(SAMPLE_RUN_55.audit);
    else if (tab === 'discoveries') renderDiscoveriesTab(SAMPLE_RUN_55.discoveries);
    else if (tab === 'contacts') renderContactsTab(SAMPLE_RUN_55.contacts);
  } else {
    panel.innerHTML = '<div class="data-empty">Loading...</div>';
    fetch('/api/data/' + monitorState.runId + '/' + tab)
    .then(function(r) { return r.json(); })
    .then(function(rows) {
      if (tab === 'discoveries') renderDiscoveriesTab(rows);
      else if (tab === 'contacts') renderContactsTab(rows);
      else if (tab === 'audit_log') renderAuditLogTab(rows);
    })
    .catch(function(err) { panel.innerHTML = '<div class="data-empty">Error: ' + escHtml(err.message) + '</div>'; });
  }
}

function exportCurrentTab() {
  if (!monitorState.runId) return;
  var tab = monitorState.activeTab;
  var filename = 'run_' + monitorState.runId + '_' + tab;

  if (tab === 'run') {
    // Export run data as JSON
    var run = monitorState.lastRun || {};
    var blob = new Blob([JSON.stringify(run, null, 2)], { type: 'application/json' });
    _downloadBlob(blob, filename + '.json');
  } else if (tab === 'report') {
    // Export report as markdown
    var md = _extractReportMarkdown();
    if (!md) { showMonitorMsg('No report to export', 'error'); return; }
    var blob = new Blob([md], { type: 'text/markdown' });
    _downloadBlob(blob, filename + '.md');
  } else if (monitorState.sampleMode) {
    // Sample mode — use embedded data
    var sampleData = { discoveries: SAMPLE_RUN_55.discoveries, contacts: SAMPLE_RUN_55.contacts, audit_log: SAMPLE_RUN_55.audit };
    var rows = sampleData[tab];
    if (!rows || !rows.length) { showMonitorMsg('No data to export', 'error'); return; }
    _exportRowsCsv(rows, filename + '.csv');
  } else {
    // Fetch table data and export as CSV
    fetch('/api/data/' + monitorState.runId + '/' + tab)
    .then(function(r) { return r.json(); })
    .then(function(rows) {
      if (!rows || !rows.length) { showMonitorMsg('No data to export', 'error'); return; }
      _exportRowsCsv(rows, filename + '.csv');
    })
    .catch(function(err) { showMonitorMsg('Export failed: ' + err.message, 'error'); });
  }
}

function _exportRowsCsv(rows, filename) {
  var cols = Object.keys(rows[0]);
  var csv = cols.join(',') + '\n';
  rows.forEach(function(r) {
    csv += cols.map(function(c) {
      var v = r[c] == null ? '' : String(r[c]);
      return v.indexOf(',') !== -1 || v.indexOf('"') !== -1 || v.indexOf('\n') !== -1
        ? '"' + v.replace(/"/g, '""') + '"' : v;
    }).join(',') + '\n';
  });
  var blob = new Blob([csv], { type: 'text/csv' });
  _downloadBlob(blob, filename);
}

function _downloadBlob(blob, filename) {
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(a.href);
}

function renderRunTab(run) {
  var panel = document.getElementById('dataPanel');
  if (!run || !run.id) { panel.innerHTML = '<div class="data-empty">No run data</div>'; return; }
  var html = '<dl class="data-kv">';
  html += '<dt>Run ID</dt><dd>#' + run.id + (run.batch_id ? ' (batch ' + run.batch_id + ')' : '') + '</dd>';
  html += '<dt>Status</dt><dd><span class="' + (run.status === 'completed' ? 'st-completed' : run.status === 'failed' ? 'st-failed' : run.status === 'cancelled' ? 'st-warning' : 'st-running') + '">' + (run.status || '?') + '</span></dd>';
  html += '<dt>Target Domain</dt><dd>' + escHtml(run.target_domain || '') + '</dd>';
  html += '<dt>Target Company</dt><dd>' + escHtml(run.target_company || '') + '</dd>';
  if (run.product_description) html += '<dt>Product Description</dt><dd>' + escHtml(run.product_description) + '</dd>';
  // Prior run dedup info
  if (run.prior_run_count != null) {
    var dedupLabel = run.dedup_enabled === false ? ' <span style="opacity:0.5">(dedup off)</span>' : run.dedup_enabled === true ? ' <span style="opacity:0.5">(dedup on)</span>' : '';
    if (run.prior_run_count > 0) {
      if (run.dedup_enabled === false) {
        html += '<dt>Prior Runs</dt><dd><span class="st-warning">' + run.prior_run_count + ' prior run(s)</span> — dedup disabled, ran without keyword diversification</dd>';
      } else {
        html += '<dt>Prior Runs</dt><dd><span class="st-warning">' + run.prior_run_count + ' prior run(s)</span> — s2 diversified keywords to avoid overlap</dd>';
      }
    } else {
      html += '<dt>Prior Runs</dt><dd>First run for this domain (to avoid overlap in future runs, will diversify keywords in s2)' + dedupLabel + '</dd>';
    }
  }
  html += '<dt>Featured Buyer</dt><dd>' + escHtml(run.featured_buyer_name || '\u2014') + (run.featured_buyer_type ? ' <span style="opacity:0.5">(' + escHtml(run.featured_buyer_type) + ')</span>' : '') + '</dd>';
  if (run.selection_rationale) html += '<dt>Selection Rationale</dt><dd>' + escHtml(run.selection_rationale) + '</dd>';
  // Secondary buyers (JSON array of objects)
  if (run.secondary_buyers) {
    try {
      var secs = typeof run.secondary_buyers === 'string' ? JSON.parse(run.secondary_buyers) : run.secondary_buyers;
      if (secs && secs.length) {
        html += '<dt>Secondary Buyers</dt><dd>' + secs.map(function(b) { return escHtml(b.buyerName || b.name || b.buyer_name || '?'); }).join(', ') + '</dd>';
      }
    } catch(e) {}
  }
  if (run.notion_url) html += '<dt>Notion URL</dt><dd><a href="' + escHtml(run.notion_url) + '" target="_blank">' + escHtml(run.notion_url) + '</a></dd>';
  // Validation result
  if (run.validation_result) {
    try {
      var vr = typeof run.validation_result === 'string' ? JSON.parse(run.validation_result) : run.validation_result;
      var vrText = (vr.passed ? 'PASS' : 'FAIL');
      if (vr.issues && vr.issues.length) vrText += ' \u2014 ' + vr.issues.length + ' issue(s)';
      if (vr.warnings && vr.warnings.length) vrText += ', ' + vr.warnings.length + ' warning(s)';
      if (vr.fixed) vrText += ' (auto-fixed)';
      html += '<dt>Validation</dt><dd>' + escHtml(vrText) + '</dd>';
    } catch(e) {}
  }
  html += '<dt>Created</dt><dd>' + escHtml(run.created_at || '') + '</dd>';
  if (run.completed_at) html += '<dt>Completed</dt><dd>' + escHtml(run.completed_at) + '</dd>';
  if (run.completed_at && run.created_at) {
    var dur = (new Date(run.completed_at) - new Date(run.created_at)) / 1000;
    if (dur > 0) html += '<dt>Duration</dt><dd>' + dur.toFixed(1) + 's</dd>';
  }
  html += '</dl>';

  // ── Score Bars ──
  try {
    var scoreBuyers = [];
    // Featured buyer score
    var featScore = run.featured_score;
    if (!featScore) {
      // Try extracting from s4 audit metadata
      var audit = monitorState.lastAudit || [];
      for (var i = 0; i < audit.length; i++) {
        var am = _parseAuditMeta(audit[i]);
        if (am && am.FEATURED) {
          featScore = am.FEATURED.score;
          break;
        }
      }
    }
    if (!featScore && run.selection_rationale) {
      var m = run.selection_rationale.match(/score:\s*([\d.]+)/);
      if (m) featScore = parseFloat(m[1]);
    }
    if (featScore && run.featured_buyer_name) {
      scoreBuyers.push({ name: run.featured_buyer_name, score: featScore, featured: true });
    }
    // Secondary buyers
    if (run.secondary_buyers) {
      var secs = typeof run.secondary_buyers === 'string' ? JSON.parse(run.secondary_buyers) : run.secondary_buyers;
      (secs || []).forEach(function(b) {
        if (b.score) scoreBuyers.push({ name: b.buyerName || b.name || '?', score: b.score, featured: false });
      });
    }
    if (scoreBuyers.length) {
      html += '<div style="margin-top:16px;border-top:1px solid var(--border);padding-top:12px">';
      html += '<div style="font-size:11px;font-weight:700;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Scoring Breakdown</div>';
      html += '<div class="score-bars">';
      scoreBuyers.forEach(function(b) {
        var pct = Math.round(b.score * 100);
        var color = b.featured ? 'var(--green)' : 'var(--blue)';
        var label = b.name.length > 30 ? b.name.slice(0, 30) + '\u2026' : b.name;
        html += '<div class="score-bar-row">';
        html += '<div class="score-bar-name" title="' + escHtml(b.name) + '">' + escHtml(label) + '</div>';
        html += '<div class="score-bar-track"><div class="score-bar-fill" style="width:' + pct + '%;background:' + color + '"></div></div>';
        html += '<div class="score-bar-val">' + b.score.toFixed(3) + '</div>';
        html += '</div>';
      });
      html += '</div></div>';
    }
  } catch(e) {}

  // ── Search Strategy ──
  try {
    var stratRaw = run.search_strategy;
    if (stratRaw) {
      var strat = typeof stratRaw === 'string' ? JSON.parse(stratRaw) : stratRaw;
      var kwCount = ((strat.primary_keywords || []).length + (strat.alternate_keywords || []).length);
      var btCount = (strat.buyer_types || []).length;
      html += '<details style="margin-top:16px;border-top:1px solid var(--border);padding-top:12px">';
      html += '<summary style="cursor:pointer;font-size:11px;font-weight:700;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px">Search Strategy \u2014 ' + kwCount + ' keywords, ' + btCount + ' buyer types</summary>';
      html += '<div style="margin-top:10px">';
      // Primary keywords
      if (strat.primary_keywords && strat.primary_keywords.length) {
        html += '<div style="font-size:10px;color:var(--text-dim);margin-bottom:4px">Primary Keywords</div>';
        html += '<div class="data-flow">';
        strat.primary_keywords.forEach(function(k) { html += '<span class="data-chip chip-in">' + escHtml(k) + '</span>'; });
        html += '</div>';
      }
      // Alternate keywords
      if (strat.alternate_keywords && strat.alternate_keywords.length) {
        html += '<div style="font-size:10px;color:var(--text-dim);margin:8px 0 4px">Alternate Keywords</div>';
        html += '<div class="data-flow">';
        strat.alternate_keywords.forEach(function(k) { html += '<span class="data-chip chip-in">' + escHtml(k) + '</span>'; });
        html += '</div>';
      }
      // Buyer types
      if (strat.buyer_types && strat.buyer_types.length) {
        html += '<div style="font-size:10px;color:var(--text-dim);margin:8px 0 4px">Buyer Types</div>';
        html += '<div class="data-flow">';
        strat.buyer_types.forEach(function(t) { html += '<span class="data-chip chip-out">' + escHtml(t) + '</span>'; });
        html += '</div>';
      }
      // Opportunity types
      if (strat.opportunity_types && strat.opportunity_types.length) {
        html += '<div style="font-size:10px;color:var(--text-dim);margin:8px 0 4px">Opportunity Types</div>';
        html += '<div class="data-flow">';
        strat.opportunity_types.forEach(function(t) { html += '<span class="data-chip chip-feeds">' + escHtml(t) + '</span>'; });
        html += '</div>';
      }
      // Geographic hints
      html += '<div style="font-size:10px;color:var(--text-dim);margin:8px 0 4px">Geographic Hints</div>';
      if (strat.geographic_hints && strat.geographic_hints.length) {
        html += '<div class="data-flow">';
        strat.geographic_hints.forEach(function(g) { html += '<span class="data-chip chip-in">' + escHtml(g) + '</span>'; });
        html += '</div>';
      } else {
        html += '<div style="font-size:11px;color:var(--text-dim);font-style:italic">(none)</div>';
      }
      // Ideal buyer profile
      if (strat.ideal_buyer_profile) {
        html += '<div style="font-size:10px;color:var(--text-dim);margin:8px 0 4px">Ideal Buyer Profile</div>';
        html += '<blockquote style="border-left:3px solid var(--blue);padding:8px 12px;margin:0;background:rgba(88,166,255,0.05);border-radius:0 4px 4px 0;font-size:12px;color:var(--text)">' + escHtml(strat.ideal_buyer_profile) + '</blockquote>';
      }
      html += '</div></details>';
    }
  } catch(e) {}

  panel.innerHTML = html;
}

function renderDiscoveriesTab(rows) {
  var panel = document.getElementById('dataPanel');
  if (!rows || !rows.length) { panel.innerHTML = '<div class="data-empty">No discoveries for this run</div>'; return; }
  var html = '<table class="data-table"><thead><tr><th>Buyer</th><th>Signal Type</th><th>Score</th><th>Summary</th></tr></thead><tbody>';
  rows.forEach(function(r) {
    html += '<tr><td>' + escHtml(r.buyer_name || '') + '</td>';
    html += '<td>' + escHtml(r.signal_type || '') + '</td>';
    html += '<td>' + (r.signal_score != null ? r.signal_score.toFixed(1) : '') + '</td>';
    html += '<td>' + escHtml((r.signal_summary || '').slice(0, 120)) + '</td></tr>';
  });
  html += '</tbody></table>';
  panel.innerHTML = html;
}

function renderContactsTab(rows) {
  var panel = document.getElementById('dataPanel');
  if (!rows || !rows.length) { panel.innerHTML = '<div class="data-empty">No contacts for this run</div>'; return; }
  var html = '<table class="data-table"><thead><tr><th>Name</th><th>Title</th><th>Email</th><th>Verified</th></tr></thead><tbody>';
  rows.forEach(function(r) {
    html += '<tr><td>' + escHtml(r.contact_name || '') + '</td>';
    html += '<td>' + escHtml(r.contact_title || '') + '</td>';
    html += '<td>' + escHtml(r.contact_email || '') + '</td>';
    html += '<td>' + (r.email_verified ? '\u2713' : '') + '</td></tr>';
  });
  html += '</tbody></table>';
  panel.innerHTML = html;
}

function renderAuditLogTab(rows) {
  var panel = document.getElementById('dataPanel');
  if (!rows || !rows.length) { panel.innerHTML = '<div class="data-empty">No audit log entries</div>'; return; }
  var html = '<table class="data-table"><thead><tr><th>Step</th><th>Status</th><th>Duration</th><th>Message</th><th>Time</th></tr></thead><tbody>';
  rows.forEach(function(r) {
    var cls = r.status === 'success' ? 'st-completed' : r.status === 'failure' ? 'st-failed' : 'st-warning';
    var ts = r.created_at ? r.created_at.split(' ')[1] || r.created_at.split('T')[1] || '' : '';
    html += '<tr><td>' + escHtml(r.step || '') + '</td>';
    html += '<td class="' + cls + '">' + escHtml(r.status || '') + '</td>';
    html += '<td>' + (r.duration_seconds != null ? r.duration_seconds.toFixed(3) + 's' : '') + '</td>';
    html += '<td>' + escHtml((r.message || '').slice(0, 200)) + '</td>';
    html += '<td style="white-space:nowrap;opacity:0.5">' + escHtml(ts) + '</td></tr>';
  });
  html += '</tbody></table>';
  panel.innerHTML = html;
}

// ── Report tab ──

function _parseAuditMeta(entry) {
  if (!entry || !entry.metadata) return null;
  if (typeof entry.metadata === 'object') return entry.metadata;
  try { return JSON.parse(entry.metadata); } catch(e) { return null; }
}

function _extractReportMarkdown() {
  var audit = monitorState.lastAudit || [];
  // Try REPORT_MARKDOWN from s12_assemble metadata
  for (var i = 0; i < audit.length; i++) {
    var m = _parseAuditMeta(audit[i]);
    if (m && m.REPORT_MARKDOWN) return m.REPORT_MARKDOWN;
  }
  // Fallback: concatenate sections
  var sections = {};
  var sectionKeys = ['SECTION_EXEC_SUMMARY', 'SECTION_FEATURED', 'SECTION_SECONDARY', 'SECTION_CTA'];
  for (var i = 0; i < audit.length; i++) {
    var m = _parseAuditMeta(audit[i]);
    if (!m) continue;
    for (var j = 0; j < sectionKeys.length; j++) {
      if (m[sectionKeys[j]] && !sections[sectionKeys[j]]) sections[sectionKeys[j]] = m[sectionKeys[j]];
    }
  }
  var parts = [];
  if (sections.SECTION_EXEC_SUMMARY) parts.push(sections.SECTION_EXEC_SUMMARY);
  if (sections.SECTION_FEATURED) parts.push(sections.SECTION_FEATURED);
  if (sections.SECTION_SECONDARY) parts.push(sections.SECTION_SECONDARY);
  if (sections.SECTION_CTA) parts.push(sections.SECTION_CTA);
  return parts.length ? parts.join('\n\n---\n\n') : null;
}

function miniMarkdown(md) {
  if (!md) return '';
  // Escape HTML first
  var html = md.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  // Headings
  html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
  html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
  html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
  // Bold
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  // Italic
  html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
  // Horizontal rule
  html = html.replace(/^---$/gm, '<hr>');
  // Blockquote (consecutive lines)
  html = html.replace(/^&gt; (.+)$/gm, '<blockquote>$1</blockquote>');
  html = html.replace(/<\/blockquote>\n<blockquote>/g, '<br>');
  // Unordered list items
  html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
  html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
  // Paragraphs: double newline
  html = html.replace(/\n\n+/g, '</p><p>');
  html = '<p>' + html + '</p>';
  // Clean up empty paragraphs
  html = html.replace(/<p>\s*<\/p>/g, '');
  html = html.replace(/<p>(<h[123]>)/g, '$1');
  html = html.replace(/(<\/h[123]>)<\/p>/g, '$1');
  html = html.replace(/<p>(<hr>)<\/p>/g, '$1');
  html = html.replace(/<p>(<ul>)/g, '$1');
  html = html.replace(/(<\/ul>)<\/p>/g, '$1');
  html = html.replace(/<p>(<blockquote>)/g, '$1');
  html = html.replace(/(<\/blockquote>)<\/p>/g, '$1');
  return html;
}

function renderReportTab() {
  var panel = document.getElementById('dataPanel');
  var md = _extractReportMarkdown();
  if (!md) { panel.innerHTML = '<div class="data-empty">Report not available</div>'; return; }
  panel.innerHTML = '<div class="report-preview">' + miniMarkdown(md) + '</div>';
}

// =======================================================
// DIAGRAM VIEW (SVG node graph)
// =======================================================

function zoomDiagram(delta) {
  if (delta === 0) {
    var wrap = document.getElementById('diagramWrap');
    var viewH = wrap.clientHeight;
    var viewW = wrap.clientWidth;
    var maxX = 0, maxY = 0;
    Object.values(NODE_POSITIONS).forEach(function(p) {
      if (p.x + NODE_W + 60 > maxX) maxX = p.x + NODE_W + 60;
      if (p.y + 120 > maxY) maxY = p.y + 120;
    });
    state.zoom = Math.min(viewW / (maxX + 40), viewH / (maxY + 40), 1.5);
    state.zoom = Math.round(state.zoom * 20) / 20;
  } else {
    state.zoom = Math.max(0.2, Math.min(2.0, state.zoom + delta));
    state.zoom = Math.round(state.zoom * 20) / 20;
  }
  applyZoom();
}

function applyZoom() {
  var canvas = document.getElementById('diagramCanvas');
  canvas.style.transform = 'scale(' + state.zoom + ')';
  document.getElementById('zoomLevel').textContent = Math.round(state.zoom * 100) + '%';
}

function renderDiagram() {
  var nodesEl = document.getElementById('diagramNodes');
  var svgEl = document.getElementById('diagramSvg');
  var canvas = document.getElementById('diagramCanvas');

  // Calculate canvas bounds
  var maxX = 0, maxY = 0;
  Object.values(NODE_POSITIONS).forEach(function(p) {
    if (p.x + NODE_W + 60 > maxX) maxX = p.x + NODE_W + 60;
    if (p.y + 120 > maxY) maxY = p.y + 120;
  });
  var canvasW = maxX + 80;
  var canvasH = maxY + 80;

  canvas.style.width = canvasW + 'px';
  canvas.style.height = canvasH + 'px';
  nodesEl.style.width = canvasW + 'px';
  nodesEl.style.height = canvasH + 'px';
  svgEl.setAttribute('width', canvasW);
  svgEl.setAttribute('height', canvasH);
  svgEl.style.width = canvasW + 'px';
  svgEl.style.height = canvasH + 'px';

  applyZoom();

  // Phase section backgrounds
  var nodesHtml = '';
  var phaseGroups = {};
  STEPS.forEach(function(s) {
    var pos = NODE_POSITIONS[s.id];
    if (!pos) return;
    if (!phaseGroups[s.phase]) phaseGroups[s.phase] = { label: PHASE_LABELS[s.phase], nodes: [] };
    phaseGroups[s.phase].nodes.push(pos);
  });
  var NODE_H = 85;
  var LABEL_H = 16, MIN_W = 260;
  var PHASE_PADS = { generate: { x: 60, y: 56 }, discover: { x: 56, y: 50 }, input: { x: 28, y: 36 } };
  var DEFAULT_PAD = { x: 28, y: 20 };
  Object.keys(phaseGroups).forEach(function(phase) {
    var g = phaseGroups[phase];
    var pad = PHASE_PADS[phase] || DEFAULT_PAD;
    var padX = pad.x, padY = pad.y;
    var mnX = Infinity, mnY = Infinity, mxX = 0, mxY = 0;
    g.nodes.forEach(function(p) {
      if (p.x < mnX) mnX = p.x;
      if (p.y < mnY) mnY = p.y;
      if (p.x + NODE_W > mxX) mxX = p.x + NODE_W;
      if (p.y + NODE_H > mxY) mxY = p.y + NODE_H;
    });
    var dimmed = state.focusPhase !== 'all' && !phaseMatch(phase, state.focusPhase);
    var contentW = mxX - mnX + padX * 2;
    var centerX = phase === 'generate' ? (mnX + mxX) / 2 : 570;
    var sW = Math.max(contentW, MIN_W);
    var sL = centerX - sW / 2;
    var sT = mnY - padY - LABEL_H;
    var sH = mxY - mnY + padY * 2 + LABEL_H * 2;
    nodesHtml += '<div class="dphase-section' + (dimmed ? ' dphase-dimmed' : '') + '" style="left:' + sL + 'px;top:' + sT + 'px;width:' + sW + 'px;height:' + sH + 'px">';
    nodesHtml += '<span class="dphase-section-label">' + g.label + '</span></div>';
  });

  // Draw nodes
  STEPS.forEach(function(s) {
    var pos = NODE_POSITIONS[s.id];
    if (!pos) return;
    var dimmed = state.focusPhase !== 'all' && !phaseMatch(s.phase, state.focusPhase);
    var selected = state.selectedStep === s.id;
    nodesHtml += '<div class="dnode dnode-' + primaryType(s) + ' ' + (selected ? 'dnode-selected' : '') + ' ' + (dimmed ? 'dnode-dimmed' : '') + '"';
    nodesHtml += ' style="left:' + pos.x + 'px;top:' + pos.y + 'px;width:' + NODE_W + 'px"';
    nodesHtml += ' onclick="selectDiagramNode(\'' + s.id + '\')" id="dnode-' + s.id + '">';
    nodesHtml += '<div class="dnode-num">' + renderSubAgentBadge(s) + typeBadges(s) + ' ' + s.num + '</div>';
    nodesHtml += '<div class="dnode-name">' + s.name + '</div>';
    nodesHtml += renderIndicators(s);
    nodesHtml += '<div class="dnode-meta">' + (s.meta.length > 50 ? s.meta.slice(0, 47) + '...' : s.meta) + '</div>';
    nodesHtml += '</div>';
  });

  // Parallel group: Discovery (s3a, s3b, s3c, s3d)
  var p1L = NODE_POSITIONS.s3a.x - 16, p1T = NODE_POSITIONS.s3a.y - 24;
  var p1R = NODE_POSITIONS.s3d.x + NODE_W + 16, p1B = NODE_POSITIONS.s3a.y + 124;
  nodesHtml += '<div class="dgroup-parallel" style="left:' + p1L + 'px;top:' + p1T + 'px;width:' + (p1R-p1L) + 'px;height:' + (p1B-p1T) + 'px">';
  nodesHtml += '<span class="dgroup-parallel-label">PARALLEL \u2014 4 discovery searches</span></div>';

  // Parallel group: Intel + Generation (s6, s7, s8, s9, s10, s11)
  var p2L = NODE_POSITIONS.s6.x - 40, p2T = NODE_POSITIONS.s6.y - 48;
  var p2R = NODE_POSITIONS.s11.x + NODE_W + 40, p2B = NODE_POSITIONS.s9.y + 150;
  nodesHtml += '<div class="dgroup-parallel" style="left:' + p2L + 'px;top:' + p2T + 'px;width:' + (p2R-p2L) + 'px;height:' + (p2B-p2T) + 'px">';
  nodesHtml += '<span class="dgroup-parallel-label">PARALLEL \u2014 4 branches: 2 intel chains + 2 generators</span></div>';

  // Sequential sub-chain: s6 -> s9
  var sq1L = NODE_POSITIONS.s6.x - 20, sq1T = NODE_POSITIONS.s6.y - 24;
  var sq1R = NODE_POSITIONS.s6.x + NODE_W + 20, sq1B = NODE_POSITIONS.s9.y + 130;
  nodesHtml += '<div class="dgroup-sequential" style="left:' + sq1L + 'px;top:' + sq1T + 'px;width:' + (sq1R-sq1L) + 'px;height:' + (sq1B-sq1T) + 'px">';
  nodesHtml += '<span class="dgroup-sequential-label">SEQUENTIAL</span></div>';

  // Sequential sub-chain: s7 -> s10
  var sq2L = NODE_POSITIONS.s7.x - 20, sq2T = NODE_POSITIONS.s7.y - 24;
  var sq2R = NODE_POSITIONS.s7.x + NODE_W + 20, sq2B = NODE_POSITIONS.s10.y + 130;
  nodesHtml += '<div class="dgroup-sequential" style="left:' + sq2L + 'px;top:' + sq2T + 'px;width:' + (sq2R-sq2L) + 'px;height:' + (sq2B-sq2T) + 'px">';
  nodesHtml += '<span class="dgroup-sequential-label">SEQUENTIAL</span></div>';

  nodesEl.innerHTML = nodesHtml;

  // Cache actual rendered node heights (may differ from NODE_H=85 estimate)
  var nodeHeights = {};
  STEPS.forEach(function(s) {
    var el = document.getElementById('dnode-' + s.id);
    nodeHeights[s.id] = el ? el.offsetHeight : 85;
  });

  // Draw SVG arrows from COMPUTED_EDGES
  var svgHtml = '';
  var edgeKeys = Object.keys(COMPUTED_EDGES);

  // Count incoming edges per target for spread calculation
  var incomingEdges = {};
  edgeKeys.forEach(function(key) {
    var edge = COMPUTED_EDGES[key];
    if (!incomingEdges[edge.target]) incomingEdges[edge.target] = [];
    incomingEdges[edge.target].push(edge.source);
  });

  function spreadX(nodeX, index, count) {
    if (count <= 1) return nodeX + NODE_W / 2;
    var pad = NODE_W / 2 - Math.min(count - 1, 6) * 5;
    var usable = NODE_W - pad * 2;
    return nodeX + pad + (index / (count - 1)) * usable;
  }

  var inIdx = {};
  edgeKeys.forEach(function(key) {
    var edge = COMPUTED_EDGES[key];
    var from = NODE_POSITIONS[edge.source];
    var to = NODE_POSITIONS[edge.target];
    if (!from || !to) return;

    var isActive = state.selectedStep === edge.source || state.selectedStep === edge.target;
    var isHighlighted = state.highlightedEdge === key;

    var fromCx = from.x + NODE_W / 2;
    var fromBottom = from.y + (nodeHeights[edge.source] || 85);

    var inCount = (incomingEdges[edge.target] || []).length;
    var iIdx = inIdx[edge.target] || 0;
    inIdx[edge.target] = iIdx + 1;
    var toCx = spreadX(to.x, iIdx, inCount);
    var toTop = to.y;

    var dy = toTop - fromBottom;
    var cpOffset = Math.max(40, Math.abs(dy) * 0.35);

    var color, width;
    if (isHighlighted) { color = '#58a6ff'; width = 3; }
    else if (isActive) { color = '#58a6ff'; width = 2.5; }
    else { color = 'rgba(48,54,61,0.45)'; width = 1.5; }

    var arrowLen = 8;
    var pathEndY = toTop - arrowLen;
    var pathD = 'M ' + fromCx + ' ' + fromBottom + ' C ' + fromCx + ' ' + (fromBottom + cpOffset) + ', ' + toCx + ' ' + (toTop - cpOffset) + ', ' + toCx + ' ' + pathEndY;

    var pathId = key.replace('->','-');
    if (isHighlighted || isActive) { svgHtml += '<circle cx="' + fromCx + '" cy="' + (fromBottom + 3) + '" r="3" fill="' + color + '"/>'; }
    svgHtml += '<path id="epath-' + pathId + '" d="' + pathD + '" fill="none" stroke="' + color + '" stroke-width="' + width + '"/>';
    svgHtml += '<polygon id="earrow-' + pathId + '" points="' + (toCx-4) + ',' + pathEndY + ' ' + (toCx+4) + ',' + pathEndY + ' ' + toCx + ',' + toTop + '" fill="' + color + '"/>';
    // Invisible hit target for hover tooltip
    svgHtml += '<path d="' + pathD + '" fill="none" stroke="transparent" stroke-width="14" style="pointer-events:stroke;cursor:pointer" data-edge="' + key + '" onmouseenter="showEdgeTooltip(event,\'' + key + '\')" onmouseleave="hideEdgeTooltip()" onclick="selectEdgeNode(\'' + key + '\')"/>';
  });

  // Validation loop arrows (pink, dotted, bidirectional)
  VALIDATION_LOOPS.forEach(function(loop) {
    var from = NODE_POSITIONS[loop.from];
    var to = NODE_POSITIONS[loop.to];
    if (!from || !to) return;
    var loopKey = loop.from + '<->' + loop.to;
    var isHighlighted = state.highlightedEdge === loopKey;
    var isActive = state.selectedStep === loop.from || state.selectedStep === loop.to;

    var color = isHighlighted ? '#ff69b4' : (isActive ? 'rgba(255,105,180,0.8)' : 'rgba(255,105,180,0.35)');
    var width = isHighlighted ? 3 : (isActive ? 2.5 : 1.5);

    var fromX = from.x + NODE_W + 8;
    var fromY = from.y + 42;
    var toX = to.x + NODE_W + 8;
    var toY = to.y + 42;

    var bulge = 60;
    var cpX = Math.max(fromX, toX) + bulge;
    var pathD = 'M ' + fromX + ' ' + fromY + ' C ' + cpX + ' ' + fromY + ', ' + cpX + ' ' + toY + ', ' + toX + ' ' + toY;

    var a1 = '<polygon points="' + toX + ',' + toY + ' ' + (toX+7) + ',' + (toY-4) + ' ' + (toX+7) + ',' + (toY+4) + '" fill="' + color + '"/>';
    var a2 = '<polygon points="' + fromX + ',' + fromY + ' ' + (fromX+7) + ',' + (fromY-4) + ' ' + (fromX+7) + ',' + (fromY+4) + '" fill="' + color + '"/>';

    svgHtml += '<path id="epath-vloop-' + loop.from + '-' + loop.to + '" d="' + pathD + '" fill="none" stroke="' + color + '" stroke-width="' + width + '" stroke-dasharray="4,4"/>';
    svgHtml += a1 + a2;
    svgHtml += '<path d="' + pathD + '" fill="none" stroke="transparent" stroke-width="14" style="pointer-events:stroke;cursor:pointer" data-edge="' + loopKey + '" onmouseenter="showEdgeTooltip(event,\'' + loopKey + '\')" onmouseleave="hideEdgeTooltip()"/>';
  });

  svgEl.innerHTML = svgHtml;
}

function selectDiagramNode(id) {
  state.selectedStep = id;
  renderDiagram();
  showDiagramDetail(id);
  updatePrompt();
}

function showDiagramDetail(id) {
  var s = STEPS.find(function(x) { return x.id === id; });
  var el = document.getElementById('diagramDetail');
  if (!s) { closeDiagramDetail(); return; }
  el.innerHTML = buildDetailHtml(id, true);
  el.classList.add('visible');
}

function closeDiagramDetail() {
  document.getElementById('diagramDetail').classList.remove('visible');
  state.selectedStep = null;
  if (state.view === 'diagram') renderDiagram();
}

// =======================================================
// VIEW SWITCHING (3 modes)
// =======================================================

function setView(v) {
  state.view = v;
  var app = document.getElementById('app');
  var sel = document.getElementById('viewSelect');
  if (sel) sel.value = v;
  document.getElementById('zoomControls').style.display = v === 'diagram' ? 'flex' : 'none';

  if (v === 'list') {
    app.classList.remove('diagram-mode');
    document.getElementById('monitorWrap').style.display = 'none';
    document.getElementById('diagramCanvas').style.display = 'none';
    closeDiagramDetail();
    renderPipeline();
    if (state.selectedStep) renderDetail(state.selectedStep);
  } else if (v === 'monitor') {
    app.classList.add('diagram-mode');
    document.getElementById('monitorWrap').style.display = 'block';
    document.getElementById('diagramCanvas').style.display = 'none';
    closeDiagramDetail();
    renderMonitor();
  } else { // diagram
    app.classList.add('diagram-mode');
    document.getElementById('monitorWrap').style.display = 'none';
    document.getElementById('diagramCanvas').style.display = 'block';
    renderDiagram();
    if (state.selectedStep) showDiagramDetail(state.selectedStep);
  }
}

function focusPhase(p) {
  state.focusPhase = p;
  var sel = document.getElementById('highlightSelect');
  if (sel) sel.value = p;
  if (state.view === 'list') renderPipeline();
  else if (state.view === 'diagram') renderDiagram();
}

// =======================================================
// PROMPT EDITING
// =======================================================

function onPromptEdit(id) {
  var el = document.getElementById('promptEdit-' + id);
  if (el) { state.editedPrompts[id] = el.innerText; updatePrompt(); }
}

// =======================================================
// MARKDOWN GENERATION (rich per-step specs)
// =======================================================

function generateStepMarkdown(s) {
  var md = '';

  // Header
  md += '## Step ' + s.num + ': ' + s.name + '\n\n';
  md += '> ' + s.meta + '\n\n';

  // Metadata
  var types = getTypes(s).map(function(t) { return t === 'llm' ? 'ai' : t; }).join(' + ');
  var exec = s.parallel ? 'parallel (Group ' + PARALLEL_GROUPS[s.id] + ')' : 'sequential';
  md += '### Metadata\n\n';
  md += '- **Node Step ID:** ' + s.id + '\n';
  md += '- **Node Type:** ' + types + '\n';
  md += '- **Node Execution:** ' + exec + '\n';

  // Implementation (matches UI detail panel section)
  if (s.module || s.fn || s.timeout || s.service) {
    md += '\n### Implementation\n\n';
    if (s.module) md += '- **Module:** ' + s.module + '\n';
    if (s.fn) md += '- **Function:** ' + s.fn + '\n';
    if (s.timeout) md += '- **Timeout:** ' + s.timeout + '\n';
    if (s.service) md += '- **Service:** ' + s.service + '\n';
  }

  // Config
  if (s.configKeys && s.configKeys.length) {
    md += '\n### Config\n\n';
    s.configKeys.forEach(function(k) {
      var val = resolveConfigValue(k);
      var rootKey = k.split('.')[0];
      var meta = state.config ? state.config.metadata[rootKey] : null;
      var unit = meta && meta.unit ? meta.unit : '';
      var display = val != null ? String(val) + unit : '—';
      md += '- `' + k + '`: ' + display + '\n';
    });
  }

  // Conditional Run
  if (s.conditionalRun) {
    var crType = s.conditionalRun.type;
    var crLabel = crType === 'always' ? 'Always runs' : crType === 'stop' ? 'Hard stop' : crType === 'skip' ? 'Conditional skip' : 'Branches';
    md += '\n### Conditional Run\n\n';
    md += '**' + crLabel + '**' + (s.conditionalRun.rule ? ' \u2014 ' + s.conditionalRun.rule.replace(/<b>/g, '**').replace(/<\/b>/g, '**') : '') + '\n';
  }

  // Tool Calls
  if (s.tools && s.tools.length) {
    md += '\n### Tool Calls\n\n';
    s.tools.forEach(function(t) { md += '- `' + t + '`\n'; });
  }

  // Data In (grouped by source)
  if (s.inputs && s.inputs.length) {
    md += '\n### Data In\n';
    var groups = {};
    s.inputs.forEach(function(name) {
      var base = name.split('.')[0];
      var src = INPUT_SOURCES[name] || INPUT_SOURCES[base] || null;
      if (!groups[src]) groups[src] = [];
      groups[src].push(name);
    });
    var order = [null].concat(STEPS.map(function(x) { return x.id; }));
    var sortedKeys = Object.keys(groups).sort(function(a, b) {
      return order.indexOf(a === 'null' ? null : a) - order.indexOf(b === 'null' ? null : b);
    });
    sortedKeys.forEach(function(src) {
      var label = getSourceLabel(src === 'null' ? null : src);
      md += '\n**From ' + label + ':**\n';
      groups[src].forEach(function(n) { md += '- `' + n + '`\n'; });
    });
  }

  // Data Out
  if (s.outputs && s.outputs.length) {
    md += '\n### Data Out\n\n';
    s.outputs.forEach(function(d) {
      var schema = s.outputSchema ? s.outputSchema[d] : null;
      if (schema) {
        md += '- `' + d + '`: ' + schema + '\n';
      } else {
        md += '- `' + d + '`\n';
      }
    });
  }

  // Feeds Into
  var outbound = getOutboundEdges(s.id);
  var loops = VALIDATION_LOOPS.filter(function(l) { return l.from === s.id || l.to === s.id; });
  if (outbound.length || loops.length) {
    md += '\n### Feeds Into\n\n';
    loops.forEach(function(loop) {
      var otherId = loop.from === s.id ? loop.to : loop.from;
      var other = STEPS.find(function(x) { return x.id === otherId; });
      if (!other) return;
      md += '**\u21c4 Validation loop** with Step ' + other.num + ': ' + other.name + '\n';
      md += loop.label.replace(/<b>/g, '**').replace(/<\/b>/g, '**') + '\n\n';
    });
    outbound.forEach(function(edge) {
      var target = STEPS.find(function(x) { return x.id === edge.target; });
      if (!target) return;
      md += '**\u2192 Step ' + target.num + ': ' + target.name + ':** ' + edge.variables.join(', ') + '\n';
    });
  }

  // Detail / Prompt sections
  var pt = primaryType(s);
  var isHybrid = getTypes(s).length > 1;

  if (isHybrid && s.detail) {
    var detailLabel = pt === 'tool' ? 'Tool Logic' : pt === 'validate' ? 'Validation Logic' : pt === 'logic' ? 'Logic' : pt === 'sqlite' ? 'DB Operations' : 'Detail';
    md += '\n### ' + detailLabel + '\n\n```\n' + s.detail + '\n```\n';
  }
  if (hasType(s, 'llm') && s.prompt) {
    var prompt = state.editedPrompts[s.id] || s.prompt;
    md += '\n### LLM System Prompt\n\n```\n' + prompt + '\n```\n';
  }
  if (hasType(s, 'llm') && s.contentTemplate) {
    md += '\n### LLM Content (User Message)\n\n```\n' + s.contentTemplate + '\n```\n';
  }
  if (!hasType(s, 'llm') && s.prompt) {
    md += '\n### Prompt\n\n```\n' + s.prompt + '\n```\n';
  }
  if (!isHybrid && s.detail) {
    var dLabel = pt === 'template' ? 'Template Logic' : pt === 'llm' ? 'LLM Sub-Agent Logic' : pt === 'api' ? 'API Call Detail' : pt === 'sqlite' ? 'DB Operations' : pt === 'python' ? 'Step Detail' : 'Logic';
    md += '\n### ' + dLabel + '\n\n```\n' + s.detail + '\n```\n';
  }

  // Output Template (template steps)
  if (s.template) {
    md += '\n### Output Template\n\n```\n' + s.template + '\n```\n';
  }

  // Scoring (pipeline-specific: s4)
  if (s.scoring) {
    md += '\n### Scoring Weights\n\n';
    Object.entries(s.scoring).forEach(function(entry) {
      var k = entry[0], v = entry[1];
      md += '- **' + k.replace(/_/g, ' ') + ':** ' + v + '%\n';
    });
  }

  // Validation checks (pipeline-specific: s14)
  if (s.checks) {
    md += '\n### Validation Checks\n\n';
    s.checks.forEach(function(c, i) {
      md += (i+1) + '. ' + c + '\n';
    });
  }

  // Quality Rules
  if (s.qualityRules && s.qualityRules.length) {
    md += '\n### Quality Rules\n\n';
    s.qualityRules.forEach(function(r) { md += '- ' + r + '\n'; });
  }

  // Edge Cases
  if (s.edgeCases && s.edgeCases.length) {
    md += '\n### Edge Cases\n\n';
    s.edgeCases.forEach(function(ec) {
      var sev = (ec.severity || 'degrade').toUpperCase();
      md += '- **' + sev + '** \u2014 ' + ec.label + ': ' + ec.action + '\n';
    });
  }

  return md;
}

function generateAllMarkdown() {
  var md = '';
  var today = new Date();
  var dateStr = today.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  md += '# Starbridge Intel Brief Pipeline \u2014 Full Workflow Spec\n\n';
  md += '> 18-step pipeline: webhook \u2192 discovery \u2192 intel \u2192 report \u2192 publish\n';
  md += '> Generated: ' + dateStr + '\n\n';

  // Table of Contents
  md += '## Table of Contents\n\n';
  var tocPhase = '';
  STEPS.forEach(function(s) {
    if (s.phase !== tocPhase) {
      if (tocPhase) md += '\n';
      md += '**Phase ' + PHASE_ROMAN[s.phase] + ': ' + PHASE_LABELS[s.phase] + '**\n';
      tocPhase = s.phase;
    }
    md += '- Step ' + s.num + ': ' + s.name + ' (' + s.id + ')\n';
  });
  md += '\n';

  var lastPhase = '';
  STEPS.forEach(function(s, i) {
    if (s.phase !== lastPhase) {
      if (lastPhase) md += '\n---\n\n';
      md += '# Phase ' + PHASE_ROMAN[s.phase] + ': ' + PHASE_LABELS[s.phase] + '\n\n';
      lastPhase = s.phase;
    } else if (i > 0) {
      md += '\n---\n\n';
    }
    md += generateStepMarkdown(s);
  });

  return md;
}

// =======================================================
// PROMPT BAR + MODAL
// =======================================================

function updatePrompt() {
  var el = document.getElementById('promptOutput');
  if (!state.selectedStep) {
    el.textContent = 'Select a step to see its full markdown spec.';
    return;
  }
  var s = STEPS.find(function(x) { return x.id === state.selectedStep; });
  if (!s) return;
  el.textContent = generateStepMarkdown(s);
}

function togglePromptBar() {
  var bar = document.getElementById('promptOutputBar');
  var text = document.getElementById('promptOutput');
  state.promptMinimized = !state.promptMinimized;
  if (state.promptMinimized) {
    state.promptCustomMaxH = text.style.maxHeight || null;
  } else if (state.promptCustomMaxH) {
    text.style.maxHeight = state.promptCustomMaxH;
  }
  bar.classList.toggle('minimized', state.promptMinimized);
  document.getElementById('minimizeBtn').innerHTML = state.promptMinimized ? '&#9652;' : '&#9662;';
}

// Prompt bar resize (drag top edge to adjust height, resets on page reload)
(function() {
  var handle = document.getElementById('promptResizeHandle');
  var text = document.getElementById('promptOutput');
  var startY, startMaxH;
  handle.addEventListener('mousedown', function(e) {
    if (state.promptMinimized) return;
    e.preventDefault();
    startY = e.clientY;
    startMaxH = text.offsetHeight;
    document.addEventListener('mousemove', onDrag);
    document.addEventListener('mouseup', onUp);
  });
  function onDrag(e) {
    var newH = Math.max(40, Math.min(window.innerHeight * 0.6, startMaxH + (startY - e.clientY)));
    text.style.maxHeight = newH + 'px';
  }
  function onUp() {
    document.removeEventListener('mousemove', onDrag);
    document.removeEventListener('mouseup', onUp);
  }
})();

// Legend (key) toggle — default visible, resets on page reload
function toggleLegend() {
  var legend = document.querySelector('.legend');
  var btn = document.getElementById('keyToggleBtn');
  var hidden = legend.style.display === 'none';
  legend.style.display = hidden ? '' : 'none';
  btn.classList.toggle('active', hidden);
}

function copyPrompt() {
  var text = document.getElementById('promptOutput').textContent;
  navigator.clipboard.writeText(text).then(function() {
    var btn = document.getElementById('copyBtn');
    btn.textContent = 'Copied!';
    btn.classList.add('copied');
    setTimeout(function() { btn.textContent = 'Copy Step'; btn.classList.remove('copied'); }, 1500);
  });
}

function showAllMarkdown() {
  document.getElementById('mdModalContent').textContent = generateAllMarkdown();
  document.getElementById('mdModalOverlay').classList.add('visible');
}

function hideAllMarkdown() {
  document.getElementById('mdModalOverlay').classList.remove('visible');
}

function copyAllMarkdown() {
  navigator.clipboard.writeText(generateAllMarkdown()).then(function() {
    var btn = document.getElementById('copyAllBtn');
    btn.textContent = 'Copied!';
    btn.classList.add('copied');
    setTimeout(function() { btn.textContent = 'Copy All Steps'; btn.classList.remove('copied'); }, 1500);
  });
}

// =======================================================
// SCROLL ZOOM
// =======================================================

document.getElementById('diagramWrap').addEventListener('wheel', function(e) {
  if (e.ctrlKey || e.metaKey) {
    e.preventDefault();
    var delta = e.deltaY < 0 ? 0.05 : -0.05;
    zoomDiagram(delta);
  }
}, { passive: false });

// =======================================================
// "HOW IT RUNS" MODAL
// =======================================================

function cfgVal(dotKey, fallback) {
  if (!state.config) return fallback;
  return resolveConfigValue(dotKey) != null ? resolveConfigValue(dotKey) : fallback;
}

function toggleOrchModal() {
  var existing = document.getElementById('orchModal');
  if (existing) { existing.remove(); return; }

  var overlay = document.createElement('div');
  overlay.id = 'orchModal';
  overlay.className = 'orch-overlay';
  overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };

  var html = '<div class="orch-modal">';
  html += '<div class="orch-modal-header">';
  html += '<span class="orch-modal-title">Details</span>';
  html += '<button class="orch-modal-close" onclick="document.getElementById(\'orchModal\').remove()">\u2715</button>';
  html += '</div>';
  html += '<div class="orch-modal-body">';

  // Thread Pools section
  html += '<div class="orch-section">';
  html += '<div class="orch-section-heading">Thread Pools</div>';
  html += '<table class="orch-pool-table">';
  html += '<tr><th>Pool</th><th>Workers</th><th>Timeout</th><th>Steps</th></tr>';
  html += '<tr><td>Phase IV Discovery</td><td><code>' + cfgVal('MAX_WORKERS_DISCOVERY', 4) + '</code></td><td><code>' + cfgVal('TIMEOUTS.s3a', 300) + 's</code></td><td>s3a, s3b, s3c, s3d</td></tr>';
  html += '<tr><td>Phase VI Enrichment</td><td><code>' + cfgVal('MAX_WORKERS_ENRICHMENT', 4) + '</code></td><td><code>' + cfgVal('TIMEOUTS.s6', 330) + 's</code></td><td>s8, s6\u2192s9, s7\u2192s10, s11</td></tr>';
  html += '<tr><td>s6 Internal (featured)</td><td><code>' + cfgVal('MAX_WORKERS_FEATURED', 3) + '</code></td><td><code>' + cfgVal('TIMEOUTS.s6', 300) + 's</code></td><td>buyer_profile, buyer_contacts, buyer_chat</td></tr>';
  html += '<tr><td>s7 Internal (secondary)</td><td><code>' + cfgVal('MAX_WORKERS_SECONDARY', 4) + '</code></td><td><code>' + cfgVal('TIMEOUTS.s7', 300) + 's</code></td><td>profile + contacts per buyer</td></tr>';
  html += '</table>';
  html += '</div>';

  // Retry & Resilience section
  html += '<div class="orch-section">';
  html += '<div class="orch-section-heading">Retry & Resilience</div>';
  html += '<table class="orch-pool-table">';
  html += '<tr><th>Layer</th><th>Retries</th><th>Delay</th><th>What\u2019s Retried</th><th>What\u2019s Not</th></tr>';
  html += '<tr><td>Notion MCP</td><td><code>3</code></td><td>2s, 5s, 10s</td><td>Transient 500/502/503/timeout</td><td>4xx auth/schema</td></tr>';
  html += '<tr><td>s12 LLM+MCP</td><td><code>2</code></td><td>immediate</td><td>Any exception (fresh LLM call)</td><td>\u2014</td></tr>';
  html += '<tr><td>s13 fix+update</td><td><code>1</code></td><td>\u2014</td><td>Non-blocking: LLM fix \u2192 Notion update</td><td>Failures logged, pipeline continues</td></tr>';
  html += '<tr><td>Starbridge REST</td><td><code>none</code></td><td>\u2014</td><td>\u2014</td><td>All errors hard-fail</td></tr>';
  html += '</table>';
  html += '</div>';

  // Rules section
  html += '<div class="orch-section">';
  html += '<div class="orch-section-heading">Execution Rules</div>';
  var keys = [
    'stateMerge', 'errorHandling', 'retryResilience', 'cancellation',
    'poolShutdown', 'dbLifecycle', 'configIsolation', 'batchExecution',
    'conditionalSkipping', 'asyncPolling', 'llmSubprocess', 'priorRunDedup'
  ];
  keys.forEach(function(k) {
    var rule = ORCHESTRATION[k];
    html += '<div class="orch-rule">';
    html += '<div class="orch-rule-label">' + rule.label + '</div>';
    html += '<div class="orch-rule-pattern">' + rule.pattern + '</div>';
    html += '<div class="orch-rule-detail">' + rule.detail + '</div>';
    html += '</div>';
  });
  html += '</div>';

  html += '</div></div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}

// =======================================================
// CONFIG PANEL
// =======================================================

function loadConfig() {
  fetch('/api/config').then(function(r) {
    if (!r.ok) throw new Error('HTTP ' + r.status);
    return r.json();
  }).then(function(data) {
    state.config = data;
    syncDedupCheckbox();
  }).catch(function() { /* server offline — config chips show dashes */ });
}

function resolveConfigValue(dotKey) {
  if (!state.config) return null;
  var parts = dotKey.split('.');
  var val = state.config.values[parts[0]];
  for (var i = 1; i < parts.length; i++) { if (val == null) return null; val = val[parts[i]]; }
  return val;
}

function formatConfigVal(val, meta) {
  if (val == null) return '\u2014';
  var unit = meta && meta.unit ? meta.unit : '';
  if (typeof val === 'string' && val.length > 20) return val.substring(0, 18) + '\u2026' + unit;
  return String(val) + unit;
}

function renderConfigChips(step) {
  if (!step.configKeys || !step.configKeys.length) return '';
  var html = '<div class="detail-section"><h3><span class="dot" style="background:var(--purple)"></span>Config</h3><div class="config-chips">';
  step.configKeys.forEach(function(k) {
    var val = resolveConfigValue(k);
    var rootKey = k.split('.')[0];
    var meta = state.config ? state.config.metadata[rootKey] : null;
    var unit = meta && meta.unit ? meta.unit : '';
    var display = val != null ? String(val) + unit : '\u2014';
    html += '<span class="config-chip"><span class="config-chip-icon">\u2699</span>' + k + ': ' + escHtml(display) + '</span>';
  });
  html += '</div></div>';
  return html;
}

function toggleConfigPanel() {
  var existing = document.getElementById('configOverlay');
  if (existing) { existing.remove(); return; }

  var overlay = document.createElement('div');
  overlay.id = 'configOverlay';
  overlay.className = 'config-overlay';
  overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };

  var html = '<div class="config-panel" id="configPanel">';
  html += '<div class="config-panel-header"><h3>Pipeline Config<span id="configSaveStatus" class="config-save-status" style="opacity:0"></span></h3>';
  html += '<div style="display:flex;gap:8px;align-items:center"><button class="config-reset-btn" onclick="resetConfig()">Reset to defaults</button>';
  html += '<button class="config-panel-close" onclick="toggleConfigPanel()">&times;</button></div></div>';
  html += '<div class="config-ephemeral-note">Click values to edit \u00b7 changes apply to next run only \u00b7 running pipelines keep their config</div>';
  html += '<input class="config-filter" type="text" placeholder="Filter by key or description\u2026" oninput="filterConfig(this.value)">';
  html += '<div class="config-panel-body" id="configPanelBody">';

  if (!state.config) {
    html += '<div class="config-offline">Server offline<br><br>Start with:<br><code>python -m agent.server</code></div>';
  } else {
    html += buildConfigPanelContent('');
  }

  html += '</div></div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}

function buildConfigPanelContent(filter) {
  if (!state.config) return '<div class="config-offline">Server offline<br><br>Start with:<br><code>python -m agent.server</code></div>';
  var meta = state.config.metadata;
  var vals = state.config.values;
  var filterLower = filter.toLowerCase();

  // Group by category
  var cats = {};
  var catOrder = [];
  Object.keys(meta).forEach(function(key) {
    var m = meta[key];
    var cat = m.cat;
    if (!cats[cat]) { cats[cat] = []; catOrder.push(cat); }
    cats[cat].push(key);
  });

  var html = '';
  catOrder.forEach(function(cat) {
    var keys = cats[cat];
    // Filter: check if any key in this category matches
    var filteredKeys = keys.filter(function(key) {
      if (!filterLower) return true;
      var m = meta[key];
      return key.toLowerCase().indexOf(filterLower) !== -1 || (m.desc && m.desc.toLowerCase().indexOf(filterLower) !== -1);
    });
    if (!filteredKeys.length) return;

    html += '<div class="config-cat" data-cat="' + cat + '">';
    html += '<div class="config-cat-header" onclick="this.parentElement.classList.toggle(\'collapsed\')"><span class="config-cat-arrow">\u25bc</span> ' + escHtml(cat) + '</div>';
    html += '<div class="config-cat-items">';

    // Special rendering for TIMEOUTS dict
    if (cat === 'Timeouts' && filteredKeys.indexOf('TIMEOUTS') !== -1) {
      var t = vals.TIMEOUTS;
      if (t && typeof t === 'object') {
        html += '<div class="config-timeout-grid">';
        Object.keys(t).forEach(function(sk) {
          if (filterLower && sk.toLowerCase().indexOf(filterLower) === -1 && 'timeouts'.indexOf(filterLower) === -1) return;
          html += '<div class="config-timeout-item"><span class="config-timeout-key">' + sk + '</span>';
          html += '<span class="config-timeout-val" onclick="editConfigTimeout(this,\'' + sk + '\')">' + t[sk] + 's</span></div>';
        });
        html += '</div>';
      }
    } else {
      filteredKeys.forEach(function(key) {
        if (key === 'TIMEOUTS') return; // handled above
        var m = meta[key];
        var val = vals[key];
        html += '<div class="config-row" title="' + escHtml(m.desc || '') + '">';
        html += '<span class="config-row-key">' + key + '</span>';
        if (m.type === 'bool') {
          html += '<span class="config-row-val config-bool-toggle" onclick="toggleConfigBool(\'' + key + '\', this)" style="cursor:pointer">' + (val ? 'true' : 'false') + '</span>';
        } else {
          html += '<span class="config-row-val" onclick="editConfigValue(this,\'' + key + '\')">' + escHtml(formatConfigVal(val, m)) + '</span>';
        }
        html += '</div>';
      });
    }

    html += '</div></div>';
  });
  return html;
}

function filterConfig(filter) {
  var body = document.getElementById('configPanelBody');
  if (body) body.innerHTML = buildConfigPanelContent(filter);
}

function editConfigValue(el, key) {
  if (el.classList.contains('editing')) return;
  var meta = state.config.metadata[key];
  var rawVal = state.config.values[key];
  var input = document.createElement('input');
  input.type = 'text';
  input.value = rawVal != null ? String(rawVal) : '';
  input.style.cssText = 'background:var(--bg);border:1px solid var(--blue);color:var(--text-bright);font-family:inherit;font-size:11px;width:100%;padding:1px 4px;border-radius:3px;outline:none;text-align:right;';
  el.textContent = '';
  el.appendChild(input);
  el.classList.add('editing');
  input.focus();
  input.select();
  function commit() {
    var newVal = input.value;
    el.classList.remove('editing');
    saveConfigValue(key, newVal, el, meta);
  }
  input.addEventListener('keydown', function(e) { if (e.key === 'Enter') { e.preventDefault(); commit(); } if (e.key === 'Escape') { el.textContent = formatConfigVal(rawVal, meta); el.classList.remove('editing'); } });
  input.addEventListener('blur', commit);
}

function editConfigTimeout(el, stepKey) {
  if (el.classList.contains('editing')) return;
  var rawVal = state.config.values.TIMEOUTS[stepKey];
  var input = document.createElement('input');
  input.type = 'text';
  input.value = rawVal != null ? String(rawVal) : '';
  input.style.cssText = 'background:var(--bg);border:1px solid var(--blue);color:var(--text-bright);font-family:inherit;font-size:11px;width:50px;padding:1px 4px;border-radius:3px;outline:none;text-align:right;';
  el.textContent = '';
  el.appendChild(input);
  el.classList.add('editing');
  input.focus();
  input.select();
  function commit() {
    var newVal = parseInt(input.value, 10);
    el.classList.remove('editing');
    if (isNaN(newVal)) { el.textContent = rawVal + 's'; return; }
    var newTimeouts = Object.assign({}, state.config.values.TIMEOUTS);
    newTimeouts[stepKey] = newVal;
    saveConfigValue('TIMEOUTS', newTimeouts, el, {unit:'s'}, stepKey);
  }
  input.addEventListener('keydown', function(e) { if (e.key === 'Enter') { e.preventDefault(); commit(); } if (e.key === 'Escape') { el.textContent = rawVal + 's'; el.classList.remove('editing'); } });
  input.addEventListener('blur', commit);
}

function toggleConfigBool(key, el) {
  var current = state.config.values[key];
  var newVal = !current;
  saveConfigValue(key, newVal, el, state.config.metadata[key]);
}

function saveConfigValue(key, value, el, meta, timeoutStepKey) {
  var body = {};
  body[key] = value;
  fetch('/api/config', { method: 'PATCH', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) })
    .then(function(r) { return r.json().then(function(d) { return {ok: r.ok, data: d}; }); })
    .then(function(res) {
      var status = document.getElementById('configSaveStatus');
      if (res.ok && res.data.changed && res.data.changed.length) {
        state.config.values = res.data.values;
        if (timeoutStepKey) {
          el.textContent = res.data.values.TIMEOUTS[timeoutStepKey] + 's';
        } else {
          el.textContent = formatConfigVal(res.data.values[key], meta);
        }
        if (status) { status.textContent = 'Saved'; status.className = 'config-save-status config-save-ok'; status.style.opacity = '1'; setTimeout(function(){ status.style.opacity = '0'; }, 1500); }
        // Refresh detail panel if a step is selected (config chips update)
        if (state.selectedStep && state.view === 'list') renderDetail(state.selectedStep);
        syncDedupCheckbox();
      } else {
        var errMsg = res.data.errors ? res.data.errors.join('; ') : 'Save failed';
        if (status) { status.textContent = errMsg; status.className = 'config-save-status config-save-err'; status.style.opacity = '1'; setTimeout(function(){ status.style.opacity = '0'; }, 3000); }
        // Revert display
        if (timeoutStepKey) { el.textContent = state.config.values.TIMEOUTS[timeoutStepKey] + 's'; }
        else { el.textContent = formatConfigVal(state.config.values[key], meta); }
      }
    })
    .catch(function() {
      if (timeoutStepKey) { el.textContent = state.config.values.TIMEOUTS[timeoutStepKey] + 's'; }
      else { el.textContent = formatConfigVal(state.config.values[key], meta); }
    });
}

function resetConfig() {
  fetch('/api/config/reset', { method: 'POST' })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.values) {
        state.config.values = data.values;
        // Refresh the panel content
        var body = document.getElementById('configPanelBody');
        if (body) body.innerHTML = buildConfigPanelContent('');
        // Clear the filter input
        var filterInput = document.querySelector('.config-filter');
        if (filterInput) filterInput.value = '';
        // Flash status
        var status = document.getElementById('configSaveStatus');
        if (status) { status.textContent = 'Reset'; status.className = 'config-save-status config-save-ok'; status.style.opacity = '1'; setTimeout(function(){ status.style.opacity = '0'; }, 1500); }
        // Refresh detail panel config chips
        if (state.selectedStep && state.view === 'list') renderDetail(state.selectedStep);
        syncDedupCheckbox();
      }
    })
    .catch(function() {
      var status = document.getElementById('configSaveStatus');
      if (status) { status.textContent = 'Reset failed'; status.className = 'config-save-status config-save-err'; status.style.opacity = '1'; setTimeout(function(){ status.style.opacity = '0'; }, 3000); }
    });
}

// =======================================================
// INIT
// =======================================================

loadConfig();
renderPipeline();
updatePrompt();
</script>
</body>
</html>
